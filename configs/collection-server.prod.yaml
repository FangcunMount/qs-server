# ============================================================
# collection-server 生产环境配置
# ============================================================
# 用途：BFF 层服务，提供前端友好的 REST API，调用 apiserver gRPC 服务
# 维护人：DevOps Team
# 最后更新：2025-01-20
# ============================================================

# ============================================================
# 1. 应用配置
# ============================================================
# 应用级别的基础配置

# ============================================================
# 2. 端口配置
# ============================================================
# HTTP、HTTPS 服务端口配置
# 说明：collection-server 是纯 REST API 服务，不对外暴露 gRPC

# -------------------------------------------------------
# 2.1 HTTP 服务（开发测试用）
# -------------------------------------------------------
insecure:
  bind-address: "0.0.0.0"
  bind-port: 8080

# -------------------------------------------------------
# 2.2 HTTPS 服务（生产环境）
# -------------------------------------------------------
secure:
  bind-address: "0.0.0.0"
  bind-port: 8443
  tls:
    # Web 证书（容器内路径，由 docker-compose 从宿主机挂载）
    cert-file: "/etc/qs-server/ssl/certs/yangshujie.com.crt"
    private-key-file: "/etc/qs-server/ssl/private/yangshujie.com.key"

# -------------------------------------------------------
# 2.3 gRPC 客户端配置（调用 apiserver）
# -------------------------------------------------------
grpc_client:
  endpoint: "qs-apiserver:9090"  # Docker 容器服务名
  timeout: 30
  insecure: false  # 生产环境启用 TLS（insecure=false 表示启用 TLS）
  max_inflight: 200
  
  # mTLS 客户端配置（宿主机 /data/infra/ssl/grpc → 容器 /etc/qs-server/ssl）
  tls-cert-file: "/etc/qs-server/ssl/grpc/server/qs-collection-server.crt"
  tls-key-file: "/etc/qs-server/ssl/grpc/server/qs-collection-server.key"
  tls-ca-file: "/etc/qs-server/ssl/grpc/ca/ca-chain.crt"
  tls-server-name: "qs-apiserver.svc"  # 服务端证书的 CN，用于验证

# ============================================================
# 3. 存储配置
# ============================================================
# 数据库、缓存等存储服务配置

# -------------------------------------------------------
# 3.1 Redis 缓存（Cache Redis）
# -------------------------------------------------------
# 用途：缓存、会话、限流等临时数据
redis:
  cache:
    host: "127.0.0.1"
    port: 6379
    username: ""
    password: ""
    database: 0
    max-idle: 50
    max-active: 60
    timeout: 5
    enable-cluster: false
    use-ssl: false
    enable-logging: false

# -------------------------------------------------------
# 3.2 Redis 存储（Store Redis）
# -------------------------------------------------------
  # 用途：持久化存储、队列、发布订阅等
  store:
    host: "127.0.0.1"
    port: 6380
    username: ""
    password: ""
    database: 1
    max-idle: 50
    max-active: 60
    timeout: 5
    enable-cluster: false
    use-ssl: false
    enable-logging: false

# -------------------------------------------------------
# 3.3 限流配置
# -------------------------------------------------------
rate_limit:
  enabled: true
  submit_global_qps: 200
  submit_global_burst: 300
  submit_user_qps: 5
  submit_user_burst: 10
  query_global_qps: 200
  query_global_burst: 300
  query_user_qps: 10
  query_user_burst: 20
  wait_report_global_qps: 80
  wait_report_global_burst: 120
  wait_report_user_qps: 2
  wait_report_user_burst: 5

# -------------------------------------------------------
# 3.4 提交排队配置
# -------------------------------------------------------
submit_queue:
  enabled: true
  queue_size: 1000
  worker_count: 8
  wait_timeout_ms: 200

# ============================================================
# 4. 集成配置
# ============================================================
# 外部服务集成配置（IAM 等）

# -------------------------------------------------------
# 4.1 IAM 认证集成
# -------------------------------------------------------
# 说明：IAM 服务端口规划
# - 9080: HTTP REST API（内部调用，不加密）
# - 9444: HTTPS REST API（外网访问，SSL 加密）
# - 9090: gRPC with mTLS（服务间调用，双向认证）
# - 9091: Health Check（健康检查端口）
iam:
  enabled: true       # 启用 IAM 集成
  grpc-enabled: true  # 启用 gRPC 认证
  jwks-enabled: true  # 启用 JWKS 认证
  
  # 可观测性配置
  enable-tracing: true            # 启用 OpenTelemetry 链路追踪
  enable-metrics: true            # 启用 Prometheus 指标
  
  # gRPC 客户端配置
  grpc:
    address: "iam-apiserver:9090"  # IAM gRPC 服务地址（Docker 容器名，端口 9090）
    timeout: 30s
    retry-max: 3
    
    # mTLS 配置（宿主机 /data/infra/ssl/grpc → 容器 /etc/qs-server/ssl）
    # IAM gRPC 服务端口 9090 启用了 mTLS 保护
    tls:
      enabled: true   # 启用 mTLS 双向认证（与 IAM 9090 端口匹配）
      ca-file: "/etc/qs-server/ssl/grpc/ca/ca-chain.crt"           # CA 证书链
      cert-file: "/etc/qs-server/ssl/grpc/server/qs-collection-server.crt" # QS 客户端证书（调用 IAM）
      key-file: "/etc/qs-server/ssl/grpc/server/qs-collection-server.key"  # QS 客户端私钥
  
  # JWT 验证配置
  jwt:
    issuer: "https://iam-apiserver:9444"  # HTTPS 端口
    audience: ["collection-api", "qs-api"]
    algorithms: ["RS256", "ES256"]
    clock-skew: 30s
    required-claims: ["sub", "exp"]
  
  # JWKS 配置
  jwks:
    url: "https://iam.yangshujie.com/api/v1/.well-known/jwks.json"
    grpc-endpoint: "iam-apiserver:9090"                    # gRPC 降级端点（HTTP 失败时使用，端口 9090）
    refresh-interval: 1h
    cache-ttl: 24h
    fetch-strategies: ["http", "grpc", "cache"]  # 降级策略：HTTP → gRPC → 缓存
  
  # 用户信息缓存
  user-cache:
    enabled: true
    ttl: 5m
    max-size: 10000
  
  # 监护关系缓存
  guardianship-cache:
    enabled: true
    ttl: 10m
    max-size: 50000

# ============================================================
# 5. 系统配置
# ============================================================
# 日志、JWT 等系统级配置

# -------------------------------------------------------
# 5.1 日志配置
# -------------------------------------------------------
log:
  disable-caller: true
  disable-stacktrace: true
  level: debug
  format: console
  enable-color: true
  development: true
  name: "qs-collection-server"
  max-size: 100
  max-age: 30
  max-backups: 10
  compress: true
  enable-time-rotation: true
  time-rotation-format: "2006-01-02"
  enable-level-output: true
  level-output-mode: "duplicate"
  level-output-paths:
    all:
      - stdout
      - /data/logs/qs/qs-collection-server.log
    warn:
      - /data/logs/qs/qs-collection-server-warn.log
    error:
      - stderr
      - /data/logs/qs/qs-collection-server-error.log

# -------------------------------------------------------
# 5.2 JWT 配置（已废弃）
# -------------------------------------------------------
# 说明：已迁移到 IAM 统一认证，此配置保留用于降级方案
jwt:
  secret_key: "change-me"
  token_duration: 168  # 7 天 (24*7小时)

# ============================================================
# 6. 调优参数（内存/并发）
# ============================================================
# 控制 Go 运行时的 GC/内存行为与并发
runtime:
  # 将 GOMEMLIMIT 设置为容器配额的 80-85% 以避免 OOM（容器 mem_limit=1GiB）
  go-mem-limit: "700MiB"
  # 更积极的 GC，降低峰值内存
  gogc: 50

# 并发/连接池调优
concurrency:
  max-concurrency: 4
