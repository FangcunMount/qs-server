# collection-server 生产环境配置

# 服务器配置（HTTP）
insecure:
  bind-address: "0.0.0.0"
  bind-port: 8080

# 安全服务配置（HTTPS）
secure:
  bind-address: "0.0.0.0"
  bind-port: 8443
  tls:
    # Web 证书（容器内路径，由 docker-compose 从宿主机挂载）
    cert-file: "/etc/qs-server/ssl/certs/yangshujie.com.crt"
    private-key-file: "/etc/qs-server/ssl/private/yangshujie.com.key"

# gRPC 客户端配置（连接 apiserver）
grpc_client:
  endpoint: "apiserver:9090"  # 生产部署请根据服务发现或网关调整
  timeout: 30
  insecure: false  # 生产环境启用 TLS
  
  # mTLS 客户端配置（宿主机 /data/infra/ssl/grpc → 容器 /etc/qs-server/ssl）
  tls-cert-file: "/etc/qs-server/ssl/grpc/server/qs-collection.crt"
  tls-key-file: "/etc/qs-server/ssl/grpc/server/qs-collection.key"
  tls-ca-file: "/etc/qs-server/ssl/grpc/ca/ca-chain.crt"
  tls-server-name: "qs-apiserver.svc"  # 服务端证书的 CN，用于验证

# JWT 配置（已废弃，使用 IAM 统一认证）
jwt:
  secret_key: "change-me"
  token_duration: 168  # 7 天 (24*7小时)

# IAM 集成配置
iam:
  enabled: true       # 启用 IAM 集成
  grpc-enabled: true  # 启用 gRPC 认证
  jwks-enabled: true  # 启用 JWKS 认证
  
  # 可观测性配置
  enable-tracing: true            # 启用 OpenTelemetry 链路追踪
  enable-metrics: true            # 启用 Prometheus 指标
  
  # gRPC 客户端配置
  grpc:
    address: "iam-apiserver:9090"  # IAM gRPC 服务地址（Docker 容器名，端口 9090）
    timeout: 30s
    retry-max: 3
    
    # mTLS 配置（宿主机 /data/infra/ssl/grpc → 容器 /etc/qs-server/ssl）
    # IAM gRPC 服务端口 9090 启用了 mTLS 保护
    tls:
      enabled: true   # 启用 mTLS 双向认证（与 IAM 9090 端口匹配）
      ca-file: "/etc/qs-server/ssl/grpc/ca/ca-chain.crt"           # CA 证书链
      cert-file: "/etc/qs-server/ssl/grpc/server/qs-collection.crt" # QS 客户端证书（调用 IAM）
      key-file: "/etc/qs-server/ssl/grpc/server/qs-collection.key"  # QS 客户端私钥
  
  # JWT 验证配置
  jwt:
    issuer: "https://iam-apiserver:9444"  # HTTPS 端口
    audience: ["collection-api", "qs-api"]
    algorithms: ["RS256", "ES256"]
    clock-skew: 30s
    required-claims: ["sub", "exp"]
  
  # JWKS 配置
  jwks:
    url: "https://iam.yangshujie.com/api/v1/.well-known/jwks.json"
    grpc-endpoint: "iam-apiserver:9090"                    # gRPC 降级端点（HTTP 失败时使用，端口 9090）
    refresh-interval: 1h
    cache-ttl: 24h
    fetch-strategies: ["http", "grpc", "cache"]  # 降级策略：HTTP → gRPC → 缓存
  
  # 用户信息缓存
  user-cache:
    enabled: true
    ttl: 5m
    max-size: 10000
  
  # 监护关系缓存
  guardianship-cache:
    enabled: true
    ttl: 10m
    max-size: 50000

# 日志配置
log:
  disable-caller: true
  disable-stacktrace: true
  level: info
  format: json
  enable-color: false
  development: false
  name: "qs-collection-server"
  max-size: 100
  max-age: 30
  max-backups: 10
  compress: true
  enable-time-rotation: true
  time-rotation-format: "2006-01-02"
  enable-level-output: true
  level-output-mode: "duplicate"
  level-output-paths:
    all:
      - stdout
      - /data/logs/qs/qs-collection-server.log
    warn:
      - /data/logs/qs/qs-collection-server-warn.log
    error:
      - stderr
      - /data/logs/qs/qs-collection-server-error.log

# Redis 配置
redis:
  # Cache Redis - 用于缓存、会话、限流等临时数据
  cache:
    host: "127.0.0.1"
    port: 6379
    username: ""
    password: ""
    database: 0
    max-idle: 50
    max-active: 100
    timeout: 5
    enable-cluster: false
    use-ssl: false
    enable-logging: false

  # Store Redis - 用于持久化存储、队列、发布订阅等
  store:
    host: "127.0.0.1"
    port: 6380
    username: ""
    password: ""
    database: 1
    max-idle: 50
    max-active: 100
    timeout: 5
    enable-cluster: false
    use-ssl: false
    enable-logging: false
