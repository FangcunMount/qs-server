# ============================================================
# qs-apiserver 开发环境配置
# ============================================================
# 用途：核心业务 API 服务，提供 REST API 和 gRPC 服务
# 维护人：DevOps Team
# 最后更新：2025-01-20
# ============================================================

# ============================================================
# 1. 应用配置
# ============================================================
# 应用级别的基础配置（开发环境）

# -------------------------------------------------------
# 1.1 应用基础信息
# -------------------------------------------------------
app:
  name: "qs-apiserver"
  version: "1.0.0"
  mode: "development"  # development, production

# -------------------------------------------------------
# 1.2 RESTful 服务配置
# -------------------------------------------------------
server:
    mode: debug # server mode: release, debug, test
    healthz: true # 是否开启健康检查，如果开启会安装 /healthz 路由
    middlewares: recovery,enhanced_logger,secure,nocache,cors,dump # Gin 中间件列表
    max-ping-count: 3 # http 服务启动后，自检尝试次数

# ============================================================
# 2. 端口配置
# ============================================================
# HTTP、HTTPS、gRPC 服务端口配置（开发环境使用 18xxx 端口避免冲突）

# -------------------------------------------------------
# 2.1 HTTP 服务（开发主端口）
# -------------------------------------------------------
insecure:
  bind-address: "127.0.0.1"
  bind-port: 18082

# -------------------------------------------------------
# 2.2 HTTPS 服务（测试 TLS）
# -------------------------------------------------------
secure:
  bind-address: "127.0.0.1"
  bind-port: 18442
  tls:
    # 使用 Web 证书（用于浏览器 HTTPS 访问）
    cert-file: "/data/infra/ssl/web/qs-apiserver.crt"
    private-key-file: "/data/infra/ssl/web/qs-apiserver.key"

# -------------------------------------------------------
# 2.3 gRPC 服务（mTLS 测试模式）
# -------------------------------------------------------
grpc:
  bind-address: "127.0.0.1"
  bind-port: 9090
  
  # 启用 TLS 进行 mTLS 测试（insecure=false 表示启用 TLS）
  insecure: false
  tls-cert-file: "/data/infra/ssl/grpc/server/qs-apiserver.crt"
  tls-key-file: "/data/infra/ssl/grpc/server/qs-apiserver.key"
  
  # 消息大小限制
  max-msg-size: 4194304  # 4MB
  
  # 连接管理
  max-connection-age: 120s
  max-connection-age-grace: 20s
  
  # mTLS 双向认证配置（开发环境测试）
  mtls:
    enabled: true
    ca-file: "/data/infra/ssl/grpc/ca/ca-chain.crt"
    require-client-cert: true
    # 证书白名单：允许 collection-server 访问
    allowed-cns:
      - "qs-collection.svc"  # collection-server 的 CN
      - "localhost"
    allowed-ous:
      - "QS"
    min-tls-version: "1.2"
  
  # 认证配置（开发环境禁用）
  auth:
    enabled: false
  
  # ACL 配置（开发环境禁用）
  acl:
    enabled: false
  
  # 审计配置（开发环境禁用）
  audit:
    enabled: false
  
  # 功能开关
  enable-reflection: true     # 启用反射，方便 grpcurl 调试
  enable-health-check: true   # 启用健康检查

# ============================================================
# 3. 存储配置
# ============================================================
# MySQL、Redis、MongoDB 数据库配置（开发环境）

# -------------------------------------------------------
# 3.1 MySQL 数据库
# -------------------------------------------------------
mysql:
  host: "127.0.0.1:3306" # MySQL 服务器地址
  username: "app_user" # 数据库用户名
  password: "dev_app_pass_123" # 数据库密码
  database: "qs" # 数据库名称
  max-idle-connections: 10 # 最大空闲连接数
  max-open-connections: 100 # 最大打开连接数
  max-connection-life-time: "1h" # 连接最大生存时间
  log-level: 4 # 日志级别 (1=Silent, 2=Error, 3=Warn, 4=Info)

# -------------------------------------------------------
# 3.2 数据库迁移配置
# -------------------------------------------------------
migration:
  enabled: true  # 是否启用自动迁移
  autoseed: false  # 是否自动加载种子数据（仅开发/测试环境）
  database: "qs"  # 数据库名称

# -------------------------------------------------------
# 3.3 Redis 缓存（Cache Redis）
# -------------------------------------------------------
# 用途：缓存、会话、限流等临时数据
redis:
  cache:
    host: "127.0.0.1"
    port: 6379
    username: "app"  # Redis 6.0+ ACL 用户名
    password: "dev_app_123"
    database: 0  # 缓存使用 DB 0
    max-idle: 50
    max-active: 100
    timeout: 5
    enable-cluster: false
    use-ssl: false
    enable-logging: true  # 开发环境启用日志便于调试

  # -------------------------------------------------------
  # 3.4 Redis 存储（Store Redis）
  # -------------------------------------------------------
  # 用途：持久化存储、队列、发布订阅等
  store:
    host: "127.0.0.1"
    port: 6380  # 使用 Store Redis 实例（端口 6380）
    username: "app"  # Redis 6.0+ ACL 用户名
    password: "dev_app_123"
    database: 0  # Store Redis 使用 DB 0
    max-idle: 50
    max-active: 100
    timeout: 5
    enable-cluster: false
    use-ssl: false
    enable-logging: true  # 开发环境启用日志便于调试

# -------------------------------------------------------
# 3.5 MongoDB 数据库
# -------------------------------------------------------
# 支持两种方式：分离参数（推荐）或直接 URL
mongodb:
  host: "127.0.0.1:27018"           # MongoDB 主机地址
  username: "app_user"              # 用户名
  password: "d3v_App@M0ngo"      # 密码
  database: "qs"   # 数据库名称
  # url: ""                         # 可选，如果设置则优先使用
  use-ssl: false                    # 是否使用SSL
  ssl-insecure-skip-verify: false   # 是否跳过SSL证书验证
  ssl-allow-invalid-hostnames: false # 是否允许无效的主机名
  ssl-ca-file: ""                   # SSL CA 证书文件路径
  ssl-pem-keyfile: ""               # SSL PEM 密钥文件路径
  
  # MongoDB 日志配置
  enable-logger: true               # 是否启用 MongoDB 命令日志
  slow-threshold: 200ms             # 慢查询阈值（超过此时间记录警告）
  
  # 详细日志配置（component-base v0.4.1+ 已支持）
  # 开发环境建议启用 log-command-detail 以便调试
  log-command-detail: true          # 记录查询详情（类似 MySQL 的 SQL 日志，敏感信息会自动脱敏）
  log-reply-detail: true           # 是否记录响应详情（通常不需要）
  log-started: true                # 是否记录命令开始事件（会增加日志量）

# ============================================================
# 4. 消息队列配置
# ============================================================================
# apiserver 作为事件发布者，需要配置消息队列连接

# -------------------------------------------------------
# 4.1 消息队列（NSQ）
# -------------------------------------------------------
messaging:
  # 是否启用消息队列（false 则使用 logging 模式）
  enabled: true
  
  # 消息队列提供者: nsq, rabbitmq
  provider: nsq
  
  # NSQ 配置（开发环境默认）
  nsq-addr: "127.0.0.1:4150"           # NSQ Daemon 地址（用于发布）
  nsq-lookupd-addr: "127.0.0.1:4161"   # NSQ Lookupd 地址（apiserver 不需要，但保留配置）

# ============================================================
# 5. 集成配置
# ============================================================
# 外部服务集成配置（IAM 等）

# -------------------------------------------------------
# 5.1 IAM 认证集成（开发环境）
# -------------------------------------------------------
# 说明：开发环境可选择性启用 IAM 集成
# - enabled: true 启用 IAM，需要 IAM 服务运行
# - enabled: false 禁用 IAM，使用本地 JWT 认证
iam:
  enabled: true                  # 开发环境可选启用 IAM
  grpc-enabled: true              # 是否启用 gRPC 调用
  jwks-enabled: true              # 是否启用 JWKS 本地验签
  
  # 可观测性配置
  enable-tracing: true            # 启用 OpenTelemetry 链路追踪
  enable-metrics: true            # 启用 Prometheus 指标
  
  # gRPC 连接配置
  grpc:
    address: "iam-apiserver:9090"  # IAM gRPC 服务地址（需修正为 9090）
    timeout: 5s                   # 请求超时时间
    retry-max: 3                  # 最大重试次数
    
    # mTLS 证书配置（开发环境可测试）
    tls:
      enabled: false              # 开发环境可选启用 mTLS（需要时改为 true）
      ca-file: "/etc/qs-server/ssl/ca/ca-chain.crt"       # CA 证书链
      cert-file: "/etc/qs-server/ssl/server/qs-apiserver.crt" # QS 客户端证书
      key-file: "/etc/qs-server/ssl/server/qs-apiserver.key"  # QS 客户端私钥
  
  # JWT 验证配置
  jwt:
    issuer: "http://iam-apiserver:9080"                # Token 签发者（Docker 容器）
    audience: ["qs"]                                   # 允许的受众（QS 服务标识）
    algorithms: ["RS256", "ES256"]                     # 支持的签名算法
    clock-skew: 60s                                    # 时钟偏移容忍度
    required-claims: ["user_id", "tenant_id"]          # 必需的 Claims
  
  # JWKS 配置（JWT 公钥管理）
  jwks:
    url: "http://iam-apiserver:9080/.well-known/jwks.json"  # JWKS HTTP 端点
    grpc-endpoint: "iam-apiserver:9090"                    # 修正为 9090 端口
    refresh-interval: 5m                               # 定时刷新间隔
    cache-ttl: 30m                                     # 缓存有效期
    fetch-strategies: ["http", "grpc", "cache"]        # 降级策略：HTTP → gRPC → 缓存
  
  # 服务间认证配置（可选）
  service-auth:
    service-id: "qs-service"                           # QS 服务 ID
    target-audience: ["iam-service"]                   # 目标服务列表
    token-ttl: 1h                                      # 服务 Token 有效期
    refresh-before: 5m                                 # 提前刷新时间
  
  # 用户信息缓存配置
  user-cache:
    enabled: true                                      # 启用用户信息缓存
    ttl: 5m                                            # 缓存时长
    max-size: 10000                                    # 最大缓存条目数
  
  # 监护关系缓存配置
  guardianship-cache:
    enabled: true                                      # 启用监护关系缓存
    ttl: 10m                                           # 缓存时长（监护关系变化较少）
    max-size: 50000                                    # 最大缓存条目数

# ============================================================
# 6. 系统配置
# ============================================================
# 日志、JWT 等系统级配置（开发环境）

# -------------------------------------------------------
# 6.1 日志配置（开发环境 - 控制台友好）
# -------------------------------------------------------
log:
  disable-caller: false         # 开发环境显示调用者信息
  disable-stacktrace: false     # 开发环境显示堆栈
  level: debug                  # 开发环境使用 debug 级别
  format: console               # 控制台格式便于阅读
  enable-color: true            # 启用颜色便于区分
  development: true             # 开发模式
  name: "qs-apiserver"          # 日志名称
  
  # 日志轮转配置
  max-size: 100                 # 单个日志文件最大 100MB
  max-age: 7                    # 开发环境保留 7 天
  max-backups: 3                # 开发环境保留 3 个备份
  compress: false               # 开发环境不压缩
  
  # 按时间轮转（可选）
  enable-time-rotation: false   # 开发环境禁用按天轮转
  time-rotation-format: "2006-01-02"
  
  # 分级输出（开发环境简化配置）
  enable-level-output: true
  level-output-mode: "duplicate"
  level-output-paths:
    all:
      - stdout
      - /data/logs/qs/qs-apiserver.log
    warn:
      - /data/logs/qs/qs-apiserver-warn.log
    error:
      - stderr
      - /data/logs/qs/qs-apiserver-error.log

# -------------------------------------------------------
# 6.2 JWT 配置（本地认证降级方案）
# -------------------------------------------------------
# 说明：当 IAM 不可用时的降级认证方式
jwt:
  realm: "qs jwt"
  key: "questionnaire-scale-jwt-secret-key-2024"
  timeout: "24h"
  max-refresh: "168h"
