# qs-apiserver å…¨é…ç½®

# åº”ç”¨é…ç½®
app:
  name: "qs-apiserver"
  version: "1.0.0"
  mode: "production"  # development, production

# RESTful æœåŠ¡é…ç½®
server:
    mode: debug # server mode: release, debug, testï¼Œé»˜è®¤ release
    healthz: true # æ˜¯å¦å¼€å¯å¥åº·æ£€æŸ¥ï¼Œå¦‚æœå¼€å¯ä¼šå®‰è£… /healthz è·¯ç”±ï¼Œé»˜è®¤ true
    middlewares: recovery,enhanced_logger,secure,nocache,cors,dump # åŠ è½½çš„ gin ä¸­é—´ä»¶åˆ—è¡¨ï¼Œå¤šä¸ªä¸­é—´ä»¶ï¼Œé€—å·(,)éš”å¼€
    max-ping-count: 3 # http æœåŠ¡å¯åŠ¨åï¼Œè‡ªæ£€å°è¯•æ¬¡æ•°ï¼Œé»˜è®¤ 3

# gRPC é…ç½®ï¼ˆå¼€å‘ç¯å¢ƒ - mTLS æµ‹è¯•æ¨¡å¼ï¼‰
grpc:
  bind-address: "127.0.0.1"
  bind-port: 9090
  
  # å¯ç”¨ TLS è¿›è¡Œ mTLS æµ‹è¯•
  insecure: false
  tls-cert-file: "/data/infra/ssl/grpc/server/qs-apiserver.crt"
  tls-key-file: "/data/infra/ssl/grpc/server/qs-apiserver.key"
  
  # æ¶ˆæ¯å¤§å°é™åˆ¶ï¼ˆå¯é€‰ï¼‰
  max-msg-size: 4194304  # 4MB
  
  # è¿æ¥ç®¡ç†ï¼ˆå¯é€‰ï¼‰
  max-connection-age: 120s
  max-connection-age-grace: 20s
  
  # mTLS åŒå‘è®¤è¯é…ç½®ï¼ˆå¼€å‘ç¯å¢ƒæµ‹è¯•ï¼‰
  mtls:
    enabled: true
    ca-file: "/data/infra/ssl/grpc/ca/ca-chain.crt"
    require-client-cert: true
    # è¯ä¹¦ç™½åå•ï¼šå…è®¸ collection-server è®¿é—®
    allowed-cns:
      - "qs-collection.svc"  # collection-server çš„ CN
      - "localhost"
    allowed-ous:
      - "QS"
    min-tls-version: "1.2"
  
  # è®¤è¯é…ç½®ï¼ˆå¼€å‘ç¯å¢ƒç¦ç”¨ï¼‰
  auth:
    enabled: false
  
  # ACL é…ç½®ï¼ˆå¼€å‘ç¯å¢ƒç¦ç”¨ï¼‰
  acl:
    enabled: false
  
  # å®¡è®¡é…ç½®ï¼ˆå¼€å‘ç¯å¢ƒç¦ç”¨ï¼‰
  audit:
    enabled: false
  
  # åŠŸèƒ½å¼€å…³
  enable-reflection: true     # å¯ç”¨åå°„ï¼Œæ–¹ä¾¿ grpcurl è°ƒè¯•
  enable-health-check: true   # å¯ç”¨å¥åº·æ£€æŸ¥

# ä¸å®‰å…¨æœåŠ¡é…ç½®
insecure:
  bind-address: "127.0.0.1"
  bind-port: 18082

# å®‰å…¨æœåŠ¡é…ç½®ï¼ˆHTTPS REST API - ä¾›æµè§ˆå™¨è®¿é—®ï¼‰
secure:
  bind-address: "127.0.0.1"
  bind-port: 18442
  tls:
    # ä½¿ç”¨ Web è¯ä¹¦ï¼ˆç”¨äºæµè§ˆå™¨ HTTPS è®¿é—®ï¼‰
    cert-file: "/data/infra/ssl/web/qs-apiserver.crt"
    private-key-file: "/data/infra/ssl/web/qs-apiserver.key"

# MySQL æ•°æ®åº“é…ç½®
mysql:
  host: "127.0.0.1:3306" # MySQL æœåŠ¡å™¨åœ°å€
  username: "app_user" # æ•°æ®åº“ç”¨æˆ·å
  password: "dev_app_pass_123" # æ•°æ®åº“å¯†ç 
  database: "qs" # æ•°æ®åº“åç§°
  max-idle-connections: 10 # æœ€å¤§ç©ºé—²è¿æ¥æ•°
  max-open-connections: 100 # æœ€å¤§æ‰“å¼€è¿æ¥æ•°
  max-connection-life-time: "1h" # è¿æ¥æœ€å¤§ç”Ÿå­˜æ—¶é—´
  log-level: 4 # æ—¥å¿—çº§åˆ« (1=Silent, 2=Error, 3=Warn, 4=Info)

# æ•°æ®åº“è¿ç§»é…ç½®
migration:
  enabled: true  # æ˜¯å¦å¯ç”¨è‡ªåŠ¨è¿ç§»ï¼ˆç”Ÿäº§ç¯å¢ƒå»ºè®®å¯ç”¨ï¼‰
  autoseed: false  # æ˜¯å¦è‡ªåŠ¨åŠ è½½ç§å­æ•°æ®ï¼ˆä»…å¼€å‘/æµ‹è¯•ç¯å¢ƒï¼‰
  database: "qs"  # æ•°æ®åº“åç§°

# Redis é…ç½®ï¼ˆåŒå®ä¾‹æ¶æ„ï¼‰
redis:
  # Cache Redis - ç”¨äºç¼“å­˜ã€ä¼šè¯ã€é™æµç­‰ä¸´æ—¶æ•°æ®
  cache:
    host: "127.0.0.1"
    port: 6379
    username: "app"  # Redis 6.0+ ACL ç”¨æˆ·å
    password: "dev_app_123"
    database: 0  # ç¼“å­˜ä½¿ç”¨ DB 0
    max-idle: 50
    max-active: 100
    timeout: 5
    enable-cluster: false
    use-ssl: false
    enable-logging: true  # å¼€å¯ Redis å‘½ä»¤æ—¥å¿—ï¼ˆç”¨äºè°ƒè¯•ï¼Œç”Ÿäº§ç¯å¢ƒå»ºè®®å…³é—­ï¼‰
  
  # Store Redis - ç”¨äºæŒä¹…åŒ–å­˜å‚¨ã€é˜Ÿåˆ—ã€å‘å¸ƒè®¢é˜…ç­‰
  store:
    host: "127.0.0.1"
    port: 6380  # ä½¿ç”¨ Store Redis å®ä¾‹ï¼ˆç«¯å£ 6380ï¼‰
    username: "app"  # Redis 6.0+ ACL ç”¨æˆ·å
    password: "dev_app_123"
    database: 0  # Store Redis ä½¿ç”¨ DB 0
    max-idle: 50
    max-active: 100
    timeout: 5
    enable-cluster: false
    use-ssl: false
    enable-logging: true  # å¼€å¯ Redis å‘½ä»¤æ—¥å¿—ï¼ˆç”¨äºè°ƒè¯•ï¼Œç”Ÿäº§ç¯å¢ƒå»ºè®®å…³é—­ï¼‰

# MongoDB æ•°æ®åº“é…ç½®
# æ”¯æŒä¸¤ç§æ–¹å¼ï¼šåˆ†ç¦»å‚æ•°ï¼ˆæ¨èï¼‰æˆ–ç›´æ¥ URL
mongodb:
  host: "127.0.0.1:27018"           # MongoDB ä¸»æœºåœ°å€
  username: "app_user"              # ç”¨æˆ·å
  password: "d3v_App@M0ngo"      # å¯†ç 
  database: "qs"   # æ•°æ®åº“åç§°
  # url: ""                         # å¯é€‰ï¼Œå¦‚æœè®¾ç½®åˆ™ä¼˜å…ˆä½¿ç”¨
  use-ssl: false                    # æ˜¯å¦ä½¿ç”¨SSL
  ssl-insecure-skip-verify: false   # æ˜¯å¦è·³è¿‡SSLè¯ä¹¦éªŒè¯
  ssl-allow-invalid-hostnames: false # æ˜¯å¦å…è®¸æ— æ•ˆçš„ä¸»æœºå
  ssl-ca-file: ""                   # SSL CA è¯ä¹¦æ–‡ä»¶è·¯å¾„
  ssl-pem-keyfile: ""               # SSL PEM å¯†é’¥æ–‡ä»¶è·¯å¾„

# æ—¥å¿—é…ç½®ï¼ˆç”Ÿäº§ç¯å¢ƒ - ä½¿ç”¨ component-base v0.2.9 duplicate æ¨¡å¼ï¼‰
log:
  # åŸºç¡€é…ç½®
  disable-caller: true          # ç”Ÿäº§ç¯å¢ƒç¦ç”¨è°ƒç”¨è€…ä¿¡æ¯ï¼ˆæ€§èƒ½ä¼˜åŒ–ï¼‰
  disable-stacktrace: true      # ä»…åœ¨ panic æ—¶è®°å½•å †æ ˆ
  level: debug                   # æ—¥å¿—åŸºæœ¬çº§åˆ«ï¼š debug, info, warn, error, fatal, panic
  format: console                # æ—¥å¿—æ ¼å¼ï¼ˆjson é€‚åˆç”Ÿäº§ç¯å¢ƒï¼Œconsole é€‚åˆå¼€å‘ç¯å¢ƒï¼‰
  enable-color: false           # æ–‡ä»¶è¾“å‡ºç¦ç”¨é¢œè‰²
  development: false            # ç”Ÿäº§æ¨¡å¼
  name: "qs-apiserver"         # æ—¥å¿—åç§°
  
  # ğŸ“Š æ—¥å¿—è½®è½¬é…ç½®
  max-size: 100                 # å•ä¸ªæ—¥å¿—æ–‡ä»¶æœ€å¤§ 100MB
  max-age: 30                   # ä¿ç•™ 30 å¤©
  max-backups: 10               # ä¿ç•™ 10 ä¸ªå¤‡ä»½æ–‡ä»¶
  compress: true                # å‹ç¼©æ—§æ–‡ä»¶èŠ‚çœç©ºé—´
  
  # â° æŒ‰æ—¶é—´è½®è½¬ï¼ˆæ¨èç”Ÿäº§ç¯å¢ƒä½¿ç”¨ï¼‰
  enable-time-rotation: true    # å¯ç”¨æŒ‰å¤©è½®è½¬
  time-rotation-format: "2006-01-02"  # æŒ‰å¤©è½®è½¬
  
  # ğŸ¯ åˆ†çº§è¾“å‡ºï¼ˆv0.2.9 duplicate æ¨¡å¼ - ç”Ÿäº§ç¯å¢ƒæ¨èï¼‰
  enable-level-output: true       # å¯ç”¨åˆ†çº§è¾“å‡º
  level-output-mode: "duplicate"  # é‡å¤è¾“å‡ºæ¨¡å¼ï¼ˆæ¨èï¼‰
  level-output-paths:
    all:
      - stdout                              # å®¹å™¨/è¿›ç¨‹æ ‡å‡†è¾“å‡ºä¿ç•™å®Œæ•´æ—¥å¿—
      - /data/logs/qs/qs-apiserver.log      # å®Œæ•´æ—¥å¿—ï¼ˆæ‰€æœ‰çº§åˆ«ï¼‰
    warn:
      - /data/logs/qs/qs-apiserver-warn.log # é¢å¤–è®°å½• WARNï¼ˆå‘ç°æ½œåœ¨é—®é¢˜ï¼Œå¯é€‰ï¼‰
    error:
      - stderr                              # ERROR çº§åˆ«å†™å…¥æ ‡å‡†é”™è¯¯ï¼Œä¾¿äºç›‘æ§é‡‡é›†
      - /data/logs/qs/qs-apiserver-error.log # é¢å¤–è®°å½• ERRORï¼ˆå¿«é€Ÿå®šä½æ•…éšœï¼‰

# IAM é›†æˆé…ç½®
iam:
  # åŠŸèƒ½å¼€å…³ï¼ˆç°åº¦å‘å¸ƒæ§åˆ¶ï¼‰
  enabled: false                  # å¼€å‘ç¯å¢ƒç¦ç”¨ IAM é›†æˆï¼ˆé¿å…è¯ä¹¦ä¾èµ–ï¼‰
  grpc-enabled: true              # æ˜¯å¦å¯ç”¨ gRPC è°ƒç”¨
  jwks-enabled: true              # æ˜¯å¦å¯ç”¨ JWKS æœ¬åœ°éªŒç­¾
  
  # gRPC è¿æ¥é…ç½®
  grpc:
    address: "iam-apiserver:9080"  # IAM gRPC æœåŠ¡åœ°å€ï¼ˆDocker å®¹å™¨åï¼‰
    timeout: 5s                   # è¯·æ±‚è¶…æ—¶æ—¶é—´
    retry-max: 3                  # æœ€å¤§é‡è¯•æ¬¡æ•°
    
    # mTLS è¯ä¹¦é…ç½®ï¼ˆå¼€å‘ç¯å¢ƒç¤ºä¾‹ï¼Œéœ€è¦æ—¶å¯ç”¨ï¼‰
    tls:
      enabled: false              # å¼€å‘ç¯å¢ƒç¦ç”¨ mTLSï¼ˆéœ€è¦æ—¶æ”¹ä¸º trueï¼‰
      ca-file: "/etc/qs-server/ssl/ca/ca-chain.crt"       # CA è¯ä¹¦é“¾
      cert-file: "/etc/qs-server/ssl/server/qs-apiserver.crt" # QS å®¢æˆ·ç«¯è¯ä¹¦
      key-file: "/etc/qs-server/ssl/server/qs-apiserver.key"  # QS å®¢æˆ·ç«¯ç§é’¥
  
  # JWT éªŒè¯é…ç½®
  jwt:
    issuer: "http://iam-apiserver:9080"                # Token ç­¾å‘è€…ï¼ˆDocker å®¹å™¨ï¼‰
    audience: ["qs"]                                   # å…è®¸çš„å—ä¼—ï¼ˆQS æœåŠ¡æ ‡è¯†ï¼‰
    algorithms: ["RS256", "ES256"]                     # æ”¯æŒçš„ç­¾åç®—æ³•
    clock-skew: 60s                                    # æ—¶é’Ÿåç§»å®¹å¿åº¦
    required-claims: ["user_id", "tenant_id"]          # å¿…éœ€çš„ Claims
  
  # JWKS é…ç½®ï¼ˆJWT å…¬é’¥ç®¡ç†ï¼‰
  jwks:
    url: "http://iam-apiserver:9080/.well-known/jwks.json"  # JWKS HTTP ç«¯ç‚¹
    refresh-interval: 5m                               # å®šæ—¶åˆ·æ–°é—´éš”
    cache-ttl: 30m                                     # ç¼“å­˜æœ‰æ•ˆæœŸ
    fetch-strategies: ["grpc", "http", "cache"]        # é™çº§ç­–ç•¥ï¼šgRPC â†’ HTTP â†’ ç¼“å­˜
  
  # æœåŠ¡é—´è®¤è¯é…ç½®ï¼ˆå¯é€‰ï¼Œç”¨äº QS è°ƒç”¨å…¶ä»–æœåŠ¡ï¼‰
  service-auth:
    service-id: "qs-service"                           # QS æœåŠ¡ ID
    target-audience: ["iam-service"]                   # ç›®æ ‡æœåŠ¡åˆ—è¡¨
    token-ttl: 1h                                      # æœåŠ¡ Token æœ‰æ•ˆæœŸ
    refresh-before: 5m                                 # æå‰åˆ·æ–°æ—¶é—´
  
  # ç”¨æˆ·ä¿¡æ¯ç¼“å­˜é…ç½®
  user-cache:
    enabled: true                                      # å¯ç”¨ç”¨æˆ·ä¿¡æ¯ç¼“å­˜
    ttl: 5m                                            # ç¼“å­˜æ—¶é•¿
    max-size: 10000                                    # æœ€å¤§ç¼“å­˜æ¡ç›®æ•°
  
  # ç›‘æŠ¤å…³ç³»ç¼“å­˜é…ç½®
  guardianship-cache:
    enabled: true                                      # å¯ç”¨ç›‘æŠ¤å…³ç³»ç¼“å­˜
    ttl: 10m                                           # ç¼“å­˜æ—¶é•¿ï¼ˆç›‘æŠ¤å…³ç³»å˜åŒ–è¾ƒå°‘ï¼‰
    max-size: 50000                                    # æœ€å¤§ç¼“å­˜æ¡ç›®æ•°

# JWT é…ç½®ï¼ˆå·²å¼ƒç”¨ï¼Œç”± IAM ç®¡ç†ï¼‰
# ä¿ç•™æ­¤é…ç½®æ®µä»¥ä¾¿å…¼å®¹æ—§ä»£ç ï¼Œä½†ä¸å†ä½¿ç”¨
jwt:
  realm: "qs jwt" # JWT é¢†åŸŸåç§°
  key: "questionnaire-scale-jwt-secret-key-2024" # JWT ç­¾åå¯†é’¥ï¼ˆç”Ÿäº§ç¯å¢ƒè¯·ä½¿ç”¨æ›´å¼ºçš„å¯†é’¥ï¼‰
  timeout: "24h" # Token æœ‰æ•ˆæœŸï¼ˆ24å°æ—¶ï¼‰
  max-refresh: "168h" # æœ€å¤§åˆ·æ–°æ—¶é—´ï¼ˆ7å¤©ï¼‰
