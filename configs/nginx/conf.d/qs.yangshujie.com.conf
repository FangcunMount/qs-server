# qs.yangshujie.com —— 后端 API（含 CORS 白名单）
# 注意：本文件被包含于 http{} 内

# 后端 upstream
upstream qs-api {
    zone qs_api 64k;
    server qs-apiserver:8080 resolve;
    keepalive 32;
}

# CORS 允许来源（严格白名单）
map $http_origin $cors_origin {
    default "";
    "~^https://([a-z0-9-]+\.)?yangshujie\.com$" $http_origin;
}

# 预检标识
map $request_method $is_options {
    default 0;
    OPTIONS 1;
}

# 是否需要为“常规请求”输出 CORS（命中白名单才输出）
map $cors_origin $cors_enabled {
    default 1;
    "" 0;
}

# 预检：OPTIONS + 非白名单 => 204 且不带 CORS
map "$is_options:$cors_origin" $preflight_deny {
    default 0;
    "1:" 1;
}

# 预检：OPTIONS + 白名单 => 204 且带 CORS
map "$is_options:$cors_origin" $preflight_allow {
    default 0;
    "~^1:https://([a-z0-9-]+\.)?yangshujie\.com$" 1;
}

server {
    listen 443 ssl;
    http2 on;
    server_name qs.yangshujie.com;

    resolver 127.0.0.11 valid=10s ipv6=off;

    # TLS（使用通配符证书）
    ssl_certificate     /data/ssl/certs/yangshujie.com.crt;
    ssl_certificate_key /data/ssl/private/yangshujie.com.key;
    ssl_protocols TLSv1.2 TLSv1.3;
    ssl_ciphers HIGH:!aNULL:!MD5:!3DES;
    ssl_prefer_server_ciphers off;
    ssl_session_cache shared:SSL:10m;
    ssl_session_timeout 5m;

    # 安全响应头（API 不允许被内嵌）
    add_header Strict-Transport-Security "max-age=31536000; includeSubDomains" always;
    add_header X-Frame-Options DENY always;
    add_header X-Content-Type-Options nosniff always;

    # 健康检查
    location /health {
        proxy_pass http://qs-api/health;
        proxy_set_header Host $host;
    }

    # 兼容 swagger 入口：/swagger 或 /swagger/xxx 重定向到 /swagger-ui/
    location ~* ^/swagger(/.*)?$ {
        return 302 https://$host/swagger-ui$1;
    }

    location / {
        # =========================================================
        # CORS（仅更新这一块）
        # 1) 屏蔽上游可能返回的 CORS，避免多个值叠加
        # =========================================================
        proxy_hide_header Access-Control-Allow-Origin;
        proxy_hide_header Access-Control-Allow-Credentials;
        proxy_hide_header Access-Control-Allow-Headers;
        proxy_hide_header Access-Control-Allow-Methods;
        proxy_hide_header Access-Control-Max-Age;
        proxy_hide_header Vary;

        # =========================================================
        # 2) 预检 OPTIONS：不嵌套 if
        # =========================================================
        if ($preflight_deny = 1) {
            add_header Content-Length 0;
            add_header Content-Type text/plain;
            return 204;
        }

        if ($preflight_allow = 1) {
            add_header Access-Control-Allow-Origin $cors_origin always;
            add_header Vary Origin always;

            add_header Access-Control-Allow-Methods "GET, POST, PUT, PATCH, DELETE, OPTIONS" always;
            add_header Access-Control-Allow-Headers "Origin, Content-Type, Authorization, X-Requested-With, Accept" always;
            add_header Access-Control-Allow-Credentials "true" always;
            add_header Access-Control-Max-Age "3600" always;

            add_header Content-Length 0;
            add_header Content-Type text/plain;
            return 204;
        }

        # =========================================================
        # 3) 常规请求：命中白名单才加 CORS（不嵌套 if）
        # =========================================================
        if ($cors_enabled = 1) {
            add_header Access-Control-Allow-Origin $cors_origin always;
            add_header Vary Origin always;
            add_header Access-Control-Allow-Credentials "true" always;

            add_header Access-Control-Allow-Methods "GET, POST, PUT, PATCH, DELETE, OPTIONS" always;
            add_header Access-Control-Allow-Headers "Origin, Content-Type, Authorization, X-Requested-With, Accept" always;
        }

        # =========================================================
        # 反代（保持原样）
        # =========================================================
        proxy_pass http://qs-api;
        proxy_http_version 1.1;
        proxy_set_header Host              $host;
        proxy_set_header X-Real-IP         $remote_addr;
        proxy_set_header X-Forwarded-For   $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_read_timeout 60s;
        proxy_send_timeout 60s;
    }
}

# 80 → 443 重定向 + ACME 校验
server {
    listen 80;
    server_name qs.yangshujie.com;

    location /.well-known/acme-challenge/ {
        root /var/www/certbot;
    }
    location / {
        return 301 https://$server_name$request_uri;
    }
}
