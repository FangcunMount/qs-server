# ============================================================
# collection-server 开发环境配置
# ============================================================
# 用途：BFF 层服务，提供前端友好的 REST API，调用 apiserver gRPC 服务
# 维护人：DevOps Team
# 最后更新：2025-01-20
# ============================================================

# ============================================================
# 1. 应用配置
# ============================================================
# 应用级别的基础配置（开发环境）

# ============================================================
# 2. 端口配置
# ============================================================
# HTTP、HTTPS 服务端口配置（开发环境使用 18xxx 端口避免冲突）

# -------------------------------------------------------
# 2.1 HTTP 服务（开发主端口）
# -------------------------------------------------------
insecure:
  bind-address: "127.0.0.1"
  bind-port: 18083

# -------------------------------------------------------
# 2.2 HTTPS 服务（测试 TLS）
# -------------------------------------------------------
secure:
  bind-address: "127.0.0.1"
  bind-port: 18443
  tls:
    # 使用 Web 证书（用于浏览器 HTTPS 访问）
    cert-file: "/data/infra/ssl/web/qs-collection.crt"
    private-key-file: "/data/infra/ssl/web/qs-collection.key"

# -------------------------------------------------------
# 2.3 gRPC 客户端配置（调用 apiserver）
# -------------------------------------------------------
grpc_client:
  endpoint: "127.0.0.1:9090"
  timeout: 30
  insecure: false  # 启用 TLS 进行 mTLS 测试（insecure=false 表示启用 TLS）
  
  # mTLS 客户端配置（使用 infra 项目生成的证书）
  tls-cert-file: "/data/infra/ssl/grpc/server/qs-collection-server.crt"
  tls-key-file: "/data/infra/ssl/grpc/server/qs-collection-server.key"
  tls-ca-file: "/data/infra/ssl/grpc/ca/ca-chain.crt"
  tls-server-name: "qs-apiserver.svc"  # 必须与服务端证书的 CN 匹配

# ============================================================
# 3. 存储配置
# ============================================================
# 数据库、缓存等存储服务配置（开发环境）

# -------------------------------------------------------
# 3.1 Redis 缓存（Cache Redis）
# -------------------------------------------------------
# 用途：缓存、会话、限流等临时数据
redis:
  cache:
    host: "127.0.0.1"
    port: 6379
    username: "app"  # Redis 6.0+ ACL 用户名
    password: "dev_app_123"
    database: 0  # 缓存使用 DB 0
    max-idle: 50
    max-active: 100
    timeout: 5
    enable-cluster: false
    use-ssl: false
    enable-logging: true  # 开发环境启用日志便于调试

  # -------------------------------------------------------
  # 3.2 Redis 存储（Store Redis）
  # -------------------------------------------------------
  # 用途：持久化存储、队列、发布订阅等
  store:
    host: "127.0.0.1"
    port: 6380  # 使用 Store Redis 实例（端口 6380）
    username: "app"  # Redis 6.0+ ACL 用户名
    password: "dev_app_123"
    database: 0  # Store Redis 使用 DB 0
    max-idle: 50
    max-active: 100
    timeout: 5
    enable-cluster: false
    use-ssl: false
    enable-logging: true  # 开发环境启用日志便于调试

# ============================================================
# 4. 集成配置
# ============================================================
# 外部服务集成配置（IAM 等）

# -------------------------------------------------------
# 4.1 IAM 认证集成（开发环境）
# -------------------------------------------------------
# 说明：开发环境可选择性启用 IAM 集成
# - enabled: true 启用 IAM，需要 IAM 服务运行
# - enabled: false 禁用 IAM，使用本地 JWT 认证
iam:
  enabled: true  # 开发环境默认启用，测试 IAM 集成
  grpc-enabled: true
  jwks-enabled: true
  
  # 可观测性配置
  enable-tracing: true            # 启用 OpenTelemetry 链路追踪
  enable-metrics: true            # 启用 Prometheus 指标
  
  # gRPC 客户端配置
  grpc:
    address: "iam-apiserver:9090"  # IAM gRPC 服务地址（需修正为 9090）
    timeout: 30s
    retry-max: 3
    
    # mTLS 配置（开发环境测试）
    tls:
      enabled: true              # 开发环境可启用 mTLS 测试
      ca-file: "/data/infra/ssl/grpc/ca/ca-chain.crt"       # CA 证书链
      cert-file: "/data/infra/ssl/grpc/server/qs-collection-server.crt" # QS 客户端证书
      key-file: "/data/infra/ssl/grpc/server/qs-collection-server.key"  # QS 客户端私钥
  
  # JWT 验证配置
  jwt:
    issuer: "https://iam-apiserver:9080"
    audience: ["collection-api", "qs-api"]
    algorithms: ["RS256", "ES256"]
    clock-skew: 30s
    required-claims: ["sub", "exp"]
  
  # JWKS 配置
  jwks:
    url: "http://iam-apiserver:9080/.well-known/jwks.json"
    grpc-endpoint: "iam-apiserver:9090"  # 修正为 9090 端口
    refresh-interval: 1h
    cache-ttl: 24h
    fetch-strategies: ["http", "grpc", "cache"]  # 降级策略：HTTP → gRPC → 缓存
  
  # 用户信息缓存
  user-cache:
    enabled: true
    ttl: 5m
    max-size: 10000
  
  # 监护关系缓存
  guardianship-cache:
    enabled: true
    ttl: 10m
    max-size: 50000

# ============================================================
# 5. 系统配置
# ============================================================
# 日志、JWT 等系统级配置（开发环境）

# -------------------------------------------------------
# 5.1 日志配置（开发环境 - 控制台友好）
# -------------------------------------------------------
log:
  name: "collection-server"
  level: "debug" # 开发环境使用 debug 级别
  format: "console" # 控制台格式便于阅读
  enable-color: true # 启用颜色便于区分
  disable-caller: false # 显示调用者信息
  disable-stacktrace: false # 显示堆栈跟踪
  development: true # 开发模式
  output-paths: ["/data/logs/qs/collection-server.log", "stdout"]
  error-output-paths: ["/data/logs/qs/collection-server-error.log", "stderr"]
  max-size: 100
  max-age: 7  # 开发环境保留 7 天
  max-backups: 3  # 开发环境保留 3 个备份
  compress: false # 开发环境不压缩

# -------------------------------------------------------
# 5.2 JWT 配置（本地认证降级方案）
# -------------------------------------------------------
# 说明：当 IAM 不可用时的降级认证方式
jwt:
  secret_key: "qs-collection-server-jwt-secret-key-2024"
  token_duration: 168  # 7 天 (24*7小时)