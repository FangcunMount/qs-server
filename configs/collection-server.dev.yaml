# Collection Server 配置文件

# 服务器配置
insecure:
  bind-address: "127.0.0.1"
  bind-port: 18083

# 安全服务配置（HTTPS REST API - 供浏览器访问）
secure:
  bind-address: "127.0.0.1"
  bind-port: 18443
  tls:
    # 使用 Web 证书（用于浏览器 HTTPS 访问）
    cert-file: "/data/infra/ssl/web/qs-collection.crt"
    private-key-file: "/data/infra/ssl/web/qs-collection.key"

# gRPC 客户端配置（连接 apiserver - mTLS 测试模式）
grpc_client:
  endpoint: "127.0.0.1:9090"
  timeout: 30
  insecure: false  # 启用 TLS 进行 mTLS 测试
  
  # mTLS 客户端配置（使用 infra 项目生成的证书）
  tls-cert-file: "/data/infra/ssl/grpc/server/qs-collection.crt"
  tls-key-file: "/data/infra/ssl/grpc/server/qs-collection.key"
  tls-ca-file: "/data/infra/ssl/grpc/ca/ca-chain.crt"
  tls-server-name: "qs-apiserver.svc"  # 必须与服务端证书的 CN 匹配

# JWT 配置（已废弃，使用 IAM 统一认证）
jwt:
  secret_key: "qs-collection-server-jwt-secret-key-2024"
  token_duration: 168  # 7 天 (24*7小时)

# IAM 集成配置
iam:
  enabled: false  # 开发环境默认禁用，需要时启用
  grpc-enabled: true
  jwks-enabled: true
  
  # gRPC 客户端配置
  grpc:
    address: "iam-apiserver:9080"  # IAM gRPC 服务地址（Docker 容器名）
    timeout: 30s
    retry-max: 3
    
    # mTLS 配置（开发环境示例，需要时启用）
    tls:
      enabled: false              # 开发环境禁用 mTLS（需要时改为 true）
      ca-file: "/data/infra/ssl/grpc/ca/ca-chain.crt"       # CA 证书链（infra 统一管理）
      cert-file: "/data/infra/ssl/grpc/server/qs.crt"       # QS 客户端证书
      key-file: "/data/infra/ssl/grpc/server/qs.key"        # QS 客户端私钥
  
  # JWT 验证配置
  jwt:
    issuer: "https://iam-apiserver:9080"
    audience: ["collection-api", "qs-api"]
    algorithms: ["RS256", "ES256"]
    clock-skew: 30s
    required-claims: ["sub", "exp"]
  
  # JWKS 配置
  jwks:
    url: "http://iam-apiserver:9080/.well-known/jwks.json"
    refresh-interval: 1h
    cache-ttl: 24h
    fetch-strategies: ["grpc", "http", "cache"]  # 优先使用 gRPC
  
  # 用户信息缓存
  user-cache:
    enabled: true
    ttl: 5m
    max-size: 10000
  
  # 监护关系缓存
  guardianship-cache:
    enabled: true
    ttl: 10m
    max-size: 50000

# 日志配置
log:
  name: "collection-server"
  level: "debug" # 日志级别：debug, info, warn, error, fatal, panic
  format: "console" # 日志格式：console, json
  enable-color: true # 是否开启颜色
  disable-caller: false # 是否禁用调用者
  disable-stacktrace: false # 是否禁用堆栈跟踪
  development: false # 是否为开发环境
  output-paths: ["/data/logs/qs/collection-server.log", "stdout"] # 输出路径
  error-output-paths: ["/data/logs/qs/collection-server-error.log", "stderr"] # 错误输出路径
  max-size: 100 # 单个日志文件最大大小（MB）
  max-age: 30 # 保留旧日志文件的最大天数
  max-backups: 10 # 保留旧日志文件的最大个数
  compress: true # 是否压缩旧日志文件

# Redis 配置（双实例架构）
redis:
  # Cache Redis - 用于缓存、会话、限流等临时数据
  cache:
    host: "127.0.0.1"
    port: 6379
    username: "app"  # Redis 6.0+ ACL 用户名
    password: "dev_app_123"
    database: 0  # 缓存使用 DB 0
    max-idle: 50
    max-active: 100
    timeout: 5
    enable-cluster: false
    use-ssl: false
    enable-logging: true  # 开启 Redis 命令日志（用于调试，生产环境建议关闭）
  
  # Store Redis - 用于持久化存储、队列、发布订阅等
  store:
    host: "127.0.0.1"
    port: 6380  # 使用 Store Redis 实例（端口 6380）
    username: "app"  # Redis 6.0+ ACL 用户名
    password: "dev_app_123"
    database: 0  # Store Redis 使用 DB 0
    max-idle: 50
    max-active: 100
    timeout: 5
    enable-cluster: false
    use-ssl: false
    enable-logging: true  # 开启 Redis 命令日志（用于调试，生产环境建议关闭）