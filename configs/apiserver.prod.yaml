# qs-apiserver 生产环境配置

# 应用配置
app:
  name: "qs-apiserver"
  version: "1.0.0"
  mode: "production"  # development, production

# RESTful 服务配置
server:
    mode: release # 生产环境默认 release
    healthz: true
    middlewares: recovery,enhanced_logger,secure,nocache,cors
    max-ping-count: 3

# gRPC 配置（生产环境 - 安全模式）
grpc:
  bind-address: "0.0.0.0"
  bind-port: 9090
  
  # 生产环境必须启用 TLS
  insecure: false
  # 证书路径（宿主机 /data/infra/ssl/grpc → 容器 /etc/qs-server/ssl/grpc）
  tls-cert-file: "/etc/qs-server/ssl/grpc/server/qs-apiserver.crt"
  tls-key-file: "/etc/qs-server/ssl/grpc/server/qs-apiserver.key"
  
  # 消息大小限制
  max-msg-size: 4194304  # 4MB
  
  # 连接管理
  max-connection-age: 120s
  max-connection-age-grace: 20s
  
  # mTLS 双向认证配置（用于内部服务间通信）
  mtls:
    enabled: true
    ca-file: "/etc/qs-server/ssl/grpc/ca/ca-chain.crt"  # CA 证书链
    require-client-cert: true
    
    # 证书白名单：只允许这些服务访问
    allowed-cns:
      - "collection-server"
      - "evaluation-server"
      - "admin-tool"
    
    # 组织单元白名单
    allowed-ous:
      - "qs-platform"
      - "qs-ops"
    
    # TLS 版本控制
    min-tls-version: "1.2"
  
  # 认证配置（如需对外暴露 gRPC API 时启用）
  auth:
    enabled: false  # 内部服务通信无需 JWT，mTLS 已提供身份验证
  
  # ACL 配置（未来扩展）
  acl:
    enabled: false
  
  # 审计配置（未来扩展）
  audit:
    enabled: false
  
  # 功能开关
  enable-reflection: false    # 生产环境禁用反射（安全考虑）
  enable-health-check: true   # 启用健康检查

# 不安全服务配置（HTTP）
insecure:
  bind-address: "0.0.0.0"
  bind-port: 8080

# 安全服务配置（HTTPS REST API - 供浏览器访问）
secure:
  bind-address: "0.0.0.0"
  bind-port: 8443
  tls:
    # Web 证书（容器内路径，由 docker-compose 从宿主机挂载）
    cert-file: "/etc/qs-server/ssl/certs/yangshujie.com.crt"
    private-key-file: "/etc/qs-server/ssl/private/yangshujie.com.key"

# MySQL 数据库配置
mysql:
  host: "127.0.0.1:3306"
  username: "app_user"
  password: ""
  database: "qs"
  max-idle-connections: 20
  max-open-connections: 200
  max-connection-life-time: 1h
  log-level: 2 # 生产降低日志级别

# 数据库迁移配置
migration:
  enabled: true   # 生产环境建议开启
  autoseed: false
  database: "qs"

# Redis 配置（双实例架构）
redis:
  cache:
    host: "127.0.0.1"
    port: 6379
    username: ""
    password: ""
    database: 0
    max-idle: 50
    max-active: 100
    timeout: 5
    enable-cluster: false
    use-ssl: false
    enable-logging: false
  store:
    host: "127.0.0.1"
    port: 6380
    username: ""
    password: ""
    database: 1
    max-idle: 50
    max-active: 100
    timeout: 5
    enable-cluster: false
    use-ssl: false
    enable-logging: false

# MongoDB 数据库配置
# 支持两种方式：
# 1. 分离参数（推荐，便于通过环境变量覆盖）
# 2. 直接 URL（如果设置了 url，则忽略分离参数）
mongodb:
  host: "127.0.0.1:27017"
  username: "app_user"
  password: ""
  database: "qs"
  # url: ""  # 可选，如果设置则优先使用
  use-ssl: false
  ssl-insecure-skip-verify: false
  ssl-allow-invalid-hostnames: false
  ssl-ca-file: ""
  ssl-pem-keyfile: ""

# IAM 集成配置
iam:
  # 功能开关（灰度发布控制）
  enabled: true                   # 是否启用 IAM 集成（生产环境开启）
  grpc-enabled: true              # 是否启用 gRPC 调用
  jwks-enabled: true              # 是否启用 JWKS 本地验签
  
  # 可观测性配置
  enable-tracing: true            # 启用 OpenTelemetry 链路追踪
  enable-metrics: true            # 启用 Prometheus 指标
  
  # gRPC 连接配置
  grpc:
    address: "iam-apiserver:9090"  # IAM gRPC 服务地址（Docker 容器，端口 9090）
    timeout: 5s                   # 请求超时时间
    retry-max: 3                  # 最大重试次数
    
    # mTLS 证书配置（宿主机 /data/infra/ssl/grpc → 容器 /etc/qs-server/ssl）
    tls:
      enabled: true               # 启用 mTLS 双向认证（匹配 IAM 9090 端口）
      ca-file: "/etc/qs-server/ssl/grpc/ca/ca-chain.crt"           # CA 证书链
      cert-file: "/etc/qs-server/ssl/grpc/server/qs-apiserver.crt" # QS 客户端证书
      key-file: "/etc/qs-server/ssl/grpc/server/qs-apiserver.key"  # QS 客户端私钥
  
  # JWT 验证配置
  jwt:
    issuer: "https://iam-apiserver:9444"              # Token 签发者（HTTPS 端口 9444）
    audience: ["qs"]                                   # 允许的受众（QS 服务标识）
    algorithms: ["RS256", "ES256"]                     # 支持的签名算法
    clock-skew: 60s                                    # 时钟偏移容忍度
    required-claims: ["user_id", "tenant_id"]          # 必需的 Claims
  
  # JWKS 配置（JWT 公钥管理）
  jwks:
    url: "https://iam.yangshujie.com/api/v1/.well-known/jwks.json"  # JWKS HTTP 端点
    grpc-endpoint: "iam-apiserver:9090"                    # gRPC 降级端点（HTTP 失败时使用，端口 9090）
    refresh-interval: 5m                               # 定时刷新间隔
    cache-ttl: 30m                                     # 缓存有效期
    fetch-strategies: ["http", "grpc", "cache"]        # 降级策略：HTTP → gRPC → 缓存
  
  # 服务间认证配置（可选，用于 QS 调用其他服务）
  service-auth:
    service-id: "qs-service"                           # QS 服务 ID
    target-audience: ["iam-service"]                   # 目标服务列表
    token-ttl: 1h                                      # 服务 Token 有效期
    refresh-before: 5m                                 # 提前刷新时间
  
  # 用户信息缓存配置
  user-cache:
    enabled: true                                      # 启用用户信息缓存
    ttl: 5m                                            # 缓存时长
    max-size: 10000                                    # 最大缓存条目数
  
  # 监护关系缓存配置
  guardianship-cache:
    enabled: true                                      # 启用监护关系缓存
    ttl: 10m                                           # 缓存时长（监护关系变化较少）
    max-size: 50000                                    # 最大缓存条目数

# 日志配置（生产环境）
log:
  disable-caller: true
  disable-stacktrace: true
  level: info
  format: json
  enable-color: false
  development: false
  name: "qs-apiserver"
  max-size: 100
  max-age: 30
  max-backups: 10
  compress: true
  enable-time-rotation: true
  time-rotation-format: "2006-01-02"
  enable-level-output: true
  level-output-mode: "duplicate"
  level-output-paths:
    all:
      - stdout
      - /data/logs/qs/qs-apiserver.log
    warn:
      - /data/logs/qs/qs-apiserver-warn.log
    error:
      - stderr
      - /data/logs/qs/qs-apiserver-error.log

# JWT 配置
jwt:
  realm: "qs jwt"
  key: "change-me"
  timeout: "24h"
  max-refresh: "168h"
