# ç‹¬ç«‹å¯åŠ¨æœåŠ¡æŒ‡å—

æœ¬æŒ‡å—è¯¦ç»†ä»‹ç»å¦‚ä½•åœ¨é—®å·é‡è¡¨ç³»ç»Ÿä¸­ç‹¬ç«‹å¯åŠ¨å•ä¸ªæœåŠ¡ï¼Œé€‚ç”¨äºå¼€å‘ã€æµ‹è¯•å’Œè°ƒè¯•åœºæ™¯ã€‚

## ğŸ“‹ ç›®å½•

- [ç³»ç»Ÿæ¶æ„æ¦‚è§ˆ](#ç³»ç»Ÿæ¶æ„æ¦‚è§ˆ)
- [æœåŠ¡ç«¯å£é…ç½®](#æœåŠ¡ç«¯å£é…ç½®)
- [ç‹¬ç«‹å¯åŠ¨æ–¹æ³•](#ç‹¬ç«‹å¯åŠ¨æ–¹æ³•)
- [æœåŠ¡ç®¡ç†å‘½ä»¤](#æœåŠ¡ç®¡ç†å‘½ä»¤)
- [å¼€å‘å·¥ä½œæµ](#å¼€å‘å·¥ä½œæµ)
- [æ•…éšœæ’é™¤](#æ•…éšœæ’é™¤)
- [æœ€ä½³å®è·µ](#æœ€ä½³å®è·µ)

## ğŸ—ï¸ ç³»ç»Ÿæ¶æ„æ¦‚è§ˆ

é—®å·é‡è¡¨ç³»ç»ŸåŒ…å«ä¸‰ä¸ªä¸»è¦æœåŠ¡ï¼š

| æœåŠ¡åç§° | æè¿° | ç«¯å£ | é…ç½®æ–‡ä»¶ |
|---------|------|------|----------|
| **API æœåŠ¡å™¨** (qs-apiserver) | æ ¸å¿ƒä¸šåŠ¡é€»è¾‘ï¼Œé—®å·ç®¡ç†ï¼Œç”¨æˆ·ç®¡ç† | 9080 | `configs/apiserver.yaml` |
| **æ”¶é›†æœåŠ¡å™¨** (collection-server) | ç­”å·æ”¶é›†ï¼Œæ•°æ®éªŒè¯ | 9081 | `configs/collection-server.yaml` |
| **è¯„ä¼°æœåŠ¡å™¨** (evaluation-server) | é‡è¡¨è¯„ä¼°ï¼ŒæŠ¥å‘Šç”Ÿæˆ | 9082 | `configs/evaluation-server.yaml` |

## ğŸ”Œ æœåŠ¡ç«¯å£é…ç½®

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   API æœåŠ¡å™¨     â”‚    â”‚   æ”¶é›†æœåŠ¡å™¨     â”‚    â”‚   è¯„ä¼°æœåŠ¡å™¨     â”‚
â”‚   Port: 9080    â”‚    â”‚   Port: 9081    â”‚    â”‚   Port: 9082    â”‚
â”‚                 â”‚    â”‚                 â”‚    â”‚                 â”‚
â”‚ é—®å·ç®¡ç†         â”‚    â”‚ ç­”å·æ”¶é›†         â”‚    â”‚ é‡è¡¨è¯„ä¼°         â”‚
â”‚ ç”¨æˆ·ç®¡ç†         â”‚    â”‚ æ•°æ®éªŒè¯         â”‚    â”‚ æŠ¥å‘Šç”Ÿæˆ         â”‚
â”‚ æƒé™æ§åˆ¶         â”‚    â”‚ æ¶ˆæ¯å‘å¸ƒ         â”‚    â”‚ æ¶ˆæ¯æ¶ˆè´¹         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## ğŸš€ ç‹¬ç«‹å¯åŠ¨æ–¹æ³•

### 1. å¼€å‘æ¨¡å¼ï¼ˆçƒ­æ›´æ–°ï¼‰- æ¨è

**ç‰¹ç‚¹**ï¼š
- æ”¯æŒä»£ç çƒ­æ›´æ–°
- è‡ªåŠ¨é‡æ–°ç¼–è¯‘å’Œé‡å¯
- é€‚åˆå¼€å‘è°ƒè¯•

```bash
# ç‹¬ç«‹å¯åŠ¨ API æœåŠ¡å™¨ï¼ˆæ”¯æŒçƒ­æ›´æ–°ï¼‰
make dev-apiserver

# ç‹¬ç«‹å¯åŠ¨æ”¶é›†æœåŠ¡å™¨ï¼ˆæ”¯æŒçƒ­æ›´æ–°ï¼‰
make dev-collection

# ç‹¬ç«‹å¯åŠ¨è¯„ä¼°æœåŠ¡å™¨ï¼ˆæ”¯æŒçƒ­æ›´æ–°ï¼‰
make dev-evaluation
```

**è¾“å‡ºç¤ºä¾‹**ï¼š
```
ğŸš€ å¯åŠ¨ apiserver å¼€å‘ç¯å¢ƒ...
  __    _   ___  
 / /\  | | | |_) 
/_/--\ |_| |_| \_ , built with Go 

watching .
watching cmd
watching cmd/qs-apiserver
...
building...
running...
```

### 2. ç”Ÿäº§æ¨¡å¼ï¼ˆåå°è¿è¡Œï¼‰

**ç‰¹ç‚¹**ï¼š
- åå°å®ˆæŠ¤è¿›ç¨‹è¿è¡Œ
- ç”Ÿæˆ PID æ–‡ä»¶ç®¡ç†
- é€‚åˆç”Ÿäº§ç¯å¢ƒ

```bash
# ç‹¬ç«‹å¯åŠ¨ API æœåŠ¡å™¨
make run-apiserver

# ç‹¬ç«‹å¯åŠ¨æ”¶é›†æœåŠ¡å™¨
make run-collection

# ç‹¬ç«‹å¯åŠ¨è¯„ä¼°æœåŠ¡å™¨
make run-evaluation
```

**è¾“å‡ºç¤ºä¾‹**ï¼š
```
ğŸš€ å¯åŠ¨ apiserver...
âœ… apiserver å·²å¯åŠ¨ (PID: 12345)
```

### 3. ç›´æ¥å‘½ä»¤è¡Œå¯åŠ¨

**ç‰¹ç‚¹**ï¼š
- å‰å°è¿è¡Œï¼Œä¾¿äºè°ƒè¯•
- å¯ä»¥ç›´æ¥çœ‹åˆ°è¾“å‡ºæ—¥å¿—
- é€‚åˆä¸´æ—¶æµ‹è¯•

```bash
# å…ˆæ„å»ºæœåŠ¡
make build-apiserver
make build-collection
make build-evaluation

# ç„¶åç‹¬ç«‹è¿è¡Œ
./qs-apiserver --config=configs/apiserver.yaml
./collection-server --config=configs/collection-server.yaml
./evaluation-server --config=configs/evaluation-server.yaml
```

### 4. ä½¿ç”¨ Air ç›´æ¥å¯åŠ¨

**ç‰¹ç‚¹**ï¼š
- ç›´æ¥ä½¿ç”¨ Air å·¥å…·
- æ›´ç²¾ç»†çš„æ§åˆ¶
- é€‚åˆé«˜çº§ç”¨æˆ·

```bash
# ç‹¬ç«‹å¯åŠ¨ API æœåŠ¡å™¨ï¼ˆçƒ­æ›´æ–°ï¼‰
air -c .air-apiserver.toml

# ç‹¬ç«‹å¯åŠ¨æ”¶é›†æœåŠ¡å™¨ï¼ˆçƒ­æ›´æ–°ï¼‰
air -c .air-collection.toml

# ç‹¬ç«‹å¯åŠ¨è¯„ä¼°æœåŠ¡å™¨ï¼ˆçƒ­æ›´æ–°ï¼‰
air -c .air-evaluation.toml
```

## ğŸ›ï¸ æœåŠ¡ç®¡ç†å‘½ä»¤

### æŸ¥çœ‹æœåŠ¡çŠ¶æ€

```bash
# æŸ¥çœ‹æ‰€æœ‰æœåŠ¡çŠ¶æ€
make status-all

# æŸ¥çœ‹å•ä¸ªæœåŠ¡çŠ¶æ€
make status-apiserver
make status-collection
make status-evaluation
```

**è¾“å‡ºç¤ºä¾‹**ï¼š
```
ğŸ“Š æœåŠ¡çŠ¶æ€:
============
âœ… apiserver      - è¿è¡Œä¸­ (PID: 12345, Port: 9080)
âœ… collection-server - è¿è¡Œä¸­ (PID: 12346, Port: 9081)
âšª evaluation-server - æœªè¿è¡Œ
```

### åœæ­¢æœåŠ¡

```bash
# åœæ­¢å•ä¸ªæœåŠ¡
make stop-apiserver
make stop-collection
make stop-evaluation

# åœæ­¢æ‰€æœ‰æœåŠ¡
make stop-all
```

### é‡å¯æœåŠ¡

```bash
# é‡å¯å•ä¸ªæœåŠ¡
make restart-apiserver
make restart-collection
make restart-evaluation

# é‡å¯æ‰€æœ‰æœåŠ¡
make restart-all
```

### æŸ¥çœ‹æ—¥å¿—

```bash
# æŸ¥çœ‹å•ä¸ªæœåŠ¡æ—¥å¿—ï¼ˆå®æ—¶ï¼‰
make logs-apiserver
make logs-collection
make logs-evaluation

# æŸ¥çœ‹æ‰€æœ‰æœåŠ¡æ—¥å¿—
make logs-all
```

**æ—¥å¿—æ–‡ä»¶ä½ç½®**ï¼š
- API æœåŠ¡å™¨ï¼š`logs/apiserver.log`
- æ”¶é›†æœåŠ¡å™¨ï¼š`logs/collection-server.log`
- è¯„ä¼°æœåŠ¡å™¨ï¼š`logs/evaluation-server.log`

### å¥åº·æ£€æŸ¥

```bash
# æ£€æŸ¥æ‰€æœ‰æœåŠ¡å¥åº·çŠ¶æ€
make health-check
```

**è¾“å‡ºç¤ºä¾‹**ï¼š
```
ğŸ” å¥åº·æ£€æŸ¥:
============
apiserver:        {"status":"ok","timestamp":"2024-01-01T12:00:00Z"}
collection-server: {"status":"ok","timestamp":"2024-01-01T12:00:00Z"}
evaluation-server: âŒ æ— å“åº”
```

## ğŸ”„ å¼€å‘å·¥ä½œæµ

### åœºæ™¯1ï¼šå¼€å‘æ–°åŠŸèƒ½

```bash
# 1. å¯åŠ¨ç›¸å…³æœåŠ¡ï¼ˆå¼€å‘æ¨¡å¼ï¼‰
make dev-apiserver    # å¦‚æœä¿®æ”¹ API æœåŠ¡å™¨
make dev-collection   # å¦‚æœä¿®æ”¹æ”¶é›†æœåŠ¡å™¨
make dev-evaluation   # å¦‚æœä¿®æ”¹è¯„ä¼°æœåŠ¡å™¨

# 2. ä¿®æ”¹ä»£ç ï¼ˆAir ä¼šè‡ªåŠ¨é‡æ–°ç¼–è¯‘å’Œé‡å¯ï¼‰

# 3. æµ‹è¯•åŠŸèƒ½
make health-check

# 4. åœæ­¢æœåŠ¡ï¼ˆCtrl+C æˆ–åœ¨å¦ä¸€ä¸ªç»ˆç«¯ï¼‰
make dev-stop
```

### åœºæ™¯2ï¼šè°ƒè¯•é—®é¢˜

```bash
# 1. å¯åŠ¨é—®é¢˜æœåŠ¡ï¼ˆç”Ÿäº§æ¨¡å¼ï¼‰
make run-apiserver

# 2. æŸ¥çœ‹æ—¥å¿—
make logs-apiserver

# 3. æŸ¥çœ‹çŠ¶æ€
make status-apiserver

# 4. é‡å¯æœåŠ¡
make restart-apiserver
```

### åœºæ™¯3ï¼šé›†æˆæµ‹è¯•

```bash
# 1. å¯åŠ¨æ‰€æœ‰æœåŠ¡
make run-all

# 2. è¿è¡Œæµ‹è¯•
make test-submit
make test-message-queue

# 3. æŸ¥çœ‹çŠ¶æ€
make status-all

# 4. åœæ­¢æ‰€æœ‰æœåŠ¡
make stop-all
```

## ğŸ› ï¸ æ•…éšœæ’é™¤

### å¸¸è§é—®é¢˜

#### 1. ç«¯å£è¢«å ç”¨

**é”™è¯¯ä¿¡æ¯**ï¼š
```
bind: address already in use
```

**è§£å†³æ–¹æ¡ˆ**ï¼š
```bash
# æŸ¥çœ‹ç«¯å£å ç”¨
lsof -i :9080
lsof -i :9081
lsof -i :9082

# åœæ­¢å ç”¨ç«¯å£çš„è¿›ç¨‹
kill -9 <PID>

# æˆ–è€…åœæ­¢æ‰€æœ‰æœåŠ¡
make stop-all
```

#### 2. é…ç½®æ–‡ä»¶æ‰¾ä¸åˆ°

**é”™è¯¯ä¿¡æ¯**ï¼š
```
failed to load config: open configs/apiserver.yaml: no such file or directory
```

**è§£å†³æ–¹æ¡ˆ**ï¼š
```bash
# æ£€æŸ¥é…ç½®æ–‡ä»¶æ˜¯å¦å­˜åœ¨
ls -la configs/

# å¦‚æœä¸å­˜åœ¨ï¼Œä»æ¨¡æ¿åˆ›å»º
cp configs/apiserver.yaml.example configs/apiserver.yaml
```

#### 3. æ•°æ®åº“è¿æ¥å¤±è´¥

**é”™è¯¯ä¿¡æ¯**ï¼š
```
failed to connect to database
```

**è§£å†³æ–¹æ¡ˆ**ï¼š
```bash
# å¯åŠ¨æ•°æ®åº“æœåŠ¡
make db-start

# æ£€æŸ¥æ•°æ®åº“çŠ¶æ€
make db-status

# æŸ¥çœ‹æ•°æ®åº“è¿æ¥ä¿¡æ¯
make db-info
```

#### 4. æ¶ˆæ¯é˜Ÿåˆ—è¿æ¥å¤±è´¥

**é”™è¯¯ä¿¡æ¯**ï¼š
```
failed to connect to Redis
```

**è§£å†³æ–¹æ¡ˆ**ï¼š
```bash
# æ£€æŸ¥ Redis æ˜¯å¦è¿è¡Œ
redis-cli ping

# å¯åŠ¨ Redisï¼ˆå¦‚æœä½¿ç”¨ Dockerï¼‰
make db-start

# æ£€æŸ¥ Redis é…ç½®
cat configs/redis/redis.conf
```

### è°ƒè¯•æŠ€å·§

#### 1. æŸ¥çœ‹è¯¦ç»†æ—¥å¿—

```bash
# æŸ¥çœ‹æ„å»ºé”™è¯¯æ—¥å¿—
tail -f tmp/build-errors-apiserver.log
tail -f tmp/build-errors-collection.log
tail -f tmp/build-errors-evaluation.log
```

#### 2. ä½¿ç”¨è°ƒè¯•æ¨¡å¼

```bash
# è®¾ç½®è°ƒè¯•çº§åˆ«
export LOG_LEVEL=debug

# å¯åŠ¨æœåŠ¡
make dev-apiserver
```

#### 3. æ£€æŸ¥è¿›ç¨‹çŠ¶æ€

```bash
# æŸ¥çœ‹è¿›ç¨‹æ ‘
ps aux | grep -E "(apiserver|collection|evaluation)"

# æŸ¥çœ‹ PID æ–‡ä»¶
ls -la tmp/pids/
```

## ğŸ“š æœ€ä½³å®è·µ

### 1. å¼€å‘ç¯å¢ƒè®¾ç½®

```bash
# å®‰è£…å¿…è¦å·¥å…·
make install-air
make deps

# åˆ›å»ºå¿…è¦ç›®å½•
make create-dirs

# å¯åŠ¨æ•°æ®åº“
make db-start
```

### 2. æœåŠ¡å¯åŠ¨é¡ºåº

**æ¨èé¡ºåº**ï¼š
1. å…ˆå¯åŠ¨ API æœåŠ¡å™¨ï¼ˆæ ¸å¿ƒæœåŠ¡ï¼‰
2. å†å¯åŠ¨æ”¶é›†æœåŠ¡å™¨ï¼ˆä¾èµ– API æœåŠ¡å™¨ï¼‰
3. æœ€åå¯åŠ¨è¯„ä¼°æœåŠ¡å™¨ï¼ˆæ¶ˆè´¹æ¶ˆæ¯ï¼‰

```bash
make run-apiserver
sleep 2
make run-collection
sleep 2
make run-evaluation
```

### 3. èµ„æºç›‘æ§

```bash
# å®šæœŸæ£€æŸ¥æœåŠ¡çŠ¶æ€
watch -n 5 "make status-all"

# ç›‘æ§ç³»ç»Ÿèµ„æº
top -p $(cat tmp/pids/*.pid | tr '\n' ',' | sed 's/,$//')
```

### 4. æ—¥å¿—ç®¡ç†

```bash
# å®šæœŸæ¸…ç†æ—¥å¿—
find logs/ -name "*.log" -mtime +7 -delete

# æ—¥å¿—è½®è½¬
logrotate -f /etc/logrotate.d/questionnaire-scale
```

### 5. é…ç½®ç®¡ç†

```bash
# å¤‡ä»½é…ç½®æ–‡ä»¶
cp configs/apiserver.yaml configs/apiserver.yaml.bak

# ä½¿ç”¨ç¯å¢ƒå˜é‡è¦†ç›–é…ç½®
export DB_HOST=localhost
export DB_PORT=3306
```

## ğŸ”— ç›¸å…³æ–‡æ¡£

- [ç³»ç»Ÿæ¶æ„è®¾è®¡](./01-æ¶æ„è®¾è®¡æ€»è§ˆ.md)
- [åŸºç¡€åº”ç”¨ä¸HTTPæœåŠ¡åˆ†ç¦»è®¾è®¡](./02-åŸºç¡€åº”ç”¨ä¸HTTPæœåŠ¡åˆ†ç¦»è®¾è®¡.md)
- [åŸºäºå…­è¾¹å½¢æ¶æ„çš„æ¨¡å—åŒ–è®¾è®¡](./03-åŸºäºå…­è¾¹å½¢æ¶æ„çš„æ¨¡å—åŒ–è®¾è®¡.md)
- [å‘å¸ƒè®¢é˜…æ¨¡å‹å®ç°](../pkg/pubsub/README.md)
- [å†…éƒ¨æ¶ˆæ¯åŒ…](../internal/pkg/pubsub/README.md)

## ğŸ’¡ æç¤º

- ä½¿ç”¨ `make help` æŸ¥çœ‹æ‰€æœ‰å¯ç”¨å‘½ä»¤
- å¼€å‘æ—¶ä¼˜å…ˆä½¿ç”¨ `make dev-*` å‘½ä»¤
- ç”Ÿäº§ç¯å¢ƒä½¿ç”¨ `make run-*` å‘½ä»¤
- é‡åˆ°é—®é¢˜æ—¶å…ˆæŸ¥çœ‹æ—¥å¿— `make logs-*`
- å®šæœŸæ£€æŸ¥æœåŠ¡çŠ¶æ€ `make status-all`

---

**æ›´æ–°æ—¶é—´**ï¼š2024-01-01  
**ç‰ˆæœ¬**ï¼šv1.0.0  
**ç»´æŠ¤è€…**ï¼šå¼€å‘å›¢é˜Ÿ 