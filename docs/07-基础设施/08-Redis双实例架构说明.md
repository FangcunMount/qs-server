# Redis 缓存架构说明（单实例现状）

> **最后更新**：2025-01-XX  
> ⚠️ 2024 Q1 起，工程已移除 redis-store，当前仅保留单实例 Redis（原 redis-cache）。若未来需要重新引入多实例，请基于本说明和历史记录重新评估。

## 1. 现状

- **实例**：单个 Redis，用于缓存/短期数据（量表、问卷、统计预聚合、幂等标记、限流等）。
- **TTL 必须配置**：所有缓存键需带 TTL（建议加抖动），避免无界膨胀。
- **数据恢复**：Redis 数据可从 MySQL/Mongo 重建；Redis 异常时应具备降级/熔断策略。
- **队列/发布订阅**：使用 MQ（NSQ/RabbitMQ），不再依赖 Redis。

## 2. 配置入口

- 配置文件：`configs/*server.*.yaml` 中的 `redis` 单实例配置（支持 addrs、超时、池参数等）。
- 代码路径：`internal/*/database.go` 读取 `RedisOptions` 并初始化连接。

## 3. 使用约定

- 所有缓存装饰器、幂等标记、统计预聚合均使用当前 Redis 实例。
- 需要强一致/持久化的数据请直接落库（MySQL/Mongo），不要放 Redis。
- 队列/发布订阅/分布式锁等如需高可靠，优先选 MQ/数据库或专用中间件。

## 4. 运维关注

- 监控：命中率、内存使用、过期键、淘汰次数、慢查询。
- 容灾：准备降级方案（本地缓存/直接查库），确保服务在 Redis 不可用时可退化运行。

## 5. 历史（双实例）说明

历史的 redis-cache / redis-store 角色划分、数据分布与配置示例已移除。需要恢复双实例时，请：
1) 明确存储/队列/持久化需求与数据模型；
2) 重新设计实例规划、持久化/备份/复制策略与告警；
3) 更新代码配置入口（恢复 store 实例注入）并增加验证/回归测试。
