# 领域事件清单与规范

## 概述

本文档定义了 qs-server 项目中所有领域事件的规范、类型清单和使用指南。

> **注意**: 事件系统已升级为配置驱动模式，详见 [04-配置驱动的事件系统.md](./04-配置驱动的事件系统.md)。
> 事件配置文件位于 `configs/events.yaml`。

### 设计原则

1. **事件即事实**：领域事件表达"已发生的业务事实"，是不可变的
2. **统一命名**：使用 `{aggregate}.{action}` 格式，如 `assessment.submitted`
3. **领域内聚**：事件结构体定义在各领域包的 `events.go` 中
4. **配置驱动**：事件类型、Topic 映射、处理器配置统一在 `configs/events.yaml` 中定义

## 事件类型清单

### Survey 领域

| 事件类型 | 常量 | 描述 | 消费者 |
|---------|------|------|--------|
| `questionnaire.published` | `EventTypeQuestionnairePublished` | 问卷已发布 | collection-server, 搜索服务 |
| `questionnaire.unpublished` | `EventTypeQuestionnaireUnpublished` | 问卷已下架 | collection-server, 搜索服务 |
| `questionnaire.archived` | `EventTypeQuestionnaireArchived` | 问卷已归档 | collection-server |
| `answersheet.submitted` | `EventTypeAnswerSheetSubmitted` | 答卷已提交 | qs-worker, 通知服务 |
| `answersheet.saved` | `EventTypeAnswerSheetSaved` | 答卷已保存(草稿) | - |

### Scale 领域

| 事件类型 | 常量 | 描述 | 消费者 |
|---------|------|------|--------|
| `scale.published` | `EventTypeScalePublished` | 量表已发布 | collection-server, qs-worker |
| `scale.unpublished` | `EventTypeScaleUnpublished` | 量表已下架 | collection-server, qs-worker |
| `scale.updated` | `EventTypeScaleUpdated` | 量表已更新 | qs-worker |
| `scale.archived` | `EventTypeScaleArchived` | 量表已归档 | collection-server, qs-worker |

### Evaluation 领域

| 事件类型 | 常量 | 描述 | 消费者 |
|---------|------|------|--------|
| `assessment.submitted` | `EventTypeAssessmentSubmitted` | 测评已提交 | qs-worker, 通知服务 |
| `assessment.interpreted` | `EventTypeAssessmentInterpreted` | 测评已解读 | 通知服务, 预警服务, 统计服务 |
| `assessment.failed` | `EventTypeAssessmentFailed` | 测评失败 | 日志服务, 监控服务 |
| `report.generated` | `EventTypeReportGenerated` | 报告已生成 | 通知服务, 预警服务 |
| `report.exported` | `EventTypeReportExported` | 报告已导出 | 统计服务 |

### Actor 领域

| 事件类型 | 常量 | 描述 | 消费者 |
|---------|------|------|--------|
| `testee.created` | `EventTypeTesteeCreated` | 受试者已创建 | - |
| `testee.updated` | `EventTypeTesteeUpdated` | 受试者已更新 | - |
| `staff.created` | `EventTypeStaffCreated` | 员工已创建 | - |
| `staff.updated` | `EventTypeStaffUpdated` | 员工已更新 | - |

## 代码结构

```
configs/
└── events.yaml                    # 事件配置文件（Topic、事件映射、处理器）

pkg/event/
├── event.go                       # DomainEvent 接口和 BaseEvent 基类
├── publisher.go                   # EventPublisher 接口和 NopEventPublisher
└── types.go                       # 事件来源常量（SourceAPIServer 等）

internal/apiserver/domain/
├── survey/
│   ├── questionnaire/events.go    # 问卷事件结构体
│   └── answersheet/events.go      # 答卷事件结构体
├── scale/events.go                # 量表事件结构体
└── evaluation/
    ├── assessment/events.go       # 测评事件结构体
    └── report/events.go           # 报告事件结构体

internal/pkg/
├── eventbus/
│   └── publisher.go               # 事件发布器实现（MQ/Logging/Nop）
└── eventconfig/
    ├── config.go                  # 事件配置加载和解析
    ├── registry.go                # 全局配置注册表
    ├── publisher.go               # 配置驱动的路由发布器
    └── subscriber.go              # 配置驱动的订阅器

internal/worker/bootstrap/
├── bootstrap.go                   # Worker 启动引导
└── handler_factory.go             # 处理器工厂
```

### 事件处理流程

```
发布端:
领域层创建事件 → RoutingPublisher 查询配置 → 发布到配置的 Topic

订阅端:
Worker 启动 → 加载 events.yaml → 注册处理器 → 订阅 Topic → 分发事件
```

## 使用指南

### 1. 定义领域事件

在领域包中创建事件结构体，嵌入 `event.BaseEvent`：

```go
package assessment

import (
    "github.com/FangcunMount/qs-server/pkg/event"
)

type AssessmentSubmittedEvent struct {
    event.BaseEvent
    
    AssessmentID string    `json:"assessment_id"`
    TesteeID     uint64    `json:"testee_id"`
    SubmittedAt  time.Time `json:"submitted_at"`
}

func NewAssessmentSubmittedEvent(assessmentID string, testeeID uint64, submittedAt time.Time) *AssessmentSubmittedEvent {
    return &AssessmentSubmittedEvent{
        BaseEvent:    event.NewBaseEvent(event.EventTypeAssessmentSubmitted, event.AggregateTypeAssessment, assessmentID),
        AssessmentID: assessmentID,
        TesteeID:     testeeID,
        SubmittedAt:  submittedAt,
    }
}
```

### 2. 在应用服务中发布事件

```go
type SubmissionService struct {
    repo           Repository
    eventPublisher event.EventPublisher
}

func (s *SubmissionService) Submit(ctx context.Context, cmd SubmitCommand) error {
    // 1. 业务逻辑处理
    assessment, err := s.createAssessment(cmd)
    if err != nil {
        return err
    }
    
    // 2. 持久化
    if err := s.repo.Save(ctx, assessment); err != nil {
        return err
    }
    
    // 3. 发布领域事件
    evt := NewAssessmentSubmittedEvent(
        assessment.ID().String(),
        assessment.TesteeID(),
        time.Now(),
    )
    if err := s.eventPublisher.Publish(ctx, evt); err != nil {
        // 事件发布失败策略：记录日志但不回滚事务
        log.Warnf("failed to publish event: %v", err)
    }
    
    return nil
}
```

### 3. 配置事件发布器

在容器配置中选择合适的发布器模式：

```go
// 生产环境：使用 MQ
container := NewContainerWithOptions(mysqlDB, mongoDB, redisCache, redisStore, ContainerOptions{
    MQPublisher:   mqPublisher,
    PublisherMode: messagingInfra.PublisherModeMQ,
})

// 开发环境：使用日志
container := NewContainerWithOptions(mysqlDB, mongoDB, redisCache, redisStore, ContainerOptions{
    PublisherMode: messagingInfra.PublisherModeLogging,
})

// 测试环境：使用空实现
container := NewContainerWithOptions(mysqlDB, mongoDB, redisCache, redisStore, ContainerOptions{
    PublisherMode: messagingInfra.PublisherModeNop,
})

// 或者根据环境自动选择
container := NewContainerWithOptions(mysqlDB, mongoDB, redisCache, redisStore, ContainerOptions{
    MQPublisher: mqPublisher,
    Env:         "prod", // 自动选择 MQ 模式
})
```

## 事件消费规范

### Worker 订阅示例

```go
func (w *Worker) subscribeEvents(ctx context.Context) error {
    // 订阅测评提交事件
    if err := w.subscriber.Subscribe(event.EventTypeAssessmentSubmitted, w.handleAssessmentSubmitted); err != nil {
        return err
    }
    
    // 订阅答卷提交事件
    if err := w.subscriber.Subscribe(event.EventTypeAnswerSheetSubmitted, w.handleAnswerSheetSubmitted); err != nil {
        return err
    }
    
    return w.subscriber.Start(ctx)
}

func (w *Worker) handleAssessmentSubmitted(ctx context.Context, evt event.DomainEvent) error {
    // 解析事件数据
    // 执行评估流程
    return nil
}
```

## 迁移说明

### 从 internal/pkg/pubsub 迁移

`internal/pkg/pubsub` 包已废弃，请按以下对照表迁移：

| 旧代码 | 新代码 |
|-------|--------|
| `pubsub.MessageTypeAnswersheetSubmitted` | `event.EventTypeAnswerSheetSubmitted` |
| `pubsub.SourceAPIServer` | `event.SourceAPIServer` |
| `pubsub.BaseMessage` | 使用 `event.DomainEvent` 接口 |
| `pubsub.AnswersheetSavedData` | `answersheet.AnswerSheetSubmittedEvent` |

## 变更历史

- 2024-12-12: 初始版本，统一事件模型
