# 配置驱动的事件系统

## 概述

本文档描述 qs-server 的配置驱动事件发布/订阅系统的设计与使用。

## 设计理念

```
┌─────────────────────────────────────────────────────────────────┐
│                   configs/events.yaml                           │
│              事件配置（单一来源）                                  │
│  - Topic 定义（名称、消费者组、并发数、重试策略）                   │
│  - 事件定义（类型 → Topic 映射、处理器、消费者列表）                │
│  - 处理器元信息                                                   │
└─────────────────────────────────────────────────────────────────┘
                              ↓
        ┌─────────────────────┴─────────────────────┐
        ↓                                           ↓
┌───────────────────┐                     ┌───────────────────┐
│   发布端 (API)    │                     │   订阅端 (Worker) │
│                   │                     │                   │
│ 领域层:           │                     │ 1. 加载配置       │
│   Event 结构体    │                     │ 2. 自动注册Topic  │
│   (业务数据)      │                     │ 3. 匹配处理器     │
│                   │                     │                   │
│ 基础设施层:       │                     │ 处理器工厂:       │
│   RoutingPublisher│                     │   根据配置中的    │
│   (根据配置路由)  │                     │   handler名称     │
│                   │                     │   查找实现        │
└───────────────────┘                     └───────────────────┘
```

## 核心组件

### 1. 事件配置文件 (`configs/events.yaml`)

```yaml
# Topic 定义
topics:
  assessment-lifecycle:
    name: "assessment.lifecycle"
    description: "测评生命周期事件"
    consumer:
      group: "qs-worker"
      concurrency: 4
      retry:
        max_attempts: 5
        initial_interval: 500ms

# 事件定义
events:
  assessment.submitted:
    topic: assessment-lifecycle      # 引用上面的 topic
    aggregate: Assessment
    domain: evaluation/assessment
    handler: assessment_submitted_handler  # 处理器名称
    consumers:
      - qs-worker
      - notification-service

# 处理器元信息
handlers:
  assessment_submitted_handler:
    package: assessment
    description: "处理测评提交事件"
```

### 2. 发布端 - RoutingPublisher

```go
// 创建路由发布器
publisher := eventconfig.NewRoutingPublisher(eventconfig.RoutingPublisherOptions{
    MQPublisher: mqClient,
    Source:      event.SourceAPIServer,
    Mode:        eventconfig.PublishModeMQ,
})

// 发布事件 - 自动路由到配置的 Topic
evt := assessment.NewAssessmentSubmittedEvent(...)
publisher.Publish(ctx, evt)  // 自动发布到 "assessment.lifecycle"
```

### 3. 订阅端 - Worker Bootstrap

```go
// 1. 创建启动引导器
bootstrap := bootstrap.NewWorkerBootstrap("configs/events.yaml", &deps)

// 2. 初始化（加载配置、注册处理器）
bootstrap.Initialize()

// 3. 获取需要订阅的 Topic
for _, sub := range bootstrap.GetTopicSubscriptions() {
    consumer.Subscribe(sub.TopicName, sub.Group)
}

// 4. 消息到达时分发
bootstrap.Dispatch(ctx, eventType, payload)
```

## 处理器注册机制

### 方式一：声明式注册（推荐）

在 `handler_factory.go` 中统一注册：

```go
func (f *HandlerFactory) registerBuiltinHandlers() {
    f.Register("assessment_submitted_handler", f.handleAssessmentSubmitted)
    f.Register("scale_published_handler", f.handleScalePublished)
    // ...
}
```

### 方式二：包级 init() 注册

```go
package assessment

func init() {
    bootstrap.RegisterHandler("assessment_submitted_handler", NewSubmittedHandler)
}
```

## 工作流程

### 发布流程

```
1. 领域层创建事件
   evt := assessment.NewAssessmentSubmittedEvent(...)

2. RoutingPublisher 查询配置
   topic := config.GetTopicForEvent("assessment.submitted")
   // 返回 "assessment.lifecycle"

3. 发布到消息队列
   mqPublisher.Publish("assessment.lifecycle", payload)
```

### 订阅流程

```
1. Worker 启动，加载 configs/events.yaml

2. 根据配置订阅 Topic
   - assessment.lifecycle (group: qs-worker, concurrency: 4)
   - questionnaire.lifecycle (group: qs-worker, concurrency: 2)

3. 消息到达，解析 event_type
   eventType := message.Metadata["event_type"]

4. 查找并调用处理器
   handler := factory.Create(config.Events[eventType].Handler)
   handler(ctx, eventType, payload)
```

## 优势

1. **单一来源**：事件配置集中管理，发布/订阅端共享
2. **配置即文档**：YAML 配置清晰展示事件拓扑
3. **灵活路由**：修改 Topic 映射无需改代码
4. **自动注册**：Worker 根据配置自动订阅
5. **易于扩展**：新增事件只需修改配置 + 实现处理器

## 与现有代码的关系

| 组件 | 现有实现 | 配置驱动方案 | 关系 |
|------|----------|-------------|------|
| 事件结构体 | 领域包 `events.go` | 保持不变 | 领域层职责 |
| 事件常量 | `eventcatalog` | 可选（配置即常量） | 配置替代 |
| 发布器 | `eventbus.NewPublisher` | `eventconfig.RoutingPublisher` | 增强版 |
| Topic 注册 | `core/types.go` | `configs/events.yaml` | 配置化 |
| 处理器注册 | `init()` 自动注册 | `HandlerFactory` | 统一管理 |

## 迁移路径

1. **阶段一**：引入配置文件，现有代码继续工作
2. **阶段二**：新事件使用配置驱动方式
3. **阶段三**：逐步迁移旧事件到配置驱动
4. **阶段四**：移除硬编码常量，完全配置化
