# Redis 存储空间评估：问卷和量表数据

## 1. 数据大小估算

### 1.1 单个问卷大小

**数据结构**：
- 基本信息：Code、Title、Description、Version、Status、Type（约 500 字节）
- Questions 数组：
  - 每个 Question：Code、Title、Type、Tips、Placeholder（约 200 字节）
  - Options 数组：每个 Option（Code、Content、Score）约 100 字节
  - ValidationRules：每个规则约 100 字节
  - CalculationRule：约 50 字节
  - ShowController：约 200 字节

**典型问卷**：
- 题目数量：20-50 题（平均 30 题）
- 每题选项：4-6 个（平均 5 个）
- 每题校验规则：0-2 个（平均 1 个）

**大小计算**：
```
基础信息：500 字节
题目数据：30 题 × (200 + 5×100 + 1×100 + 50 + 200) = 30 × 850 = 25,500 字节
JSON 序列化开销：约 20%
总大小：约 30 KB
```

**范围**：
- 简单问卷（10 题）：约 10 KB
- 中等问卷（30 题）：约 30 KB
- 复杂问卷（50+ 题）：约 50-100 KB

### 1.2 单个量表大小

**数据结构**：
- 基本信息：Code、Title、Description、Category、Stages、Tags 等（约 500 字节）
- Factors 数组：
  - 每个 Factor：Code、Title、Type、QuestionCodes、ScoringStrategy、InterpretRules 等
  - InterpretRules：每个规则（MinScore、MaxScore、RiskLevel、Conclusion、Suggestion）约 300 字节

**典型量表**：
- 因子数量：3-10 个（平均 5 个）
- 每个因子解读规则：3-5 个（平均 4 个）

**大小计算**：
```
基础信息：500 字节
因子数据：5 因子 × (300 + 4×300) = 5 × 1,500 = 7,500 字节
JSON 序列化开销：约 20%
总大小：约 10 KB
```

**范围**：
- 简单量表（3 因子）：约 5 KB
- 中等量表（5 因子）：约 10 KB
- 复杂量表（10+ 因子）：约 20-30 KB

## 2. 总数据量估算

### 2.1 场景假设

**小规模系统**：
- 问卷数量：50 个
- 量表数量：30 个
- 每个问卷平均版本数：1.5 个

**中规模系统**：
- 问卷数量：200 个
- 量表数量：100 个
- 每个问卷平均版本数：2 个

**大规模系统**：
- 问卷数量：500 个
- 量表数量：200 个
- 每个问卷平均版本数：2.5 个

### 2.2 存储空间计算

#### 小规模系统

```
问卷：50 × 1.5 × 30 KB = 2,250 KB ≈ 2.2 MB
量表：30 × 10 KB = 300 KB ≈ 0.3 MB
总计：约 2.5 MB
```

#### 中规模系统

```
问卷：200 × 2 × 30 KB = 12,000 KB ≈ 12 MB
量表：100 × 10 KB = 1,000 KB ≈ 1 MB
总计：约 13 MB
```

#### 大规模系统

```
问卷：500 × 2.5 × 30 KB = 37,500 KB ≈ 37 MB
量表：200 × 10 KB = 2,000 KB ≈ 2 MB
总计：约 39 MB
```

### 2.3 Redis 额外开销

**Redis 内存开销**：
- 键名：`questionnaire:{code}` 或 `questionnaire:{code}:{version}`（约 30-50 字节）
- Redis 键元数据：约 90 字节
- 字符串值元数据：约 20 字节
- **总开销**：约 140-160 字节/键

**总键数估算**：
- 小规模：50×1.5 + 30 = 105 键
- 中规模：200×2 + 100 = 500 键
- 大规模：500×2.5 + 200 = 1,450 键

**元数据开销**：
- 小规模：105 × 150 字节 ≈ 16 KB
- 中规模：500 × 150 字节 ≈ 75 KB
- 大规模：1,450 × 150 字节 ≈ 218 KB

**总存储空间（含开销）**：
- 小规模：2.5 MB + 16 KB ≈ **2.5 MB**
- 中规模：13 MB + 75 KB ≈ **13 MB**
- 大规模：39 MB + 218 KB ≈ **39 MB**

## 3. 结论

### 3.1 存储空间评估

| 系统规模 | 数据量 | Redis 存储空间 | 评估 |
|---------|-------|---------------|------|
| 小规模 | 50 问卷 + 30 量表 | 约 2.5 MB | ✅ 非常小 |
| 中规模 | 200 问卷 + 100 量表 | 约 13 MB | ✅ 很小 |
| 大规模 | 500 问卷 + 200 量表 | 约 39 MB | ✅ 可接受 |

### 3.2 是否占用很大空间？

**答案：不会占用很大空间**

**理由**：
1. **数据量小**：即使大规模系统，也只需要约 40 MB
2. **Redis 容量大**：现代 Redis 实例通常有 1-16 GB 内存
3. **占比很小**：40 MB 占 1 GB 内存的 4%，占 16 GB 内存的 0.25%

### 3.3 与 redis-cache 对比

**当前方案（redis-cache）**：
- 使用 TTL（12-24 小时）
- 数据可以过期
- 适合缓存场景

**如果放到 redis-store**：
- 不使用 TTL 或 TTL 很长
- 数据长期保存
- 适合持久化场景

**空间占用相同**：无论放在哪个实例，数据大小是一样的。

## 4. 建议

### 4.1 存储位置建议

**推荐：继续使用 redis-cache**

**理由**：
1. **语义清晰**：问卷、量表是"缓存"，不是"持久化存储"
2. **数据源**：MongoDB 是持久化存储，Redis 只是缓存层
3. **可恢复性**：缓存丢失可以从 MongoDB 恢复
4. **TTL 策略**：可以设置合理的 TTL，自动清理过期数据

### 4.2 如果确实需要放到 redis-store

**适用场景**：
- 需要长期保存（不使用 TTL）
- 需要高可用性（redis-store 更可靠）
- 需要跨服务共享（多个服务访问同一份数据）

**注意事项**：
1. **数据一致性**：需要确保更新时同步失效缓存
2. **版本管理**：需要考虑多版本数据的存储策略
3. **内存监控**：虽然空间不大，但仍需监控内存使用

### 4.3 优化建议

**如果担心空间占用**：

1. **压缩存储**：
   ```go
   // 使用 gzip 压缩
   data, _ := json.Marshal(po)
   compressed := gzip.Compress(data)
   redis.Set(key, compressed, ttl)
   ```
   - 压缩率：约 50-70%
   - 小规模：2.5 MB → 1 MB
   - 大规模：39 MB → 15 MB

2. **只缓存热点数据**：
   - 只缓存常用的问卷/量表
   - 其他按需从 MongoDB 加载

3. **使用摘要版本**：
   - 列表查询使用摘要（不包含完整题目）
   - 详情查询使用完整数据

## 5. 总结

**存储空间评估**：
- ✅ 小规模：约 2.5 MB（可忽略）
- ✅ 中规模：约 13 MB（很小）
- ✅ 大规模：约 39 MB（可接受）

**结论**：
- **不会占用很大空间**，即使大规模系统也只需要约 40 MB
- **建议继续使用 redis-cache**，保持架构清晰
- **如果确实需要持久化**，可以放到 redis-store，但需要确保数据一致性

