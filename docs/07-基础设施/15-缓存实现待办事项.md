# 缓存实现待办事项

> **最后更新**：2025-01-XX  
> **状态**：✅ 容器集成已完成，剩余低优先级优化工作

## 已完成工作 ✅

### 容器集成（已完成）

#### 1.1 Assessment 详情缓存集成 ✅

**文件**: `internal/apiserver/container/assembler/evaluation.go`

**已完成**：
- ✅ 添加 Redis 参数（params[6]）
- ✅ 使用 `NewCachedAssessmentRepository` 包装基础 Repository
- ✅ 在 `container.go` 中传入 `redisCache`

#### 1.2 Assessment 状态缓存集成 ✅

**文件**: `internal/apiserver/container/assembler/evaluation.go`

**已完成**：
- ✅ 创建 `RedisCache` 实例
- ✅ 创建 `AssessmentStatusCache` 并传递给应用服务
- ✅ 使用 `NewSubmissionServiceWithCache` 和 `NewManagementServiceWithCache`

#### 1.3 Testee 信息缓存集成 ✅

**文件**: `internal/apiserver/container/assembler/actor.go`

**已完成**：
- ✅ 添加 Redis 参数（params[3]）
- ✅ 使用 `NewCachedTesteeRepository` 包装基础 Repository
- ✅ 在 `container.go` 中传入 `redisCache`

#### 1.4 Plan 信息缓存集成 ✅

**文件**: `internal/apiserver/container/assembler/plan.go`

**已完成**：
- ✅ 添加 Redis 参数（params[3]）
- ✅ 使用 `NewCachedPlanRepository` 包装基础 Repository
- ✅ 在 `container.go` 中传入 `redisCache`

## 待完成工作

### 1. 容器集成（重要）⏳

#### 1.1 Assessment 详情缓存集成

**文件**: `internal/apiserver/container/assembler/evaluation.go`

**当前状态**：

- ✅ 已实现 `CachedAssessmentRepository`
- ❌ 容器中还未使用缓存装饰器

**需要修改**：

```go
// 当前代码（第131行）
m.AssessmentRepo = mysqlEval.NewAssessmentRepository(mysqlDB)

// 需要改为
baseRepo := mysqlEval.NewAssessmentRepository(mysqlDB)
if redisClient != nil {
    m.AssessmentRepo = cache.NewCachedAssessmentRepository(baseRepo, redisClient)
} else {
    m.AssessmentRepo = baseRepo
}
```

**同时需要**：

- 在 `Initialize` 方法中添加 `redis.UniversalClient` 参数
- 在 `container.go` 的 `initEvaluationModule` 中传入 `redisCache`

#### 1.2 Testee 信息缓存集成

**文件**: `internal/apiserver/container/assembler/actor.go`

**当前状态**：

- ✅ 已实现 `CachedTesteeRepository`
- ❌ 容器中还未使用缓存装饰器

**需要修改**：

```go
// 当前代码（第65行）
m.TesteeRepo = actorInfra.NewTesteeRepository(mysqlDB)

// 需要改为
baseRepo := actorInfra.NewTesteeRepository(mysqlDB)
if redisClient != nil {
    m.TesteeRepo = cache.NewCachedTesteeRepository(baseRepo, redisClient)
} else {
    m.TesteeRepo = baseRepo
}
```

**同时需要**：

- 在 `Initialize` 方法中添加 `redis.UniversalClient` 参数
- 在 `container.go` 的 `initActorModule` 中传入 `redisCache`

#### 1.3 Plan 信息缓存集成

**文件**: `internal/apiserver/container/assembler/plan.go`

**当前状态**：

- ✅ 已实现 `CachedPlanRepository`
- ❌ 容器中还未使用缓存装饰器

**需要修改**：

```go
// 当前代码（第66行）
m.PlanRepo = planInfra.NewPlanRepository(mysqlDB)

// 需要改为
baseRepo := planInfra.NewPlanRepository(mysqlDB)
if redisClient != nil {
    m.PlanRepo = cache.NewCachedPlanRepository(baseRepo, redisClient)
} else {
    m.PlanRepo = baseRepo
}
```

**同时需要**：

- 在 `Initialize` 方法中添加 `redis.UniversalClient` 参数
- 在 `container.go` 的 `initPlanModule` 中传入 `redisCache`

#### 1.4 Assessment 状态缓存集成

**文件**: `internal/apiserver/container/assembler/evaluation.go`

**当前状态**：

- ✅ 已实现 `AssessmentStatusCache`
- ✅ 已集成到应用服务（`submission_service.go`、`management_service.go`）
- ⚠️ 需要在容器中创建并传递给应用服务

**需要修改**：

```go
// 在 evaluation.go 的 Initialize 方法中
// 创建状态缓存
var statusCache *cache.AssessmentStatusCache
if redisClient != nil {
    statusCache = cache.NewAssessmentStatusCache(redisClient)
}

// 修改应用服务创建
m.SubmissionService = assessmentApp.NewSubmissionServiceWithCache(
    m.AssessmentRepo,
    assessmentCreator,
    m.eventPublisher,
    statusCache,
)

m.ManagementService = assessmentApp.NewManagementServiceWithCache(
    m.AssessmentRepo,
    statusCache,
)
```

**同时需要**：

- 在 `Initialize` 方法中添加 `redis.UniversalClient` 参数
- 在 `container.go` 的 `initEvaluationModule` 中传入 `redisCache`

### 2. 低优先级功能（可选）❌

#### 2.1 L1 本地内存缓存

**说明**：在进程内使用 sync.Map 或 LRU 缓存热点数据

**适用场景**：

- 超高频访问的数据（如 Assessment 状态）
- 减少网络往返

**实现方式**：

- 创建 `LocalCache` 实现 `Cache` 接口
- 在 `MetricsCache` 或 `RedisCache` 外层再包装一层 `LocalCache`

#### 2.2 缓存压缩

**说明**：对大数据使用 gzip 压缩

**适用场景**：

- 问卷、量表等较大的数据
- 减少 Redis 内存占用

**实现方式**：

- 在 `setCache` 时压缩，`getCache` 时解压
- 或创建 `CompressedCache` 装饰器

#### 2.3 智能预热

**说明**：基于访问日志动态调整预热列表

**实现方式**：

- 记录访问日志（Redis 或文件）
- 定时分析访问频率
- 动态调整预热列表

## 优先级

1. **高优先级**：容器集成（1.1-1.4）✅
   - ✅ 已完成，所有新实现的缓存已集成到容器

2. **低优先级**：L1 本地内存缓存、缓存压缩、智能预热
   - 可选优化，根据实际性能需求决定
   - 预计工作量：每个功能 4-8 小时

## 完成检查清单

### 容器集成检查 ✅

- [x] Assessment 详情缓存集成到 `evaluation.go`
- [x] Testee 信息缓存集成到 `actor.go`
- [x] Plan 信息缓存集成到 `plan.go`
- [x] Assessment 状态缓存在容器中创建并传递给应用服务
- [x] 所有模块的 `Initialize` 方法支持 `redis.UniversalClient` 参数
- [x] `container.go` 中所有模块初始化时传入 `redisCache`
- [ ] 测试验证缓存正常工作（需要运行时测试）

### 功能验证

- [ ] Assessment 详情缓存命中测试
- [ ] Testee 信息缓存命中测试
- [ ] Plan 信息缓存命中测试
- [ ] Assessment 状态缓存 Write-Through 测试
- [ ] 缓存失效测试（Save/Update/Delete 后缓存是否失效）

## 注意事项

1. **向后兼容**：缓存装饰器应该是可选的，Redis 不可用时降级到直接查询数据库
2. **参数顺序**：修改 `Initialize` 方法时注意参数顺序，保持向后兼容
3. **测试**：集成后需要测试缓存是否正常工作，特别是缓存失效逻辑

