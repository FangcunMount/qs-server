# Plan 子域实现总结

> **版本**：V1.0  
> **更新日期**：2025-01-XX  
> **实现状态**：✅ 已完成

## 1. 实现概览

Plan 子域已完成以下实现：

- ✅ 领域层（Domain Layer）
- ✅ 应用服务层（Application Layer）
- ✅ 基础设施层（Infrastructure Layer）
- ✅ REST API 接口层
- ✅ 数据库迁移脚本
- ✅ Worker 事件处理器

## 2. 目录结构

```text
internal/apiserver/
├── domain/plan/                    # 领域层
│   ├── types.go                    # 类型定义（ID、Status、ScheduleType）
│   ├── errors.go                   # 领域错误
│   ├── assessment_plan.go          # AssessmentPlan 聚合根
│   ├── assessment_task.go          # AssessmentTask 实体
│   ├── events.go                   # 领域事件定义
│   ├── repository.go                # 仓储接口
│   ├── task_generator.go           # 任务生成器
│   ├── plan_lifecycle.go           # 计划生命周期领域服务
│   ├── plan_enrollment.go          # 受试者加入计划领域服务
│   ├── task_lifecycle.go           # 任务生命周期领域服务
│   └── validator.go                # 计划验证器
│
├── application/plan/               # 应用服务层
│   ├── interface.go                # 应用服务接口
│   ├── dto.go                      # 数据传输对象
│   ├── converter.go                # 转换器
│   ├── lifecycle_service.go       # 计划生命周期服务
│   ├── enrollment_service.go        # 受试者加入计划服务
│   ├── task_scheduler_service.go    # 任务调度服务
│   ├── task_management_service.go  # 任务管理服务
│   └── query_service.go            # 查询服务
│
├── infra/
│   ├── mysql/plan/                 # MySQL 基础设施层
│   │   ├── po.go                   # 持久化对象
│   │   ├── mapper.go               # 领域对象与 PO 映射
│   │   ├── plan_repository.go      # 计划仓储实现
│   │   └── task_repository.go     # 任务仓储实现
│   └── plan/
│       └── entry_generator.go      # 入口生成器实现
│
└── interface/restful/              # REST API 接口层
    ├── handler/plan.go             # Plan Handler
    ├── request/plan.go             # 请求结构
    └── response/plan.go            # 响应结构

internal/worker/
└── handlers/
    └── plan_handler.go             # Plan 事件处理器

internal/pkg/migration/migrations/mysql/
└── 000003_init_plan_schema.up.sql # 数据库迁移脚本
```

## 3. 核心设计决策

### 3.1 Plan 作为模板

**决策**：`AssessmentPlan` 不关联 `testeeID`，而是作为模板

**理由**：

- 支持模板复用（如 SNAP 18 周测评模板）
- 多个受试者可以加入同一个 Plan
- 每个受试者可以有不同的 `startDate`

**实现**：

- Plan 只包含周期策略（`scheduleType`, `interval`, `totalTimes` 等）
- 受试者通过 `PlanEnrollment.EnrollTestee()` 加入计划
- 任务生成时关联 `testeeID` 和 `planID`

### 3.2 相对时间窗口

**决策**：Plan 不包含 `startDate`/`endDate`，而是使用相对时间窗口

**理由**：

- Plan 是模板，不应该有绝对时间范围
- 每个受试者的开始时间不同
- 支持计划模板的复用

**实现**：

- `startDate` 作为 `TaskGenerator.GenerateTasks()` 的参数
- 所有周期策略都是相对 `startDate` 计算
- `fixedDates` 是特殊情况，使用绝对日期

### 3.3 审计字段分离

**决策**：领域对象不包含审计字段（`createdAt`, `updatedAt`, `version` 等）

**理由**：

- 符合 DDD 原则：领域对象关注业务逻辑，基础设施关注持久化
- 审计字段由基础设施层（PO）处理
- 领域对象更纯粹，易于测试

**实现**：

- 领域对象：`AssessmentPlan`, `AssessmentTask` 不包含审计字段
- PO 对象：`AssessmentPlanPO`, `AssessmentTaskPO` 包含 `mysql.AuditFields`
- Mapper 负责在领域对象和 PO 之间转换

### 3.4 领域服务封装业务规则

**决策**：状态变更方法（`pause`, `resume`, `open`, `complete` 等）是包内方法，由领域服务调用

**理由**：

- 封装业务规则（如暂停时取消任务、恢复时重新生成任务）
- 确保状态变更的一致性
- 应用层通过领域服务调用，而不是直接调用聚合根方法

**实现**：

- `PlanLifecycle`：封装计划生命周期业务规则
- `TaskLifecycle`：封装任务生命周期业务规则
- `PlanEnrollment`：封装受试者加入计划的业务规则

## 4. 关键业务流程

### 4.1 创建计划并加入受试者

```text
1. POST /api/v1/plans
   └─> PlanLifecycleService.CreatePlan()
       └─> domain.NewAssessmentPlan() 创建计划模板
       └─> planRepo.Save() 保存计划
       └─> 发布 PlanCreatedEvent

2. POST /api/v1/plans/enroll
   └─> PlanEnrollmentService.EnrollTestee()
       └─> PlanEnrollment.EnrollTestee()
           └─> TaskGenerator.GenerateTasks(plan, testeeID, startDate)
           └─> 返回生成的任务列表
       └─> taskRepo.SaveBatch() 批量保存任务
```

### 4.2 任务调度与开放

```text
定时任务（每小时）
   └─> POST /api/v1/plans/tasks/schedule
       └─> TaskSchedulerService.SchedulePendingTasks()
           └─> taskRepo.FindPendingTasks() 查询待推送任务
           └─> EntryGenerator.GenerateEntry() 生成入口
           └─> TaskLifecycle.Open() 开放任务
           └─> taskRepo.Save() 保存任务
           └─> 发布 TaskOpenedEvent
       └─> Worker 消费事件 → 发送通知
```

### 4.3 计划暂停与恢复

```text
1. POST /api/v1/plans/:id/pause
   └─> PlanLifecycleService.PausePlan()
       └─> PlanLifecycle.Pause()
           └─> 查询所有任务
           └─> 取消所有未执行的任务（pending/opened）
           └─> plan.pause() 更新计划状态
       └─> 保存被取消的任务

2. POST /api/v1/plans/:id/resume
   └─> PlanLifecycleService.ResumePlan()
       └─> PlanLifecycle.Resume()
           └─> 查询所有任务，找出每个受试者已完成的最大序号
           └─> 为每个受试者重新生成未完成的任务
           └─> plan.resume() 更新计划状态
       └─> 保存新生成的任务
```

## 5. 数据模型

### 5.1 AssessmentPlan 表

| 字段 | 类型 | 说明 |
|------|------|------|
| id | BIGINT UNSIGNED | 计划ID（主键） |
| org_id | BIGINT | 组织ID |
| scale_id | BIGINT UNSIGNED | 量表ID |
| schedule_type | VARCHAR(50) | 周期类型 |
| interval | INT | 间隔（周/天） |
| total_times | INT | 总次数 |
| fixed_dates | JSON | 固定日期列表 |
| relative_weeks | JSON | 相对周次列表 |
| status | VARCHAR(50) | 状态 |
| created_at | DATETIME(3) | 创建时间 |
| updated_at | DATETIME(3) | 更新时间 |
| deleted_at | DATETIME(3) | 删除时间（软删除） |
| version | INT UNSIGNED | 乐观锁版本号 |

### 5.2 AssessmentTask 表

| 字段 | 类型 | 说明 |
|------|------|------|
| id | BIGINT UNSIGNED | 任务ID（主键） |
| plan_id | BIGINT UNSIGNED | 计划ID |
| seq | INT | 序号 |
| org_id | BIGINT | 组织ID（冗余） |
| testee_id | BIGINT UNSIGNED | 受试者ID |
| scale_id | BIGINT UNSIGNED | 量表ID（冗余） |
| planned_at | DATETIME(3) | 计划时间点 |
| open_at | DATETIME(3) | 实际开放时间 |
| expire_at | DATETIME(3) | 截止时间 |
| completed_at | DATETIME(3) | 完成时间 |
| status | VARCHAR(50) | 状态 |
| assessment_id | BIGINT UNSIGNED | 关联的测评ID（唯一） |
| entry_token | VARCHAR(255) | 入口令牌 |
| entry_url | VARCHAR(500) | 入口URL |
| created_at | DATETIME(3) | 创建时间 |
| updated_at | DATETIME(3) | 更新时间 |
| deleted_at | DATETIME(3) | 删除时间（软删除） |
| version | INT UNSIGNED | 乐观锁版本号 |

## 6. 索引设计

### 6.1 AssessmentPlan 表索引

- `idx_org_id` - 组织ID索引
- `idx_scale_id` - 量表ID索引
- `idx_schedule_type` - 周期类型索引
- `idx_status` - 状态索引
- `idx_deleted_at` - 软删除索引

### 6.2 AssessmentTask 表索引

- `idx_plan_id` - 计划ID索引
- `idx_plan_seq` - 计划ID + 序号复合索引
- `idx_org_id` - 组织ID索引
- `idx_testee_id` - 受试者ID索引
- `idx_scale_id` - 量表ID索引
- `idx_planned_at` - 计划时间点索引
- `idx_open_at` - 开放时间索引
- `idx_expire_at` - 截止时间索引
- `idx_status` - 状态索引
- `idx_assessment_id` - 测评ID索引
- `idx_plan_testee_seq` - 计划ID + 受试者ID + 序号复合索引
- `uk_assessment_id` - 测评ID唯一索引

## 7. 事件处理

### 7.1 事件列表

- `plan.created` - 计划创建事件
- `task.opened` - 任务开放事件
- `task.completed` - 任务完成事件
- `task.expired` - 任务过期事件

### 7.2 Worker 处理器

位置：`internal/worker/handlers/plan_handler.go`

**处理逻辑**：

- `plan_created_handler` - 记录日志，更新统计指标（TODO）
- `task_opened_handler` - 发送通知给受试者（TODO），更新统计指标（TODO）
- `task_completed_handler` - 更新统计指标（TODO），触发报告生成（TODO），检查风险等级（TODO）
- `task_expired_handler` - 更新统计指标（TODO），发送通知（TODO），分析过期原因（TODO）

## 8. 待实现功能

### 8.1 统计服务

- [ ] 计划创建数量统计
- [ ] 任务开放数量统计
- [ ] 任务完成率统计
- [ ] 计划执行趋势分析

### 8.2 通知服务

- [ ] 任务开放通知（短信/小程序推送/邮件）
- [ ] 任务完成确认通知
- [ ] 任务过期提醒通知

### 8.3 报告服务

- [ ] 自动生成报告（如果计划配置了自动生成）
- [ ] 风险等级检查与预警

## 9. 相关文档

- [01-测评计划子域设计.md](./01-测评计划子域设计.md) - 子域设计文档
- [02-领域事件说明.md](./02-领域事件说明.md) - 领域事件说明
- [03-任务调度机制说明.md](./03-任务调度机制说明.md) - 任务调度机制说明
