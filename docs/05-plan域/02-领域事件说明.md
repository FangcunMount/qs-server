# Plan 子域领域事件说明

> **版本**：V1.0  
> **更新日期**：2025-01-XX  
> **实现状态**：✅ 已实现

## 事件列表

### 1. PlanCreatedEvent (plan.created)

**触发时机**：创建测评计划模板时

**事件数据**：

```go
type PlanCreatedData struct {
    PlanID    string    `json:"plan_id"`    // 计划ID
    ScaleID   string    `json:"scale_id"`   // 量表ID
    CreatedAt time.Time `json:"created_at"` // 创建时间
}
```

**注意**：事件数据中不包含 `testeeID`，因为 Plan 是模板，不关联具体的受试者。

**潜在消费者**：

- **统计服务**：记录计划创建数量，更新统计指标
- **通知服务**：向管理员发送"新计划已创建"通知（可选）
- **缓存服务**：预热计划相关缓存

**实现位置**：

- 事件定义：`internal/apiserver/domain/plan/events.go`
- 事件发布：`internal/apiserver/application/plan/lifecycle_service.go` (CreatePlan)
- 事件处理：`internal/worker/handlers/plan_handler.go` (plan_created_handler)

### 2. TaskOpenedEvent (task.opened)

**触发时机**：任务被开放（生成入口URL）时

**事件数据**：

```go
type TaskOpenedData struct {
    TaskID   string    `json:"task_id"`   // 任务ID
    PlanID   string    `json:"plan_id"`   // 计划ID
    TesteeID string    `json:"testee_id"` // 受试者ID
    EntryURL string    `json:"entry_url"` // 测评入口URL
    OpenAt   time.Time `json:"open_at"`   // 开放时间
}
```

**潜在消费者**：

- **通知服务**：向受试者发送测评提醒（短信/小程序推送/邮件）
  - 发送内容：测评入口链接、截止时间、提醒文案
  - **实现状态**：TODO（在 `plan_handler.go` 中标记）
- **统计服务**：记录任务开放数量，更新实时统计
  - **实现状态**：TODO（在 `plan_handler.go` 中标记）
- **日志服务**：记录任务开放日志，用于审计
  - **实现状态**：✅ 已实现

**实现位置**：

- 事件定义：`internal/apiserver/domain/plan/events.go`
- 事件发布：`internal/apiserver/domain/plan/assessment_task.go` (open 方法)
- 事件处理：`internal/worker/handlers/plan_handler.go` (task_opened_handler)

### 3. TaskCompletedEvent (task.completed)

**触发时机**：用户完成测评，任务状态变为已完成时

**事件数据**：

```go
type TaskCompletedData struct {
    TaskID       string    `json:"task_id"`        // 任务ID
    PlanID       string    `json:"plan_id"`        // 计划ID
    AssessmentID string    `json:"assessment_id"`  // 关联的测评ID
    CompletedAt  time.Time `json:"completed_at"`   // 完成时间
}
```

**潜在消费者**：

- **统计服务**：
  - 更新计划完成率统计
  - 更新受试者完成进度
  - 计算计划执行趋势
  - **实现状态**：TODO（在 `plan_handler.go` 中标记）
- **通知服务**：向受试者发送"测评已完成"确认通知（可选）
  - **实现状态**：TODO（在 `plan_handler.go` 中标记）
- **报告服务**：触发报告生成流程（如果计划配置了自动生成报告）
  - **实现状态**：TODO（在 `plan_handler.go` 中标记）
- **预警服务**：检查测评结果，如果风险等级高，触发预警流程
  - **实现状态**：TODO（在 `plan_handler.go` 中标记）

**实现位置**：

- 事件定义：`internal/apiserver/domain/plan/events.go`
- 事件发布：`internal/apiserver/domain/plan/assessment_task.go` (complete 方法)
- 事件处理：`internal/worker/handlers/plan_handler.go` (task_completed_handler)

### 4. TaskExpiredEvent (task.expired)

**触发时机**：任务超过截止时间，状态变为已过期时

**事件数据**：

```go
type TaskExpiredData struct {
    TaskID    string    `json:"task_id"`    // 任务ID
    PlanID    string    `json:"plan_id"`    // 计划ID
    ExpiredAt time.Time `json:"expired_at"` // 过期时间
}
```

**潜在消费者**：

- **通知服务**：向受试者发送"测评已过期"提醒（可选）
  - **实现状态**：TODO（在 `plan_handler.go` 中标记）
- **统计服务**：更新过期任务统计，计算完成率
  - **实现状态**：TODO（在 `plan_handler.go` 中标记）
- **分析服务**：分析过期原因，生成报告
  - **实现状态**：TODO（在 `plan_handler.go` 中标记）

**实现位置**：

- 事件定义：`internal/apiserver/domain/plan/events.go`
- 事件发布：`internal/apiserver/domain/plan/assessment_task.go` (expire 方法)
- 事件处理：`internal/worker/handlers/plan_handler.go` (task_expired_handler)

## 事件驱动架构的优势

1. **解耦**：Plan 子域不需要知道谁在监听这些事件，只需要发布事件即可
2. **扩展性**：新增消费者不需要修改 Plan 子域代码
3. **异步处理**：通知、统计等耗时操作可以异步处理，不影响主流程
4. **可靠性**：通过消息队列保证事件不丢失，支持重试机制

## 事件订阅配置

在 `configs/events.yaml` 中配置事件订阅：

```yaml
events:
  plan.created:
    topic: plan-lifecycle
    aggregate: AssessmentPlan
    domain: plan
    description: "计划已创建"
    handler: plan_created_handler
    consumers:
      - qs-worker

  task.opened:
    topic: task-lifecycle
    aggregate: AssessmentTask
    domain: plan
    description: "任务已开放"
    handler: task_opened_handler
    consumers:
      - qs-worker  # 发送通知、更新统计

  task.completed:
    topic: task-lifecycle
    aggregate: AssessmentTask
    domain: plan
    description: "任务已完成"
    handler: task_completed_handler
    consumers:
      - qs-worker  # 发送通知、触发报告生成、检查风险等级

  task.expired:
    topic: task-lifecycle
    aggregate: AssessmentTask
    domain: plan
    description: "任务已过期"
    handler: task_expired_handler
    consumers:
      - qs-worker  # 发送通知、更新统计
```

**配置位置**：`configs/events.yaml`

**处理器位置**：`internal/worker/handlers/plan_handler.go`

## 事件处理实现状态

| 事件 | 处理器 | 日志记录 | 通知发送 | 统计更新 | 其他功能 |
|------|--------|---------|---------|---------|---------|
| plan.created | ✅ | ✅ | - | TODO | 缓存预热 TODO |
| task.opened | ✅ | ✅ | TODO | TODO | - |
| task.completed | ✅ | ✅ | TODO | TODO | 报告生成 TODO、风险检查 TODO |
| task.expired | ✅ | ✅ | TODO | TODO | 过期分析 TODO |

**说明**：

- ✅ 已实现
- TODO 待实现（在代码中已标记 TODO 注释）
- - 不适用
