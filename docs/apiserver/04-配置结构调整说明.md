# é…ç½®ç»“æ„è°ƒæ•´è¯´æ˜

## âœ… å·²å®Œæˆçš„è°ƒæ•´

åŸºäº IAM ç³»ç»Ÿçš„é…ç½®æœ€ä½³å®è·µï¼Œå¯¹ QS ç³»ç»Ÿé…ç½®è¿›è¡Œäº†ç»“æ„ä¼˜åŒ–ã€‚

---

## ğŸ“‹ ä¸»è¦å˜æ›´

### 1. **æ·»åŠ åº”ç”¨å…ƒä¿¡æ¯æ®µ** âœ¨

**é…ç½®æ–‡ä»¶** (`configs/apiserver.dev.yaml`):
```yaml
# åº”ç”¨é…ç½®
app:
  name: "qs-apiserver"
  version: "1.0.0"
  mode: "production"  # development, production
```

**ç”¨é€”**: æ ‡è¯†åº”ç”¨ä¿¡æ¯ï¼Œä¾¿äºç›‘æ§å’Œç‰ˆæœ¬ç®¡ç†

---

### 2. **Migration é…ç½®ç‹¬ç«‹** ğŸ”„

**ä¹‹å‰** (åœ¨ mysql æ®µå†…):
```yaml
mysql:
  # ...å…¶ä»–é…ç½®
  enable-migration: true
  auto-seed: false
```

**ç°åœ¨** (ç‹¬ç«‹é…ç½®æ®µ):
```yaml
# æ•°æ®åº“è¿ç§»é…ç½®
migration:
  enabled: true  # æ˜¯å¦å¯ç”¨è‡ªåŠ¨è¿ç§»
  autoseed: false  # æ˜¯å¦è‡ªåŠ¨åŠ è½½ç§å­æ•°æ®
  database: "qs"  # æ•°æ®åº“åç§°
```

**ä»£ç å˜æ›´**:
- âœ… æ–°å¢ `internal/pkg/options/migration_options.go`
- âœ… æ›´æ–° `internal/apiserver/options/options.go` æ·»åŠ  `MigrationOptions`
- âœ… æ›´æ–° `internal/apiserver/database.go` ä½¿ç”¨æ–°é…ç½®è·¯å¾„
- âœ… ä» `MySQLOptions` ä¸­ç§»é™¤ `EnableMigration` å’Œ `AutoSeed` å­—æ®µ

**å‘½ä»¤è¡Œå‚æ•°å˜æ›´**:
```bash
# ä¹‹å‰
--mysql.enable-migration=true
--mysql.auto-seed=false

# ç°åœ¨
--migration.enabled=true
--migration.autoseed=false
--migration.database=qs
```

---

### 3. **Redis åŒå®ä¾‹æ¶æ„** ğŸ”´ğŸ”´

**ä¹‹å‰** (å•å®ä¾‹):
```yaml
redis:
  host: "127.0.0.1"
  port: 6379
  password: "questionnaire_redis_2024"
  database: 0
  # ...å…¶ä»–é…ç½®
```

**ç°åœ¨** (åŒå®ä¾‹):
```yaml
redis:
  # Cache Redis - ç”¨äºç¼“å­˜ã€ä¼šè¯ã€é™æµç­‰ä¸´æ—¶æ•°æ®
  cache:
    host: "127.0.0.1"
    port: 6379
    username: ""
    password: "questionnaire_redis_2024"
    database: 0  # ç¼“å­˜ä½¿ç”¨ DB 0
    max-idle: 50
    max-active: 100
    timeout: 5
    enable-cluster: false
    use-ssl: false
    enable-logging: true
  
  # Store Redis - ç”¨äºæŒä¹…åŒ–å­˜å‚¨ã€é˜Ÿåˆ—ã€å‘å¸ƒè®¢é˜…ç­‰
  store:
    host: "127.0.0.1"
    port: 6379  # å¯ä»¥ä½¿ç”¨ä¸åŒç«¯å£çš„å®ä¾‹
    username: ""
    password: "questionnaire_redis_2024"
    database: 1  # å­˜å‚¨ä½¿ç”¨ DB 1
    max-idle: 50
    max-active: 100
    timeout: 5
    enable-cluster: false
    use-ssl: false
    enable-logging: true
```

**æ¶æ„ä¼˜åŠ¿**:
- âœ… **èŒè´£åˆ†ç¦»**: Cache ç”¨äºä¸´æ—¶æ•°æ®ï¼ŒStore ç”¨äºæŒä¹…åŒ–
- âœ… **æ€§èƒ½éš”ç¦»**: é¿å…ç¼“å­˜æ“ä½œå½±å“æŒä¹…åŒ–æ“ä½œ
- âœ… **æ•…éšœéš”ç¦»**: ä¸€ä¸ªå®ä¾‹æ•…éšœä¸å½±å“å¦ä¸€ä¸ª
- âœ… **çµæ´»éƒ¨ç½²**: å¯ä½¿ç”¨åŒä¸€å®ä¾‹ä¸åŒ DBï¼Œæˆ–å®Œå…¨ç‹¬ç«‹çš„å®ä¾‹

**ä»£ç å˜æ›´**:
- âœ… æ–°å¢ `internal/pkg/options/redis_dual_options.go`
- âœ… æ›´æ–° `internal/apiserver/options/options.go` å°† `RedisOptions` æ”¹ä¸º `RedisDualOptions`
- âœ… æ›´æ–° `internal/apiserver/database.go` çš„ `initRedis()` æ–¹æ³•

**å‘½ä»¤è¡Œå‚æ•°å˜æ›´**:
```bash
# Cache Redis
--redis.cache.host=127.0.0.1
--redis.cache.port=6379
--redis.cache.password=xxx
--redis.cache.database=0

# Store Redis
--redis.store.host=127.0.0.1
--redis.store.port=6379
--redis.store.password=xxx
--redis.store.database=1
```

---

### 4. **æ—¥å¿—é…ç½®å‡çº§** ğŸ“Š

**ç°åœ¨** (component-base v0.2.9 duplicate æ¨¡å¼):
```yaml
log:
  # åŸºç¡€é…ç½®
  disable-caller: true
  disable-stacktrace: true
  level: debug
  format: console
  enable-color: false
  development: false
  name: "qs-apiserver"
  
  # æ—¥å¿—è½®è½¬é…ç½®
  max-size: 100
  max-age: 30
  max-backups: 10
  compress: true
  
  # æŒ‰æ—¶é—´è½®è½¬
  enable-time-rotation: true
  time-rotation-format: "2006-01-02"
  
  # åˆ†çº§è¾“å‡ºï¼ˆduplicate æ¨¡å¼ï¼‰
  enable-level-output: true
  level-output-mode: "duplicate"
  level-output-paths:
    all:
      - stdout
      - /data/logs/qs/qs-apiserver.log
    warn:
      - /data/logs/qs/qs-apiserver-warn.log
    error:
      - stderr
      - /data/logs/qs/qs-apiserver-error.log
```

**ä¼˜åŠ¿**:
- âœ… **åˆ†çº§è¾“å‡º**: ä¸åŒçº§åˆ«æ—¥å¿—å†™å…¥ä¸åŒæ–‡ä»¶ï¼Œä¾¿äºæ•…éšœæ’æŸ¥
- âœ… **duplicate æ¨¡å¼**: å®Œæ•´æ—¥å¿— + åˆ†çº§æ—¥å¿—ï¼Œä¿¡æ¯ä¸ä¸¢å¤±
- âœ… **æŒ‰å¤©è½®è½¬**: è‡ªåŠ¨æŒ‰æ—¥æœŸè½®è½¬æ—¥å¿—æ–‡ä»¶
- âœ… **ç”Ÿäº§ä¼˜åŒ–**: ç¦ç”¨ caller å’Œ stacktraceï¼Œæå‡æ€§èƒ½

---

## ğŸ”§ ä»£ç æ–‡ä»¶å˜æ›´æ¸…å•

### æ–°å¢æ–‡ä»¶

| æ–‡ä»¶ | è¯´æ˜ |
|------|------|
| `internal/pkg/options/migration_options.go` | Migration é…ç½®é€‰é¡¹ |
| `internal/pkg/options/redis_dual_options.go` | Redis åŒå®ä¾‹é…ç½®é€‰é¡¹ |

### ä¿®æ”¹æ–‡ä»¶

| æ–‡ä»¶ | å˜æ›´å†…å®¹ |
|------|----------|
| `configs/apiserver.dev.yaml` | æ·»åŠ  app æ®µï¼Œé‡æ„ migration/redis/log é…ç½® |
| `internal/pkg/options/mysql_options.go` | ç§»é™¤ `EnableMigration` å’Œ `AutoSeed` å­—æ®µ |
| `internal/apiserver/options/options.go` | æ·»åŠ  `MigrationOptions` å’Œ `RedisDualOptions` |
| `internal/apiserver/database.go` | æ›´æ–° `runMigrations()` å’Œ `initRedis()` æ–¹æ³• |

---

## ğŸš€ ä½¿ç”¨æŒ‡å—

### å¯åŠ¨æœåŠ¡

```bash
# ä½¿ç”¨é…ç½®æ–‡ä»¶
./tmp/apiserver --config=configs/apiserver.dev.yaml

# è¦†ç›–ç‰¹å®šé…ç½®
./tmp/apiserver --config=configs/apiserver.dev.yaml \
  --migration.enabled=true \
  --redis.cache.database=0 \
  --redis.store.database=1
```

### éªŒè¯é…ç½®

```bash
# æŸ¥çœ‹æ‰€æœ‰é…ç½®é¡¹
./tmp/apiserver --help

# æµ‹è¯•é…ç½®åŠ è½½
./tmp/apiserver --config=configs/apiserver.dev.yaml --dry-run
```

---

## ğŸ“Š é…ç½®å¯¹ç…§è¡¨

### Migration é…ç½®æ˜ å°„

| æ—§é…ç½®è·¯å¾„ | æ–°é…ç½®è·¯å¾„ |
|-----------|-----------|
| `mysql.enable-migration` | `migration.enabled` |
| `mysql.auto-seed` | `migration.autoseed` |
| - | `migration.database` (æ–°å¢) |

### Redis é…ç½®æ˜ å°„

| æ—§é…ç½®è·¯å¾„ | æ–°é…ç½®è·¯å¾„ (Cache) | æ–°é…ç½®è·¯å¾„ (Store) |
|-----------|-------------------|-------------------|
| `redis.host` | `redis.cache.host` | `redis.store.host` |
| `redis.port` | `redis.cache.port` | `redis.store.port` |
| `redis.password` | `redis.cache.password` | `redis.store.password` |
| `redis.database` | `redis.cache.database` | `redis.store.database` |
| `redis.max-idle` | `redis.cache.max-idle` | `redis.store.max-idle` |
| `redis.max-active` | `redis.cache.max-active` | `redis.store.max-active` |
| - | `redis.cache.username` (æ–°å¢) | `redis.store.username` (æ–°å¢) |
| - | `redis.cache.enable-logging` (æ–°å¢) | `redis.store.enable-logging` (æ–°å¢) |

---

## âš ï¸ å‘åå…¼å®¹æ€§

### Migration é…ç½®

- âŒ **ä¸å…¼å®¹**: æ—§çš„ `mysql.enable-migration` å’Œ `mysql.auto-seed` é…ç½®å·²ç§»é™¤
- âœ… **è¿ç§»è·¯å¾„**: ä½¿ç”¨æ–°çš„ `migration.*` é…ç½®æ®µ

### Redis é…ç½®

- âœ… **éƒ¨åˆ†å…¼å®¹**: Cache Redis æ³¨å†Œä¸ºä¸» Redis å®ä¾‹ï¼Œä¿æŒå‘åå…¼å®¹
- âš ï¸ **æ³¨æ„**: Store Redis æš‚æœªåœ¨ registry ä¸­æ³¨å†Œï¼Œéœ€è¦ä¸šåŠ¡ä»£ç ç›´æ¥åˆ›å»ºè¿æ¥

### æ—¥å¿—é…ç½®

- âœ… **å®Œå…¨å…¼å®¹**: component-base æ—¥å¿—åº“æ”¯æŒæ–°æ—§é…ç½®æ ¼å¼

---

## ğŸ¯ æ¨èé…ç½®

### å¼€å‘ç¯å¢ƒ

```yaml
app:
  mode: "development"

migration:
  enabled: true
  autoseed: true  # å¼€å‘ç¯å¢ƒå¯ä»¥åŠ è½½ç§å­æ•°æ®

redis:
  cache:
    host: "127.0.0.1"
    port: 6379
    database: 0
  store:
    host: "127.0.0.1"
    port: 6379
    database: 1

log:
  level: debug
  format: console
  enable-color: true
  enable-level-output: false  # å¼€å‘ç¯å¢ƒå¯ä»¥å…³é—­åˆ†çº§è¾“å‡º
```

### ç”Ÿäº§ç¯å¢ƒ

```yaml
app:
  mode: "production"

migration:
  enabled: true
  autoseed: false  # âš ï¸ ç”Ÿäº§ç¯å¢ƒç¦ç”¨ç§å­æ•°æ®

redis:
  cache:
    host: "cache-redis.example.com"
    port: 6379
    password: "å¼ºå¯†ç "
    database: 0
    enable-logging: false  # ç”Ÿäº§ç¯å¢ƒå…³é—­å‘½ä»¤æ—¥å¿—
  store:
    host: "store-redis.example.com"  # ä½¿ç”¨ç‹¬ç«‹å®ä¾‹
    port: 6379
    password: "å¼ºå¯†ç "
    database: 0
    enable-logging: false

log:
  level: info  # ç”Ÿäº§ç¯å¢ƒä½¿ç”¨ info çº§åˆ«
  format: json  # JSON æ ¼å¼ä¾¿äºæ—¥å¿—é‡‡é›†
  enable-color: false
  disable-caller: true
  disable-stacktrace: true
  enable-level-output: true
  level-output-mode: "duplicate"
```

---

## âœ… éªŒè¯ç»“æœ

- âœ… **ç¼–è¯‘æˆåŠŸ**: `go build ./internal/apiserver/...`
- âœ… **æœåŠ¡ç¼–è¯‘æˆåŠŸ**: `go build -o tmp/apiserver cmd/qs-apiserver/apiserver.go`
- âœ… **é…ç½®æ–‡ä»¶è¯­æ³•æ­£ç¡®**: YAML æ ¼å¼éªŒè¯é€šè¿‡
- âœ… **æ–°é…ç½®é€‰é¡¹å·²æ³¨å†Œ**: `MigrationOptions` å’Œ `RedisDualOptions` å·²æ·»åŠ åˆ° `Options` ç»“æ„

---

## ğŸ“š ç›¸å…³æ–‡æ¡£

- Migration ä½¿ç”¨æŒ‡å—: `docs/apiserver/03-Migrationé›†æˆä½¿ç”¨æŒ‡å—.md`
- IAM é…ç½®å‚è€ƒ: è§æœ¬æ¬¡æä¾›çš„ IAM é…ç½®æ–‡ä»¶
- component-base æ—¥å¿—æ–‡æ¡£: æŸ¥çœ‹ component-base v0.2.9 æ–‡æ¡£

---

## ğŸ”„ åç»­ä¼˜åŒ–å»ºè®®

1. **Redis Registry æ‰©å±•**: æ‰©å±• `database.Registry` æ”¯æŒæ³¨å†Œå¤šä¸ª Redis å®ä¾‹
2. **é…ç½®éªŒè¯**: æ·»åŠ é…ç½®é¡¹çš„åˆæ³•æ€§éªŒè¯ï¼ˆå¦‚ç«¯å£èŒƒå›´ã€è·¯å¾„å­˜åœ¨æ€§ç­‰ï¼‰
3. **é…ç½®çƒ­é‡è½½**: æ”¯æŒéƒ¨åˆ†é…ç½®é¡¹çš„çƒ­é‡è½½ï¼ˆå¦‚æ—¥å¿—çº§åˆ«ï¼‰
4. **ç›‘æ§æŒ‡æ ‡**: ä¸ºåŒ Redis å®ä¾‹æ·»åŠ ç‹¬ç«‹çš„ç›‘æ§æŒ‡æ ‡
5. **æ–‡æ¡£å®Œå–„**: è¡¥å…… Redis åŒå®ä¾‹æ¶æ„çš„ä½¿ç”¨ç¤ºä¾‹å’Œæœ€ä½³å®è·µ

---

**é…ç½®è°ƒæ•´å·²å®Œæˆï¼** ğŸ‰

æœåŠ¡ç°åœ¨é‡‡ç”¨ä¸ IAM ç³»ç»Ÿä¸€è‡´çš„é…ç½®ç»“æ„ï¼Œæ›´åŠ æ¸…æ™°ã€è§„èŒƒã€æ˜“äºç»´æŠ¤ã€‚
