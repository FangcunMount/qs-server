# API Server 项目文档

## 项目概述

API Server 是问卷量表系统的核心服务，负责问卷管理、答卷收集、用户管理等核心业务功能。该服务采用领域驱动设计（DDD）和六边形架构，实现了高度可扩展的问卷和答卷系统。

## 架构设计

### 整体架构

```mermaid
┌─────────────────────────────────────────────────────────────┐
│                    Interface Layer                          │
│  ┌─────────────────┐  ┌─────────────────┐  ┌──────────────┐ │
│  │   REST API      │  │   gRPC API      │  │   WebSocket  │ │
│  │   Controllers   │  │   Services      │  │   Handlers   │ │
│  └─────────────────┘  └─────────────────┘  └──────────────┘ │
└─────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────┐
│                   Application Layer                         │
│  ┌─────────────────┐  ┌─────────────────┐  ┌──────────────┐ │
│  │   DTOs          │  │   Mappers       │  │   Services   │ │
│  │   (Data)        │  │   (Convert)     │  │   (Orchestr) │ │
│  └─────────────────┘  └─────────────────┘  └──────────────┘ │
└─────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────┐
│                     Domain Layer                            │
│  ┌─────────────────┐  ┌─────────────────┐  ┌──────────────┐ │
│  │   Questionnaire │  │   AnswerSheet   │  │   User       │ │
│  │   (Aggregate)   │  │   (Aggregate)   │  │   (Entity)   │ │
│  └─────────────────┘  └─────────────────┘  └──────────────┘ │
│  ┌─────────────────┐  ┌─────────────────┐  ┌──────────────┐ │
│  │   Question      │  │   Answer        │  │   Medical    │ │
│  │   (Entity)      │  │   (Value Obj)   │  │   Scale      │ │
│  └─────────────────┘  └─────────────────┘  └──────────────┘ │
└─────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────┐
│                Infrastructure Layer                         │
│  ┌─────────────────┐  ┌─────────────────┐  ┌──────────────┐ │
│  │   MySQL         │  │   MongoDB       │  │   Redis      │ │
│  │   (Repository)  │  │   (Repository)  │  │   (Cache)    │ │
│  └─────────────────┘  └─────────────────┘  └──────────────┘ │
└─────────────────────────────────────────────────────────────┘
```

### 核心模块

1. **问卷模块 (Questionnaire)** - 问卷的创建、编辑、发布和管理
2. **问题模块 (Question)** - 可扩展的题型系统，支持多种问题类型
3. **答卷模块 (AnswerSheet)** - 答卷的收集、存储和查询
4. **答案模块 (Answer)** - 灵活的答案值系统，支持多种数据类型
5. **用户模块 (User)** - 用户管理和权限控制
6. **医学量表模块 (Medical Scale)** - 专业的医学量表支持

## 技术栈

- **语言**: Go 1.21+
- **架构模式**: 领域驱动设计 (DDD) + 六边形架构
- **设计模式**: 工厂模式、构建器模式、策略模式、适配器模式
- **数据库**: MySQL (主数据) + MongoDB (答卷数据)
- **缓存**: Redis
- **API**: RESTful + gRPC
- **认证**: JWT + RBAC

## 目录结构

```text
apiserver/
├── application/           # 应用服务层
│   ├── dto/              # 数据传输对象
│   ├── mapper/           # 数据映射器
│   ├── questionnaire/    # 问卷应用服务
│   ├── answersheet/      # 答卷应用服务
│   ├── user/             # 用户应用服务
│   └── medical-scale/    # 医学量表应用服务
├── domain/               # 领域层
│   ├── questionnaire/    # 问卷聚合根
│   ├── question/         # 问题实体
│   │   ├── question-types/ # 问题类型实现
│   │   ├── option/       # 选项值对象
│   │   ├── validation/   # 校验规则
│   │   └── calculation/  # 计算规则
│   ├── answer/           # 答案值对象
│   │   └── answer-values/ # 答案值类型
│   ├── answersheet/      # 答卷聚合根
│   ├── user/             # 用户实体
│   └── medical-scale/    # 医学量表聚合根
├── infrastructure/       # 基础设施层
│   ├── mysql/           # MySQL 存储实现
│   ├── mongo/           # MongoDB 存储实现
│   └── redis/           # Redis 缓存实现
├── interface/           # 接口层
│   ├── restful/         # REST API
│   └── grpc/            # gRPC API
└── config/              # 配置管理
```

## 核心特性

### 1. 可扩展的题型系统

- **基础题型**: 单选、多选、文本、数字、文本域、段落
- **扩展机制**: 工厂模式 + 注册表，支持动态添加新题型
- **能力组合**: 校验能力、计算能力、选项能力的灵活组合

### 2. 灵活的答案值系统

- **类型安全**: 每种题型对应专门的答案值类型
- **工厂模式**: 根据题型自动创建对应的答案值对象
- **扩展性**: 支持添加新的答案值类型

### 3. 强大的校验系统

- **规则引擎**: 支持多种校验规则类型
- **组合校验**: 一个问题可以应用多个校验规则
- **可扩展**: 支持自定义校验规则

### 4. 智能计算系统

- **公式引擎**: 支持多种计算公式
- **策略模式**: 不同的计算策略可以灵活切换
- **可扩展**: 支持添加新的计算策略

### 5. 版本管理

- **问卷版本**: 支持问卷的版本控制和历史追踪
- **状态管理**: 草稿、发布、归档等状态管理
- **克隆功能**: 支持问卷的克隆和分支

## 设计原则

### 1. 领域驱动设计 (DDD)

- **聚合根**: 问卷、答卷作为聚合根管理其内部实体
- **实体**: 问题、用户等具有唯一标识的对象
- **值对象**: 答案、选项等不可变的对象
- **领域服务**: 问卷服务、版本服务等业务逻辑

### 2. 六边形架构

- **端口**: 定义与外部系统的接口契约
- **适配器**: 实现具体的接口适配
- **依赖倒置**: 依赖抽象而非具体实现

### 3. SOLID 原则

- **单一职责**: 每个类只负责一个功能
- **开闭原则**: 对扩展开放，对修改关闭
- **里氏替换**: 子类可以替换父类
- **接口隔离**: 客户端不应该依赖不需要的接口
- **依赖倒置**: 依赖抽象而非具体实现

## 扩展指南

### 1. 添加新的题型

```go
// 1. 定义新题型
const QuestionTypeCustom QuestionType = "Custom"

// 2. 实现题型结构
type CustomQuestion struct {
    BaseQuestion
    validation.ValidationAbility
    calculation.CalculationAbility
    // 自定义字段
}

// 3. 注册到工厂
func init() {
    RegisterQuestionFactory(QuestionTypeCustom, func(builder *QuestionBuilder) Question {
        // 创建逻辑
    })
}
```

### 2. 添加新的答案值类型

```go
// 1. 实现答案值接口
type CustomValue struct {
    // 自定义字段
}

func (v CustomValue) Raw() any {
    // 返回原始值
}

// 2. 在工厂中添加创建逻辑
case QuestionTypeCustom:
    return CustomValue{...}
```

### 3. 添加新的校验规则

```go
// 1. 定义规则类型
const RuleTypeCustom RuleType = "custom"

// 2. 实现校验逻辑
func (r *CustomValidationRule) Validate(value any) error {
    // 校验逻辑
}
```

## 总结

API Server 通过领域驱动设计和六边形架构，实现了高度可扩展的问卷和答卷系统。其核心优势包括：

1. **可扩展性**: 支持动态添加新的题型和答案类型
2. **可维护性**: 清晰的架构和模块化设计
3. **高性能**: 优化的数据库查询和缓存策略
4. **可靠性**: 完善的错误处理和监控机制
5. **灵活性**: 支持多种配置和部署方式

该服务为问卷量表系统提供了强大的基础能力，支持复杂的业务场景和未来的功能扩展。 