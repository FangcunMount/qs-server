# 11-05-01 Scale 子域架构总览

> **版本**：V2.0  
> **最后更新**：2025-11-29  
> **状态**：✅ 已实现并验证

---

## 📋 文档导航

**当前位置**：Scale 子域架构总览（你在这里）  
**后续阅读**：[11-05-02 MedicalScale聚合与领域服务](./11-05-02-MedicalScale聚合与领域服务.md)

---

## 🎯 核心设计思想（30秒速览）

> **如果只有30秒，你需要知道这些：**

```text
┌────────────────────────────────────────────────────────────────────────────┐
│                                                                            │
│   Scale = 量表配置中心 = "定义如何计分和解读"                              │
│                                                                            │
│   ┌─────────────────┐                                                      │
│   │  MedicalScale   │  ← 唯一聚合根                                        │
│   │   (量表配置)    │                                                      │
│   │  ┌───────────┐  │                                                      │
│   │  │  Factor   │  │  ← 因子实体（测量维度）                              │
│   │  │ ┌───────┐ │  │                                                      │
│   │  │ │ Rule  │ │  │  ← 解读规则（值对象）                                │
│   │  │ └───────┘ │  │                                                      │
│   │  └───────────┘  │                                                      │
│   └─────────────────┘                                                      │
│            │                                                               │
│            │ 提供配置                                                      │
│            ▼                                                               │
│   ┌─────────────────────────────────────────────────────────────────────┐ │
│   │  Evaluation 子域                                                    │ │
│   │  Calculation ──▶ Interpretation ──▶ Report                         │ │
│   │  (执行计算)      (执行解读)          (生成报告)                      │ │
│   └─────────────────────────────────────────────────────────────────────┘ │
│                                                                            │
├────────────────────────────────────────────────────────────────────────────┤
│  核心设计模式：                                                            │
│    ✓ 聚合模式 - MedicalScale 管理 Factor 和 Rule 的一致性                 │
│    ✓ Option 模式 - 灵活构造复杂对象                                       │
│    ✓ 领域服务分离 - Lifecycle / FactorManager / Validator                │
│    ✓ 状态机 - Draft → Published → Archived                               │
└────────────────────────────────────────────────────────────────────────────┘
```

---

## 一、为什么需要 Scale 子域？（问题域）

### 1.1 业务场景：管理员配置"抑郁自评量表"

```text
┌─────────────────────────────────────────────────────────────────────────────┐
│  场景：管理员需要在系统中配置一个心理测评量表                                      │
│                                                                             │
│  需求：                                                                      │
│    1. 定义量表基本信息（标题、描述、关联问卷）                                     │
│    2. 划分测量维度（因子）                                                     │
│       - 精神情感症状（Q1-Q5）                                                  │
│       - 躯体症状（Q6-Q10）                                                    │
│       - 精神运动障碍（Q11-Q15）                                                │
│       - 抑郁心理障碍（Q16-Q20）                                                │
│       - 总分（全部题目）                                                       │
│    3. 配置每个因子的计分方式                                                    │
│       - 精神情感症状：求和                                                     │
│       - 总分：加权求和                                                        │
│    4. 配置每个因子的解读规则                                                    │
│       - [0, 53) → 正常                                                       │
│       - [53, 63) → 轻度抑郁                                                   │
│       - [63, 73) → 中度抑郁                                                   │
│       - [73, 100] → 重度抑郁                                                  │
│    5. 发布量表，供测评使用                                                      │
│                                                                              │
│  期望：                                                                       │
│    ✅ 量表配置完成后，Evaluation 子域可读取并执行计算和解读                         │
│    ✅ 支持草稿→发布→归档的生命周期管理                                            │
│    ✅ 发布前验证配置完整性                                                      │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

### 1.2 问题拆解与解决方案

| 问题 | 挑战 | Scale 的解决方案 |
|------|------|-----------------|
| **配置复杂** | 量表包含多因子，因子包含多规则 | **聚合模式** - 统一管理一致性 |
| **构造灵活** | 创建/重建对象参数多 | **Option 模式** - 可选参数灵活组合 |
| **生命周期** | 草稿、发布、归档状态管理 | **状态机** - 合法状态转换 |
| **发布验证** | 发布前需校验完整性 | **Validator** - 发布前验证 |
| **职责分离** | 聚合根方法过多 | **领域服务分离** - 按职责拆分 |

### 1.3 职责边界

```text
┌─────────────────────────────────────────────────────────────────────────────┐
│                          Scale 子域边界                                     │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  ✅ 我负责的（配置层）：                 ❌ 我不关心的（执行层）：          │
│    • 量表基本信息管理                     • 如何执行计算 → Calculation      │
│    • 因子结构定义                         • 如何执行解读 → Interpretation   │
│    • 计分策略配置                         • 测评流程管理 → Assessment       │
│    • 解读规则配置                         • 报告生成导出 → Report           │
│    • 生命周期管理                         • 问卷结构定义 → Survey           │
│                                                                             │
│  核心定位：                                                                 │
│    Scale 定义"规则是什么" → Evaluation 执行"规则怎么用"                   │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

---

## 二、整体架构（是什么？）

### 2.1 与 Evaluation 子域的协作

```text
┌─────────────────────────────────────────────────────────────────────────────┐
│                     Scale 与 Evaluation 的协作关系                          │
│                                                                             │
│   ┌─────────────────────────────────────────────────────────────────────┐  │
│   │  Scale 子域 (配置层) - "定义规则"                                   │  │
│   │                                                                     │  │
│   │  MedicalScale                                                       │  │
│   │  ├── title: "抑郁自评量表"                                         │  │
│   │  ├── questionnaireCode: "SDS-Q001"                                 │  │
│   │  └── factors:                                                       │  │
│   │      ├── Factor: "精神情感症状"                                    │  │
│   │      │   ├── questionCodes: [Q1, Q2, Q3, Q4, Q5]                   │  │
│   │      │   ├── scoringStrategy: "sum"        ──────────────────┐     │  │
│   │      │   └── interpretRules:                                  │     │  │
│   │      │       ├── [0,20) → "正常"           ──────────────┐   │     │  │
│   │      │       └── [20,40) → "轻度"                        │   │     │  │
│   │      └── Factor: "总分" (isTotalScore=true)              │   │     │  │
│   │                                                          │   │     │  │
│   └──────────────────────────────────────────────────────────┼───┼─────┘  │
│                                                              │   │        │
│                              提供配置                        │   │        │
│                                                              ▼   ▼        │
│   ┌─────────────────────────────────────────────────────────────────────┐  │
│   │  Evaluation 子域 (执行层) - "应用规则"                              │  │
│   │                                                                     │  │
│   │  1. Calculation: 读取 scoringStrategy，执行计算                    │  │
│   │     strategy := GetStrategy("sum")                                 │  │
│   │     score := strategy.Calculate([2,3,1,4,2])  // = 12              │  │
│   │                                                                     │  │
│   │  2. Interpretation: 读取 interpretRules，执行解读                  │  │
│   │     for rule in interpretRules:                                    │  │
│   │         if rule.Contains(12): return rule.RiskLevel               │  │
│   │                                                                     │  │
│   │  3. Report: 组装解读结果，生成报告                                 │  │
│   │                                                                     │  │
│   └─────────────────────────────────────────────────────────────────────┘  │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

### 2.2 六边形架构视图

```text
┌─────────────────────────────────────────────────────────────────────────────┐
│                              Interface Layer                                │
│  ┌──────────────────────────────────────────────────────────────────────┐  │
│  │  RESTful Handler (ScaleHandler)                                      │  │
│  │  POST /scales, PUT /scales/:code, POST /scales/:code/publish ...    │  │
│  └───────────────────────────────────┬──────────────────────────────────┘  │
└──────────────────────────────────────┼──────────────────────────────────────┘
                                       │
┌──────────────────────────────────────┼──────────────────────────────────────┐
│                              Application Layer                              │
│  ┌───────────────────┐ ┌───────────────────┐ ┌───────────────────┐         │
│  │LifecycleService   │ │  FactorService    │ │  QueryService     │         │
│  │ (管理员)          │ │  (因子编辑)       │ │  (所有用户)       │         │
│  │ Create/Publish/   │ │ AddFactor/        │ │ GetByCode/        │         │
│  │ Archive           │ │ RemoveFactor      │ │ ListPublished     │         │
│  └─────────┬─────────┘ └─────────┬─────────┘ └─────────┬─────────┘         │
└────────────┼─────────────────────┼─────────────────────┼────────────────────┘
             │                     │                     │
┌────────────┼─────────────────────┼─────────────────────┼────────────────────┐
│            ▼                     ▼                     ▼     Domain Layer   │
│  ┌──────────────────────────────────────────────────────────────────────┐  │
│  │                     MedicalScale (聚合根)                            │  │
│  │  ┌──────────┐  ┌──────────┐  ┌──────────┐                           │  │
│  │  │  Factor  │  │  Factor  │  │  Factor  │  (实体)                   │  │
│  │  │ ├─Rule   │  │ ├─Rule   │  │ ├─Rule   │  (值对象)                 │  │
│  │  │ └─Rule   │  │ └─Rule   │  │ └─Rule   │                           │  │
│  │  └──────────┘  └──────────┘  └──────────┘                           │  │
│  └──────────────────────────────────────────────────────────────────────┘  │
│                                                                             │
│  ┌────────────┐ ┌────────────┐ ┌──────────────┐ ┌────────────┐            │
│  │ Lifecycle  │ │  BaseInfo  │ │FactorManager │ │ Validator  │ 领域服务   │
│  └────────────┘ └────────────┘ └──────────────┘ └────────────┘            │
│                                                                             │
│  ┌──────────────────────────────────────────────────────────────────────┐  │
│  │                      Repository (出站端口)                           │  │
│  └───────────────────────────────────┬──────────────────────────────────┘  │
└──────────────────────────────────────┼──────────────────────────────────────┘
                                       │ 依赖倒置
┌──────────────────────────────────────┼──────────────────────────────────────┐
│                              Infrastructure Layer                           │
│  ┌──────────────────────────────────────────────────────────────────────┐  │
│  │               MongoDB Repository (适配器实现)                        │  │
│  │  ┌──────────┐  ┌──────────┐  ┌──────────┐                           │  │
│  │  │ ScalePO  │  │ FactorPO │  │  Mapper  │                           │  │
│  │  └──────────┘  └──────────┘  └──────────┘                           │  │
│  └──────────────────────────────────────────────────────────────────────┘  │
└─────────────────────────────────────────────────────────────────────────────┘
```

### 2.3 状态机设计

```text
┌─────────────────────────────────────────────────────────────────────────────┐
│                       MedicalScale 状态机                                   │
│                                                                             │
│         创建                 发布                  归档                     │
│    ┌──────────┐         ┌──────────┐         ┌──────────┐                  │
│    │          │ Publish │          │ Archive │          │                  │
│    │  Draft   │────────▶│Published │────────▶│ Archived │                  │
│    │  (草稿)  │         │ (已发布) │         │ (已归档) │                  │
│    │          │◀────────│          │         │          │                  │
│    └──────────┘Unpublish└──────────┘         └──────────┘                  │
│         │                    │                                              │
│         │                    │                                              │
│         ▼                    ▼                                              │
│    可编辑因子            不可编辑                                           │
│    可修改信息            仅可查询                                           │
│                          可被 Evaluation 使用                               │
│                                                                             │
│  状态转换规则：                                                             │
│    • Draft → Published: 需通过 Validator 验证                              │
│    • Published → Draft: Unpublish（取消发布）                              │
│    • Published → Archived: 归档（不可逆）                                  │
│    • Archived: 终态，不可变更                                              │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

---

## 三、目录结构

```text
internal/apiserver/
├── domain/scale/                    # 领域层
│   ├── types.go                     # 类型定义（Status, FactorCode, RiskLevel）
│   ├── medical_scale.go             # 聚合根
│   ├── factor.go                    # 因子实体
│   ├── interpretation_rule.go       # 解读规则值对象
│   ├── lifecycle.go                 # 生命周期领域服务
│   ├── baseinfo.go                  # 基础信息领域服务
│   ├── factor_manager.go            # 因子管理领域服务
│   ├── validator.go                 # 发布验证器
│   └── repository.go                # 仓储接口（出站端口）
│
├── application/scale/               # 应用层
│   ├── interface.go                 # 服务接口定义
│   ├── dto.go                       # 数据传输对象
│   ├── converter.go                 # DTO ↔ Domain 转换
│   ├── lifecycle_service.go         # 生命周期服务
│   ├── factor_service.go            # 因子服务
│   └── query_service.go             # 查询服务
│
├── infra/mongo/scale/               # 基础设施层
│   ├── po.go                        # 持久化对象
│   ├── mapper.go                    # PO ↔ Domain 映射
│   └── repo.go                      # MongoDB 仓储实现
│
└── interface/restful/handler/       # 接口层
    └── scale.go                     # RESTful Handler
```

---

## 四、核心领域概念一览

```text
┌─────────────────────────────────────────────────────────────────────────────┐
│                          Scale 子域核心概念                                 │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │  MedicalScale (聚合根)                                              │   │
│  │  ─────────────────────────────────────────────────────────────────  │   │
│  │  • 量表的完整定义                                                   │   │
│  │  • 管理 Factor 实体的生命周期                                       │   │
│  │  • 状态机：Draft → Published → Archived                            │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│       │                                                                     │
│       │ 包含 1:N                                                           │
│       ▼                                                                     │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │  Factor (实体)                                                      │   │
│  │  ─────────────────────────────────────────────────────────────────  │   │
│  │  • 测量维度（如"情感症状"、"躯体症状"）                            │   │
│  │  • 关联题目列表（questionCodes）                                    │   │
│  │  • 计分策略配置（scoringStrategy + params）                        │   │
│  │  • 解读规则列表（interpretRules）                                   │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│       │                                                                     │
│       │ 包含 1:N                                                           │
│       ▼                                                                     │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │  InterpretationRule (值对象)                                        │   │
│  │  ─────────────────────────────────────────────────────────────────  │   │
│  │  • 分数区间 [min, max) → 风险等级 + 结论 + 建议                    │   │
│  │  • 不可变，按内容判等                                               │   │
│  │  • 左闭右开区间，保证连续无缝                                       │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│                                                                             │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │  领域服务                                                           │   │
│  │  ─────────────────────────────────────────────────────────────────  │   │
│  │  • Lifecycle: 状态流转（Publish / Unpublish / Archive）            │   │
│  │  • BaseInfo: 基础信息更新（Title / Description）                   │   │
│  │  • FactorManager: 因子增删改（Add / Remove / Replace）             │   │
│  │  • Validator: 发布前验证（校验配置完整性）                          │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

---

## 五、代码索引

| 文件 | 职责 | 路径 |
|------|------|------|
| `medical_scale.go` | 聚合根 | `internal/apiserver/domain/scale/` |
| `factor.go` | 因子实体 | 同上 |
| `interpretation_rule.go` | 解读规则值对象 | 同上 |
| `types.go` | 类型定义 | 同上 |
| `lifecycle.go` | 生命周期服务 | 同上 |
| `baseinfo.go` | 基础信息服务 | 同上 |
| `factor_manager.go` | 因子管理服务 | 同上 |
| `validator.go` | 发布验证器 | 同上 |
| `repository.go` | 仓储接口 | 同上 |

---

## 📖 延伸阅读

- **后一篇**：[11-05-02 MedicalScale聚合与领域服务](./11-05-02-MedicalScale聚合与领域服务.md) - 深入聚合根和领域服务设计
- **相关子域**：[11-06 Evaluation子域设计](../evaluation%20模块设计/README.md) - 了解 Scale 配置如何被使用
