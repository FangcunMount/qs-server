# 11-05-02 MedicalScale 聚合与领域服务设计

> **版本**：V2.0  
> **最后更新**：2025-11-29  
> **状态**：✅ 已实现并验证

---

## 📋 文档导航

**前一篇**：[11-05-01 Scale子域架构总览](./11-05-01-Scale子域架构总览.md)  
**相关文档**：[11-06 Evaluation子域设计](../evaluation%20模块设计/README.md)

---

## 🎯 核心设计思想（30秒速览）

> **如果只有30秒，你需要知道这些：**

```text
┌────────────────────────────────────────────────────────────────────────────┐
│                                                                            │
│   MedicalScale 聚合 = 量表配置的完整封装                                   │
│                                                                            │
│   ┌─────────────────────────────────────────────────────────────────────┐ │
│   │  MedicalScale (聚合根)                                              │ │
│   │  ════════════════════════════════════════════════════════════════  │ │
│   │  • scaleCode: "SDS-001"                                            │ │
│   │  • title: "抑郁自评量表"                                           │ │
│   │  • status: Draft → Published → Archived                           │ │
│   │  • questionnaireCode: "Q-SDS-001"                                  │ │
│   │                                                                     │ │
│   │  ┌───────────────────────────────────────────────────────────────┐ │ │
│   │  │  factors: []*Factor                                           │ │ │
│   │  │  ─────────────────────────────────────────────────────────────│ │ │
│   │  │  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐        │ │ │
│   │  │  │   Factor 1   │  │   Factor 2   │  │   Factor 3   │  ...   │ │ │
│   │  │  │ (精神情感)   │  │  (躯体症状)  │  │   (总分)     │        │ │ │
│   │  │  │              │  │              │  │ isTotalScore │        │ │ │
│   │  │  │ ┌──────────┐ │  │ ┌──────────┐ │  │ ┌──────────┐ │        │ │ │
│   │  │  │ │  Rules   │ │  │ │  Rules   │ │  │ │  Rules   │ │        │ │ │
│   │  │  │ └──────────┘ │  │ └──────────┘ │  │ └──────────┘ │        │ │ │
│   │  │  └──────────────┘  └──────────────┘  └──────────────┘        │ │ │
│   │  └───────────────────────────────────────────────────────────────┘ │ │
│   └─────────────────────────────────────────────────────────────────────┘ │
│                                                                            │
│   领域服务：围绕聚合根，按职责拆分                                         │
│   ┌──────────┐ ┌──────────┐ ┌──────────────┐ ┌──────────┐                │
│   │Lifecycle │ │ BaseInfo │ │FactorManager │ │Validator │                │
│   │发布/归档 │ │更新信息  │ │ 增删改因子   │ │发布验证  │                │
│   └──────────┘ └──────────┘ └──────────────┘ └──────────┘                │
│                                                                            │
├────────────────────────────────────────────────────────────────────────────┤
│  核心设计模式：                                                            │
│    ✓ Option 模式 - 灵活构造复杂对象                                       │
│    ✓ 领域服务分离 - 避免聚合根膨胀                                        │
│    ✓ 值对象不可变 - InterpretationRule                                    │
│    ✓ 私有方法暴露 - 领域服务调用聚合内部方法                              │
└────────────────────────────────────────────────────────────────────────────┘
```

---

## 一、问题域：为什么这样设计？

### 1.1 场景一：创建量表时参数多且可选

```text
┌─────────────────────────────────────────────────────────────────────────────┐
│  问题：创建 MedicalScale 时，参数组合多样化                                 │
│                                                                             │
│  必填参数：                     可选参数：                                  │
│    • scaleCode                   • description                             │
│    • title                       • questionnaireCode                       │
│                                  • questionnaireVersion                    │
│                                  • factors                                 │
│                                  • status (重建时需要)                     │
│                                                                             │
│  传统方式的问题：                                                           │
│    ❌ 构造函数参数爆炸                                                      │
│    ❌ 多个重载构造函数难以维护                                              │
│    ❌ 可选参数用零值无法区分"未设置"和"设置为空"                           │
│                                                                             │
├─────────────────────────────────────────────────────────────────────────────┤
│  解决方案：Option 模式                                                      │
│                                                                             │
│  scale, err := NewMedicalScale(                                            │
│      scaleCode,                        // 必填                              │
│      title,                            // 必填                              │
│      WithDescription("..."),           // 可选                              │
│      WithQuestionnaire(qCode, qVer),   // 可选                              │
│      WithFactors(factors),             // 可选                              │
│  )                                                                          │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

### 1.2 场景二：聚合根方法过多导致膨胀

```text
┌─────────────────────────────────────────────────────────────────────────────┐
│  问题：所有操作都放在聚合根，导致 MedicalScale 代码膨胀                     │
│                                                                             │
│  如果把所有方法都放聚合根：                                                 │
│    • Publish(), Unpublish(), Archive()     // 生命周期                     │
│    • UpdateTitle(), UpdateDescription()    // 基础信息                     │
│    • AddFactor(), RemoveFactor(), ...      // 因子管理                     │
│    • ValidateForPublish()                  // 验证                         │
│                                                                             │
│  问题：                                                                     │
│    ❌ 聚合根代码行数膨胀（可能超过500行）                                   │
│    ❌ 职责不清晰，难以维护                                                  │
│    ❌ 不同角色关注点混杂（管理员关注发布，编辑者关注因子）                  │
│                                                                             │
├─────────────────────────────────────────────────────────────────────────────┤
│  解决方案：领域服务按职责拆分                                               │
│                                                                             │
│  ┌────────────────────────────────────────────────────────────────────────┐│
│  │  MedicalScale (聚合根)                                                 ││
│  │  ───────────────────────────────────────────────────────────────────── ││
│  │  ✅ 状态与数据：字段 + Getter                                          ││
│  │  ✅ 业务查询：FindFactorByCode, GetTotalScoreFactor                   ││
│  │  ✅ 私有修改方法：updateStatus, addFactor, removeFactor               ││
│  │  ⚠️  不直接暴露修改方法，通过领域服务协调                              ││
│  └────────────────────────────────────────────────────────────────────────┘│
│                        │                                                    │
│                        │ 调用私有方法                                       │
│                        ▼                                                    │
│  ┌──────────────┐ ┌──────────────┐ ┌──────────────┐ ┌──────────────┐       │
│  │  Lifecycle   │ │   BaseInfo   │ │FactorManager │ │  Validator   │       │
│  │  Publish()   │ │UpdateTitle() │ │ AddFactor()  │ │ValidateFor   │       │
│  │  Unpublish() │ │UpdateDesc()  │ │RemoveFactor()│ │  Publish()   │       │
│  │  Archive()   │ │UpdateQ'naire │ │ReplaceFactors│ │              │       │
│  └──────────────┘ └──────────────┘ └──────────────┘ └──────────────┘       │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

### 1.3 场景三：因子与解读规则的嵌套结构

```text
┌─────────────────────────────────────────────────────────────────────────────┐
│  问题：量表包含因子，因子包含解读规则，如何保证一致性？                     │
│                                                                             │
│  数据结构：                                                                 │
│    MedicalScale                                                            │
│      └── factors: []*Factor        (1:N)                                   │
│            └── interpretRules: []InterpretationRule  (1:N)                 │
│                                                                             │
│  一致性要求：                                                               │
│    1. 每个量表必须有且仅有一个总分因子                                     │
│    2. 因子编码在量表内唯一                                                 │
│    3. 非总分因子必须包含题目                                               │
│    4. 每个因子必须有解读规则                                               │
│    5. 解读规则的分数区间必须有效                                           │
│                                                                             │
├─────────────────────────────────────────────────────────────────────────────┤
│  解决方案：聚合模式 + 验证器                                                │
│                                                                             │
│  ┌───────────────────────────────────────────────────────────────────────┐ │
│  │  聚合边界内的一致性由聚合根保证                                       │ │
│  │                                                                       │ │
│  │  MedicalScale                                                         │ │
│  │    │                                                                  │ │
│  │    ├── addFactor(): 检查编码唯一性                                   │ │
│  │    ├── FindFactorByCode(): 内部查找                                  │ │
│  │    └── GetTotalScoreFactor(): 查找总分因子                           │ │
│  │                                                                       │ │
│  │  发布前验证（Validator）：                                            │ │
│  │    • 检查是否有总分因子                                               │ │
│  │    • 检查每个因子的完整性                                             │ │
│  │    • 检查解读规则有效性                                               │ │
│  │                                                                       │ │
│  └───────────────────────────────────────────────────────────────────────┘ │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

---

## 二、MedicalScale 聚合根

### 2.1 结构定义

```text
┌─────────────────────────────────────────────────────────────────────────────┐
│  MedicalScale 聚合根结构                                                    │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  // 代码链接: domain/scale/medical_scale.go                                │
│                                                                             │
│  type MedicalScale struct {                                                │
│      // === 标识 ===                                                       │
│      id        meta.ID      // MongoDB ObjectID                           │
│      scaleCode meta.Code    // 业务编码 "SDS-001"                          │
│                                                                             │
│      // === 基本信息 ===                                                   │
│      title       string     // 量表标题                                    │
│      description string     // 量表描述                                    │
│                                                                             │
│      // === 关联问卷 ===                                                   │
│      questionnaireCode    meta.Code  // 问卷编码                           │
│      questionnaireVersion string     // 问卷版本                           │
│                                                                             │
│      // === 状态 ===                                                       │
│      status Status          // Draft | Published | Archived               │
│                                                                             │
│      // === 因子列表（聚合边界内） ===                                     │
│      factors []*Factor      // 包含多个因子                                │
│  }                                                                          │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

### 2.2 Option 模式构造

```text
┌─────────────────────────────────────────────────────────────────────────────┐
│  Option 模式：灵活构造 MedicalScale                                         │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  // 代码链接: domain/scale/medical_scale.go                                │
│                                                                             │
│  // 1. 定义 Option 函数类型                                                │
│  type MedicalScaleOption func(*MedicalScale)                               │
│                                                                             │
│  // 2. 构造函数：必填参数 + 可变 Option                                    │
│  func NewMedicalScale(                                                      │
│      scaleCode meta.Code,                                                  │
│      title string,                                                         │
│      opts ...MedicalScaleOption,                                           │
│  ) (*MedicalScale, error)                                                  │
│                                                                             │
│  // 3. Option 工厂函数                                                     │
│  ┌────────────────────────────────────────────────────────────────────────┐│
│  │  WithID(id)             → 设置 ID（重建时使用）                        ││
│  │  WithDescription(desc)  → 设置描述                                     ││
│  │  WithQuestionnaire(code, version) → 设置关联问卷                       ││
│  │  WithStatus(status)     → 设置状态（重建时使用）                       ││
│  │  WithFactors(factors)   → 设置因子列表（重建时使用）                   ││
│  └────────────────────────────────────────────────────────────────────────┘│
│                                                                             │
│  // 4. 使用示例                                                            │
│  scale, err := NewMedicalScale(                                            │
│      meta.NewCode("SDS-001"),                                              │
│      "抑郁自评量表",                                                        │
│      WithDescription("用于评估抑郁程度"),                                  │
│      WithQuestionnaire(meta.NewCode("Q-001"), "v1.0"),                     │
│  )                                                                          │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

### 2.3 状态机设计

```text
┌─────────────────────────────────────────────────────────────────────────────┐
│  MedicalScale 状态流转                                                      │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  // 代码链接: domain/scale/types.go                                        │
│                                                                             │
│  type Status uint8                                                         │
│  const (                                                                    │
│      StatusDraft     Status = 0  // 草稿                                   │
│      StatusPublished Status = 1  // 已发布                                 │
│      StatusArchived  Status = 2  // 已归档                                 │
│  )                                                                          │
│                                                                             │
│  状态转换图：                                                               │
│  ════════════════════════════════════════════════════════════════════════  │
│                                                                             │
│         ┌──────────────────────────────────────────────────┐               │
│         │                                                  │               │
│         │     Publish()              Archive()             │               │
│         │   (需通过验证)            (不可逆)               │               │
│         ▼         │                    │                   │               │
│     ┌───────┐     │     ┌──────────┐   │    ┌──────────┐  │               │
│     │       │─────┼────▶│          │───┼───▶│          │  │               │
│     │ Draft │     │     │Published │   │    │ Archived │  │               │
│     │       │◀────┼─────│          │   │    │          │  │               │
│     └───────┘     │     └──────────┘   │    └──────────┘  │               │
│         ▲         │          │         │                   │               │
│         │         │    Unpublish()     │                   │               │
│         │         │   (恢复为草稿)     │                   │               │
│         │         │                    │                   │               │
│         └─────────┴────────────────────┴───────────────────┘               │
│                                                                             │
│  状态权限矩阵：                                                             │
│  ════════════════════════════════════════════════════════════════════════  │
│  ┌──────────────┬───────────┬────────────┬───────────┐                     │
│  │    操作      │   Draft   │ Published  │ Archived  │                     │
│  ├──────────────┼───────────┼────────────┼───────────┤                     │
│  │ 编辑因子     │    ✅     │     ❌      │    ❌     │                     │
│  │ 修改基础信息 │    ✅     │     ❌      │    ❌     │                     │
│  │ 发布         │    ✅     │     ❌      │    ❌     │                     │
│  │ 取消发布     │    ❌     │     ✅      │    ❌     │                     │
│  │ 归档         │    ❌     │     ✅      │    ❌     │                     │
│  │ 被 Eval 使用 │    ❌     │     ✅      │    ❌     │                     │
│  └──────────────┴───────────┴────────────┴───────────┘                     │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

### 2.4 业务查询方法

```text
┌─────────────────────────────────────────────────────────────────────────────┐
│  聚合根业务查询方法                                                         │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  // 代码链接: domain/scale/medical_scale.go                                │
│                                                                             │
│  ┌────────────────────────────────────────────────────────────────────────┐│
│  │  // 因子数量                                                           ││
│  │  func (m *MedicalScale) FactorCount() int                              ││
│  │                                                                        ││
│  │  // 根据编码查找因子                                                   ││
│  │  func (m *MedicalScale) FindFactorByCode(code FactorCode) (*Factor, bool)│
│  │                                                                        ││
│  │  // 获取总分因子                                                       ││
│  │  func (m *MedicalScale) GetTotalScoreFactor() (*Factor, bool)          ││
│  │                                                                        ││
│  │  // 获取非总分因子列表                                                 ││
│  │  func (m *MedicalScale) GetNonTotalScoreFactors() []*Factor            ││
│  └────────────────────────────────────────────────────────────────────────┘│
│                                                                             │
│  使用示例：                                                                 │
│  ════════════════════════════════════════════════════════════════════════  │
│                                                                             │
│  // 查找特定因子                                                           │
│  factor, ok := scale.FindFactorByCode(NewFactorCode("depression"))         │
│  if ok {                                                                   │
│      rules := factor.GetInterpretRules()                                  │
│      // 使用规则...                                                        │
│  }                                                                          │
│                                                                             │
│  // 获取总分因子                                                           │
│  totalFactor, ok := scale.GetTotalScoreFactor()                            │
│  if !ok {                                                                  │
│      return errors.New("量表缺少总分因子")                                 │
│  }                                                                          │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

---

## 三、Factor 实体

### 3.1 结构定义

```text
┌─────────────────────────────────────────────────────────────────────────────┐
│  Factor 因子实体                                                            │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  // 代码链接: domain/scale/factor.go                                       │
│                                                                             │
│  type Factor struct {                                                       │
│      // === 基本信息 ===                                                   │
│      code       FactorCode     // 因子编码 "depression"                    │
│      title      string         // 因子标题 "抑郁症状"                      │
│      factorType FactorType     // 类型 (primary | multilevel)             │
│                                                                             │
│      // === 总分标识 ===                                                   │
│      isTotalScore bool         // 是否为总分因子                           │
│                                                                             │
│      // === 题目关联 ===                                                   │
│      questionCodes []meta.Code // 该因子包含的题目编码                     │
│                                                                             │
│      // === 计分配置 ===                                                   │
│      scoringStrategy ScoringStrategyCode // 策略编码 (sum|avg|custom)     │
│      scoringParams   map[string]string   // 策略参数                       │
│                                                                             │
│      // === 解读规则 ===                                                   │
│      interpretRules []InterpretationRule // 解读规则列表                   │
│  }                                                                          │
│                                                                             │
│  ═════════════════════════════════════════════════════════════════════════ │
│                                                                             │
│  设计要点：                                                                 │
│    1. Factor 是实体（有标识 code），不是值对象                             │
│    2. Factor 隶属于 MedicalScale 聚合边界内                                │
│    3. 外部不能直接持有 Factor 引用，只能通过聚合根访问                     │
│    4. questionCodes 是逻辑关联，不持有 Question 对象                       │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

### 3.2 Option 模式构造

```text
┌─────────────────────────────────────────────────────────────────────────────┐
│  Factor 的 Option 模式                                                      │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  // 代码链接: domain/scale/factor.go                                       │
│                                                                             │
│  type FactorOption func(*Factor)                                           │
│                                                                             │
│  func NewFactor(                                                            │
│      factorCode FactorCode,                                                │
│      title string,                                                         │
│      opts ...FactorOption,                                                 │
│  ) (*Factor, error)                                                        │
│                                                                             │
│  // Option 工厂函数                                                        │
│  ┌────────────────────────────────────────────────────────────────────────┐│
│  │  WithFactorType(ft)        → 设置因子类型                              ││
│  │  WithIsTotalScore(bool)    → 设置是否为总分因子                        ││
│  │  WithQuestionCodes(codes)  → 设置关联题目                              ││
│  │  WithScoringStrategy(s)    → 设置计分策略                              ││
│  │  WithScoringParams(params) → 设置计分参数                              ││
│  │  WithInterpretRules(rules) → 设置解读规则                              ││
│  └────────────────────────────────────────────────────────────────────────┘│
│                                                                             │
│  使用示例：                                                                 │
│  ════════════════════════════════════════════════════════════════════════  │
│                                                                             │
│  // 创建一个普通因子                                                       │
│  factor, _ := NewFactor(                                                   │
│      NewFactorCode("emotion"),                                             │
│      "情感症状",                                                            │
│      WithQuestionCodes([]meta.Code{q1, q2, q3, q4, q5}),                   │
│      WithScoringStrategy(ScoringStrategySum),                              │
│      WithInterpretRules([]InterpretationRule{rule1, rule2}),               │
│  )                                                                          │
│                                                                             │
│  // 创建总分因子                                                           │
│  totalFactor, _ := NewFactor(                                              │
│      NewFactorCode("total"),                                               │
│      "总分",                                                                │
│      WithIsTotalScore(true),                                               │
│      WithScoringStrategy(ScoringStrategySum),                              │
│      WithInterpretRules(totalRules),                                       │
│  )                                                                          │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

### 3.3 业务方法

```text
┌─────────────────────────────────────────────────────────────────────────────┐
│  Factor 业务方法                                                            │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  // 代码链接: domain/scale/factor.go                                       │
│                                                                             │
│  ┌────────────────────────────────────────────────────────────────────────┐│
│  │  // 题目数量                                                           ││
│  │  func (f *Factor) QuestionCount() int                                  ││
│  │                                                                        ││
│  │  // 判断是否包含指定题目                                               ││
│  │  func (f *Factor) ContainsQuestion(code meta.Code) bool                ││
│  │                                                                        ││
│  │  // 根据分数查找匹配的解读规则                                         ││
│  │  func (f *Factor) FindInterpretRule(score float64) *InterpretationRule ││
│  └────────────────────────────────────────────────────────────────────────┘│
│                                                                             │
│  FindInterpretRule 流程图：                                                │
│  ════════════════════════════════════════════════════════════════════════  │
│                                                                             │
│     输入：score = 65.5                                                     │
│                │                                                            │
│                ▼                                                            │
│     ┌─────────────────────┐                                                │
│     │ for rule in rules:  │                                                │
│     │   if rule.Matches() │                                                │
│     └──────────┬──────────┘                                                │
│                │                                                            │
│     ┌──────────┼──────────────────────────────────────────────────────┐    │
│     │          ▼                                                      │    │
│     │  Rule1: [0, 53)   → 不匹配                                     │    │
│     │  Rule2: [53, 63)  → 不匹配                                     │    │
│     │  Rule3: [63, 73)  → ✅ 匹配！返回 &Rule3                       │    │
│     │  Rule4: [73, 100) → 跳过                                       │    │
│     │                                                                 │    │
│     └─────────────────────────────────────────────────────────────────┘    │
│                │                                                            │
│                ▼                                                            │
│     返回：Rule3 {RiskLevel: "medium", Conclusion: "中度抑郁"}              │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

---

## 四、InterpretationRule 值对象

### 4.1 结构定义

```text
┌─────────────────────────────────────────────────────────────────────────────┐
│  InterpretationRule 解读规则值对象                                          │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  // 代码链接: domain/scale/interpretation_rule.go                          │
│                                                                             │
│  type InterpretationRule struct {                                           │
│      scoreRange ScoreRange  // 分数区间 [min, max)                         │
│      riskLevel  RiskLevel   // 风险等级                                    │
│      conclusion string      // 结论文案                                    │
│      suggestion string      // 建议文案                                    │
│  }                                                                          │
│                                                                             │
│  ═════════════════════════════════════════════════════════════════════════ │
│                                                                             │
│  值对象特征：                                                               │
│    ✅ 无标识符（按内容判等）                                               │
│    ✅ 不可变（无 setter 方法）                                             │
│    ✅ 自包含验证（IsValid 方法）                                           │
│                                                                             │
│  方法列表：                                                                 │
│  ┌────────────────────────────────────────────────────────────────────────┐│
│  │  NewInterpretationRule(range, level, conclusion, suggestion)           ││
│  │  GetScoreRange() ScoreRange                                            ││
│  │  GetRiskLevel() RiskLevel                                              ││
│  │  GetConclusion() string                                                ││
│  │  GetSuggestion() string                                                ││
│  │  Matches(score float64) bool                                           ││
│  │  IsValid() bool                                                        ││
│  └────────────────────────────────────────────────────────────────────────┘│
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

### 4.2 ScoreRange 值对象

```text
┌─────────────────────────────────────────────────────────────────────────────┐
│  ScoreRange 分数区间值对象                                                  │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  // 代码链接: domain/scale/types.go                                        │
│                                                                             │
│  type ScoreRange struct {                                                   │
│      min float64                                                           │
│      max float64                                                           │
│  }                                                                          │
│                                                                             │
│  区间语义：左闭右开 [min, max)                                             │
│  ════════════════════════════════════════════════════════════════════════  │
│                                                                             │
│     0        53        63        73       100                              │
│     ├─────────┼─────────┼─────────┼─────────┤                              │
│     │ [0,53)  │[53,63)  │[63,73)  │[73,100) │                              │
│     │  正常   │轻度抑郁 │中度抑郁 │重度抑郁 │                              │
│     └─────────┴─────────┴─────────┴─────────┘                              │
│                                                                             │
│  优势：                                                                     │
│    ✅ 连续无缝：每个分数只落入一个区间                                     │
│    ✅ 边界清晰：53 属于 [53,63)，不属于 [0,53)                            │
│    ✅ 易于验证：min < max 即有效                                           │
│                                                                             │
│  方法：                                                                     │
│  ┌────────────────────────────────────────────────────────────────────────┐│
│  │  NewScoreRange(min, max) ScoreRange                                    ││
│  │  Min() float64                                                         ││
│  │  Max() float64                                                         ││
│  │  Contains(score float64) bool  // score >= min && score < max         ││
│  │  IsValid() bool                // min < max                           ││
│  └────────────────────────────────────────────────────────────────────────┘│
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

### 4.3 RiskLevel 风险等级

```text
┌─────────────────────────────────────────────────────────────────────────────┐
│  RiskLevel 风险等级枚举                                                     │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  // 代码链接: domain/scale/types.go                                        │
│                                                                             │
│  type RiskLevel string                                                      │
│                                                                             │
│  const (                                                                    │
│      RiskLevelNone   RiskLevel = "none"    // 无风险                       │
│      RiskLevelLow    RiskLevel = "low"     // 低风险                       │
│      RiskLevelMedium RiskLevel = "medium"  // 中风险                       │
│      RiskLevelHigh   RiskLevel = "high"    // 高风险                       │
│      RiskLevelSevere RiskLevel = "severe"  // 严重风险                     │
│  )                                                                          │
│                                                                             │
│  方法：                                                                     │
│  ┌────────────────────────────────────────────────────────────────────────┐│
│  │  String() string      // 返回字符串表示                                ││
│  │  IsValid() bool       // 检查是否为有效枚举值                          ││
│  └────────────────────────────────────────────────────────────────────────┘│
│                                                                             │
│  与 Evaluation 子域的对接：                                                │
│  ════════════════════════════════════════════════════════════════════════  │
│                                                                             │
│  Scale 定义：                          Evaluation 使用：                   │
│  ┌────────────────────┐               ┌────────────────────┐              │
│  │  RiskLevelHigh     │  ──────────▶  │  识别高危因子      │              │
│  │  RiskLevelSevere   │               │  触发预警通知      │              │
│  └────────────────────┘               └────────────────────┘              │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

---

## 五、领域服务设计

### 5.1 Lifecycle 生命周期服务

```text
┌─────────────────────────────────────────────────────────────────────────────┐
│  Lifecycle 生命周期领域服务                                                 │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  // 代码链接: domain/scale/lifecycle.go                                    │
│                                                                             │
│  type Lifecycle interface {                                                 │
│      Publish(ctx context.Context, scale *MedicalScale) error               │
│      Unpublish(ctx context.Context, scale *MedicalScale) error             │
│      Archive(ctx context.Context, scale *MedicalScale) error               │
│  }                                                                          │
│                                                                             │
│  Publish 流程图：                                                          │
│  ════════════════════════════════════════════════════════════════════════  │
│                                                                             │
│      ┌────────────────┐                                                    │
│      │ scale.IsArchived? ─────────▶ ❌ 已归档，不能发布                   │
│      └───────┬────────┘                                                    │
│              │ 否                                                          │
│              ▼                                                              │
│      ┌────────────────┐                                                    │
│      │scale.IsPublished?─────────▶ ❌ 已发布，无需重复                    │
│      └───────┬────────┘                                                    │
│              │ 否                                                          │
│              ▼                                                              │
│      ┌────────────────────────────────┐                                    │
│      │ Validator.ValidateForPublish() │                                    │
│      └───────┬────────────────────────┘                                    │
│              │                                                              │
│        ┌─────┴─────┐                                                       │
│        │           │                                                       │
│        ▼           ▼                                                       │
│     有错误      无错误                                                      │
│        │           │                                                       │
│        ▼           ▼                                                       │
│   ❌ 返回错误   scale.updateStatus(StatusPublished)                        │
│                    │                                                       │
│                    ▼                                                       │
│               ✅ 返回 nil                                                  │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

### 5.2 FactorManager 因子管理服务

```text
┌─────────────────────────────────────────────────────────────────────────────┐
│  FactorManager 因子管理领域服务                                             │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  // 代码链接: domain/scale/factor_manager.go                               │
│                                                                             │
│  type FactorManager struct{}                                               │
│                                                                             │
│  方法列表：                                                                 │
│  ┌────────────────────────────────────────────────────────────────────────┐│
│  │  AddFactor(m *MedicalScale, factor *Factor) error                      ││
│  │  RemoveFactor(m *MedicalScale, factorCode FactorCode) error            ││
│  │  RemoveAllFactors(m *MedicalScale)                                     ││
│  │  ReplaceFactors(m *MedicalScale, factors []*Factor) error              ││
│  │  UpdateFactor(m *MedicalScale, updatedFactor *Factor) error            ││
│  └────────────────────────────────────────────────────────────────────────┘│
│                                                                             │
│  ReplaceFactors 流程图（批量替换）：                                       │
│  ════════════════════════════════════════════════════════════════════════  │
│                                                                             │
│      ┌───────────────────────────────────────┐                             │
│      │ 1. 验证 factors 不为空                │                             │
│      └──────────────────┬────────────────────┘                             │
│                         │                                                   │
│                         ▼                                                   │
│      ┌───────────────────────────────────────┐                             │
│      │ 2. 遍历检查：                          │                             │
│      │    - factor 不为 nil                  │                             │
│      │    - code 不为空                      │                             │
│      │    - code 不重复                      │                             │
│      │    - 只有一个总分因子                  │                             │
│      └──────────────────┬────────────────────┘                             │
│                         │                                                   │
│                   ┌─────┴─────┐                                            │
│                   │           │                                            │
│                   ▼           ▼                                            │
│                验证失败    验证通过                                         │
│                   │           │                                            │
│                   ▼           ▼                                            │
│              ❌ 返回错误   m.updateFactors(factors)                        │
│                               │                                            │
│                               ▼                                            │
│                          ✅ 返回 nil                                       │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

### 5.3 Validator 验证器

```text
┌─────────────────────────────────────────────────────────────────────────────┐
│  Validator 发布验证器                                                       │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  // 代码链接: domain/scale/validator.go                                    │
│                                                                             │
│  type Validator struct{}                                                   │
│                                                                             │
│  func (Validator) ValidateForPublish(m *MedicalScale) []ValidationError   │
│                                                                             │
│  验证规则清单：                                                             │
│  ════════════════════════════════════════════════════════════════════════  │
│                                                                             │
│  ┌────┬────────────────────────┬────────────────────────────────────────┐  │
│  │ #  │        验证项          │              错误信息                  │  │
│  ├────┼────────────────────────┼────────────────────────────────────────┤  │
│  │ 1  │ title 不为空           │ "量表标题不能为空"                     │  │
│  │ 2  │ scaleCode 不为空       │ "量表编码不能为空"                     │  │
│  │ 3  │ factors 数量 > 0       │ "量表必须至少包含一个因子"             │  │
│  │ 4  │ 有且仅有一个总分因子   │ "量表必须包含一个总分因子"             │  │
│  │ 5  │ questionnaireCode 不空 │ "量表必须关联一个问卷"                 │  │
│  │ 6  │ questionnaireVersion   │ "量表必须指定关联问卷的版本"           │  │
│  └────┴────────────────────────┴────────────────────────────────────────┘  │
│                                                                             │
│  因子级验证：                                                               │
│  ════════════════════════════════════════════════════════════════════════  │
│                                                                             │
│  ┌────┬────────────────────────┬────────────────────────────────────────┐  │
│  │ #  │        验证项          │              错误信息                  │  │
│  ├────┼────────────────────────┼────────────────────────────────────────┤  │
│  │ 1  │ factor.title 不为空    │ "因子标题不能为空"                     │  │
│  │ 2  │ 非总分因子有题目       │ "非总分因子必须包含至少一个题目"       │  │
│  │ 3  │ 有解读规则             │ "因子必须包含至少一个解读规则"         │  │
│  │ 4  │ 规则有效               │ "解读规则无效（分数区间或风险等级）"   │  │
│  └────┴────────────────────────┴────────────────────────────────────────┘  │
│                                                                             │
│  ValidationError 结构：                                                    │
│  ┌────────────────────────────────────────────────────────────────────────┐│
│  │  type ValidationError struct {                                         ││
│  │      Field   string   // 字段名 "factor[depression].interpretRules"   ││
│  │      Message string   // 错误信息                                     ││
│  │  }                                                                     ││
│  └────────────────────────────────────────────────────────────────────────┘│
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

---

## 六、类型定义汇总

### 6.1 类型关系图

```text
┌─────────────────────────────────────────────────────────────────────────────┐
│                          Scale 子域类型体系                                 │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  // 代码链接: domain/scale/types.go                                        │
│                                                                             │
│  枚举类型：                                                                 │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │  Status          : uint8  (Draft=0, Published=1, Archived=2)       │   │
│  │  FactorType      : string (primary, multilevel)                    │   │
│  │  ScoringStrategyCode : string (sum, avg, custom)                   │   │
│  │  RiskLevel       : string (none, low, medium, high, severe)        │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│                                                                             │
│  标识类型：                                                                 │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │  FactorCode      : string (业务编码，如 "depression")               │   │
│  │  meta.Code       : string (通用业务编码)                            │   │
│  │  meta.ID         : string (MongoDB ObjectID)                        │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│                                                                             │
│  值对象：                                                                   │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │  ScoreRange         : {min, max float64}                            │   │
│  │  InterpretationRule : {ScoreRange, RiskLevel, conclusion, suggestion}│   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

### 6.2 与 Evaluation 的类型映射

```text
┌─────────────────────────────────────────────────────────────────────────────┐
│  Scale ↔ Evaluation 类型映射                                               │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  Scale (配置)                      Evaluation (执行)                       │
│  ═══════════════════════════════════════════════════════════════════════   │
│                                                                             │
│  ScoringStrategyCode "sum"    →    SumStrategy.Calculate()                │
│  ScoringStrategyCode "avg"    →    AverageStrategy.Calculate()            │
│  ScoringStrategyCode "custom" →    CustomStrategy + scoringParams         │
│                                                                             │
│  InterpretationRule           →    ThresholdStrategy.Interpret()          │
│    ├─ ScoreRange                   ├─ ScoreRange                          │
│    ├─ RiskLevel                    ├─ RiskLevel                           │
│    ├─ conclusion                   ├─ InterpretItem.Conclusion            │
│    └─ suggestion                   └─ InterpretItem.Suggestion            │
│                                                                             │
│  Factor.questionCodes         →    用于提取答案计算分数                   │
│  Factor.isTotalScore          →    区分因子得分 vs 总分                   │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

---

## 七、代码索引

| 模块 | 文件 | 核心类型/函数 |
|------|------|--------------|
| **聚合根** | `medical_scale.go` | `MedicalScale`, `NewMedicalScale`, `MedicalScaleOption` |
| **实体** | `factor.go` | `Factor`, `NewFactor`, `FactorOption` |
| **值对象** | `interpretation_rule.go` | `InterpretationRule`, `Matches()` |
| **类型定义** | `types.go` | `Status`, `FactorCode`, `RiskLevel`, `ScoreRange` |
| **生命周期** | `lifecycle.go` | `Lifecycle`, `Publish`, `Unpublish`, `Archive` |
| **基础信息** | `baseinfo.go` | `BaseInfo` 服务 |
| **因子管理** | `factor_manager.go` | `FactorManager`, `AddFactor`, `ReplaceFactors` |
| **验证器** | `validator.go` | `Validator`, `ValidateForPublish`, `ValidationError` |
| **仓储接口** | `repository.go` | `Repository` 接口 |

---

## 八、设计模式总结

```text
┌─────────────────────────────────────────────────────────────────────────────┐
│                       Scale 子域设计模式总结                                │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  1. Option 模式                                                            │
│     ─────────────────────────────────────────────────────────────────────  │
│     场景：MedicalScale、Factor 构造                                        │
│     优势：灵活组合可选参数，避免构造函数爆炸                               │
│                                                                             │
│  2. 聚合模式                                                                │
│     ─────────────────────────────────────────────────────────────────────  │
│     场景：MedicalScale 管理 Factor 和 InterpretationRule                   │
│     优势：保证边界内一致性，统一访问入口                                   │
│                                                                             │
│  3. 值对象模式                                                              │
│     ─────────────────────────────────────────────────────────────────────  │
│     场景：InterpretationRule、ScoreRange、RiskLevel                        │
│     优势：不可变，自包含验证，按内容判等                                   │
│                                                                             │
│  4. 领域服务分离                                                            │
│     ─────────────────────────────────────────────────────────────────────  │
│     场景：Lifecycle、BaseInfo、FactorManager、Validator                    │
│     优势：避免聚合根膨胀，职责单一，易于测试                               │
│                                                                             │
│  5. 状态机模式                                                              │
│     ─────────────────────────────────────────────────────────────────────  │
│     场景：Draft → Published → Archived                                    │
│     优势：状态转换受控，非法转换被拒绝                                     │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

---

## 📖 延伸阅读

- **前一篇**：[11-05-01 Scale子域架构总览](./11-05-01-Scale子域架构总览.md)
- **Evaluation 如何使用 Scale**：[11-06-03 Calculation计算策略设计](../evaluation%20模块设计/11-06-03-Calculation计算策略设计.md)
- **解读规则在 Evaluation 中的应用**：[11-06-04 Interpretation解读策略设计](../evaluation%20模块设计/11-06-04-Interpretation解读策略设计.md)
