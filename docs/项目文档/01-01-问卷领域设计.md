# ğŸ“Š é—®å·é¢†åŸŸè®¾è®¡

## ğŸ“‹ ç›®å½•

- [é¢†åŸŸæ¦‚è¿°](#domain-overview)
- [é—®å·èšåˆæ ¹è®¾è®¡](#questionnaire-aggregate)
- [é—®é¢˜é¢†åŸŸæ¨¡å‹](#question-domain)
- [å€¼å¯¹è±¡è®¾è®¡](#value-objects)
- [åº”ç”¨æœåŠ¡è®¾è®¡](#application-services)
- [ç«¯å£æ¥å£è®¾è®¡](#port-interfaces)
- [åŸºç¡€è®¾æ–½é€‚é…å™¨](#infrastructure-adapters)

## ğŸ¯ é¢†åŸŸæ¦‚è¿° {#domain-overview}

é—®å·é¢†åŸŸæ˜¯ç³»ç»Ÿçš„æ ¸å¿ƒä¸šåŠ¡é¢†åŸŸï¼Œè´Ÿè´£ç®¡ç†é—®å·çš„åˆ›å»ºã€ç¼–è¾‘ã€å‘å¸ƒã€é—®é¢˜ç®¡ç†ç­‰æ ¸å¿ƒä¸šåŠ¡é€»è¾‘ã€‚é‡‡ç”¨é¢†åŸŸé©±åŠ¨è®¾è®¡ï¼ˆDDDï¼‰åŸåˆ™ï¼Œç¡®ä¿ä¸šåŠ¡é€»è¾‘çš„æ¸…æ™°æ€§å’Œå¯ç»´æŠ¤æ€§ã€‚

### ğŸ¨ é¢†åŸŸè¾¹ç•Œ

```mermaid
graph TB
    subgraph "é—®å·é¢†åŸŸ Questionnaire Domain"
        subgraph "èšåˆæ ¹ Aggregates"
            QUESTIONNAIRE[é—®å· Questionnaire]
            QUESTION[é—®é¢˜ Question]
        end
        
        subgraph "å€¼å¯¹è±¡ Value Objects"
            QID[é—®å·ID QuestionnaireID]
            QCODE[é—®å·ç¼–ç  QuestionnaireCode]
            QVERSION[é—®å·ç‰ˆæœ¬ QuestionnaireVersion]
            QSTATUS[é—®å·çŠ¶æ€ QuestionnaireStatus]
        end
        
        subgraph "é¢†åŸŸæœåŠ¡ Domain Services"
            VCONTROLLER[ç‰ˆæœ¬æ§åˆ¶å™¨ VersionController]
            VALIDATOR[éªŒè¯å™¨ Validator]
        end
    end
    
    QUESTIONNAIRE --> QID
    QUESTIONNAIRE --> QCODE
    QUESTIONNAIRE --> QVERSION
    QUESTIONNAIRE --> QSTATUS
    QUESTIONNAIRE --> QUESTION
```

## ğŸ›ï¸ é—®å·èšåˆæ ¹è®¾è®¡ {#questionnaire-aggregate}

### ğŸ“¦ æ ¸å¿ƒç»“æ„

```go
// Questionnaire é—®å·èšåˆæ ¹
type Questionnaire struct {
    id          QuestionnaireID      // é—®å·å”¯ä¸€æ ‡è¯†
    code        QuestionnaireCode    // é—®å·ç¼–ç 
    title       string              // é—®å·æ ‡é¢˜
    description string              // é—®å·æè¿°
    imgUrl      string              // é—®å·å›¾ç‰‡
    version     QuestionnaireVersion // é—®å·ç‰ˆæœ¬
    status      QuestionnaireStatus  // é—®å·çŠ¶æ€
    questions   []question.Question  // é—®å·é—®é¢˜é›†åˆ
}
```

### ğŸ”§ æ ¸å¿ƒä¸šåŠ¡æ–¹æ³•

#### 1. é—®å·åˆ›å»º

```go
// NewQuestionnaire åˆ›å»ºé—®å·ï¼ˆå·¥å‚æ–¹æ³•ï¼‰
func NewQuestionnaire(code QuestionnaireCode, opts ...Option) *Questionnaire

// æ”¯æŒçš„åˆ›å»ºé€‰é¡¹
- WithTitle(title string)           // è®¾ç½®æ ‡é¢˜
- WithDescription(description)      // è®¾ç½®æè¿°  
- WithImgUrl(imgUrl)               // è®¾ç½®å›¾ç‰‡
- WithVersion(version)             // è®¾ç½®ç‰ˆæœ¬
- WithStatus(status)               // è®¾ç½®çŠ¶æ€
```

#### 2. é—®å·å‘å¸ƒæµç¨‹

```go
// Publish å‘å¸ƒé—®å·
func (q *Questionnaire) Publish() {
    q.status = STATUS_PUBLISHED
    q.version = q.version.Increment()
}

// Unpublish ä¸‹æ¶é—®å·
func (q *Questionnaire) Unpublish() {
    q.status = STATUS_DRAFT
}
```

#### 3. é—®å·å†…å®¹ç®¡ç†

```go
// ChangeBasicInfo ä¿®æ”¹é—®å·åŸºæœ¬ä¿¡æ¯
func (q *Questionnaire) ChangeBasicInfo(title, description, imgUrl string)

// AddQuestion æ·»åŠ é—®é¢˜
func (q *Questionnaire) AddQuestion(question question.Question)

// RemoveQuestion åˆ é™¤é—®é¢˜
func (q *Questionnaire) RemoveQuestion(question question.Question)
```

### ğŸ”„ çŠ¶æ€è½¬æ¢

```mermaid
stateDiagram-v2
    [*] --> è‰ç¨¿: åˆ›å»ºé—®å·
    è‰ç¨¿ --> å·²å‘å¸ƒ: å‘å¸ƒ
    å·²å‘å¸ƒ --> è‰ç¨¿: ä¸‹æ¶
    å·²å‘å¸ƒ --> å·²å½’æ¡£: å½’æ¡£
    è‰ç¨¿ --> å·²å½’æ¡£: ç›´æ¥å½’æ¡£
    å·²å½’æ¡£ --> [*]: åˆ é™¤
    
    note right of è‰ç¨¿
        STATUS_DRAFT
        å¯ç¼–è¾‘ã€å¯å‘å¸ƒ
    end note
    
    note right of å·²å‘å¸ƒ
        STATUS_PUBLISHED
        åªè¯»ã€å¯ä¸‹æ¶
    end note
    
    note right of å·²å½’æ¡£
        STATUS_ARCHIVED
        åªè¯»ã€å¯åˆ é™¤
    end note
```

## ğŸ§© é—®é¢˜é¢†åŸŸæ¨¡å‹ {#question-domain}

### ğŸ“Š é—®é¢˜ç±»å‹å±‚æ¬¡

```mermaid
classDiagram
    class Question {
        <<interface>>
        +GetCode() string
        +GetTitle() string
        +GetType() QuestionType
        +GetOptions() []Option
        +GetValidationRules() []ValidationRule
        +GetCalculationRule() CalculationRule
    }
    
    class BaseQuestion {
        -code string
        -title string
        -questionType QuestionType
        -tips string
        -placeholder string
        -options []Option
        -validationRules []ValidationRule
        -calculationRule CalculationRule
    }
    
    class RadioQuestion {
        +IsRequired() bool
        +GetSelectedOption() Option
    }
    
    class TextQuestion {
        +GetMaxLength() int
        +GetMinLength() int
    }
    
    class NumberQuestion {
        +GetMaxValue() float64
        +GetMinValue() float64
    }
    
    class SectionQuestion {
        +GetSubQuestions() []Question
    }
    
    Question <|.. BaseQuestion
    BaseQuestion <|-- RadioQuestion
    BaseQuestion <|-- TextQuestion
    BaseQuestion <|-- NumberQuestion
    BaseQuestion <|-- SectionQuestion
```

### ğŸ¯ é—®é¢˜ç±»å‹å®šä¹‰

```go
// QuestionType é¢˜å‹æšä¸¾
type QuestionType string

const (
    QuestionTypeSection  QuestionType = "section"  // æ®µè½
    QuestionTypeRadio    QuestionType = "radio"    // å•é€‰
    QuestionTypeCheckbox QuestionType = "checkbox" // å¤šé€‰
    QuestionTypeText     QuestionType = "text"     // æ–‡æœ¬
    QuestionTypeTextarea QuestionType = "textarea" // æ–‡æœ¬åŸŸ
    QuestionTypeNumber   QuestionType = "number"   // æ•°å­—
)
```

## ğŸ’ å€¼å¯¹è±¡è®¾è®¡ {#value-objects}

### 1. **é—®å·æ ‡è¯†ç¬¦ (QuestionnaireID)**

```go
type QuestionnaireID struct {
    value uint64
}

func NewQuestionnaireID(value uint64) QuestionnaireID
func (id QuestionnaireID) Value() uint64
```

### 2. **é—®å·ç¼–ç  (QuestionnaireCode)**

```go
type QuestionnaireCode string

func NewQuestionnaireCode(value string) QuestionnaireCode
func (c QuestionnaireCode) Value() string
```

**ç¼–ç è§„åˆ™:**
- å…¨å±€å”¯ä¸€æ€§
- å¯è¯»æ€§å¼º
- æ”¯æŒä¸šåŠ¡è¯­ä¹‰

### 3. **é—®å·ç‰ˆæœ¬ (QuestionnaireVersion)**

```go
type QuestionnaireVersion string

func NewQuestionnaireVersion(value string) QuestionnaireVersion
func (v QuestionnaireVersion) Value() string
func (v QuestionnaireVersion) Increment() QuestionnaireVersion
```

**ç‰ˆæœ¬ç­–ç•¥:**
- æ•°å­—é€’å¢: 1 â†’ 2 â†’ 3
- è¯­ä¹‰ç‰ˆæœ¬: 1.0.0 â†’ 1.0.1 â†’ 1.1.0

### 4. **é—®å·çŠ¶æ€ (QuestionnaireStatus)**

```go
type QuestionnaireStatus uint8

const (
    STATUS_DRAFT     QuestionnaireStatus = 0 // è‰ç¨¿
    STATUS_PUBLISHED QuestionnaireStatus = 1 // å·²å‘å¸ƒ
    STATUS_ARCHIVED  QuestionnaireStatus = 2 // å·²å½’æ¡£
)

func (s QuestionnaireStatus) Value() uint8
func (s QuestionnaireStatus) String() string
```

## ğŸš€ åº”ç”¨æœåŠ¡è®¾è®¡ {#application-services}

### ğŸ“¦ æœåŠ¡åˆ†å±‚

```mermaid
graph TB
    subgraph "åº”ç”¨æœåŠ¡å±‚ Application Services"
        CREATOR[Creator åˆ›å»ºå™¨]
        EDITOR[Editor ç¼–è¾‘å™¨]
        PUBLISHER[Publisher å‘å¸ƒå™¨]
        QUERYER[Queryer æŸ¥è¯¢å™¨]
    end
    
    subgraph "é¢†åŸŸå±‚ Domain Layer"
        QUESTIONNAIRE[Questionnaire èšåˆæ ¹]
        QUESTION[Question å®ä½“]
    end
    
    subgraph "åŸºç¡€è®¾æ–½å±‚ Infrastructure"
        MYSQL[MySQL Repository]
        MONGO[MongoDB Repository]
    end
    
    CREATOR --> QUESTIONNAIRE
    EDITOR --> QUESTIONNAIRE
    PUBLISHER --> QUESTIONNAIRE
    QUERYER --> QUESTIONNAIRE
    
    CREATOR --> MYSQL
    CREATOR --> MONGO
    EDITOR --> MYSQL
    EDITOR --> MONGO
    PUBLISHER --> MYSQL
    PUBLISHER --> MONGO
    QUERYER --> MYSQL
    QUERYER --> MONGO
```

### 1. **Creator åˆ›å»ºå™¨**

```go
type Creator struct {
    qRepoMySQL port.QuestionnaireRepositoryMySQL
    qRepoMongo port.QuestionnaireRepositoryMongo
}

// CreateQuestionnaire åˆ›å»ºé—®å·
func (c *Creator) CreateQuestionnaire(
    ctx context.Context, 
    title, description, imgUrl string
) (*questionnaire.Questionnaire, error) {
    // 1. ç”Ÿæˆé—®å·ç¼–ç 
    code, err := codeutil.GenerateCode()
    
    // 2. åˆ›å»ºé—®å·é¢†åŸŸæ¨¡å‹
    qBo := questionnaire.NewQuestionnaire(
        questionnaire.NewQuestionnaireCode(code),
        questionnaire.WithTitle(title),
        questionnaire.WithDescription(description),
        questionnaire.WithImgUrl(imgUrl),
        questionnaire.WithVersion(questionnaire.NewQuestionnaireVersion("1")),
        questionnaire.WithStatus(questionnaire.STATUS_DRAFT),
    )
    
    // 3. åŒå†™å­˜å‚¨ï¼ˆMySQL + MongoDBï¼‰
    if err := c.qRepoMySQL.Save(ctx, qBo); err != nil {
        return nil, err
    }
    if err := c.qRepoMongo.Save(ctx, qBo); err != nil {
        return nil, err
    }
    
    return qBo, nil
}
```

### 2. **Editor ç¼–è¾‘å™¨**

```go
type Editor struct {
    qRepoMySQL port.QuestionnaireRepositoryMySQL
    qRepoMongo port.QuestionnaireRepositoryMongo
}

// EditBasicInfo ç¼–è¾‘é—®å·åŸºæœ¬ä¿¡æ¯
func (e *Editor) EditBasicInfo(
    ctx context.Context,
    code questionnaire.QuestionnaireCode,
    title, description, imgUrl string,
) (*questionnaire.Questionnaire, error) {
    // 1. è·å–ç°æœ‰é—®å·
    qBo, err := e.qRepoMySQL.FindByCode(ctx, code.Value())
    
    // 2. ä¸šåŠ¡é€»è¾‘ï¼šä¿®æ”¹åŸºæœ¬ä¿¡æ¯
    qBo.ChangeBasicInfo(title, description, imgUrl)
    
    // 3. æŒä¹…åŒ–
    if err := e.qRepoMySQL.Save(ctx, qBo); err != nil {
        return nil, err
    }
    if err := e.qRepoMongo.Save(ctx, qBo); err != nil {
        return nil, err
    }
    
    return qBo, nil
}
```

### 3. **Publisher å‘å¸ƒå™¨**

```go
type Publisher struct {
    qRepoMySQL port.QuestionnaireRepositoryMySQL
    qRepoMongo port.QuestionnaireRepositoryMongo
}

// Publish å‘å¸ƒé—®å·
func (p *Publisher) Publish(
    ctx context.Context,
    code questionnaire.QuestionnaireCode,
) (*questionnaire.Questionnaire, error) {
    // 1. è·å–é—®å·
    qBo, err := p.qRepoMySQL.FindByCode(ctx, code.Value())
    
    // 2. ä¸šåŠ¡é€»è¾‘ï¼šæ‰§è¡Œå‘å¸ƒ
    qBo.Publish()
    
    // 3. æŒä¹…åŒ–
    if err := p.qRepoMySQL.Save(ctx, qBo); err != nil {
        return nil, err
    }
    if err := p.qRepoMongo.Save(ctx, qBo); err != nil {
        return nil, err
    }
    
    return qBo, nil
}
```

## ğŸ”Œ ç«¯å£æ¥å£è®¾è®¡ {#port-interfaces}

### ğŸ“¥ å…¥ç«™ç«¯å£ (Driving Ports)

```go
// QuestionnaireCreator é—®å·åˆ›å»ºæ¥å£
type QuestionnaireCreator interface {
    CreateQuestionnaire(ctx context.Context, title, description, imgUrl string) (*questionnaire.Questionnaire, error)
}

// QuestionnaireEditor é—®å·ç¼–è¾‘æ¥å£
type QuestionnaireEditor interface {
    EditBasicInfo(ctx context.Context, code questionnaire.QuestionnaireCode, title, description, imgUrl string) (*questionnaire.Questionnaire, error)
}

// QuestionnairePublisher é—®å·å‘å¸ƒæ¥å£
type QuestionnairePublisher interface {
    Publish(ctx context.Context, code questionnaire.QuestionnaireCode) (*questionnaire.Questionnaire, error)
    Unpublish(ctx context.Context, code questionnaire.QuestionnaireCode) (*questionnaire.Questionnaire, error)
}

// QuestionnaireQueryer é—®å·æŸ¥è¯¢æ¥å£
type QuestionnaireQueryer interface {
    GetQuestionnaire(ctx context.Context, id uint64) (*questionnaire.Questionnaire, error)
    GetQuestionnaireByCode(ctx context.Context, code string) (*questionnaire.Questionnaire, error)
    ListQuestionnaires(ctx context.Context, page, pageSize int) ([]*questionnaire.Questionnaire, int64, error)
}
```

### ğŸ“¤ å‡ºç«™ç«¯å£ (Driven Ports)

```go
// QuestionnaireRepositoryMySQL MySQLå­˜å‚¨åº“æ¥å£
type QuestionnaireRepositoryMySQL interface {
    Save(ctx context.Context, questionnaire *questionnaire.Questionnaire) error
    FindByID(ctx context.Context, id uint64) (*questionnaire.Questionnaire, error)
    FindByCode(ctx context.Context, code string) (*questionnaire.Questionnaire, error)
    Update(ctx context.Context, questionnaire *questionnaire.Questionnaire) error
    Remove(ctx context.Context, id uint64) error
}

// QuestionnaireRepositoryMongo MongoDBå­˜å‚¨åº“æ¥å£
type QuestionnaireRepositoryMongo interface {
    Save(ctx context.Context, qDomain *questionnaire.Questionnaire) error
    FindByCode(ctx context.Context, code string) (*questionnaire.Questionnaire, error)
    Update(ctx context.Context, qDomain *questionnaire.Questionnaire) error
    Remove(ctx context.Context, code string) error
    HardDelete(ctx context.Context, code string) error
    ExistsByCode(ctx context.Context, code string) (bool, error)
    FindActiveQuestionnaires(ctx context.Context) ([]*questionnaire.Questionnaire, error)
}
```

## ğŸ—ï¸ åŸºç¡€è®¾æ–½é€‚é…å™¨ {#infrastructure-adapters}

### ğŸ“Š MySQL é€‚é…å™¨

```go
// Repository MySQLå­˜å‚¨åº“å®ç°
type Repository struct {
    mysql.BaseRepository[*QuestionnairePO]
    mapper *QuestionnaireMapper
}

// QuestionnairePO é—®å·æŒä¹…åŒ–å¯¹è±¡
type QuestionnairePO struct {
    base.AuditFields
    Code        string `gorm:"column:code;type:varchar(255)"`
    Title       string `gorm:"column:title;type:varchar(255)"`
    Description string `gorm:"column:description;type:varchar(255)"`
    ImgUrl      string `gorm:"column:img_url;type:varchar(255)"`
    Version     string `gorm:"column:version;type:varchar(255)"`
    Status      uint8  `gorm:"column:status;type:tinyint"`
}

// Mapper æ˜ å°„å™¨
type QuestionnaireMapper struct{}

func (m *QuestionnaireMapper) ToPO(bo *questionnaire.Questionnaire) *QuestionnairePO
func (m *QuestionnaireMapper) ToBO(po *QuestionnairePO) *questionnaire.Questionnaire
```

### ğŸ“„ MongoDB é€‚é…å™¨

```go
// Repository MongoDBå­˜å‚¨åº“å®ç°
type Repository struct {
    mongoBase.BaseRepository
    mapper *QuestionnaireMapper
}

// QuestionnairePO MongoDBæŒä¹…åŒ–å¯¹è±¡
type QuestionnairePO struct {
    base.BaseDocument `bson:",inline"`
    Code              string       `bson:"code"`
    Title             string       `bson:"title"`
    Description       string       `bson:"description,omitempty"`
    ImgUrl            string       `bson:"img_url,omitempty"`
    Version           string       `bson:"version"`
    Status            uint8        `bson:"status"`
    Questions         []QuestionPO `bson:"questions"`
}
```

### ğŸ”„ æ•°æ®æµè½¬

```mermaid
sequenceDiagram
    participant Client as å®¢æˆ·ç«¯
    participant Handler as REST Handler
    participant Service as Application Service
    participant Domain as Domain Model
    participant MySQL as MySQL Repository
    participant MongoDB as MongoDB Repository
    
    Client->>Handler: HTTP Request
    Handler->>Service: è°ƒç”¨åº”ç”¨æœåŠ¡
    Service->>Domain: åˆ›å»º/ä¿®æ”¹é¢†åŸŸå¯¹è±¡
    Domain->>Domain: æ‰§è¡Œä¸šåŠ¡é€»è¾‘
    Service->>MySQL: ä¿å­˜åˆ°MySQL
    Service->>MongoDB: ä¿å­˜åˆ°MongoDB
    Service-->>Handler: è¿”å›é¢†åŸŸå¯¹è±¡
    Handler-->>Client: HTTP Response
```

## ğŸ¯ è®¾è®¡åŸåˆ™æ€»ç»“

### âœ… å·²å®ç°çš„è®¾è®¡åŸåˆ™

1. **èšåˆæ ¹å®Œæ•´æ€§**: é—®å·ä½œä¸ºèšåˆæ ¹ç®¡ç†å†…éƒ¨å®ä½“
2. **å€¼å¯¹è±¡ä¸å˜æ€§**: æ‰€æœ‰å€¼å¯¹è±¡éƒ½æ˜¯ä¸å¯å˜çš„
3. **ä¸šåŠ¡é€»è¾‘å°è£…**: ä¸šåŠ¡è§„åˆ™å°è£…åœ¨é¢†åŸŸå¯¹è±¡ä¸­
4. **ç«¯å£é€‚é…å™¨**: æ¸…æ™°çš„ç«¯å£æ¥å£å®šä¹‰
5. **åŒå†™ä¸€è‡´æ€§**: MySQL + MongoDB æ•°æ®åŒæ­¥

### ğŸ”® æ‰©å±•å»ºè®®

1. **é¢†åŸŸäº‹ä»¶**: å¼•å…¥äº‹ä»¶æœºåˆ¶å¤„ç†é—®å·çŠ¶æ€å˜æ›´
2. **è§„çº¦æ¨¡å¼**: å¤æ‚ä¸šåŠ¡è§„åˆ™ä½¿ç”¨è§„çº¦æ¨¡å¼
3. **ç‰ˆæœ¬æ§åˆ¶æœåŠ¡**: ç‹¬ç«‹çš„ç‰ˆæœ¬ç®¡ç†é¢†åŸŸæœåŠ¡
4. **é—®å·æ¨¡æ¿**: æ”¯æŒé—®å·æ¨¡æ¿å’Œå…‹éš†åŠŸèƒ½

è¿™ç§é¢†åŸŸè®¾è®¡ç¡®ä¿äº†é—®å·ä¸šåŠ¡é€»è¾‘çš„æ¸…æ™°æ€§ã€å¯ç»´æŠ¤æ€§å’Œå¯æ‰©å±•æ€§ã€‚ 