# 11-08 入校筛查子域设计（V2）

> **版本**：V2.0  
> **范围**：问卷&量表 BC 中的 screening 子域  
> **目标**：阐述入校筛查子域的核心职责、批量筛查项目管理、扫码填写流程设计、与其他子域的协作关系

---

## 1. Screening 子域的定位与职责

### 1.1 子域边界

**screening 子域关注的核心问题**：

* **批量筛查项目管理**：以"项目"为单位，面向某校/某年级/某班级的批量测评
* **开放式入口**：通过二维码/链接，让家长自助扫码填写
* **筛查记录管理**：记录每个参与者的信息，避免与 Testee 混淆
* **统计与分析**：按项目/年级/班级维度统计完成率、风险分布等

**screening 子域不关心的问题**：

* "问卷怎么展示、如何填写"：这是 survey 子域的职责
* "如何计分和解读"：这是 scale 子域的职责
* "周期性测评"：这是 plan 子域的职责

### 1.2 核心聚合

screening 子域包含两个核心聚合：

1. **ScreeningProject 聚合根**：筛查项目
   * 描述一次批量筛查活动的边界（时间范围、问卷、对象范围）
   * 管理项目状态（draft / published / closed）
   * 生成二维码入口

2. **ScreeningRecord 实体**：筛查记录（新增）
   * 记录每个参与者的入校筛查信息
   * 存储临时性的年级、班级、学校等信息
   * 与 Testee 解耦，避免污染 Testee 模型

### 1.3 与其他子域的关系

* **依赖** survey 子域：引用 QuestionnaireID
* **依赖** scale 子域：引用 MedicalScaleID（可选）
* **依赖** user 子域：引用 TesteeID（通过 EnsureTestee 创建）
* **被引用** assessment 子域：Assessment 创建时记录 originType=screening

### 1.4 与 Testee 的区分

**关键设计决策**：

* **grade、class、school 等信息不放到 Testee 上**
* 这些信息只是在入校筛查时使用一次，并不属于受试者长期的信息
* 通过 **ScreeningRecord** 存储每个入校筛查项目进来的人、受试者等信息

**为什么不放到 Testee 上？**

1. **临时性**：入校筛查的班级/年级信息是某一时刻的快照，会随时间变化
2. **多项目冲突**：同一个 Testee 可能参加多个筛查项目，每次的班级/年级可能不同
3. **职责分离**：Testee 代表"长期被跟踪的受试者"，不应承载"某次活动的参与信息"

---

## 2. 入校筛查业务场景

### 2.1 典型场景

***场景：学校发起新生心理筛查***

* 学校发起"2025 秋季一年级新生心理筛查"项目
* 发放二维码海报给所有新生家长
* 家长在家中通过微信扫码填写
* 提交后自动生成测评报告
* 学校统计完成率、风险分布等

### 2.2 业务流程概览

```text
┌──────────────┐    ┌──────────────┐    ┌──────────────┐    ┌──────────────┐
│1. 创建项目   │───>│2. 生成二维码 │───>│3. 家长扫码   │───>│4. 提交答卷   │
│  (Staff)     │    │  (System)    │    │  (Guardian)  │    │  (Guardian)  │
└──────────────┘    └──────────────┘    └──────────────┘    └──────────────┘
                                                │
                                                ▼
                                        ┌──────────────┐
                                        │选择/创建孩子 │
                                        │(IAM Child)   │
                                        └──────────────┘
                                                │
                                                ▼
                                        ┌──────────────┐
                                        │创建 Testee   │
                                        │(EnsureTestee)│
                                        └──────────────┘
                                                │
                                                ▼
                                        ┌──────────────┐
                                        │创建筛查记录  │
                                        │(Record)      │
                                        └──────────────┘
                                                │
                                                ▼
                                        ┌──────────────┐
                                        │填写问卷      │
                                        │(AnswerSheet) │
                                        └──────────────┘
```

---

## 3. ScreeningProject 聚合根

### 3.1 聚合根定位

ScreeningProject 是 screening 子域的核心聚合根，代表"一次批量筛查活动"。

**核心职责**：

1. 定义筛查活动的边界（学校、年级、班级、时间范围）
2. 生成并管理二维码入口
3. 管理项目生命周期（草稿、已发布、已结束）
4. 提供统计快照（已完成人数等）

### 3.2 聚合根结构

```go
type ScreeningProjectID string

// 项目状态
type ScreeningStatus string

const (
    ScreeningStatusDraft     ScreeningStatus = "draft"     // 草稿
    ScreeningStatusPublished ScreeningStatus = "published" // 已发布
    ScreeningStatusClosed    ScreeningStatus = "closed"    // 已关闭
    ScreeningStatusArchived  ScreeningStatus = "archived"  // 已归档
)

type ScreeningProject struct {
    // 基本标识
    id     ScreeningProjectID
    orgID  int64

    // 项目信息
    name       string            // 项目名称，如 "2025 秋季一年级入校筛查"
    schoolName string            // 学校名称
    grade      *string           // 年级（可选）
    classes    []string          // 班级列表（可选）

    // 关联问卷/量表
    questionnaireID survey.QuestionnaireID
    scaleID         *scale.MedicalScaleID // 可选：问卷模式时为空

    // 时间范围
    startAt    time.Time
    endAt      time.Time

    // 状态
    status     ScreeningStatus

    // 参与人数管理
    expectedParticipants *int  // 预计参与人数（导入花名册或预估）
    maxParticipants      *int  // 上限（可选）

    // 二维码/H5 入口
    entryPath  string  // 相对路径：/screening/{id}/entry
    entryURL   string  // 完整 URL（含域名）
    qrImageURL string  // 生成好的二维码图片地址（对象存储）

    // 统计快照（异步更新）
    filledCount   int  // 已完成测评人数

    // 审计字段
    createdBy     user.StaffID
    createdAt     time.Time
    updatedAt     time.Time
    deletedAt     *time.Time
    version       int64
}
```

### 3.3 构造函数与核心方法

```go
// NewScreeningProject 创建筛查项目
func NewScreeningProject(
    orgID int64,
    name string,
    schoolName string,
    grade *string,
    questionnaireID survey.QuestionnaireID,
    scaleID *scale.MedicalScaleID,
    startAt time.Time,
    endAt time.Time,
    createdBy user.StaffID,
) *ScreeningProject {
    now := time.Now()
    id := NewScreeningProjectID()

    return &ScreeningProject{
        id:              id,
        orgID:           orgID,
        name:            name,
        schoolName:      schoolName,
        grade:           grade,
        questionnaireID: questionnaireID,
        scaleID:         scaleID,
        startAt:         startAt,
        endAt:           endAt,
        status:          ScreeningStatusDraft,
        entryPath:       fmt.Sprintf("/screening/%s/entry", id),
        createdBy:       createdBy,
        createdAt:       now,
        updatedAt:       now,
    }
}

// Publish 发布项目（生成二维码）
func (p *ScreeningProject) Publish(entryURL string, qrImageURL string) error {
    if p.status != ScreeningStatusDraft {
        return ErrProjectNotDraft
    }

    p.status = ScreeningStatusPublished
    p.entryURL = entryURL
    p.qrImageURL = qrImageURL
    p.updatedAt = time.Now()

    return nil
}

// Close 关闭项目
func (p *ScreeningProject) Close() error {
    if p.status != ScreeningStatusPublished {
        return ErrProjectNotPublished
    }

    p.status = ScreeningStatusClosed
    p.updatedAt = time.Now()

    return nil
}

// IncrementFilledCount 增加完成人数
func (p *ScreeningProject) IncrementFilledCount() {
    p.filledCount++
    p.updatedAt = time.Now()
}

// IsActive 是否活跃
func (p *ScreeningProject) IsActive() bool {
    now := time.Now()
    return p.status == ScreeningStatusPublished &&
           now.After(p.startAt) &&
           now.Before(p.endAt)
}

// CanParticipate 是否可以参与
func (p *ScreeningProject) CanParticipate() error {
    if !p.IsActive() {
        return ErrProjectNotActive
    }

    if p.maxParticipants != nil && p.filledCount >= *p.maxParticipants {
        return ErrProjectFull
    }

    return nil
}
```

---

## 4. ScreeningRecord 实体（新增）

### 4.1 设计动机

**为什么需要 ScreeningRecord？**

* **避免污染 Testee 模型**：grade、class、school 等信息只在筛查时使用，不属于 Testee 长期属性
* **支持多项目参与**：同一个 Testee 可能参加多个筛查项目，每次的班级/年级可能不同
* **便于统计分析**：可以按项目、年级、班级维度统计，而不依赖 Testee

### 4.2 实体结构

```go
type ScreeningRecordID string

type ScreeningRecord struct {
    // 基本标识
    id        ScreeningRecordID
    projectID ScreeningProjectID
    testeeID  user.TesteeID

    // 入校筛查专属信息（临时性）
    schoolName string    // 学校名称（快照）
    grade      string    // 年级，如 "一年级"
    className  string    // 班级，如 "1班"
    studentNo  *string   // 学号（可选）

    // 家长信息（填写人）
    guardianName   string      // 家长姓名
    guardianUserID *int64      // 家长 IAM UserID（可选）
    guardianPhone  *string     // 家长手机号（可选）

    // 关联答卷
    answerSheetID *survey.AnswerSheetID

    // 审计字段
    createdAt     time.Time
    updatedAt     time.Time
}
```

### 4.3 核心方法

```go
// NewScreeningRecord 创建筛查记录
func NewScreeningRecord(
    projectID ScreeningProjectID,
    testeeID user.TesteeID,
    schoolName string,
    grade string,
    className string,
    studentNo *string,
    guardianName string,
    guardianUserID *int64,
) *ScreeningRecord {
    now := time.Now()

    return &ScreeningRecord{
        id:             NewScreeningRecordID(),
        projectID:      projectID,
        testeeID:       testeeID,
        schoolName:     schoolName,
        grade:          grade,
        className:      className,
        studentNo:      studentNo,
        guardianName:   guardianName,
        guardianUserID: guardianUserID,
        createdAt:      now,
        updatedAt:      now,
    }
}

// LinkAnswerSheet 关联答卷
func (r *ScreeningRecord) LinkAnswerSheet(answerSheetID survey.AnswerSheetID) {
    r.answerSheetID = &answerSheetID
    r.updatedAt = time.Now()
}
```

### 4.4 唯一性约束

**同一项目 + 同一 Testee 只允许一条记录**：

```sql
CREATE UNIQUE INDEX uk_screening_testee 
ON screening_records (project_id, testee_id)
WHERE deleted_at IS NULL;
```

---

## 5. 家长扫码填写完整流程

### 5.1 步骤 1：家长扫码

* 微信扫描二维码 → 跳转到 H5 页面
* 页面显示：项目名称、学校名称、填写说明
* 校验项目是否活跃、是否在时间范围内

### 5.2 步骤 2：选择/填写孩子信息

#### 情况 A：预先导入了学生花名册

* 显示筛选界面：班级下拉框 + 学生列表
* 家长选择孩子姓名、学号进行核验
* 系统根据学号查找/创建 Testee

#### 情况 B：未导入花名册

* 显示表单：孩子姓名、性别、出生日期、班级
* 家长填写后，系统创建临时 Testee

**关键逻辑**：

```go
// 应用服务层
func (s *ScreeningAppService) PrepareEntry(ctx context.Context, req PrepareEntryRequest) (*EntryInfo, error) {
    // 1. 查询项目
    project, err := s.projectRepo.FindByID(ctx, req.ProjectID)
    if err != nil {
        return nil, err
    }

    // 2. 校验项目状态
    if err := project.CanParticipate(); err != nil {
        return nil, err
    }

    // 3. 获取家长信息（从 JWT token 解析）
    guardian := GetGuardianFromContext(ctx)

    // 4. 获取家长名下的孩子列表（调用 IAM）
    children, err := s.iamClient.GetChildrenByGuardian(ctx, guardian.UserID)
    if err != nil {
        return nil, err
    }

    return &EntryInfo{
        Project:  project,
        Children: children,
    }, nil
}
```

### 5.3 步骤 3：创建筛查记录

家长选择/填写孩子信息后，系统执行：

```go
func (s *ScreeningAppService) CreateRecord(ctx context.Context, req CreateRecordRequest) (*ScreeningRecord, error) {
    // 1. 查询项目
    project, err := s.projectRepo.FindByID(ctx, req.ProjectID)
    if err != nil {
        return nil, err
    }

    // 2. 校验项目状态
    if err := project.CanParticipate(); err != nil {
        return nil, err
    }

    // 3. EnsureTestee（幂等创建）
    testee, err := s.testeeSvc.EnsureTestee(ctx, EnsureTesteeKey{
        IamChildID: req.ChildID,
        OrgID:      project.OrgID(),
    })
    if err != nil {
        return nil, err
    }

    // 4. 检查是否已存在记录
    existingRecord, _ := s.recordRepo.FindByProjectAndTestee(ctx, req.ProjectID, testee.ID())
    if existingRecord != nil {
        return nil, ErrRecordAlreadyExists
    }

    // 5. 创建筛查记录
    record := domain.NewScreeningRecord(
        req.ProjectID,
        testee.ID(),
        project.SchoolName(),
        req.Grade,
        req.ClassName,
        req.StudentNo,
        req.GuardianName,
        &req.GuardianUserID,
    )

    if err := s.recordRepo.Save(ctx, record); err != nil {
        return nil, err
    }

    return record, nil
}
```

### 5.4 步骤 4：填写问卷

创建筛查记录后，跳转到答题页面：

```go
func (s *AnswerSheetAppService) CreateForScreening(ctx context.Context, req CreateForScreeningRequest) (*survey.AnswerSheet, error) {
    // 1. 查询筛查记录
    record, err := s.recordRepo.FindByID(ctx, req.RecordID)
    if err != nil {
        return nil, err
    }

    // 2. 查询项目
    project, err := s.projectRepo.FindByID(ctx, record.ProjectID())
    if err != nil {
        return nil, err
    }

    // 3. 创建答卷
    fillerRef := survey.FillerRef{
        UserID:     req.GuardianUserID,
        FillerType: survey.FillerTypeGuardian,
    }

    answerSheet := survey.NewAnswerSheet(
        project.QuestionnaireID(),
        record.TesteeID(),
        fillerRef,
        survey.ScenarioScreeningProject,
        survey.OriginTypeScreening,
        string(project.ID()),
    )

    if err := s.answerSheetRepo.Save(ctx, answerSheet); err != nil {
        return nil, err
    }

    // 4. 关联答卷到筛查记录
    record.LinkAnswerSheet(answerSheet.ID())
    if err := s.recordRepo.Save(ctx, record); err != nil {
        return nil, err
    }

    return answerSheet, nil
}
```

### 5.5 步骤 5：提交答卷

用户填写完成后，提交答卷：

```go
func (s *AnswerSheetAppService) SubmitForScreening(ctx context.Context, req SubmitRequest) error {
    // 1. 查询答卷
    answerSheet, err := s.answerSheetRepo.FindByID(ctx, req.AnswerSheetID)
    if err != nil {
        return err
    }

    // 2. 校验并提交
    if err := answerSheet.Submit(); err != nil {
        return err
    }

    if err := s.answerSheetRepo.Save(ctx, answerSheet); err != nil {
        return err
    }

    // 3. 如果是量表模式，创建 Assessment
    if answerSheet.ScaleID() != nil {
        assessment := assessment.NewAssessment(
            answerSheet.TesteeID(),
            *answerSheet.ScaleID(),
            assessment.OriginTypeScreening,
            answerSheet.OriginID(),
            answerSheet,
        )

        if err := s.assessmentRepo.Save(ctx, assessment); err != nil {
            return err
        }

        // 发送消息到 evaluation-server
        s.eventBus.Publish(ctx, AssessmentSubmittedEvent{
            AssessmentID: assessment.ID(),
        })
    }

    // 4. 更新项目完成人数（异步或实时）
    s.projectSvc.IncrementFilledCount(ctx, answerSheet.OriginID())

    return nil
}
```

### 5.6 步骤 6：查看报告

提交成功后跳转到报告页：

* 显示测评结果、风险等级、建议等
* 可保存/分享报告

---

## 6. 二维码入口生成与使用

### 6.1 项目发布时生成入口

当 ScreeningProject 状态从 draft 变为 published 时：

```go
func (s *ScreeningAppService) PublishProject(ctx context.Context, projectID ScreeningProjectID) error {
    // 1. 查询项目
    project, err := s.projectRepo.FindByID(ctx, projectID)
    if err != nil {
        return err
    }

    // 2. 生成 entryURL
    entryURL := fmt.Sprintf("https://survey.example.com%s", project.EntryPath())

    // 3. 生成二维码图片
    qrImageURL, err := s.qrCodeSvc.Generate(ctx, entryURL)
    if err != nil {
        return err
    }

    // 4. 发布项目
    if err := project.Publish(entryURL, qrImageURL); err != nil {
        return err
    }

    if err := s.projectRepo.Save(ctx, project); err != nil {
        return err
    }

    return nil
}
```

### 6.2 唯一性约束

**同一筛查项目中，同一个 Testee 只能提交一次答卷**：

* 在 ScreeningRecord 层面建立唯一约束：`(ProjectID, TesteeID)`
* 若家长重复扫码，系统检测到已提交，可提示"已完成"或跳转到结果页

---

## 7. 筛查项目统计维度

### 7.1 完成率统计

**计算公式**：

完成率 = 已完成人数 / 预期参与人数 × 100%

**数据来源**：

* 预期参与人数：`project.expectedParticipants`（导入花名册时统计）
* 已完成人数：`project.filledCount`（异步更新快照）

**SQL 查询（实时统计）**：

```sql
SELECT COUNT(DISTINCT testee_id) AS filled_count
FROM screening_records
WHERE project_id = ?
  AND answer_sheet_id IS NOT NULL
```

### 7.2 风险分布统计（量表模式）

**按风险等级分组**：

```sql
SELECT risk_level, COUNT(*) AS count
FROM assessments
WHERE origin_type = 'screening'
  AND origin_id = ?
GROUP BY risk_level
```

返回结果：

| risk_level | count |
|-----------|-------|
| low       | 150   |
| medium    | 30    |
| high      | 5     |

### 7.3 按班级统计

**完成率 by 班级**：

```sql
SELECT 
    r.class_name,
    COUNT(*) AS filled_count
FROM screening_records r
WHERE r.project_id = ?
  AND r.answer_sheet_id IS NOT NULL
GROUP BY r.class_name
ORDER BY r.class_name
```

**风险分布 by 班级**：

```sql
SELECT 
    r.class_name,
    ast.risk_level,
    COUNT(*) AS count
FROM assessments ast
JOIN screening_records r ON ast.testee_id = r.testee_id
WHERE ast.origin_type = 'screening'
  AND ast.origin_id = ?
  AND r.project_id = ?
GROUP BY r.class_name, ast.risk_level
ORDER BY r.class_name, ast.risk_level
```

### 7.4 按年级统计

**完成率 by 年级**：

```sql
SELECT 
    r.grade,
    COUNT(*) AS filled_count
FROM screening_records r
WHERE r.project_id = ?
  AND r.answer_sheet_id IS NOT NULL
GROUP BY r.grade
ORDER BY r.grade
```

### 7.5 统计快照更新策略

#### 实时更新（简单方案）

每次提交答卷时更新 `project.filledCount`：

```go
func (s *ProjectAppService) IncrementFilledCount(ctx context.Context, projectID string) error {
    project, err := s.projectRepo.FindByID(ctx, ScreeningProjectID(projectID))
    if err != nil {
        return err
    }

    project.IncrementFilledCount()

    return s.projectRepo.Save(ctx, project)
}
```

#### 定时批量更新（高并发方案）

使用 cron job 每 5 分钟更新一次：

```go
func (job *ScreeningStatsJob) UpdateFilledCounts(ctx context.Context) {
    projects, err := job.projectRepo.FindActiveProjects(ctx)
    if err != nil {
        return
    }

    for _, project := range projects {
        count := job.recordRepo.CountByProject(ctx, project.ID())
        job.projectRepo.UpdateFilledCount(ctx, project.ID(), count)
    }
}
```

---

## 8. 与 Testee 模型的协同

### 8.1 数据流向

```text
IAM.Child
    │
    ▼ EnsureTestee
Testee (长期实体)
    │
    ▼ CreateRecord
ScreeningRecord (临时记录)
    │
    │ 包含：grade, className, schoolName
    │
    ▼ LinkAnswerSheet
AnswerSheet
    │
    ▼ Submit
Assessment (可选)
```

### 8.2 职责划分

| 实体 | 职责 | 字段示例 |
|------|------|---------|
| **Testee** | 长期被跟踪的受试者，存储稳定的基本信息 | name, gender, birthDate, tags, lastAssessmentAt |
| **ScreeningRecord** | 某次筛查活动的参与记录，存储临时性的上下文信息 | grade, className, schoolName, studentNo, guardianName |
| **AnswerSheet** | 一次填写行为的答案内容 | questionnaireID, answers, status, submittedAt |
| **Assessment** | 一次测评行为的业务元数据与结果 | originType, originID, totalScore, riskLevel |

### 8.3 查询示例

**查询某个 Testee 的所有筛查记录**：

```sql
SELECT 
    r.id,
    r.project_id,
    p.name AS project_name,
    r.grade,
    r.class_name,
    r.school_name,
    r.created_at
FROM screening_records r
JOIN screening_projects p ON r.project_id = p.id
WHERE r.testee_id = ?
ORDER BY r.created_at DESC
```

**查询某个筛查项目的所有参与者**：

```sql
SELECT 
    t.id AS testee_id,
    t.name AS testee_name,
    r.grade,
    r.class_name,
    r.student_no,
    r.guardian_name,
    r.answer_sheet_id,
    r.created_at
FROM screening_records r
JOIN testees t ON r.testee_id = t.id
WHERE r.project_id = ?
ORDER BY r.grade, r.class_name, t.name
```

---

## 9. 仓储接口

```go
// ScreeningProjectRepository 筛查项目仓储
type ScreeningProjectRepository interface {
    // FindByID 根据 ID 查询项目
    FindByID(ctx context.Context, id ScreeningProjectID) (*ScreeningProject, error)

    // FindByOrgID 查询某个机构的所有项目
    FindByOrgID(ctx context.Context, orgID int64) ([]*ScreeningProject, error)

    // FindActiveProjects 查询所有活跃的项目
    FindActiveProjects(ctx context.Context) ([]*ScreeningProject, error)

    // Save 保存项目
    Save(ctx context.Context, project *ScreeningProject) error

    // UpdateFilledCount 更新完成人数
    UpdateFilledCount(ctx context.Context, id ScreeningProjectID, count int) error
}

// ScreeningRecordRepository 筛查记录仓储
type ScreeningRecordRepository interface {
    // FindByID 根据 ID 查询记录
    FindByID(ctx context.Context, id ScreeningRecordID) (*ScreeningRecord, error)

    // FindByProjectAndTestee 查询某个项目中某个受试者的记录
    FindByProjectAndTestee(ctx context.Context, projectID ScreeningProjectID, testeeID user.TesteeID) (*ScreeningRecord, error)

    // FindByProjectID 查询某个项目的所有记录
    FindByProjectID(ctx context.Context, projectID ScreeningProjectID) ([]*ScreeningRecord, error)

    // FindByTesteeID 查询某个受试者的所有筛查记录
    FindByTesteeID(ctx context.Context, testeeID user.TesteeID) ([]*ScreeningRecord, error)

    // CountByProject 统计某个项目的参与人数
    CountByProject(ctx context.Context, projectID ScreeningProjectID) int

    // Save 保存记录
    Save(ctx context.Context, record *ScreeningRecord) error
}
```

---

## 10. 领域事件

```go
// ProjectPublishedEvent 项目发布事件
type ProjectPublishedEvent struct {
    ProjectID ScreeningProjectID
    OrgID     int64
    EntryURL  string
    QrCodeURL string
    PublishedAt time.Time
}

// RecordCreatedEvent 筛查记录创建事件
type RecordCreatedEvent struct {
    RecordID  ScreeningRecordID
    ProjectID ScreeningProjectID
    TesteeID  user.TesteeID
    Grade     string
    ClassName string
    CreatedAt time.Time
}

// ScreeningCompletedEvent 筛查完成事件
type ScreeningCompletedEvent struct {
    RecordID      ScreeningRecordID
    ProjectID     ScreeningProjectID
    TesteeID      user.TesteeID
    AnswerSheetID survey.AnswerSheetID
    AssessmentID  *assessment.AssessmentID
    CompletedAt   time.Time
}
```

---

## 11. 用例示例

### 11.1 创建入校筛查项目

```text
POST /screening-projects
{
  "org_id": 10,
  "name": "2025 秋季一年级入校心理筛查",
  "school_name": "XX小学",
  "grade": "一年级",
  "classes": ["1班", "2班", "3班"],
  "questionnaire_id": 456,
  "medical_scale_id": 789,
  "start_at": "2025-09-01T00:00:00Z",
  "end_at": "2025-09-30T23:59:59Z",
  "expected_participants": 150
}
```

**应用层处理**：

1. 校验 org/问卷/时间范围
2. 创建 ScreeningProject
3. 返回 project_id

### 11.2 发布项目

```text
POST /screening-projects/{id}/publish
```

**应用层处理**：

1. 查询项目
2. 生成 entryURL
3. 生成二维码图片
4. 更新项目状态为 published
5. 返回 qrImageURL

### 11.3 家长扫码进入

```text
GET /screening/{id}/entry
```

**应用层处理**：

1. 校验项目状态
2. 获取家长信息（JWT）
3. 获取家长名下的孩子列表（IAM）
4. 返回项目信息 + 孩子列表

### 11.4 创建筛查记录

```text
POST /screening/{id}/records
{
  "child_id": 123,
  "grade": "一年级",
  "class_name": "1班",
  "student_no": "2025001",
  "guardian_name": "张三"
}
```

**应用层处理**：

1. EnsureTestee
2. 检查是否已存在记录
3. 创建 ScreeningRecord
4. 创建 AnswerSheet
5. 返回答题入口

---

## 12. 总结

* **screening 子域**通过 ScreeningProject + ScreeningRecord 管理批量筛查项目，与 Assessment/Testee 结合，支持学校/班级维度的整体风险分析
* **ScreeningRecord 解耦设计**：grade、class、school 等临时性信息不放到 Testee 上，避免污染 Testee 模型
* **开放式入口**：通过二维码/链接，支持家长自助扫码填写，无需预先创建账号
* **EnsureTestee 幂等创建**：支持多上游 BC 安全调用，第一次参与筛查时创建 Testee
* **多维度统计**：支持按项目、年级、班级统计完成率、风险分布等，便于学校管理者分析
* **与 plan 子域区分**：plan 子域面向单个受试者的长期周期性测评，screening 子域面向批量一次性筛查
