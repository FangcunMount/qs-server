# Collection-Server 用户模块实现说明

## 实现概述

本文档记录了 collection-server 用户模块的完整实现，包括小程序注册/登录、受试者管理等核心功能。

## 已实现功能

### 1. 基础设施层 (infrastructure/)

#### 1.1 gRPC 客户端封装
**文件**: `infrastructure/grpc/user_service_client.go`
- **功能**: 封装对 apiserver UserService 的 gRPC 调用
- **关键方法**:
  - `CreateOrUpdateMiniProgramAccount`: 创建或更新小程序账号
  - `GetWechatAccountByOpenID`: 根据 OpenID 获取微信账号
  - `GetUser`: 获取用户信息
  - `CreateTestee`: 创建受试者
  - `GetTestee`: 获取受试者信息
  - `TesteeExists`: 检查受试者是否存在

#### 1.2 JWT 认证
**文件**: `infrastructure/auth/jwt.go`
- **功能**: JWT Token 的生成和验证
- **Claims 字段**: user_id, app_id, open_id
- **过期时间**: 可配置（默认 7 天）

#### 1.3 微信小程序客户端
**文件**: `infrastructure/wechat/miniprogram_client.go`
- **功能**: 调用微信 API
- **关键方法**:
  - `Code2Session`: 通过 code 换取 openid 和 session_key

### 2. 应用层 (application/user/)

#### 2.1 MiniProgramRegistrar
**文件**: `application/user/miniprogram_registrar.go`
- **功能**: 小程序注册/登录服务
- **流程**:
  1. 调用微信 API 获取 openid
  2. 调用 apiserver 创建或更新账号
  3. 生成 JWT Token
  4. 返回 Token 和用户信息

#### 2.2 TesteeRegistrar
**文件**: `application/user/testee_registrar.go`
- **功能**: 受试者注册服务
- **字段**:
  - name: 姓名
  - sex: 性别 (0-未知, 1-男, 2-女)
  - birthday: 生日 (RFC3339 格式)

#### 2.3 UserQueryer
**文件**: `application/user/user_queryer.go`
- **功能**: 用户信息查询服务
- **关键方法**:
  - `GetUser`: 获取用户基本信息
  - `GetTestee`: 获取受试者信息

### 3. 接口层 (interface/http/handler/)

#### 3.1 UserHandler
**文件**: `interface/http/handler/user_handler.go`
- **路由**:
  - `POST /api/v1/users/miniprogram/register`: 小程序注册/登录（无需认证）
  - `GET /api/v1/users/me`: 获取当前用户信息（需要认证）

#### 3.2 TesteeHandler
**文件**: `interface/http/handler/testee_handler.go`
- **路由**:
  - `POST /api/v1/testees/register`: 创建受试者（需要认证）
  - `GET /api/v1/testees/me`: 获取当前用户的受试者信息（需要认证）

#### 3.3 JWT 认证中间件
**文件**: `interface/http/middleware/jwt_auth.go`
- **功能**: 验证 JWT Token，提取用户信息
- **使用**: 需要认证的路由需添加此中间件

## 配置说明

### 配置文件 (configs/collection-server.yaml)

```yaml
# JWT 配置
jwt:
  secret_key: "qs-collection-server-jwt-secret-key-2024"
  token_duration: 168  # 7 天 (24*7小时)

# 微信小程序配置
wechat:
  app_id: "your_wechat_app_id"
  app_secret: "your_wechat_app_secret"
```

### 配置项说明 (options/options.go)

- **JWTOptions**:
  - `secret_key`: JWT 签名密钥（生产环境务必修改）
  - `token_duration`: Token 有效期（小时）

- **WechatOptions**:
  - `app_id`: 微信小程序 AppID
  - `app_secret`: 微信小程序 AppSecret

## 容器集成 (container/container.go)

### 新增组件

```go
// 基础设施层
UserServiceClient   *grpc.UserServiceClient
JWTManager          *auth.JWTManager
MiniProgramClient   *wechat.MiniProgramClient

// 应用层
MiniProgramRegistrar *userapp.MiniProgramRegistrar
TesteeRegistrar      *userapp.TesteeRegistrar
UserQueryer          *userapp.UserQueryer

// 接口层
UserHandler    *userhandler.UserHandler
TesteeHandler  *userhandler.TesteeHandler
```

### 初始化顺序

1. **Infrastructure**: gRPC Client → JWT Manager → WeChat Client
2. **Application**: Registrar → Queryer (依赖 Infrastructure)
3. **Interface**: Handlers (依赖 Application + JWT Manager)

## API 使用示例

### 1. 小程序注册/登录

**请求**:
```http
POST /api/v1/users/miniprogram/register
Content-Type: application/json

{
  "code": "wx_login_code",
  "nickname": "张三",
  "avatar": "https://example.com/avatar.jpg"
}
```

**响应**:
```json
{
  "token": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...",
  "user_id": "123",
  "open_id": "oABC123XYZ",
  "is_new_user": true
}
```

### 2. 创建受试者

**请求**:
```http
POST /api/v1/testees/register
Authorization: Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...
Content-Type: application/json

{
  "name": "张三",
  "sex": 1,
  "birthday": "1990-01-01T00:00:00Z"
}
```

**响应**:
```json
{
  "user_id": "123",
  "name": "张三",
  "sex": 1,
  "birthday": "1990-01-01T00:00:00Z",
  "age": 34
}
```

### 3. 获取用户信息

**请求**:
```http
GET /api/v1/users/me
Authorization: Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...
```

**响应**:
```json
{
  "user_id": "123",
  "username": "user123",
  "nickname": "张三",
  "email": "",
  "phone": "",
  "avatar": "https://example.com/avatar.jpg",
  "introduction": "",
  "status": 1
}
```

### 4. 获取受试者信息

**请求**:
```http
GET /api/v1/testees/me
Authorization: Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...
```

**响应**:
```json
{
  "user_id": "123",
  "name": "张三",
  "sex": 1,
  "birthday": "1990-01-01T00:00:00Z",
  "age": 34
}
```

## 数据流图

### 小程序注册流程

```
小程序客户端
    ↓ POST /api/v1/users/miniprogram/register
UserHandler.RegisterMiniProgram
    ↓
MiniProgramRegistrar.Register
    ↓ 1. Code2Session
MiniProgramClient → 微信 API
    ↓ 2. CreateOrUpdateMiniProgramAccount
UserServiceClient → apiserver gRPC
    ↓ 3. GenerateToken
JWTManager
    ↓
返回 Token + UserID
```

### 受试者创建流程

```
小程序客户端 (带 JWT Token)
    ↓ POST /api/v1/testees/register
JWTAuth 中间件（验证 Token，提取 user_id）
    ↓
TesteeHandler.CreateTestee
    ↓
TesteeRegistrar.CreateTestee
    ↓ CreateTestee
UserServiceClient → apiserver gRPC
    ↓
返回受试者信息
```

## 错误处理

### 常见错误码

- `INVALID_REQUEST`: 请求参数错误
- `UNAUTHORIZED`: 未认证或 Token 无效
- `REGISTER_FAILED`: 注册失败
- `CREATE_TESTEE_FAILED`: 创建受试者失败
- `GET_USER_FAILED`: 获取用户信息失败
- `GET_TESTEE_FAILED`: 获取受试者信息失败

### 错误响应格式

```json
{
  "code": "ERROR_CODE",
  "message": "Error message",
  "details": "Detailed error information"
}
```

## 安全考虑

1. **JWT 密钥**: 生产环境必须使用强密钥并妥善保管
2. **Token 过期**: 默认 7 天，可根据需求调整
3. **HTTPS**: 生产环境必须使用 HTTPS
4. **微信凭证**: AppSecret 不得泄露，建议使用环境变量

## 测试建议

### 单元测试重点

1. **MiniProgramRegistrar**: 模拟微信 API 和 gRPC 调用
2. **TesteeRegistrar**: 验证数据转换和 gRPC 调用
3. **JWTManager**: Token 生成和验证逻辑
4. **Handlers**: HTTP 请求处理和错误响应

### 集成测试重点

1. 完整的注册/登录流程
2. Token 认证中间件
3. 受试者创建流程
4. 跨服务通信 (collection-server ↔ apiserver)

## 下一步优化

### P1 (重要)

- [ ] 添加 Token 刷新机制
- [ ] 实现用户信息缓存（Redis）
- [ ] 添加请求限流
- [ ] 完善错误日志记录

### P2 (可选)

- [ ] 支持多小程序 (多 AppID)
- [ ] 实现 SessionKey 加密存储
- [ ] 添加 Prometheus 监控指标
- [ ] 生成 Swagger API 文档

## 依赖关系

```
interface/http/handler/
  └── application/user/
      ├── infrastructure/grpc/user_service_client.go
      ├── infrastructure/auth/jwt.go
      └── infrastructure/wechat/miniprogram_client.go
```

## 代码统计

| 模块 | 文件数 | 代码行数 |
|------|--------|----------|
| infrastructure/grpc | 1 | ~170 |
| infrastructure/auth | 1 | ~70 |
| infrastructure/wechat | 1 | ~80 |
| application/user | 3 | ~250 |
| interface/http/handler | 2 | ~200 |
| interface/http/middleware | 1 | ~50 |
| **总计** | **9** | **~820** |

## 总结

本次实现完成了 collection-server 用户模块的核心功能，遵循了以下设计原则：

1. **分层架构**: Interface → Application → Infrastructure
2. **单一职责**: 每个服务专注于单一功能
3. **防腐层模式**: collection-server 作为 apiserver 的门面
4. **无状态设计**: 使用 JWT Token 实现无状态认证
5. **清晰的依赖关系**: 单向依赖，易于测试和维护

实现效果：
- ✅ 完整的小程序登录流程
- ✅ JWT 认证机制
- ✅ 受试者管理
- ✅ 清晰的 API 接口
- ✅ 良好的错误处理
