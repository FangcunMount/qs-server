# Collection-Server 微信客户端重构说明

## 重构内容

将 `collection-server/infrastructure/wechat/miniprogram_client.go` 从自定义 HTTP 实现改为复用 `github.com/silenceper/wechat/v2` SDK。

## 重构原因

### 之前的问题

**旧实现**（自己实现 HTTP 请求）：
```go
// 自己拼接 URL、发送 HTTP 请求
const Code2SessionURL = "https://api.weixin.qq.com/sns/jscode2session"

func (c *MiniProgramClient) Code2Session(ctx context.Context, code string) (*Code2SessionResponse, error) {
    params := url.Values{}
    params.Set("appid", c.appID)
    params.Set("secret", c.appSecret)
    params.Set("js_code", code)
    // ... 手动发送 HTTP 请求
}
```

**问题**：
1. ❌ 重复造轮子（项目已经引入了 wechat SDK）
2. ❌ 代码冗余（apiserver 已经使用了该 SDK）
3. ❌ 缺少错误处理和重试机制
4. ❌ 缺少 access_token 管理和缓存
5. ❌ 将来扩展功能（如解密手机号）需要继续手动实现

### 现在的优势

**新实现**（复用 wechat SDK）：
```go
import (
    wechatSDK "github.com/silenceper/wechat/v2"
    "github.com/silenceper/wechat/v2/cache"
    "github.com/silenceper/wechat/v2/miniprogram"
    "github.com/silenceper/wechat/v2/miniprogram/config"
)

func NewMiniProgramClient(appID, appSecret string) *MiniProgramClient {
    wc := wechatSDK.NewWechat()
    memCache := cache.NewMemory()
    cfg := &config.Config{
        AppID:     appID,
        AppSecret: appSecret,
        Cache:     memCache,
    }
    mini := wc.GetMiniProgram(cfg)
    return &MiniProgramClient{mini: mini}
}
```

**优势**：
1. ✅ 复用成熟的 SDK，减少代码量
2. ✅ 内置错误处理和重试
3. ✅ 自动管理 access_token 和缓存
4. ✅ 易于扩展其他微信 API（订阅消息、小程序码等）
5. ✅ 与 apiserver 保持一致的技术栈

## 架构对比

### apiserver 的微信客户端

**位置**: `apiserver/infra/wechat/client_factory.go`

**特点**：
- 依赖 `AppRepository` 从**数据库**读取微信应用配置
- 支持**多应用**（多个 AppID）
- 同时支持**小程序**和**公众号**
- 使用 `sync.Map` 缓存客户端实例

```go
type WxClientFactory struct {
    wc        *wechatSDK.Wechat
    appRepo   wechatPort.AppRepository  // 从数据库加载配置
    rdb       *redis.Client
    miniCache sync.Map                  // 支持多应用
    oaCache   sync.Map
}
```

**用途**：
- 处理公众号 webhook（关注/取关事件）
- 预留小程序功能（将来可能需要）

### collection-server 的微信客户端

**位置**: `collection-server/infrastructure/wechat/miniprogram_client.go`

**特点**：
- 从**配置文件**读取 AppID/AppSecret
- 只支持**单一应用**（配置驱动）
- 只支持**小程序**
- 简化的客户端封装

```go
type MiniProgramClient struct {
    mini *miniprogram.MiniProgram  // 单一小程序实例
}

func NewMiniProgramClient(appID, appSecret string) *MiniProgramClient {
    // 配置驱动，不依赖数据库
}
```

**用途**：
- 小程序用户注册/登录
- code2session
- access_token 管理

## 职责划分

### apiserver（有状态服务）

**职责**：
- 管理用户数据（数据库）
- 管理微信应用配置（数据库）
- 处理公众号 webhook
- 提供 gRPC 服务

**微信功能**：
- ✅ 公众号 webhook 处理（关注/取关）
- ⚠️ 小程序功能（预留，暂未使用）

### collection-server（无状态服务）

**职责**：
- 小程序前端服务
- 问卷收集
- 防腐层（隔离 apiserver 变化）

**微信功能**：
- ✅ 小程序 code2session
- ✅ 小程序登录/注册
- 🚀 将来可扩展：订阅消息、小程序码等

## 技术细节

### 依赖的 wechat SDK

```go
github.com/silenceper/wechat/v2
```

**主要模块**：
- `miniprogram`: 小程序相关功能
- `officialaccount`: 公众号相关功能
- `cache`: 缓存管理（Memory/Redis）
- `context`: access_token 管理

### 当前实现的功能

#### 1. Code2Session

```go
func (c *MiniProgramClient) Code2Session(ctx context.Context, code string) (*Code2SessionResult, error)
```

**功能**: 通过微信登录 code 换取 openid 和 session_key

**返回**:
```go
type Code2SessionResult struct {
    OpenID     string  // 用户唯一标识
    SessionKey string  // 会话密钥
    UnionID    string  // 开放平台 UnionID（可选）
}
```

#### 2. GetAccessToken

```go
func (c *MiniProgramClient) GetAccessToken() (string, error)
```

**功能**: 获取小程序 access_token（用于调用其他微信接口）

**特点**:
- SDK 自动管理 token 过期和刷新
- 使用内存缓存

#### 3. GetMiniProgram

```go
func (c *MiniProgramClient) GetMiniProgram() *miniprogram.MiniProgram
```

**功能**: 获取底层 SDK 实例，用于高级功能

**用途**:
- 发送订阅消息
- 生成小程序码
- 解密手机号
- 内容安全检测

## 将来可扩展的功能

通过 `GetMiniProgram()` 可以访问以下功能：

### 1. 订阅消息

```go
mini := client.GetMiniProgram()
msg := mini.GetSubscribe()
err := msg.Send(&subscribe.Message{
    ToUser:     openID,
    TemplateID: templateID,
    Data:       data,
})
```

### 2. 小程序码

```go
mini := client.GetMiniProgram()
qrcode := mini.GetQRCode()
img, err := qrcode.CreateWXAQRCode(&qrcode.QRCoder{
    Path:  "pages/index/index",
    Width: 430,
})
```

### 3. 解密手机号

```go
mini := client.GetMiniProgram()
encryptor := mini.GetEncryptor()
result, err := encryptor.Decrypt(sessionKey, encryptedData, iv)
```

### 4. 内容安全检测

```go
mini := client.GetMiniProgram()
security := mini.GetSecurity()
result, err := security.MsgSecCheck(&security.MsgCheckRequest{
    Content: "待检测内容",
})
```

## 配置说明

### collection-server 配置文件

`configs/collection-server.yaml`:

```yaml
# 微信小程序配置
wechat:
  app_id: "wx1234567890abcdef"
  app_secret: "your_app_secret_here"
```

### 与 apiserver 的区别

**apiserver**: 从数据库加载多个应用配置
```go
// 从数据库查询
app, err := f.appRepo.FindByPlatformAndAppID(ctx, domainWechat.PlatformMini, appID)
```

**collection-server**: 从配置文件加载单个应用
```go
// 从配置文件（通过 Options 传入）
client := wechat.NewMiniProgramClient(
    config.Wechat.AppID,
    config.Wechat.AppSecret,
)
```

## 优化效果

### 代码量对比

| 实现方式 | 代码行数 | 功能 |
|---------|---------|------|
| 旧实现（手动 HTTP） | ~90 行 | code2session |
| 新实现（SDK） | ~75 行 | code2session + access_token + 扩展接口 |

### 减少的代码

- ❌ HTTP 请求封装（~30 行）
- ❌ URL 拼接和参数处理（~10 行）
- ❌ 错误处理逻辑（~10 行）

### 新增的能力

- ✅ 自动管理 access_token
- ✅ 内置缓存机制
- ✅ 完善的错误处理
- ✅ 易于扩展其他 API

## 测试建议

### 单元测试

```go
func TestMiniProgramClient_Code2Session(t *testing.T) {
    client := NewMiniProgramClient("test_app_id", "test_app_secret")
    
    // Mock 微信 API 响应
    result, err := client.Code2Session(context.Background(), "test_code")
    
    assert.NoError(t, err)
    assert.NotEmpty(t, result.OpenID)
}
```

### 集成测试

1. 配置真实的 AppID 和 AppSecret（测试环境）
2. 从小程序获取真实的登录 code
3. 调用 Code2Session 验证返回结果

## 总结

### 本次重构的价值

1. **代码复用** - 避免重复实现微信 API 调用
2. **降低维护成本** - SDK 自动处理 access_token 和错误
3. **技术一致性** - 与 apiserver 使用相同的技术栈
4. **易于扩展** - 通过 SDK 快速集成新功能

### 架构清晰度提升

**之前**:
- apiserver: 使用 wechat SDK ✅
- collection-server: 手动实现 HTTP ❌

**现在**:
- apiserver: 使用 wechat SDK（数据库驱动，多应用）✅
- collection-server: 使用 wechat SDK（配置驱动，单应用）✅

### 符合的设计原则

1. ✅ **DRY（Don't Repeat Yourself）** - 复用 SDK，不重复造轮子
2. ✅ **单一职责** - collection-server 专注小程序，apiserver 管理数据
3. ✅ **防腐层** - collection-server 隔离对 apiserver 的依赖
4. ✅ **配置驱动** - collection-server 无状态，通过配置文件管理
