# Collection-Server å¾®ä¿¡å®¢æˆ·ç«¯é‡æ„è¯´æ˜

## é‡æ„å†…å®¹

å°† `collection-server/infrastructure/wechat/miniprogram_client.go` ä»è‡ªå®šä¹‰ HTTP å®ç°æ”¹ä¸ºå¤ç”¨ `github.com/silenceper/wechat/v2` SDKã€‚

## é‡æ„åŸå› 

### ä¹‹å‰çš„é—®é¢˜

**æ—§å®ç°**ï¼ˆè‡ªå·±å®ç° HTTP è¯·æ±‚ï¼‰ï¼š
```go
// è‡ªå·±æ‹¼æ¥ URLã€å‘é€ HTTP è¯·æ±‚
const Code2SessionURL = "https://api.weixin.qq.com/sns/jscode2session"

func (c *MiniProgramClient) Code2Session(ctx context.Context, code string) (*Code2SessionResponse, error) {
    params := url.Values{}
    params.Set("appid", c.appID)
    params.Set("secret", c.appSecret)
    params.Set("js_code", code)
    // ... æ‰‹åŠ¨å‘é€ HTTP è¯·æ±‚
}
```

**é—®é¢˜**ï¼š
1. âŒ é‡å¤é€ è½®å­ï¼ˆé¡¹ç›®å·²ç»å¼•å…¥äº† wechat SDKï¼‰
2. âŒ ä»£ç å†—ä½™ï¼ˆapiserver å·²ç»ä½¿ç”¨äº†è¯¥ SDKï¼‰
3. âŒ ç¼ºå°‘é”™è¯¯å¤„ç†å’Œé‡è¯•æœºåˆ¶
4. âŒ ç¼ºå°‘ access_token ç®¡ç†å’Œç¼“å­˜
5. âŒ å°†æ¥æ‰©å±•åŠŸèƒ½ï¼ˆå¦‚è§£å¯†æ‰‹æœºå·ï¼‰éœ€è¦ç»§ç»­æ‰‹åŠ¨å®ç°

### ç°åœ¨çš„ä¼˜åŠ¿

**æ–°å®ç°**ï¼ˆå¤ç”¨ wechat SDKï¼‰ï¼š
```go
import (
    wechatSDK "github.com/silenceper/wechat/v2"
    "github.com/silenceper/wechat/v2/cache"
    "github.com/silenceper/wechat/v2/miniprogram"
    "github.com/silenceper/wechat/v2/miniprogram/config"
)

func NewMiniProgramClient(appID, appSecret string) *MiniProgramClient {
    wc := wechatSDK.NewWechat()
    memCache := cache.NewMemory()
    cfg := &config.Config{
        AppID:     appID,
        AppSecret: appSecret,
        Cache:     memCache,
    }
    mini := wc.GetMiniProgram(cfg)
    return &MiniProgramClient{mini: mini}
}
```

**ä¼˜åŠ¿**ï¼š
1. âœ… å¤ç”¨æˆç†Ÿçš„ SDKï¼Œå‡å°‘ä»£ç é‡
2. âœ… å†…ç½®é”™è¯¯å¤„ç†å’Œé‡è¯•
3. âœ… è‡ªåŠ¨ç®¡ç† access_token å’Œç¼“å­˜
4. âœ… æ˜“äºæ‰©å±•å…¶ä»–å¾®ä¿¡ APIï¼ˆè®¢é˜…æ¶ˆæ¯ã€å°ç¨‹åºç ç­‰ï¼‰
5. âœ… ä¸ apiserver ä¿æŒä¸€è‡´çš„æŠ€æœ¯æ ˆ

## æ¶æ„å¯¹æ¯”

### apiserver çš„å¾®ä¿¡å®¢æˆ·ç«¯

**ä½ç½®**: `apiserver/infra/wechat/client_factory.go`

**ç‰¹ç‚¹**ï¼š
- ä¾èµ– `AppRepository` ä»**æ•°æ®åº“**è¯»å–å¾®ä¿¡åº”ç”¨é…ç½®
- æ”¯æŒ**å¤šåº”ç”¨**ï¼ˆå¤šä¸ª AppIDï¼‰
- åŒæ—¶æ”¯æŒ**å°ç¨‹åº**å’Œ**å…¬ä¼—å·**
- ä½¿ç”¨ `sync.Map` ç¼“å­˜å®¢æˆ·ç«¯å®ä¾‹

```go
type WxClientFactory struct {
    wc        *wechatSDK.Wechat
    appRepo   wechatPort.AppRepository  // ä»æ•°æ®åº“åŠ è½½é…ç½®
    rdb       *redis.Client
    miniCache sync.Map                  // æ”¯æŒå¤šåº”ç”¨
    oaCache   sync.Map
}
```

**ç”¨é€”**ï¼š
- å¤„ç†å…¬ä¼—å· webhookï¼ˆå…³æ³¨/å–å…³äº‹ä»¶ï¼‰
- é¢„ç•™å°ç¨‹åºåŠŸèƒ½ï¼ˆå°†æ¥å¯èƒ½éœ€è¦ï¼‰

### collection-server çš„å¾®ä¿¡å®¢æˆ·ç«¯

**ä½ç½®**: `collection-server/infrastructure/wechat/miniprogram_client.go`

**ç‰¹ç‚¹**ï¼š
- ä»**é…ç½®æ–‡ä»¶**è¯»å– AppID/AppSecret
- åªæ”¯æŒ**å•ä¸€åº”ç”¨**ï¼ˆé…ç½®é©±åŠ¨ï¼‰
- åªæ”¯æŒ**å°ç¨‹åº**
- ç®€åŒ–çš„å®¢æˆ·ç«¯å°è£…

```go
type MiniProgramClient struct {
    mini *miniprogram.MiniProgram  // å•ä¸€å°ç¨‹åºå®ä¾‹
}

func NewMiniProgramClient(appID, appSecret string) *MiniProgramClient {
    // é…ç½®é©±åŠ¨ï¼Œä¸ä¾èµ–æ•°æ®åº“
}
```

**ç”¨é€”**ï¼š
- å°ç¨‹åºç”¨æˆ·æ³¨å†Œ/ç™»å½•
- code2session
- access_token ç®¡ç†

## èŒè´£åˆ’åˆ†

### apiserverï¼ˆæœ‰çŠ¶æ€æœåŠ¡ï¼‰

**èŒè´£**ï¼š
- ç®¡ç†ç”¨æˆ·æ•°æ®ï¼ˆæ•°æ®åº“ï¼‰
- ç®¡ç†å¾®ä¿¡åº”ç”¨é…ç½®ï¼ˆæ•°æ®åº“ï¼‰
- å¤„ç†å…¬ä¼—å· webhook
- æä¾› gRPC æœåŠ¡

**å¾®ä¿¡åŠŸèƒ½**ï¼š
- âœ… å…¬ä¼—å· webhook å¤„ç†ï¼ˆå…³æ³¨/å–å…³ï¼‰
- âš ï¸ å°ç¨‹åºåŠŸèƒ½ï¼ˆé¢„ç•™ï¼Œæš‚æœªä½¿ç”¨ï¼‰

### collection-serverï¼ˆæ— çŠ¶æ€æœåŠ¡ï¼‰

**èŒè´£**ï¼š
- å°ç¨‹åºå‰ç«¯æœåŠ¡
- é—®å·æ”¶é›†
- é˜²è…å±‚ï¼ˆéš”ç¦» apiserver å˜åŒ–ï¼‰

**å¾®ä¿¡åŠŸèƒ½**ï¼š
- âœ… å°ç¨‹åº code2session
- âœ… å°ç¨‹åºç™»å½•/æ³¨å†Œ
- ğŸš€ å°†æ¥å¯æ‰©å±•ï¼šè®¢é˜…æ¶ˆæ¯ã€å°ç¨‹åºç ç­‰

## æŠ€æœ¯ç»†èŠ‚

### ä¾èµ–çš„ wechat SDK

```go
github.com/silenceper/wechat/v2
```

**ä¸»è¦æ¨¡å—**ï¼š
- `miniprogram`: å°ç¨‹åºç›¸å…³åŠŸèƒ½
- `officialaccount`: å…¬ä¼—å·ç›¸å…³åŠŸèƒ½
- `cache`: ç¼“å­˜ç®¡ç†ï¼ˆMemory/Redisï¼‰
- `context`: access_token ç®¡ç†

### å½“å‰å®ç°çš„åŠŸèƒ½

#### 1. Code2Session

```go
func (c *MiniProgramClient) Code2Session(ctx context.Context, code string) (*Code2SessionResult, error)
```

**åŠŸèƒ½**: é€šè¿‡å¾®ä¿¡ç™»å½• code æ¢å– openid å’Œ session_key

**è¿”å›**:
```go
type Code2SessionResult struct {
    OpenID     string  // ç”¨æˆ·å”¯ä¸€æ ‡è¯†
    SessionKey string  // ä¼šè¯å¯†é’¥
    UnionID    string  // å¼€æ”¾å¹³å° UnionIDï¼ˆå¯é€‰ï¼‰
}
```

#### 2. GetAccessToken

```go
func (c *MiniProgramClient) GetAccessToken() (string, error)
```

**åŠŸèƒ½**: è·å–å°ç¨‹åº access_tokenï¼ˆç”¨äºè°ƒç”¨å…¶ä»–å¾®ä¿¡æ¥å£ï¼‰

**ç‰¹ç‚¹**:
- SDK è‡ªåŠ¨ç®¡ç† token è¿‡æœŸå’Œåˆ·æ–°
- ä½¿ç”¨å†…å­˜ç¼“å­˜

#### 3. GetMiniProgram

```go
func (c *MiniProgramClient) GetMiniProgram() *miniprogram.MiniProgram
```

**åŠŸèƒ½**: è·å–åº•å±‚ SDK å®ä¾‹ï¼Œç”¨äºé«˜çº§åŠŸèƒ½

**ç”¨é€”**:
- å‘é€è®¢é˜…æ¶ˆæ¯
- ç”Ÿæˆå°ç¨‹åºç 
- è§£å¯†æ‰‹æœºå·
- å†…å®¹å®‰å…¨æ£€æµ‹

## å°†æ¥å¯æ‰©å±•çš„åŠŸèƒ½

é€šè¿‡ `GetMiniProgram()` å¯ä»¥è®¿é—®ä»¥ä¸‹åŠŸèƒ½ï¼š

### 1. è®¢é˜…æ¶ˆæ¯

```go
mini := client.GetMiniProgram()
msg := mini.GetSubscribe()
err := msg.Send(&subscribe.Message{
    ToUser:     openID,
    TemplateID: templateID,
    Data:       data,
})
```

### 2. å°ç¨‹åºç 

```go
mini := client.GetMiniProgram()
qrcode := mini.GetQRCode()
img, err := qrcode.CreateWXAQRCode(&qrcode.QRCoder{
    Path:  "pages/index/index",
    Width: 430,
})
```

### 3. è§£å¯†æ‰‹æœºå·

```go
mini := client.GetMiniProgram()
encryptor := mini.GetEncryptor()
result, err := encryptor.Decrypt(sessionKey, encryptedData, iv)
```

### 4. å†…å®¹å®‰å…¨æ£€æµ‹

```go
mini := client.GetMiniProgram()
security := mini.GetSecurity()
result, err := security.MsgSecCheck(&security.MsgCheckRequest{
    Content: "å¾…æ£€æµ‹å†…å®¹",
})
```

## é…ç½®è¯´æ˜

### collection-server é…ç½®æ–‡ä»¶

`configs/collection-server.yaml`:

```yaml
# å¾®ä¿¡å°ç¨‹åºé…ç½®
wechat:
  app_id: "wx1234567890abcdef"
  app_secret: "your_app_secret_here"
```

### ä¸ apiserver çš„åŒºåˆ«

**apiserver**: ä»æ•°æ®åº“åŠ è½½å¤šä¸ªåº”ç”¨é…ç½®
```go
// ä»æ•°æ®åº“æŸ¥è¯¢
app, err := f.appRepo.FindByPlatformAndAppID(ctx, domainWechat.PlatformMini, appID)
```

**collection-server**: ä»é…ç½®æ–‡ä»¶åŠ è½½å•ä¸ªåº”ç”¨
```go
// ä»é…ç½®æ–‡ä»¶ï¼ˆé€šè¿‡ Options ä¼ å…¥ï¼‰
client := wechat.NewMiniProgramClient(
    config.Wechat.AppID,
    config.Wechat.AppSecret,
)
```

## ä¼˜åŒ–æ•ˆæœ

### ä»£ç é‡å¯¹æ¯”

| å®ç°æ–¹å¼ | ä»£ç è¡Œæ•° | åŠŸèƒ½ |
|---------|---------|------|
| æ—§å®ç°ï¼ˆæ‰‹åŠ¨ HTTPï¼‰ | ~90 è¡Œ | code2session |
| æ–°å®ç°ï¼ˆSDKï¼‰ | ~75 è¡Œ | code2session + access_token + æ‰©å±•æ¥å£ |

### å‡å°‘çš„ä»£ç 

- âŒ HTTP è¯·æ±‚å°è£…ï¼ˆ~30 è¡Œï¼‰
- âŒ URL æ‹¼æ¥å’Œå‚æ•°å¤„ç†ï¼ˆ~10 è¡Œï¼‰
- âŒ é”™è¯¯å¤„ç†é€»è¾‘ï¼ˆ~10 è¡Œï¼‰

### æ–°å¢çš„èƒ½åŠ›

- âœ… è‡ªåŠ¨ç®¡ç† access_token
- âœ… å†…ç½®ç¼“å­˜æœºåˆ¶
- âœ… å®Œå–„çš„é”™è¯¯å¤„ç†
- âœ… æ˜“äºæ‰©å±•å…¶ä»– API

## æµ‹è¯•å»ºè®®

### å•å…ƒæµ‹è¯•

```go
func TestMiniProgramClient_Code2Session(t *testing.T) {
    client := NewMiniProgramClient("test_app_id", "test_app_secret")
    
    // Mock å¾®ä¿¡ API å“åº”
    result, err := client.Code2Session(context.Background(), "test_code")
    
    assert.NoError(t, err)
    assert.NotEmpty(t, result.OpenID)
}
```

### é›†æˆæµ‹è¯•

1. é…ç½®çœŸå®çš„ AppID å’Œ AppSecretï¼ˆæµ‹è¯•ç¯å¢ƒï¼‰
2. ä»å°ç¨‹åºè·å–çœŸå®çš„ç™»å½• code
3. è°ƒç”¨ Code2Session éªŒè¯è¿”å›ç»“æœ

## æ€»ç»“

### æœ¬æ¬¡é‡æ„çš„ä»·å€¼

1. **ä»£ç å¤ç”¨** - é¿å…é‡å¤å®ç°å¾®ä¿¡ API è°ƒç”¨
2. **é™ä½ç»´æŠ¤æˆæœ¬** - SDK è‡ªåŠ¨å¤„ç† access_token å’Œé”™è¯¯
3. **æŠ€æœ¯ä¸€è‡´æ€§** - ä¸ apiserver ä½¿ç”¨ç›¸åŒçš„æŠ€æœ¯æ ˆ
4. **æ˜“äºæ‰©å±•** - é€šè¿‡ SDK å¿«é€Ÿé›†æˆæ–°åŠŸèƒ½

### æ¶æ„æ¸…æ™°åº¦æå‡

**ä¹‹å‰**:
- apiserver: ä½¿ç”¨ wechat SDK âœ…
- collection-server: æ‰‹åŠ¨å®ç° HTTP âŒ

**ç°åœ¨**:
- apiserver: ä½¿ç”¨ wechat SDKï¼ˆæ•°æ®åº“é©±åŠ¨ï¼Œå¤šåº”ç”¨ï¼‰âœ…
- collection-server: ä½¿ç”¨ wechat SDKï¼ˆé…ç½®é©±åŠ¨ï¼Œå•åº”ç”¨ï¼‰âœ…

### ç¬¦åˆçš„è®¾è®¡åŸåˆ™

1. âœ… **DRYï¼ˆDon't Repeat Yourselfï¼‰** - å¤ç”¨ SDKï¼Œä¸é‡å¤é€ è½®å­
2. âœ… **å•ä¸€èŒè´£** - collection-server ä¸“æ³¨å°ç¨‹åºï¼Œapiserver ç®¡ç†æ•°æ®
3. âœ… **é˜²è…å±‚** - collection-server éš”ç¦»å¯¹ apiserver çš„ä¾èµ–
4. âœ… **é…ç½®é©±åŠ¨** - collection-server æ— çŠ¶æ€ï¼Œé€šè¿‡é…ç½®æ–‡ä»¶ç®¡ç†
