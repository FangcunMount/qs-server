# collection-server 用户模块设计

## 概述

collection-server 的用户模块是**防腐层（Anti-Corruption Layer）**，负责：
1. 承接小程序的用户注册、登录请求
2. 通过 gRPC 调用 apiserver 的 UserService
3. 管理受试者（Testee）的创建和查询
4. 为问卷收集提供用户身份验证

## 架构设计

### 系统边界

```
┌─────────────────────────────────────────────────────────────┐
│                    collection-server                        │
│                                                             │
│  ┌─────────────────────────────────────────────────────┐  │
│  │           Interface Layer (HTTP API)                │  │
│  │  - POST /api/v1/users/miniprogram/register          │  │
│  │  - POST /api/v1/users/miniprogram/login             │  │
│  │  - POST /api/v1/testees/register                    │  │
│  │  - GET  /api/v1/testees/:id                         │  │
│  └────────────────────┬────────────────────────────────┘  │
│                       │                                     │
│  ┌────────────────────▼────────────────────────────────┐  │
│  │         Application Layer (防腐层)                  │  │
│  │  - MiniProgramRegistrar  (小程序注册器)             │  │
│  │  - TesteeRegistrar       (受试者注册器)             │  │
│  │  - UserQueryer           (用户查询器)                │  │
│  └────────────────────┬────────────────────────────────┘  │
│                       │                                     │
│  ┌────────────────────▼────────────────────────────────┐  │
│  │         Infrastructure Layer (gRPC Client)          │  │
│  │  - UserServiceClient     (调用 apiserver)            │  │
│  └─────────────────────────────────────────────────────┘  │
└─────────────────────────────────────────────────────────────┘
                       │
                       │ gRPC
                       ▼
┌─────────────────────────────────────────────────────────────┐
│                      qs-apiserver                           │
│  - UserService (gRPC Server)                                │
│    - CreateOrUpdateMiniProgramAccount                       │
│    - CreateTestee                                           │
│    - GetTestee                                              │
└─────────────────────────────────────────────────────────────┘
```

## 模块职责

### 1. MiniProgramRegistrar - 小程序注册器

**职责**：
- 接收小程序的 code、用户信息
- 调用微信 API 换取 openid、session_key
- 通过 gRPC 调用 apiserver 创建/更新微信账号
- 创建/更新用户
- 返回 token 给小程序

**流程**：
```
1. 小程序调用 wx.login() 获取 code
2. 小程序调用 wx.getUserProfile() 获取用户信息
3. 小程序发送 POST /api/v1/users/miniprogram/register
   {
     "code": "xxx",
     "nickname": "张三",
     "avatar": "https://..."
   }
4. MiniProgramRegistrar:
   a. 调用微信 API: code → openid + session_key
   b. 调用 gRPC: UserService.CreateOrUpdateMiniProgramAccount
   c. 生成 JWT token
   d. 返回: { "token": "...", "user_id": 123, "is_new": true }
```

**接口定义**：
```go
type MiniProgramRegistrar struct {
    userServiceClient pb.UserServiceClient  // gRPC 客户端
    wxClient          *wechat.Client        // 微信客户端
    jwtGenerator      *JWTGenerator         // JWT 生成器
}

func (r *MiniProgramRegistrar) Register(ctx context.Context, req *RegisterRequest) (*RegisterResponse, error)
```

### 2. TesteeRegistrar - 受试者注册器

**职责**：
- 将用户注册为受试者（测试参与者）
- 调用 gRPC UserService.CreateTestee
- 返回受试者 ID

**流程**：
```
1. 前端调用 POST /api/v1/testees/register
   Header: Authorization: Bearer <token>
   {
     "realname": "张三",
     "id_card": "110101199001011234",  // 可选
     "code": "TEST001"                 // 受试者编码
   }
2. TesteeRegistrar:
   a. 从 token 解析 user_id
   b. 调用 gRPC: UserService.CreateTestee
   c. 返回: { "testee_id": 456 }
```

**接口定义**：
```go
type TesteeRegistrar struct {
    userServiceClient pb.UserServiceClient
}

func (r *TesteeRegistrar) RegisterTestee(ctx context.Context, userID uint64, req *TesteeRequest) (*TesteeResponse, error)
```

### 3. UserQueryer - 用户查询器

**职责**：
- 查询用户信息
- 查询受试者信息
- 调用 gRPC UserService.GetUser / GetTestee

**接口定义**：
```go
type UserQueryer struct {
    userServiceClient pb.UserServiceClient
}

func (q *UserQueryer) GetUser(ctx context.Context, userID uint64) (*UserInfo, error)
func (q *UserQueryer) GetTestee(ctx context.Context, testeeID uint64) (*TesteeInfo, error)
```

## 数据流设计

### 小程序注册/登录流程

```sequence
小程序 -> collection-server: POST /users/miniprogram/register
collection-server -> 微信API: code2Session (code → openid)
collection-server -> apiserver (gRPC): CreateOrUpdateMiniProgramAccount
apiserver -> MySQL: Upsert wx_accounts + users
apiserver -> collection-server: WechatAccountResponse
collection-server -> collection-server: 生成 JWT token
collection-server -> 小程序: { token, user_id, is_new }
```

### 受试者注册流程

```sequence
小程序 -> collection-server: POST /testees/register (with token)
collection-server -> collection-server: 验证 token → user_id
collection-server -> apiserver (gRPC): CreateTestee
apiserver -> MySQL: Insert testees
apiserver -> collection-server: TesteeResponse
collection-server -> 小程序: { testee_id }
```

## 目录结构

```
internal/collection-server/
├── interface/
│   └── http/
│       └── handler/
│           ├── user_handler.go           # 用户 HTTP 接口
│           └── testee_handler.go         # 受试者 HTTP 接口
├── application/
│   └── user/
│       ├── miniprogram_registrar.go      # 小程序注册器
│       ├── testee_registrar.go           # 受试者注册器
│       ├── user_queryer.go               # 用户查询器
│       └── README.md
├── infrastructure/
│   └── grpc/
│       └── user_service_client.go        # gRPC 客户端封装
└── config/
    └── grpc.go                            # gRPC 连接配置
```

## 关键设计原则

### 1. 防腐层模式（Anti-Corruption Layer）

collection-server 不直接依赖 apiserver 的领域模型，而是：
- 定义自己的 DTO (Data Transfer Object)
- 通过 gRPC 协议通信
- 隔离 apiserver 的变化

### 2. 单一职责

- **MiniProgramRegistrar**: 只负责小程序用户注册
- **TesteeRegistrar**: 只负责受试者注册
- **UserQueryer**: 只负责用户查询

不要创建大而全的 UserService！

### 3. 无状态设计

- 所有用户数据存储在 apiserver
- collection-server 只保存 token → user_id 的映射（通过 JWT 实现）
- 不维护用户状态

### 4. 错误处理

gRPC 调用失败时：
- 转换 gRPC 错误码为 HTTP 状态码
- 记录详细日志
- 返回友好的错误信息给前端

## API 设计

### POST /api/v1/users/miniprogram/register

**请求**：
```json
{
  "app_id": "wx1234567890",
  "code": "081xYzll2WXXXXX",
  "nickname": "张三",
  "avatar": "https://thirdwx.qlogo.cn/xxx"
}
```

**响应**：
```json
{
  "code": 0,
  "message": "success",
  "data": {
    "token": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...",
    "user_id": 123,
    "account_id": 456,
    "is_new_user": true
  }
}
```

### POST /api/v1/testees/register

**请求**（需要 Authorization header）：
```json
{
  "realname": "张三",
  "id_card": "110101199001011234",
  "code": "TEST001"
}
```

**响应**：
```json
{
  "code": 0,
  "message": "success",
  "data": {
    "testee_id": 789,
    "user_id": 123,
    "code": "TEST001"
  }
}
```

### GET /api/v1/testees/:id

**响应**：
```json
{
  "code": 0,
  "message": "success",
  "data": {
    "testee_id": 789,
    "user_id": 123,
    "realname": "张三",
    "code": "TEST001",
    "status": "active"
  }
}
```

## 实现优先级

### P0 - 必须实现
1. MiniProgramRegistrar (小程序注册/登录)
2. gRPC UserServiceClient 封装
3. JWT token 生成和验证

### P1 - 重要
1. TesteeRegistrar (受试者注册)
2. UserQueryer (用户查询)

### P2 - 可选
1. Token 刷新机制
2. 用户信息缓存

## 技术选型

- **gRPC 客户端**: google.golang.org/grpc
- **JWT**: github.com/golang-jwt/jwt/v5
- **微信 SDK**: github.com/silenceper/wechat/v2
- **HTTP 路由**: github.com/gin-gonic/gin

## 安全考虑

1. **Token 验证**: 所有需要用户身份的接口必须验证 JWT token
2. **gRPC TLS**: 生产环境使用 TLS 加密 gRPC 通信
3. **敏感信息**: 不在日志中打印 session_key、token 等敏感信息
4. **权限控制**: 用户只能操作自己的数据

## 下一步

1. 创建 gRPC 客户端封装
2. 实现 MiniProgramRegistrar
3. 实现 HTTP handler
4. 编写集成测试
