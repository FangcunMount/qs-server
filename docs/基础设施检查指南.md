# 基础设施检查指南

## 概述

本项目提供了完整的基础设施检查功能，确保在启动服务前所有依赖的系统组件（MySQL、Redis、MongoDB、NSQ）都已就绪。

## 检查命令

### 检查所有基础设施组件

```bash
make check-infra
```

该命令会依次检查：
- MySQL 数据库连接和数据库可用性
- Redis 缓存服务连接
- MongoDB 文档数据库连接
- NSQ 消息队列服务（nsqd 和 nsqlookupd）

### 单独检查各组件

```bash
# 检查 MySQL
make check-mysql

# 检查 Redis
make check-redis

# 检查 MongoDB
make check-mongodb

# 检查 NSQ
make check-nsq
```

## 检查结果说明

### 状态标识

- **✅ 就绪** - 组件完全可用，已通过连接测试
- **⚠️  端口可达，但无客户端验证** - 端口开放，但系统缺少客户端工具无法完全验证
- **❌ 连接失败** - 组件不可用或配置错误
- **❌ 端口不可达** - 组件未启动或网络不通

### 检查示例

```bash
$ make check-infra

🔍 检查基础设施状态...

📦 MySQL:       ✅ 就绪 (127.0.0.1:3306/questionnaire_scale)
📦 Redis:       ✅ 就绪 (127.0.0.1:6379)
📦 MongoDB:     ✅ 就绪 (127.0.0.1:27017/questionnaire_scale)
📦 NSQ:         ✅ 就绪 (nsqd:4150, lookupd:4160)

✅ 所有基础设施组件就绪！
```

## 自动检查

以下命令会在执行前自动检查基础设施：

```bash
# 快速启动（检查 + 构建 + 运行）
make quick-start

# 运行所有服务（先检查）
make run-all
```

如果检查失败，命令会提前终止并显示错误信息。

## 配置文件

检查命令从以下配置文件读取连接信息：

- **MySQL/Redis/MongoDB**: `configs/apiserver.dev.yaml`
- **NSQ**: 默认端口（nsqd: 4150/4151, lookupd: 4160/4161）

## 依赖工具

为了获得最佳的检查效果，建议安装以下客户端工具：

### macOS 安装

```bash
# MySQL 客户端
brew install mysql-client

# Redis 客户端
brew install redis

# MongoDB 客户端
brew install mongosh

# 网络工具（通常已预装）
# nc (netcat) - 用于端口检查
```

### 最小依赖

如果不安装客户端工具，检查功能会降级使用 `nc`（netcat）进行端口探测：

- ✅ 可以检测端口是否开放
- ❌ 无法验证服务是否真正可用（例如密码错误、数据库不存在等）

## 检查逻辑

### MySQL 检查

1. 从配置文件读取主机、端口、用户名、密码、数据库名
2. 如果有 `mysql` 客户端，尝试连接并执行 `USE database; SELECT 1;`
3. 如果没有客户端，使用 `nc` 检查端口

### Redis 检查

1. 从配置文件读取主机、端口、密码
2. 如果有 `redis-cli` 客户端，执行 `PING` 命令
3. 如果没有客户端，使用 `nc` 检查端口

### MongoDB 检查

1. 从配置文件读取完整 URL、主机、端口、数据库名
2. 如果有 `mongosh` 或 `mongo` 客户端，执行 `db.adminCommand('ping')`
3. 如果没有客户端，使用 `nc` 检查端口

### NSQ 检查

1. 检查 nsqd 的 TCP 端口（4150）和 HTTP 端口（4151）
2. 检查 nsqlookupd 的 TCP 端口（4160）和 HTTP 端口（4161）
3. 使用 `nc` 进行端口探测

## 故障排查

### 问题：MySQL 连接失败

```bash
📦 MySQL:       ❌ 连接失败 (127.0.0.1:3306)
```

**可能原因：**
1. MySQL 服务未启动
2. 配置文件中的用户名、密码错误
3. 数据库不存在
4. 防火墙阻止连接

**解决方案：**
```bash
# 检查 infra 项目是否启动
cd ../infra
make status

# 如果未启动，启动 infra
make up

# 验证 MySQL 容器运行
docker ps | grep mysql

# 手动测试连接
mysql -h127.0.0.1 -P3306 -uqs_app_user -pqs_app_password_2024 -e "SHOW DATABASES;"
```

### 问题：Redis 连接失败

```bash
📦 Redis:       ❌ 连接失败 (127.0.0.1:6379)
```

**可能原因：**
1. Redis 服务未启动
2. 配置文件中的密码错误
3. Redis 绑定地址配置问题

**解决方案：**
```bash
# 检查 Redis 是否运行
redis-cli -h 127.0.0.1 -p 6379 -a questionnaire_redis_2024 ping

# 检查 infra 项目
cd ../infra
docker ps | grep redis
docker logs redis
```

### 问题：MongoDB 连接失败

```bash
📦 MongoDB:     ❌ 连接失败 (127.0.0.1:27017)
```

**可能原因：**
1. MongoDB 服务未启动
2. 认证信息错误
3. 数据库未初始化

**解决方案：**
```bash
# 手动测试连接
mongosh "mongodb://qs_app_user:qs_app_password_2024@127.0.0.1:27017/questionnaire_scale"

# 检查 infra 项目
cd ../infra
docker ps | grep mongo
docker logs mongodb
```

### 问题：NSQ 不可达

```bash
📦 NSQ:         ❌ 不可达 (127.0.0.1:4150/4160)
```

**可能原因：**
1. NSQ 服务未启动
2. 端口被占用

**解决方案：**
```bash
# 检查端口占用
lsof -i :4150
lsof -i :4160

# 检查 infra 项目
cd ../infra
docker ps | grep nsq
docker logs nsqd
docker logs nsqlookupd
```

## 集成到 CI/CD

在 CI/CD 管道中，可以使用检查命令来验证环境：

```yaml
# .github/workflows/deploy.yml 示例
- name: Check Infrastructure
  run: make check-infra
  
- name: Build and Deploy
  run: make build-all && make run-all
```

## 跳过检查

如果需要在某些情况下跳过检查（不推荐），可以直接调用底层命令：

```bash
# 不检查基础设施，直接构建
make build-all

# 不检查基础设施，直接运行（需要先停止 run-all 的检查）
./bin/qs-apiserver --config=configs/apiserver.dev.yaml &
./bin/collection-server --config=configs/collection-server.dev.yaml &
```

## 最佳实践

1. **开发环境**
   - 启动 qs-server 前，先确保 infra 项目已启动：`cd ../infra && make up`
   - 使用 `make check-infra` 验证环境
   - 使用 `make quick-start` 一键启动

2. **生产环境**
   - 在部署脚本中集成 `make check-infra`
   - 失败时自动告警，不继续部署
   - 定期运行健康检查

3. **故障排查**
   - 服务启动失败时，先运行 `make check-infra`
   - 根据检查结果，定位问题组件
   - 使用客户端工具手动验证

## 扩展检查

如果需要添加更多组件检查（例如 Kafka、Elasticsearch），可以参考现有实现：

```makefile
check-kafka: ## 检查 Kafka 是否就绪
	@echo -n "$(COLOR_CYAN)📦 Kafka:       $(COLOR_RESET)"
	@KAFKA_HOST="127.0.0.1"; \
	KAFKA_PORT=9092; \
	if nc -z $$KAFKA_HOST $$KAFKA_PORT >/dev/null 2>&1; then \
		echo "$(COLOR_GREEN)✅ 就绪$(COLOR_RESET) ($$KAFKA_HOST:$$KAFKA_PORT)"; \
	else \
		echo "$(COLOR_RED)❌ 不可达$(COLOR_RESET) ($$KAFKA_HOST:$$KAFKA_PORT)"; \
		exit 1; \
	fi
```

然后在 `check-infra` 中添加调用即可。
