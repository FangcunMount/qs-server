# æ•°æ®åè°ƒé‡æ„ï¼šä»å­˜å‚¨å±‚åˆ°åº”ç”¨æœåŠ¡å±‚

## é‡æ„èƒŒæ™¯

åœ¨ä¹‹å‰çš„æ¶æ„ä¸­ï¼Œæˆ‘ä»¬åœ¨å­˜å‚¨å±‚ï¼ˆ`adapters/storage/composite/`ï¼‰å®ç°äº†ç»„åˆå¤šä¸ªæ•°æ®æºï¼ˆMySQL + MongoDBï¼‰çš„é€»è¾‘ã€‚è¿™ç§è®¾è®¡è¿åäº†å…­è¾¹å½¢æ¶æ„çš„åˆ†å±‚åŸåˆ™å’Œå•ä¸€èŒè´£åŸåˆ™ã€‚

## é—®é¢˜åˆ†æ

### ğŸš¨ åŸæœ‰æ¶æ„é—®é¢˜

#### 1. **å­˜å‚¨å±‚èŒè´£è¶Šç•Œ**
```go
// âŒ å­˜å‚¨å±‚åœ¨åšåº”ç”¨æœåŠ¡å±‚çš„å·¥ä½œ
func (r *questionnaireCompositeRepository) Save(ctx context.Context, q *questionnaire.Questionnaire) error {
    // 1. ä¿å­˜åŸºç¡€ä¿¡æ¯åˆ° MySQL
    if err := r.mysqlRepo.Save(ctx, q); err != nil {
        return fmt.Errorf("failed to save questionnaire to MySQL: %w", err)
    }

    // 2. ä¿å­˜æ–‡æ¡£ç»“æ„åˆ° MongoDB
    if err := r.documentRepo.SaveDocument(ctx, q); err != nil {
        // å¦‚æœ MongoDB å¤±è´¥ï¼Œå°è¯•å›æ»š MySQLï¼ˆç®€å•å®ç°ï¼‰
        _ = r.mysqlRepo.Remove(ctx, q.ID())  // âŒ äº‹åŠ¡é€»è¾‘
        return fmt.Errorf("failed to save questionnaire document to MongoDB: %w", err)
    }
}
```

#### 2. **è¿åå•ä¸€èŒè´£åŸåˆ™**
- **å­˜å‚¨å±‚åº”è¯¥**ï¼šä¸“æ³¨äºä¸ç‰¹å®šæ•°æ®æºçš„CRUDæ“ä½œ
- **å®é™…åœ¨åš**ï¼šåè°ƒå¤šä¸ªæ•°æ®æºã€äº‹åŠ¡ç®¡ç†ã€æ•°æ®åˆå¹¶

#### 3. **æ¶æ„å±‚æ¬¡æ··ä¹±**
- å­˜å‚¨å±‚åŒ…å«ä¸šåŠ¡ç¼–æ’é€»è¾‘
- äº‹åŠ¡ç®¡ç†æ•£å¸ƒåœ¨åŸºç¡€è®¾æ–½å±‚
- æ•°æ®ä¸€è‡´æ€§é€»è¾‘ç¼ºä¹ç»Ÿä¸€ç®¡ç†

## é‡æ„æ–¹æ¡ˆ

### âœ… æ–°çš„æ¶æ„è®¾è®¡

#### 1. **å­˜å‚¨å±‚èŒè´£æ¸…æ™°**
```go
// âœ… å­˜å‚¨å±‚ä¸“æ³¨äºå•ä¸€æ•°æ®æº
type mysqlQuestionnaireRepository struct {
    // åªè´Ÿè´£MySQLæ“ä½œ
}

type mongoQuestionnaireRepository struct {
    // åªè´Ÿè´£MongoDBæ“ä½œ
}
```

#### 2. **åº”ç”¨æœåŠ¡å±‚æ•°æ®åè°ƒ**
```go
// âœ… åº”ç”¨å±‚è´Ÿè´£å¤šæ•°æ®æºåè°ƒ
type DataCoordinator struct {
    mysqlRepo    storage.QuestionnaireRepository
    documentRepo storage.QuestionnaireDocumentRepository
}

// åº”ç”¨å±‚å¤„ç†ä¸šåŠ¡è§„åˆ™å’Œäº‹åŠ¡é€»è¾‘
func (c *DataCoordinator) SaveQuestionnaire(ctx context.Context, q *questionnaire.Questionnaire) error {
    // ä¸šåŠ¡è§„åˆ™ï¼šå…ˆä¿å­˜åŸºç¡€ä¿¡æ¯ï¼Œå†ä¿å­˜æ–‡æ¡£ç»“æ„
    
    // 1. ä¿å­˜åŸºç¡€ä¿¡æ¯åˆ° MySQL
    if err := c.mysqlRepo.Save(ctx, q); err != nil {
        return fmt.Errorf("failed to save questionnaire basic info: %w", err)
    }

    // 2. ä¿å­˜æ–‡æ¡£ç»“æ„åˆ° MongoDB
    if err := c.documentRepo.SaveDocument(ctx, q); err != nil {
        // åº”ç”¨å±‚å¤„ç†äº‹åŠ¡ä¸€è‡´æ€§ï¼šå›æ»šMySQLæ“ä½œ
        if rollbackErr := c.mysqlRepo.Remove(ctx, q.ID()); rollbackErr != nil {
            return fmt.Errorf("failed to save document and rollback failed: original=%w, rollback=%w", err, rollbackErr)
        }
        return fmt.Errorf("failed to save questionnaire document: %w", err)
    }

    return nil
}
```

## æ¶æ„å¯¹æ¯”

### é‡æ„å‰
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                åº”ç”¨æœåŠ¡å±‚                      â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚        QuestionnaireService            â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                        â”‚
                        â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                 å­˜å‚¨å±‚                       â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚    CompositeRepository                 â”‚ â”‚ âŒ èŒè´£è¶Šç•Œ
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚ â”‚
â”‚  â”‚  â”‚ MySQLRepo   â”‚  â”‚ MongoRepo       â”‚  â”‚ â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### é‡æ„å
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                åº”ç”¨æœåŠ¡å±‚                      â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚        QuestionnaireService            â”‚ â”‚ âœ… ä¸šåŠ¡åè°ƒ
â”‚  â”‚                                       â”‚ â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚ â”‚
â”‚  â”‚  â”‚       DataCoordinator              â”‚ â”‚ â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                        â”‚
                        â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                 å­˜å‚¨å±‚                       â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚ MySQLRepo   â”‚        â”‚ MongoRepo       â”‚  â”‚ âœ… èŒè´£å•ä¸€
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## é‡æ„å®ç°

### 1. **DataCoordinator æ ¸å¿ƒåŠŸèƒ½**

#### æ•°æ®ä¿å­˜åè°ƒ
- å…ˆä¿å­˜MySQLåŸºç¡€ä¿¡æ¯
- å†ä¿å­˜MongoDBæ–‡æ¡£ç»“æ„
- å¤±è´¥æ—¶è‡ªåŠ¨å›æ»š

#### æ•°æ®æŸ¥è¯¢åˆå¹¶
- ä»MySQLè·å–åŸºç¡€ä¿¡æ¯
- ä»MongoDBè·å–æ–‡æ¡£ç»“æ„
- åº”ç”¨å±‚åˆå¹¶æ•°æ®

#### æ•°æ®ä¸€è‡´æ€§æ£€æŸ¥
- æ£€æŸ¥ä¸¤ä¸ªæ•°æ®æºçš„æ•°æ®ä¸€è‡´æ€§
- æä¾›æ•°æ®ä¿®å¤åŠŸèƒ½

### 2. **é—®å·æœåŠ¡å¢å¼º**

#### åŒæ„é€ å‡½æ•°è®¾è®¡
```go
// å¤šæ•°æ®æºæ¨¡å¼
func NewService(
    mysqlRepo storage.QuestionnaireRepository,
    mongoRepo storage.QuestionnaireDocumentRepository,
) *Service

// å•æ•°æ®æºæ¨¡å¼ï¼ˆå‘åå…¼å®¹ï¼‰
func NewServiceWithSingleRepo(questionnaireRepo storage.QuestionnaireRepository) *Service
```

#### æ–°å¢æ•°æ®ä¸€è‡´æ€§æ–¹æ³•
- `CheckQuestionnaireDataConsistency()` - æ£€æŸ¥æ•°æ®ä¸€è‡´æ€§
- `RepairQuestionnaireData()` - ä¿®å¤æ•°æ®ä¸ä¸€è‡´
- `GetCompleteQuestionnaire()` - è·å–å®Œæ•´é—®å·ï¼ˆåŒ…å«æ–‡æ¡£ï¼‰

### 3. **æ–‡ä»¶ç»“æ„å˜åŒ–**

#### åˆ é™¤æ–‡ä»¶
- `internal/apiserver/adapters/storage/composite/questionnaire.go` (162è¡Œ)

#### æ–°å¢æ–‡ä»¶
- `internal/apiserver/application/questionnaire/coordinator.go` (189è¡Œ)

#### ä¿®æ”¹æ–‡ä»¶
- `internal/apiserver/application/questionnaire/service.go` (å¢å¼º315è¡Œ â†’ 398è¡Œ)

## æ¶æ„ä¼˜åŠ¿

### 1. **æ¸…æ™°çš„èŒè´£åˆ†ç¦»**
- **å­˜å‚¨å±‚**ï¼šä¸“æ³¨å•ä¸€æ•°æ®æºCRUD
- **åº”ç”¨å±‚**ï¼šè´Ÿè´£ä¸šåŠ¡åè°ƒå’Œäº‹åŠ¡ç®¡ç†
- **é¢†åŸŸå±‚**ï¼šä¿æŒçº¯ç²¹çš„ä¸šåŠ¡è§„åˆ™

### 2. **æ›´å¥½çš„å¯æµ‹è¯•æ€§**
- DataCoordinatorå¯ä»¥ç‹¬ç«‹æµ‹è¯•
- å­˜å‚¨å±‚é€‚é…å™¨æ›´å®¹æ˜“æ¨¡æ‹Ÿ
- ä¸šåŠ¡é€»è¾‘ä¸åŸºç¡€è®¾æ–½è§£è€¦

### 3. **å¢å¼ºçš„æ‰©å±•æ€§**
- æ˜“äºæ·»åŠ æ–°çš„æ•°æ®æº
- æ”¯æŒä¸åŒçš„æ•°æ®åè°ƒç­–ç•¥
- çµæ´»çš„äº‹åŠ¡ç®¡ç†æœºåˆ¶

### 4. **æ•°æ®ä¸€è‡´æ€§ä¿éšœ**
- ç»Ÿä¸€çš„æ•°æ®ä¸€è‡´æ€§æ£€æŸ¥
- è‡ªåŠ¨åŒ–æ•°æ®ä¿®å¤æœºåˆ¶
- æ¸…æ™°çš„é”™è¯¯å¤„ç†å’Œå›æ»šé€»è¾‘

## ä½¿ç”¨ç¤ºä¾‹

### å¤šæ•°æ®æºæ¨¡å¼
```go
// åˆ›å»ºæœåŠ¡
mysqlRepo := mysql.NewQuestionnaireRepository(db)
mongoRepo := mongodb.NewQuestionnaireRepository(mongoClient)
service := questionnaire.NewService(mysqlRepo, mongoRepo)

// ä½¿ç”¨æ•°æ®ä¸€è‡´æ€§åŠŸèƒ½
consistency, err := service.CheckQuestionnaireDataConsistency(ctx, "questionnaire-id")
if consistency["status"] != "consistent" {
    err = service.RepairQuestionnaireData(ctx, "questionnaire-id")
}

// è·å–å®Œæ•´é—®å·
completeQ, err := service.GetCompleteQuestionnaire(ctx, "questionnaire-id")
```

### å•æ•°æ®æºæ¨¡å¼ï¼ˆå‘åå…¼å®¹ï¼‰
```go
// åˆ›å»ºæœåŠ¡
repo := mysql.NewQuestionnaireRepository(db)
service := questionnaire.NewServiceWithSingleRepo(repo)

// æ­£å¸¸ä½¿ç”¨ï¼Œæ— æ•°æ®åè°ƒåŠŸèƒ½
q, err := service.GetQuestionnaire(ctx, query)
```

## æ€»ç»“

è¿™æ¬¡é‡æ„å°†æ•°æ®åè°ƒé€»è¾‘ä»å­˜å‚¨å±‚ç§»åˆ°äº†åº”ç”¨æœåŠ¡å±‚ï¼Œ**å®ç°äº†æ›´ç¬¦åˆå…­è¾¹å½¢æ¶æ„åŸåˆ™çš„è®¾è®¡**ï¼š

1. **å­˜å‚¨å±‚èŒè´£å•ä¸€**ï¼šæ¯ä¸ªé€‚é…å™¨ä¸“æ³¨äºå•ä¸€æ•°æ®æº
2. **åº”ç”¨å±‚ä¸šåŠ¡åè°ƒ**ï¼šDataCoordinatorå¤„ç†è·¨æ•°æ®æºçš„ä¸šåŠ¡é€»è¾‘
3. **æ¸…æ™°çš„æ¶æ„è¾¹ç•Œ**ï¼šå„å±‚èŒè´£æ˜ç¡®ï¼Œæ˜“äºç»´æŠ¤å’Œæ‰©å±•
4. **ä¼ä¸šçº§ç‰¹æ€§**ï¼šæ•°æ®ä¸€è‡´æ€§ä¿éšœã€äº‹åŠ¡ç®¡ç†ã€é”™è¯¯å¤„ç†

è¿™æ˜¯ä¸€ä¸ª**ä»æŠ€æœ¯å€ºåŠ¡åˆ°æ¶æ„ä¼˜é›…**çš„å…¸å‹é‡æ„æ¡ˆä¾‹ï¼Œä½“ç°äº†å…­è¾¹å½¢æ¶æ„å’ŒDDDè®¾è®¡çš„æ ¸å¿ƒä»·å€¼ã€‚ 