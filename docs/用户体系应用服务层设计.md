# 用户体系应用服务层设计

## 设计原则

本设计遵循**关注点分离**（Separation of Concerns）原则，将应用服务层按照不同的业务职责进行划分：

1. **User** - 基础用户管理
2. **WechatAccount** - 微信账号管理
3. **Role** - 用户角色管理（Testee、Writer、Auditor）

## 架构概览

```
application/
├── user/                    # 基础用户服务
│   ├── creator.go          # ✅ 保留 - 用户创建
│   ├── editor.go           # ✅ 保留 - 用户编辑
│   ├── activator.go        # ❌ 移除建议 - 非通用需求
│   ├── password-changer.go # ❌ 移除建议 - 非通用需求
│   └── queryer.go          # ❌ 移除建议 - 非通用需求
│
├── wechat/                  # 微信相关服务
│   ├── account-creator.go  # ⭐ 新增 - 微信账号创建
│   ├── authenticator.go    # ✅ 保留 - 微信登录认证
│   ├── phone-binder.go     # ✅ 保留 - 手机号绑定
│   └── ...                 # 其他微信相关服务
│
└── role/                    # ⭐ 新增 - 角色管理服务
    ├── testee-creator.go   # 受试者创建
    ├── writer-creator.go   # 填写人创建
    └── auditor-creator.go  # 审核员创建
```

---

## 一、基础用户服务 (application/user)

### 保留的服务

#### 1. UserCreator - 用户创建器

**职责**: 创建基础用户账号

**方法**:
```go
CreateUser(ctx, username, password, nickname, email, phone, introduction) (*user.User, error)
```

**使用场景**:
- 用户注册
- 管理员创建用户
- 批量导入用户

**文件**: `application/user/creator.go`

---

#### 2. UserEditor - 用户编辑器

**职责**: 编辑用户基本信息

**方法**:
```go
UpdateBasicInfo(ctx, id, username, nickname, email, phone, avatar, introduction) (*user.User, error)
UpdateAvatar(ctx, id, avatar) error
```

**使用场景**:
- 用户修改个人资料
- 管理员编辑用户信息

**文件**: `application/user/editor.go`

---

### 建议移除的服务

以下服务不属于通用功能，建议移除或移到特定业务模块：

#### ❌ UserActivator - 用户状态管理
- **原因**: 用户状态管理不是高频操作，可以通过 UserEditor 或专门的管理后台服务实现
- **替代方案**: 在管理后台模块实现

#### ❌ PasswordChanger - 密码管理
- **原因**: 密码修改属于安全相关操作，应该在独立的认证/安全模块中实现
- **替代方案**: 在 `application/auth` 模块实现

#### ❌ UserQueryer - 用户查询
- **原因**: 查询操作应该直接通过 Repository 或 Query Service 实现，不需要单独的应用服务
- **替代方案**: 直接使用 `domain/user/port/repository.go`

---

## 二、微信账号服务 (application/wechat)

### ⭐ 新增：WechatAccountCreator - 微信账号创建器

**职责**: 创建或更新微信账号（小程序、公众号）

**方法**:
```go
// 创建或更新小程序账号
CreateOrUpdateMiniProgramAccount(
    ctx context.Context,
    appID string,
    openID string,
    unionID *string,
    nickname string,
    avatar string,
    sessionKey string,
) (*accountDomain.WechatAccount, error)

// 创建或更新公众号账号
CreateOrUpdateOfficialAccount(
    ctx context.Context,
    appID string,
    openID string,
    unionID *string,
    nickname string,
    avatar string,
) (*accountDomain.WechatAccount, error)

// 获取微信账号
GetWechatAccountByOpenID(
    ctx context.Context,
    appID string,
    platform accountDomain.WxPlatform,
    openID string,
) (*accountDomain.WechatAccount, error)
```

**使用场景**:
- ✅ 用户第一次使用小程序时创建对应账户
- ✅ 用户关注公众号时创建对应的账号
- ✅ 更新微信用户信息（昵称、头像）

**文件**: `application/wechat/account-creator.go` ⭐ 新增

**设计特点**:
- 自动验证微信应用是否启用
- 支持创建和更新（Upsert 模式）
- 分离小程序和公众号账号创建逻辑
- 自动更新用户资料和 SessionKey

---

## 三、角色管理服务 (application/role) ⭐ 新增模块

### 1. TesteeCreator - 受试者创建器

**职责**: 创建和管理受试者角色

**方法**:
```go
// 创建受试者
CreateTestee(ctx, userID, name, sex, birthday) (*role.Testee, error)

// 更新受试者信息
UpdateTestee(ctx, userID, name, sex, birthday) (*role.Testee, error)

// 获取受试者
GetTesteeByUserID(ctx, userID) (*role.Testee, error)

// 检查是否存在
TesteeExists(ctx, userID) bool
```

**使用场景**:
- ✅ 用户在小程序侧注册受试者时创建 Testee
- ✅ 更新受试者个人信息（姓名、性别、生日）
- ✅ 查询受试者信息

**文件**: `application/role/testee-creator.go` ⭐ 新增

**Repository 接口**:
```go
type TesteeRepository interface {
    Save(ctx, testee) error
    Update(ctx, testee) error
    FindByUserID(ctx, userID) (*role.Testee, error)
    ExistsByUserID(ctx, userID) bool
}
```

---

### 2. AuditorCreator - 审核员创建器

**职责**: 创建和管理审核员角色

**方法**:
```go
// 创建审核员
CreateAuditor(ctx, userID, name, employeeID, department, position, hiredAt) (*role.Auditor, error)

// 更新审核员信息
UpdateAuditorInfo(ctx, userID, name, department, position) (*role.Auditor, error)

// 状态管理
UpdateAuditorStatus(ctx, userID, status) (*role.Auditor, error)
ActivateAuditor(ctx, userID) error       // 激活（在职）
SuspendAuditor(ctx, userID) error        // 停职
ResignAuditor(ctx, userID) error         // 离职
SetAuditorOnLeave(ctx, userID) error     // 休假

// 查询
GetAuditorByUserID(ctx, userID) (*role.Auditor, error)
GetAuditorByEmployeeID(ctx, employeeID) (*role.Auditor, error)
AuditorExists(ctx, userID) bool
CanAudit(ctx, userID) (bool, error)      // 检查是否可审核
```

**使用场景**:
- ✅ 创建审核账户时创建 Auditor
- ✅ 管理员工状态（在职、休假、停职、离职）
- ✅ 权限验证（是否可以审核）
- ✅ 更新员工信息

**文件**: `application/role/auditor-creator.go` ⭐ 新增

**Repository 接口**:
```go
type AuditorRepository interface {
    Save(ctx, auditor) error
    Update(ctx, auditor) error
    FindByUserID(ctx, userID) (*role.Auditor, error)
    FindByEmployeeID(ctx, employeeID) (*role.Auditor, error)
    ExistsByUserID(ctx, userID) bool
    ExistsByEmployeeID(ctx, employeeID) bool
}
```

---

### 3. WriterCreator - 填写人创建器

**职责**: 创建和管理填写人角色

**方法**:
```go
// 创建填写人
CreateWriter(ctx, userID, name) (*role.Writer, error)

// 更新填写人
UpdateWriter(ctx, userID, name) (*role.Writer, error)

// 查询
GetWriterByUserID(ctx, userID) (*role.Writer, error)
WriterExists(ctx, userID) bool
```

**使用场景**:
- 创建代理填写账号
- 更新填写人信息

**文件**: `application/role/writer-creator.go` ⭐ 新增

**Repository 接口**:
```go
type WriterRepository interface {
    Save(ctx, writer) error
    Update(ctx, writer) error
    FindByUserID(ctx, userID) (*role.Writer, error)
    ExistsByUserID(ctx, userID) bool
}
```

---

## 使用示例

### 场景1: 用户首次使用小程序

```go
// 1. 创建或更新微信账号
wxAccountCreator := wechat.NewWechatAccountCreator(wxAccountRepo, appRepo)
wxAccount, err := wxAccountCreator.CreateOrUpdateMiniProgramAccount(
    ctx,
    "wx1234567890",     // appID
    "oABC123",          // openID
    &unionID,           // unionID
    "张三",             // nickname
    "http://...",       // avatar
    "session_key_xxx",  // sessionKey
)

// 2. 如果是新用户，创建 User
if wxAccount.GetUserID().IsZero() {
    userCreator := user.NewUserCreator(userRepo)
    user, err := userCreator.CreateUser(ctx, username, password, ...)
    
    // 绑定 wxAccount 和 user
    wxAccount.BindUser(user.ID())
}

// 3. 创建受试者角色
testeeCreator := role.NewTesteeCreator(testeeRepo)
testee, err := testeeCreator.CreateTestee(
    ctx,
    user.ID(),
    "张三",
    1,                  // 男性
    &birthday,
)
```

---

### 场景2: 创建审核员账号

```go
// 1. 创建基础用户
userCreator := user.NewUserCreator(userRepo)
user, err := userCreator.CreateUser(
    ctx,
    "auditor001",
    "password123",
    "李审核",
    "audit@example.com",
    "13800138000",
    "高级审核员",
)

// 2. 创建审核员角色
auditorCreator := role.NewAuditorCreator(auditorRepo)
auditor, err := auditorCreator.CreateAuditor(
    ctx,
    user.ID(),
    "李审核",
    "EMP001",           // 员工编号
    "审核部",           // 部门
    "高级审核员",       // 职位
    &hiredAt,           // 入职时间
)

// 3. 使用权限验证
canAudit, err := auditorCreator.CanAudit(ctx, user.ID())
if canAudit {
    // 执行审核操作
}
```

---

### 场景3: 用户关注公众号

```go
wxAccountCreator := wechat.NewWechatAccountCreator(wxAccountRepo, appRepo)
wxAccount, err := wxAccountCreator.CreateOrUpdateOfficialAccount(
    ctx,
    "wx0987654321",     // 公众号 appID
    "oXYZ789",          // openID
    &unionID,           // unionID
    "王五",             // nickname
    "http://...",       // avatar
)

// 根据 unionID 合并账号逻辑...
```

---

## 关注点分离总结

| 服务模块 | 职责 | 对外提供 | 内部使用 |
|---------|------|---------|---------|
| **user/** | 基础用户管理 | Creator, Editor | - |
| **wechat/** | 微信账号管理 | AccountCreator | Authenticator, PhoneBinder |
| **role/** | 角色管理 | TesteeCreator, AuditorCreator, WriterCreator | - |

---

## Repository 实现建议

需要在基础设施层实现以下 Repository：

### 1. TesteeRepository
```go
// infra/mysql/testee/repository.go
type testeeRepository struct {
    db *gorm.DB
}
```

### 2. AuditorRepository
```go
// infra/mysql/auditor/repository.go
type auditorRepository struct {
    db *gorm.DB
}
```

### 3. WriterRepository
```go
// infra/mysql/writer/repository.go
type writerRepository struct {
    db *gorm.DB
}
```

---

## 下一步工作

✅ **已完成**:
1. 保留 User 的 Creator 和 Editor
2. 创建 WechatAccountCreator
3. 创建 TesteeCreator、AuditorCreator、WriterCreator

🔲 **待实现**:
1. 实现 Repository 接口（基础设施层）
2. 创建数据库表结构
3. 编写单元测试
4. 集成到 Container（依赖注入）
5. 创建 RESTful API 接口

---

## 文件清单

### 新增文件
- ✅ `application/wechat/account-creator.go` (164行)
- ✅ `application/role/testee-creator.go` (108行)
- ✅ `application/role/auditor-creator.go` (206行)
- ✅ `application/role/writer-creator.go` (91行)

### 保留文件
- ✅ `application/user/creator.go`
- ✅ `application/user/editor.go`

### 建议移除
- ❌ `application/user/activator.go`
- ❌ `application/user/password-changer.go`
- ❌ `application/user/queryer.go`
