# ç”¨æˆ·ä½“ç³»åº”ç”¨æœåŠ¡å±‚è®¾è®¡

## è®¾è®¡åŸåˆ™

æœ¬è®¾è®¡éµå¾ª**å…³æ³¨ç‚¹åˆ†ç¦»**ï¼ˆSeparation of Concernsï¼‰åŸåˆ™ï¼Œå°†åº”ç”¨æœåŠ¡å±‚æŒ‰ç…§ä¸åŒçš„ä¸šåŠ¡èŒè´£è¿›è¡Œåˆ’åˆ†ï¼š

1. **User** - åŸºç¡€ç”¨æˆ·ç®¡ç†
2. **WechatAccount** - å¾®ä¿¡è´¦å·ç®¡ç†
3. **Role** - ç”¨æˆ·è§’è‰²ç®¡ç†ï¼ˆTesteeã€Writerã€Auditorï¼‰

## æ¶æ„æ¦‚è§ˆ

```
application/
â”œâ”€â”€ user/                    # åŸºç¡€ç”¨æˆ·æœåŠ¡
â”‚   â”œâ”€â”€ creator.go          # âœ… ä¿ç•™ - ç”¨æˆ·åˆ›å»º
â”‚   â”œâ”€â”€ editor.go           # âœ… ä¿ç•™ - ç”¨æˆ·ç¼–è¾‘
â”‚   â”œâ”€â”€ activator.go        # âŒ ç§»é™¤å»ºè®® - éé€šç”¨éœ€æ±‚
â”‚   â”œâ”€â”€ password-changer.go # âŒ ç§»é™¤å»ºè®® - éé€šç”¨éœ€æ±‚
â”‚   â””â”€â”€ queryer.go          # âŒ ç§»é™¤å»ºè®® - éé€šç”¨éœ€æ±‚
â”‚
â”œâ”€â”€ wechat/                  # å¾®ä¿¡ç›¸å…³æœåŠ¡
â”‚   â”œâ”€â”€ account-creator.go  # â­ æ–°å¢ - å¾®ä¿¡è´¦å·åˆ›å»º
â”‚   â”œâ”€â”€ authenticator.go    # âœ… ä¿ç•™ - å¾®ä¿¡ç™»å½•è®¤è¯
â”‚   â”œâ”€â”€ phone-binder.go     # âœ… ä¿ç•™ - æ‰‹æœºå·ç»‘å®š
â”‚   â””â”€â”€ ...                 # å…¶ä»–å¾®ä¿¡ç›¸å…³æœåŠ¡
â”‚
â””â”€â”€ role/                    # â­ æ–°å¢ - è§’è‰²ç®¡ç†æœåŠ¡
    â”œâ”€â”€ testee-creator.go   # å—è¯•è€…åˆ›å»º
    â”œâ”€â”€ writer-creator.go   # å¡«å†™äººåˆ›å»º
    â””â”€â”€ auditor-creator.go  # å®¡æ ¸å‘˜åˆ›å»º
```

---

## ä¸€ã€åŸºç¡€ç”¨æˆ·æœåŠ¡ (application/user)

### ä¿ç•™çš„æœåŠ¡

#### 1. UserCreator - ç”¨æˆ·åˆ›å»ºå™¨

**èŒè´£**: åˆ›å»ºåŸºç¡€ç”¨æˆ·è´¦å·

**æ–¹æ³•**:
```go
CreateUser(ctx, username, password, nickname, email, phone, introduction) (*user.User, error)
```

**ä½¿ç”¨åœºæ™¯**:
- ç”¨æˆ·æ³¨å†Œ
- ç®¡ç†å‘˜åˆ›å»ºç”¨æˆ·
- æ‰¹é‡å¯¼å…¥ç”¨æˆ·

**æ–‡ä»¶**: `application/user/creator.go`

---

#### 2. UserEditor - ç”¨æˆ·ç¼–è¾‘å™¨

**èŒè´£**: ç¼–è¾‘ç”¨æˆ·åŸºæœ¬ä¿¡æ¯

**æ–¹æ³•**:
```go
UpdateBasicInfo(ctx, id, username, nickname, email, phone, avatar, introduction) (*user.User, error)
UpdateAvatar(ctx, id, avatar) error
```

**ä½¿ç”¨åœºæ™¯**:
- ç”¨æˆ·ä¿®æ”¹ä¸ªäººèµ„æ–™
- ç®¡ç†å‘˜ç¼–è¾‘ç”¨æˆ·ä¿¡æ¯

**æ–‡ä»¶**: `application/user/editor.go`

---

### å»ºè®®ç§»é™¤çš„æœåŠ¡

ä»¥ä¸‹æœåŠ¡ä¸å±äºé€šç”¨åŠŸèƒ½ï¼Œå»ºè®®ç§»é™¤æˆ–ç§»åˆ°ç‰¹å®šä¸šåŠ¡æ¨¡å—ï¼š

#### âŒ UserActivator - ç”¨æˆ·çŠ¶æ€ç®¡ç†
- **åŸå› **: ç”¨æˆ·çŠ¶æ€ç®¡ç†ä¸æ˜¯é«˜é¢‘æ“ä½œï¼Œå¯ä»¥é€šè¿‡ UserEditor æˆ–ä¸“é—¨çš„ç®¡ç†åå°æœåŠ¡å®ç°
- **æ›¿ä»£æ–¹æ¡ˆ**: åœ¨ç®¡ç†åå°æ¨¡å—å®ç°

#### âŒ PasswordChanger - å¯†ç ç®¡ç†
- **åŸå› **: å¯†ç ä¿®æ”¹å±äºå®‰å…¨ç›¸å…³æ“ä½œï¼Œåº”è¯¥åœ¨ç‹¬ç«‹çš„è®¤è¯/å®‰å…¨æ¨¡å—ä¸­å®ç°
- **æ›¿ä»£æ–¹æ¡ˆ**: åœ¨ `application/auth` æ¨¡å—å®ç°

#### âŒ UserQueryer - ç”¨æˆ·æŸ¥è¯¢
- **åŸå› **: æŸ¥è¯¢æ“ä½œåº”è¯¥ç›´æ¥é€šè¿‡ Repository æˆ– Query Service å®ç°ï¼Œä¸éœ€è¦å•ç‹¬çš„åº”ç”¨æœåŠ¡
- **æ›¿ä»£æ–¹æ¡ˆ**: ç›´æ¥ä½¿ç”¨ `domain/user/port/repository.go`

---

## äºŒã€å¾®ä¿¡è´¦å·æœåŠ¡ (application/wechat)

### â­ æ–°å¢ï¼šWechatAccountCreator - å¾®ä¿¡è´¦å·åˆ›å»ºå™¨

**èŒè´£**: åˆ›å»ºæˆ–æ›´æ–°å¾®ä¿¡è´¦å·ï¼ˆå°ç¨‹åºã€å…¬ä¼—å·ï¼‰

**æ–¹æ³•**:
```go
// åˆ›å»ºæˆ–æ›´æ–°å°ç¨‹åºè´¦å·
CreateOrUpdateMiniProgramAccount(
    ctx context.Context,
    appID string,
    openID string,
    unionID *string,
    nickname string,
    avatar string,
    sessionKey string,
) (*accountDomain.WechatAccount, error)

// åˆ›å»ºæˆ–æ›´æ–°å…¬ä¼—å·è´¦å·
CreateOrUpdateOfficialAccount(
    ctx context.Context,
    appID string,
    openID string,
    unionID *string,
    nickname string,
    avatar string,
) (*accountDomain.WechatAccount, error)

// è·å–å¾®ä¿¡è´¦å·
GetWechatAccountByOpenID(
    ctx context.Context,
    appID string,
    platform accountDomain.WxPlatform,
    openID string,
) (*accountDomain.WechatAccount, error)
```

**ä½¿ç”¨åœºæ™¯**:
- âœ… ç”¨æˆ·ç¬¬ä¸€æ¬¡ä½¿ç”¨å°ç¨‹åºæ—¶åˆ›å»ºå¯¹åº”è´¦æˆ·
- âœ… ç”¨æˆ·å…³æ³¨å…¬ä¼—å·æ—¶åˆ›å»ºå¯¹åº”çš„è´¦å·
- âœ… æ›´æ–°å¾®ä¿¡ç”¨æˆ·ä¿¡æ¯ï¼ˆæ˜µç§°ã€å¤´åƒï¼‰

**æ–‡ä»¶**: `application/wechat/account-creator.go` â­ æ–°å¢

**è®¾è®¡ç‰¹ç‚¹**:
- è‡ªåŠ¨éªŒè¯å¾®ä¿¡åº”ç”¨æ˜¯å¦å¯ç”¨
- æ”¯æŒåˆ›å»ºå’Œæ›´æ–°ï¼ˆUpsert æ¨¡å¼ï¼‰
- åˆ†ç¦»å°ç¨‹åºå’Œå…¬ä¼—å·è´¦å·åˆ›å»ºé€»è¾‘
- è‡ªåŠ¨æ›´æ–°ç”¨æˆ·èµ„æ–™å’Œ SessionKey

---

## ä¸‰ã€è§’è‰²ç®¡ç†æœåŠ¡ (application/role) â­ æ–°å¢æ¨¡å—

### 1. TesteeCreator - å—è¯•è€…åˆ›å»ºå™¨

**èŒè´£**: åˆ›å»ºå’Œç®¡ç†å—è¯•è€…è§’è‰²

**æ–¹æ³•**:
```go
// åˆ›å»ºå—è¯•è€…
CreateTestee(ctx, userID, name, sex, birthday) (*role.Testee, error)

// æ›´æ–°å—è¯•è€…ä¿¡æ¯
UpdateTestee(ctx, userID, name, sex, birthday) (*role.Testee, error)

// è·å–å—è¯•è€…
GetTesteeByUserID(ctx, userID) (*role.Testee, error)

// æ£€æŸ¥æ˜¯å¦å­˜åœ¨
TesteeExists(ctx, userID) bool
```

**ä½¿ç”¨åœºæ™¯**:
- âœ… ç”¨æˆ·åœ¨å°ç¨‹åºä¾§æ³¨å†Œå—è¯•è€…æ—¶åˆ›å»º Testee
- âœ… æ›´æ–°å—è¯•è€…ä¸ªäººä¿¡æ¯ï¼ˆå§“åã€æ€§åˆ«ã€ç”Ÿæ—¥ï¼‰
- âœ… æŸ¥è¯¢å—è¯•è€…ä¿¡æ¯

**æ–‡ä»¶**: `application/role/testee-creator.go` â­ æ–°å¢

**Repository æ¥å£**:
```go
type TesteeRepository interface {
    Save(ctx, testee) error
    Update(ctx, testee) error
    FindByUserID(ctx, userID) (*role.Testee, error)
    ExistsByUserID(ctx, userID) bool
}
```

---

### 2. AuditorCreator - å®¡æ ¸å‘˜åˆ›å»ºå™¨

**èŒè´£**: åˆ›å»ºå’Œç®¡ç†å®¡æ ¸å‘˜è§’è‰²

**æ–¹æ³•**:
```go
// åˆ›å»ºå®¡æ ¸å‘˜
CreateAuditor(ctx, userID, name, employeeID, department, position, hiredAt) (*role.Auditor, error)

// æ›´æ–°å®¡æ ¸å‘˜ä¿¡æ¯
UpdateAuditorInfo(ctx, userID, name, department, position) (*role.Auditor, error)

// çŠ¶æ€ç®¡ç†
UpdateAuditorStatus(ctx, userID, status) (*role.Auditor, error)
ActivateAuditor(ctx, userID) error       // æ¿€æ´»ï¼ˆåœ¨èŒï¼‰
SuspendAuditor(ctx, userID) error        // åœèŒ
ResignAuditor(ctx, userID) error         // ç¦»èŒ
SetAuditorOnLeave(ctx, userID) error     // ä¼‘å‡

// æŸ¥è¯¢
GetAuditorByUserID(ctx, userID) (*role.Auditor, error)
GetAuditorByEmployeeID(ctx, employeeID) (*role.Auditor, error)
AuditorExists(ctx, userID) bool
CanAudit(ctx, userID) (bool, error)      // æ£€æŸ¥æ˜¯å¦å¯å®¡æ ¸
```

**ä½¿ç”¨åœºæ™¯**:
- âœ… åˆ›å»ºå®¡æ ¸è´¦æˆ·æ—¶åˆ›å»º Auditor
- âœ… ç®¡ç†å‘˜å·¥çŠ¶æ€ï¼ˆåœ¨èŒã€ä¼‘å‡ã€åœèŒã€ç¦»èŒï¼‰
- âœ… æƒé™éªŒè¯ï¼ˆæ˜¯å¦å¯ä»¥å®¡æ ¸ï¼‰
- âœ… æ›´æ–°å‘˜å·¥ä¿¡æ¯

**æ–‡ä»¶**: `application/role/auditor-creator.go` â­ æ–°å¢

**Repository æ¥å£**:
```go
type AuditorRepository interface {
    Save(ctx, auditor) error
    Update(ctx, auditor) error
    FindByUserID(ctx, userID) (*role.Auditor, error)
    FindByEmployeeID(ctx, employeeID) (*role.Auditor, error)
    ExistsByUserID(ctx, userID) bool
    ExistsByEmployeeID(ctx, employeeID) bool
}
```

---

### 3. WriterCreator - å¡«å†™äººåˆ›å»ºå™¨

**èŒè´£**: åˆ›å»ºå’Œç®¡ç†å¡«å†™äººè§’è‰²

**æ–¹æ³•**:
```go
// åˆ›å»ºå¡«å†™äºº
CreateWriter(ctx, userID, name) (*role.Writer, error)

// æ›´æ–°å¡«å†™äºº
UpdateWriter(ctx, userID, name) (*role.Writer, error)

// æŸ¥è¯¢
GetWriterByUserID(ctx, userID) (*role.Writer, error)
WriterExists(ctx, userID) bool
```

**ä½¿ç”¨åœºæ™¯**:
- åˆ›å»ºä»£ç†å¡«å†™è´¦å·
- æ›´æ–°å¡«å†™äººä¿¡æ¯

**æ–‡ä»¶**: `application/role/writer-creator.go` â­ æ–°å¢

**Repository æ¥å£**:
```go
type WriterRepository interface {
    Save(ctx, writer) error
    Update(ctx, writer) error
    FindByUserID(ctx, userID) (*role.Writer, error)
    ExistsByUserID(ctx, userID) bool
}
```

---

## ä½¿ç”¨ç¤ºä¾‹

### åœºæ™¯1: ç”¨æˆ·é¦–æ¬¡ä½¿ç”¨å°ç¨‹åº

```go
// 1. åˆ›å»ºæˆ–æ›´æ–°å¾®ä¿¡è´¦å·
wxAccountCreator := wechat.NewWechatAccountCreator(wxAccountRepo, appRepo)
wxAccount, err := wxAccountCreator.CreateOrUpdateMiniProgramAccount(
    ctx,
    "wx1234567890",     // appID
    "oABC123",          // openID
    &unionID,           // unionID
    "å¼ ä¸‰",             // nickname
    "http://...",       // avatar
    "session_key_xxx",  // sessionKey
)

// 2. å¦‚æœæ˜¯æ–°ç”¨æˆ·ï¼Œåˆ›å»º User
if wxAccount.GetUserID().IsZero() {
    userCreator := user.NewUserCreator(userRepo)
    user, err := userCreator.CreateUser(ctx, username, password, ...)
    
    // ç»‘å®š wxAccount å’Œ user
    wxAccount.BindUser(user.ID())
}

// 3. åˆ›å»ºå—è¯•è€…è§’è‰²
testeeCreator := role.NewTesteeCreator(testeeRepo)
testee, err := testeeCreator.CreateTestee(
    ctx,
    user.ID(),
    "å¼ ä¸‰",
    1,                  // ç”·æ€§
    &birthday,
)
```

---

### åœºæ™¯2: åˆ›å»ºå®¡æ ¸å‘˜è´¦å·

```go
// 1. åˆ›å»ºåŸºç¡€ç”¨æˆ·
userCreator := user.NewUserCreator(userRepo)
user, err := userCreator.CreateUser(
    ctx,
    "auditor001",
    "password123",
    "æå®¡æ ¸",
    "audit@example.com",
    "13800138000",
    "é«˜çº§å®¡æ ¸å‘˜",
)

// 2. åˆ›å»ºå®¡æ ¸å‘˜è§’è‰²
auditorCreator := role.NewAuditorCreator(auditorRepo)
auditor, err := auditorCreator.CreateAuditor(
    ctx,
    user.ID(),
    "æå®¡æ ¸",
    "EMP001",           // å‘˜å·¥ç¼–å·
    "å®¡æ ¸éƒ¨",           // éƒ¨é—¨
    "é«˜çº§å®¡æ ¸å‘˜",       // èŒä½
    &hiredAt,           // å…¥èŒæ—¶é—´
)

// 3. ä½¿ç”¨æƒé™éªŒè¯
canAudit, err := auditorCreator.CanAudit(ctx, user.ID())
if canAudit {
    // æ‰§è¡Œå®¡æ ¸æ“ä½œ
}
```

---

### åœºæ™¯3: ç”¨æˆ·å…³æ³¨å…¬ä¼—å·

```go
wxAccountCreator := wechat.NewWechatAccountCreator(wxAccountRepo, appRepo)
wxAccount, err := wxAccountCreator.CreateOrUpdateOfficialAccount(
    ctx,
    "wx0987654321",     // å…¬ä¼—å· appID
    "oXYZ789",          // openID
    &unionID,           // unionID
    "ç‹äº”",             // nickname
    "http://...",       // avatar
)

// æ ¹æ® unionID åˆå¹¶è´¦å·é€»è¾‘...
```

---

## å…³æ³¨ç‚¹åˆ†ç¦»æ€»ç»“

| æœåŠ¡æ¨¡å— | èŒè´£ | å¯¹å¤–æä¾› | å†…éƒ¨ä½¿ç”¨ |
|---------|------|---------|---------|
| **user/** | åŸºç¡€ç”¨æˆ·ç®¡ç† | Creator, Editor | - |
| **wechat/** | å¾®ä¿¡è´¦å·ç®¡ç† | AccountCreator | Authenticator, PhoneBinder |
| **role/** | è§’è‰²ç®¡ç† | TesteeCreator, AuditorCreator, WriterCreator | - |

---

## Repository å®ç°å»ºè®®

éœ€è¦åœ¨åŸºç¡€è®¾æ–½å±‚å®ç°ä»¥ä¸‹ Repositoryï¼š

### 1. TesteeRepository
```go
// infra/mysql/testee/repository.go
type testeeRepository struct {
    db *gorm.DB
}
```

### 2. AuditorRepository
```go
// infra/mysql/auditor/repository.go
type auditorRepository struct {
    db *gorm.DB
}
```

### 3. WriterRepository
```go
// infra/mysql/writer/repository.go
type writerRepository struct {
    db *gorm.DB
}
```

---

## ä¸‹ä¸€æ­¥å·¥ä½œ

âœ… **å·²å®Œæˆ**:
1. ä¿ç•™ User çš„ Creator å’Œ Editor
2. åˆ›å»º WechatAccountCreator
3. åˆ›å»º TesteeCreatorã€AuditorCreatorã€WriterCreator

ğŸ”² **å¾…å®ç°**:
1. å®ç° Repository æ¥å£ï¼ˆåŸºç¡€è®¾æ–½å±‚ï¼‰
2. åˆ›å»ºæ•°æ®åº“è¡¨ç»“æ„
3. ç¼–å†™å•å…ƒæµ‹è¯•
4. é›†æˆåˆ° Containerï¼ˆä¾èµ–æ³¨å…¥ï¼‰
5. åˆ›å»º RESTful API æ¥å£

---

## æ–‡ä»¶æ¸…å•

### æ–°å¢æ–‡ä»¶
- âœ… `application/wechat/account-creator.go` (164è¡Œ)
- âœ… `application/role/testee-creator.go` (108è¡Œ)
- âœ… `application/role/auditor-creator.go` (206è¡Œ)
- âœ… `application/role/writer-creator.go` (91è¡Œ)

### ä¿ç•™æ–‡ä»¶
- âœ… `application/user/creator.go`
- âœ… `application/user/editor.go`

### å»ºè®®ç§»é™¤
- âŒ `application/user/activator.go`
- âŒ `application/user/password-changer.go`
- âŒ `application/user/queryer.go`
