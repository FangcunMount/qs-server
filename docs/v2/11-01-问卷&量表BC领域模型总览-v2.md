# 11-01 问卷&量表 BC 领域模型总览（V2）

> 版本：V2.0
> 模块：问卷&量表 BC（Questionnaire & Scale Bounded Context）
> 适用范围：qs-apiserver、qs-worker 中所有与“问卷/量表测评”相关的服务

本篇文档站在 **领域建模视角**，给出 V2 版本的最终领域模型结论，用于指导后续代码结构设计与实现。
建模过程、事件风暴原始记录仍以《「量表测评」领域建模.pdf》《「量表测评」需求分析.pdf》为准，本篇只保留最终落地的结构。

---

## 1. BC 内子域划分

问卷&量表 BC 内部拆分为 6 个子域（Subdomain）：

1. **survey 子域（问卷）**

   * 关注“怎么问”“怎么填”“答案是否合法”。
   * 不关心“分数代表什么含义”，只描述校验规则和计分元数据。
   * 聚合：

     * `Questionnaire`：问卷模板
     * `AnswerSheet`：答卷实例

2. **scale 子域（量表）**

   * 关注“量表语义”“因子结构”“常模与解释规则”。
   * 不关心“问卷怎么展示”，只关心“怎么从答案算出量表分和结论”。
   * 聚合：

     * `MedicalScale`：量表定义（因子、常模、解读规则）

3. **assessment 子域（测评案例）**

   * 关注“一次具体测评行为”的生命周期。
   * 作为 **bridge 聚合**，连接 `AnswerSheet`、`MedicalScale`、`Testee` 以及测评来源（计划/筛查）。
   * 聚合：

     * `Assessment`：一次测评记录
     * `AssessmentScore`：维度/因子得分
     * `InterpretReport`：解读报告

4. **user 子域（BC 内部用户视图）**

   * 关注“本 BC 如何看待用户”，与 IAM 的 User/Child 解耦。
   * 聚合：

     * `Testee`：受试者（被测人）
     * `Staff`：量表后台工作人员（执行人、负责人等）

5. **plan 子域（测评计划）**

   * 关注“周期性测评计划”，通常由外部业务（互联网医院、行为训练中心等）驱动。
   * 聚合：

     * `AssessmentPlan`：测评计划
     * `AssessmentTask`：具体执行任务/期次

6. **screening 子域（入校筛查项目）**

   * 关注“入校筛查项目”的建模：一个班级/年级/学校作为单位，统一发放问卷。
   * 聚合：

     * `ScreeningProject`：入校筛查项目

---

## 2. 各子域核心聚合说明

### 2.1 survey：Questionnaire / AnswerSheet

* **Questionnaire 聚合**

  * 表示一份问卷模板及其版本。
  * 核心职责：

    * 管理题目列表（Question / Option）
    * 维护题目级校验规则（必填、范围、依赖等）
    * 维护题目级计分元数据（ScoringConfig），描述“选项如何映射为原始分”

* **AnswerSheet 聚合**

  * 表示一次填写行为的结果。
  * 核心职责：

    * 记录问卷 ID、答题项列表（AnswerItem：QuestionID → Values）
    * 管理答卷状态（草稿 / 已提交）
    * 配合领域服务完成结构校验，确保答卷合法

> 边界：
>
> * `Questionnaire` / `AnswerSheet` **不负责量表意义上的“算分和解读”**，
> * 只负责收集和校验输入。

---

### 2.2 scale：MedicalScale

* **MedicalScale 聚合**

  * 表示一个具体的量表定义（例如 SDS、SAS、Conners 等）。
  * 核心职责：

    * 定义因子结构（Factor：维度编码、名称、关联题目列表）
    * 定义题目/因子的计分方式（结合 `survey.ScoringConfig` 使用）
    * 定义常模与区间规则
    * 定义解释规则（InterpretationRule）：不同分数区间对应的风险等级、结论文案、建议片段

> scale 子域是“规则和算法库”，不记录哪一个人、哪一次做了这套量表。

---

### 2.3 assessment：Assessment / AssessmentScore / InterpretReport

* **Assessment 聚合**

  * 表示“一次具体测评行为”的中心记录。
  * 典型字段（逻辑上）：

    * `AssessmentID`
    * `TesteeID`
    * `QuestionnaireID`
    * `AnswerSheetID`
    * `MedicalScaleID`（可空，纯问卷模式为 NULL）
    * `OriginType`（adhoc / plan / screening）
    * `OriginID`（对应 PlanID / ScreeningProjectID）
    * `Status`（pending / submitted / interpreted / failed）
    * `TotalScore`、`RiskLevel`
    * `CreatedAt`、`InterpretedAt`
  * 核心职责：

    * 记录一次测评从“答卷提交”到“生成解读”的整个生命周期
    * 提供状态迁移方法（ApplyEvaluation 等）
    * 作为趋势分析、统计查询的锚点（按 Testee 聚合）

* **AssessmentScore**

  * 记录每个因子的得分信息，便于维度趋势分析。

* **InterpretReport 聚合**

  * 代表对外展示的解读报告。
  * 建议存储在 Mongo（文档型），结构化字段包括：

    * 总分、风险等级
    * 各因子得分和风险
    * 结论与建议文案

---

### 2.4 user：Testee / Staff

* **Testee（受试者）**

  * 代表“被测评的人”在本 BC 内部的视图。
  * 与 IAM 系统中的 User/Child 解耦，通过 ID 映射。
  * 用于所有“按人统计”的入口。

* **Staff（后台人员）**

  * 代表量表后台的操作用户。
  * 持有 org / iamUserID / 本 BC 内角色。

---

### 2.5 plan：AssessmentPlan / AssessmentTask

* **AssessmentPlan**

  * 一个中长期测评计划，例如“每 4 周测一次量表”。
  * 对象是单个 Testee。

* **AssessmentTask**

  * 某一次“应该发生的测评”实例。
  * 生成测评入口、绑定 Assessment。

---

### 2.6 screening：ScreeningProject

* **ScreeningProject 聚合**

  * 表示一次入校筛查项目，例如“2025 秋季一年级筛查”。
  * 管理学校/班级信息、问卷模板、时间窗口。
  * 每一次填写会生成 Assessment，OriginType=screening。

---

## 3. 子域依赖关系

为避免循环依赖，约束如下：

* `survey` 不依赖其他子域；
* `scale` 依赖 `survey` 的 Question/AnswerSheet 视图（只读）；
* `assessment` 依赖 `survey` + `scale` + `user` + `plan` + `screening`；
* `user` / `plan` / `screening` 只依赖 `common` VO。

抽象为：

```text
common
  ↑
survey   user   plan   screening
   ↑         ↘    ↘        ↘
   └───────── scale ────────┘
          ↑
      assessment
```

---

## 4. 典型数据流

以“患者扫码填写 SDS 量表”为例：

1. 创建测评入口（可来自一次性测评、计划或筛查）。
2. 用户填写问卷 → 生成 AnswerSheet 并做领域校验。
3. 创建 Assessment，绑定 Testee / Questionnaire / AnswerSheet / MedicalScale / Origin。
4. 发布 AssessmentSubmittedEvent，交由 qs-worker 异步评估。
5. qs-worker 使用 Evaluator 计算分数，生成 AssessmentScore 与 InterpretReport，并更新 Assessment 状态。
6. 前端通过 AssessmentID 查询 InterpretReport，或由通知服务基于 AssessmentInterpretedEvent 推送结果。

---

## 5. 问卷模式 vs 量表模式

* **问卷模式（Survey Only）**

  * 不绑定 MedicalScaleID；
  * 可不创建 Assessment，或创建但不触发评估任务。

* **量表模式（Survey + Scale + Assessment）**

  * 绑定 MedicalScaleID；
  * 必须创建 Assessment；
  * 提交后触发评估工作流。

通过 Assessment 这一桥接聚合，将“泛问卷能力（survey）”与“专业量表能力（scale）”组合起来。

---

## 6. 与 IAM BC 的关系

* 问卷&量表 BC 不直接持有 IAM 聚合，只通过 ID 做关联：

  * Testee / Staff 字段中包含 IAMUserID / IAMChildID / OrgID 等；
* 认证与授权由 IAM/AuthN/AuthZ 负责；
* 本 BC 领域层只关心：

  * 当前请求对应的 `Principal`；
  * 如何根据 Principal 映射到 Testee / Staff / Org 视图。

---

## 7. 总结

V2 版本中，问卷&量表 BC 的领域模型遵循：

1. 按职责拆分子域：survey 收集与校验，scale 规则与算法，assessment 记录一次测评行为，user/plan/screening 提供人/计划/项目维度。
2. 以 Assessment 作为桥接聚合，将 Testee、AnswerSheet、MedicalScale、Plan/Screening 串成一条可追溯的测评主线。
3. 严格控制依赖方向，避免子域间循环依赖。
4. 同时支持问卷模式与量表模式，通过是否绑定 MedicalScaleID / 是否触发评估工作流来区分。

后续所有代码设计（特别是 `internal/domain` 包）均以本模型为基础实现。
