# 用户体系应用服务层 - 快速参考

## 📁 目录结构

```
application/
├── user/
│   ├── creator.go              ✅ 用户创建器
│   └── editor.go               ✅ 用户编辑器
│
├── wechat/
│   ├── account-creator.go      ⭐ 微信账号创建器 (新增)
│   ├── authenticator.go        ✅ 微信登录认证器
│   └── ...
│
└── role/                        ⭐ 角色管理模块 (新增)
    ├── testee-creator.go       ⭐ 受试者创建器
    ├── auditor-creator.go      ⭐ 审核员创建器
    └── writer-creator.go       ⭐ 填写人创建器
```

## 🎯 核心服务

### 1️⃣ UserCreator - 用户创建

```go
userCreator := user.NewUserCreator(userRepo)
user, err := userCreator.CreateUser(ctx, username, password, nickname, email, phone, intro)
```

### 2️⃣ UserEditor - 用户编辑

```go
userEditor := user.NewUserEditor(userRepo)
user, err := userEditor.UpdateBasicInfo(ctx, id, username, nickname, email, phone, avatar, intro)
```

### 3️⃣ WechatAccountCreator - 微信账号创建 ⭐

```go
wxCreator := wechat.NewWechatAccountCreator(wxAccountRepo, appRepo)

// 小程序账号
wxAcc, err := wxCreator.CreateOrUpdateMiniProgramAccount(
    ctx, appID, openID, unionID, nickname, avatar, sessionKey,
)

// 公众号账号
wxAcc, err := wxCreator.CreateOrUpdateOfficialAccount(
    ctx, appID, openID, unionID, nickname, avatar,
)
```

### 4️⃣ TesteeCreator - 受试者创建 ⭐

```go
testeeCreator := role.NewTesteeCreator(testeeRepo)

// 创建
testee, err := testeeCreator.CreateTestee(ctx, userID, name, sex, birthday)

// 更新
testee, err := testeeCreator.UpdateTestee(ctx, userID, &name, &sex, &birthday)

// 查询
testee, err := testeeCreator.GetTesteeByUserID(ctx, userID)
exists := testeeCreator.TesteeExists(ctx, userID)
```

### 5️⃣ AuditorCreator - 审核员创建 ⭐

```go
auditorCreator := role.NewAuditorCreator(auditorRepo)

// 创建
auditor, err := auditorCreator.CreateAuditor(
    ctx, userID, name, employeeID, department, position, hiredAt,
)

// 状态管理
err = auditorCreator.ActivateAuditor(ctx, userID)      // 在职
err = auditorCreator.SuspendAuditor(ctx, userID)       // 停职
err = auditorCreator.ResignAuditor(ctx, userID)        // 离职
err = auditorCreator.SetAuditorOnLeave(ctx, userID)    // 休假

// 权限检查
canAudit, err := auditorCreator.CanAudit(ctx, userID)

// 查询
auditor, err := auditorCreator.GetAuditorByUserID(ctx, userID)
auditor, err := auditorCreator.GetAuditorByEmployeeID(ctx, employeeID)
```

### 6️⃣ WriterCreator - 填写人创建 ⭐

```go
writerCreator := role.NewWriterCreator(writerRepo)

// 创建
writer, err := writerCreator.CreateWriter(ctx, userID, name)

// 更新
writer, err := writerCreator.UpdateWriter(ctx, userID, name)

// 查询
writer, err := writerCreator.GetWriterByUserID(ctx, userID)
```

## 🔗 Repository 接口定义

### TesteeRepository

```go
type TesteeRepository interface {
    Save(ctx context.Context, testee *role.Testee) error
    Update(ctx context.Context, testee *role.Testee) error
    FindByUserID(ctx context.Context, userID user.UserID) (*role.Testee, error)
    ExistsByUserID(ctx context.Context, userID user.UserID) bool
}
```

### AuditorRepository

```go
type AuditorRepository interface {
    Save(ctx context.Context, auditor *role.Auditor) error
    Update(ctx context.Context, auditor *role.Auditor) error
    FindByUserID(ctx context.Context, userID user.UserID) (*role.Auditor, error)
    FindByEmployeeID(ctx context.Context, employeeID string) (*role.Auditor, error)
    ExistsByUserID(ctx context.Context, userID user.UserID) bool
    ExistsByEmployeeID(ctx context.Context, employeeID string) bool
}
```

### WriterRepository

```go
type WriterRepository interface {
    Save(ctx context.Context, writer *role.Writer) error
    Update(ctx context.Context, writer *role.Writer) error
    FindByUserID(ctx context.Context, userID user.UserID) (*role.Writer, error)
    ExistsByUserID(ctx context.Context, userID user.UserID) bool
}
```

## 📋 常见使用场景

### 场景1: 小程序首次登录

```go
// 1. 创建微信账号
wxAccount, _ := wxCreator.CreateOrUpdateMiniProgramAccount(...)

// 2. 创建用户（如果是新用户）
if wxAccount.GetUserID().IsZero() {
    user, _ := userCreator.CreateUser(...)
    wxAccount.BindUser(user.ID())
}

// 3. 创建受试者角色
testee, _ := testeeCreator.CreateTestee(ctx, user.ID(), name, sex, birthday)
```

### 场景2: 创建审核员

```go
// 1. 创建用户
user, _ := userCreator.CreateUser(...)

// 2. 创建审核员角色
auditor, _ := auditorCreator.CreateAuditor(
    ctx, user.ID(), name, "EMP001", "审核部", "高级审核员", &hiredAt,
)

// 3. 验证权限
canAudit, _ := auditorCreator.CanAudit(ctx, user.ID())
```

## ✅ 总结

| 服务 | 状态 | 文件 |
|------|------|------|
| UserCreator | ✅ 保留 | `application/user/creator.go` |
| UserEditor | ✅ 保留 | `application/user/editor.go` |
| WechatAccountCreator | ⭐ 新增 | `application/wechat/account-creator.go` |
| TesteeCreator | ⭐ 新增 | `application/role/testee-creator.go` |
| AuditorCreator | ⭐ 新增 | `application/role/auditor-creator.go` |
| WriterCreator | ⭐ 新增 | `application/role/writer-creator.go` |

**新增代码**: 569 行
**编译状态**: ✅ 通过
