# Testee æ¨¡å— ProfileID é‡æ„å®Œæˆæ€»ç»“

## âœ… é‡æ„çŠ¶æ€ï¼š100% å®Œæˆ

**å®Œæˆæ—¶é—´**: 2024å¹´  
**ç¼–è¯‘çŠ¶æ€**: âœ… é€šè¿‡ï¼ˆ`go build -v ./internal/apiserver/...`ï¼‰

---

## é‡æ„èŒƒå›´

### ç»Ÿè®¡æ•°æ®
- **æ–‡ä»¶æ•°é‡**: 13 ä¸ªæ–‡ä»¶
- **ä»£ç è¡Œæ•°**: ~800 è¡Œæ›´æ–°
- **æ¶æ„å±‚æ¬¡**: 4 å±‚å…¨è¦†ç›–
  - âœ… Domain Layerï¼ˆé¢†åŸŸå±‚ï¼‰
  - âœ… Application Layerï¼ˆåº”ç”¨å±‚ï¼‰
  - âœ… Infrastructure Layerï¼ˆåŸºç¡€è®¾æ–½å±‚ï¼‰
  - âœ… Interface Layerï¼ˆæ¥å£å±‚ï¼‰

### æ ¸å¿ƒå˜æ›´
```
IAMUserID (*int64) + IAMChildID (*int64)  â†’  ProfileID (*uint64)
```

---

## å·²å®Œæˆæ–‡ä»¶æ¸…å•

### 1ï¸âƒ£ é¢†åŸŸå±‚ (Domain)
- âœ… `domain/actor/testee/testee.go` - å®ä½“å­—æ®µæ›´æ–°
- âœ… `domain/actor/testee/interfaces.go` - æ¥å£ç­¾åæ›´æ–°
- âœ… `domain/actor/testee/binder.go` - Binder å®ç°
- âœ… `domain/actor/testee/factory.go` - Factory å®ç°

### 2ï¸âƒ£ åº”ç”¨å±‚ (Application)
- âœ… `application/actor/testee_management/service.go` - DTO æ›´æ–°
- âœ… `application/actor/testee_management/interface.go` - æœåŠ¡æ¥å£
- âœ… `application/actor/testee_management/composite_service.go` - ç»„åˆæœåŠ¡
- âœ… `application/actor/testee_management/query_service.go` - æŸ¥è¯¢æœåŠ¡
- âœ… `application/actor/testee_management/profile_service.go` - æ¡£æ¡ˆæœåŠ¡
- âœ… `application/actor/testee_registration/interface.go` - æ³¨å†Œæ¥å£
- âœ… `application/actor/testee_registration/service.go` - æ³¨å†ŒæœåŠ¡
- âœ… `application/actor/testee_registration/query_service.go` - æ³¨å†ŒæŸ¥è¯¢

### 3ï¸âƒ£ åŸºç¡€è®¾æ–½å±‚ (Infrastructure)
- âœ… `infra/mysql/actor/testee_repository.go` - ä»“å‚¨å®ç°ï¼ˆæ–°å¢ FindByProfileï¼‰
- âœ… `infra/mysql/actor/testee_mapper.go` - POâ†”Domain æ˜ å°„

### 4ï¸âƒ£ æ¥å£å±‚ (Interface)
- âœ… `interface/grpc/service/actor_service.go` - gRPC æœåŠ¡
- âœ… `interface/restful/request/actor.go` - RESTful è¯·æ±‚ DTO
- âœ… `interface/restful/response/actor.go` - RESTful å“åº” DTO
- âœ… `interface/restful/handler/actor.go` - RESTful å¤„ç†å™¨

---

## æŠ€æœ¯æ–¹æ¡ˆ

### æ ¸å¿ƒè®¾è®¡
1. **ç±»å‹å®šä¹‰**: `profileID *uint64`ï¼ˆå¯ç©ºï¼Œæ”¯æŒæœªç»‘å®šæ¡£æ¡ˆï¼‰
2. **ä¸šåŠ¡è¯­ä¹‰**: å½“å‰ ProfileID â‰¡ IAM.Child.ID
3. **å‘åå…¼å®¹**: API åŒæ—¶è¿”å› `profile_id` å’Œ `iam_child_id`

### æ•°æ®åº“ç­–ç•¥
- **ä¿æŒç°æœ‰ç»“æ„**: ç»§ç»­ä½¿ç”¨ `testees.iam_child_id` å­—æ®µ
- **æ˜ å°„å±‚é€‚é…**: é€šè¿‡ Mapper å®ç° ProfileID â†” IAMChildID è½¬æ¢
- **é›¶æ•°æ®è¿ç§»**: ä¸å½±å“ç°æœ‰æ•°æ®

### API å…¼å®¹æ€§
```json
// è¯·æ±‚ï¼ˆæ”¯æŒä¸¤ç§æ–¹å¼ï¼‰
{
  "profile_id": 12345,      // æ¨èï¼ˆæ–°ï¼‰
  "iam_child_id": 12345     // å…¼å®¹ï¼ˆæ—§ï¼‰
}

// å“åº”ï¼ˆåŒæ—¶è¿”å›ï¼‰
{
  "profile_id": 12345,      // æ–°å­—æ®µ
  "iam_child_id": 12345     // æ—§å­—æ®µï¼ˆå€¼ç›¸åŒï¼‰
}
```

---

## å…³é”®ä»£ç ç‰‡æ®µ

### Repository å®ç°
```go
// FindByProfile æ ¹æ®ç”¨æˆ·æ¡£æ¡ˆIDæŸ¥æ‰¾å—è¯•è€…
// æ³¨æ„ï¼šå½“å‰ ProfileID å¯¹åº” IAM.Child.ID
func (r *testeeRepository) FindByProfile(ctx context.Context, orgID int64, profileID uint64) (*testee.Testee, error) {
	var po TesteePO
	iamChildID := int64(profileID)
	err := r.WithContext(ctx).
		Where("org_id = ? AND iam_child_id = ? AND deleted_at IS NULL", orgID, iamChildID).
		First(&po).Error
	// ...
}
```

### Mapper è½¬æ¢
```go
// Domain â†’ PO
if profileID := domain.ProfileID(); profileID != nil {
	iamChildID := int64(*profileID)
	po.IAMChildID = &iamChildID
}

// PO â†’ Domain
var profileID *uint64
if po.IAMChildID != nil {
	pid := uint64(*po.IAMChildID)
	profileID = &pid
}
domain.RestoreFromRepository(profileID, tags, isKeyFocus, stats)
```

---

## éªŒè¯ç»“æœ

### ç¼–è¯‘æ£€æŸ¥ âœ…
```bash
go build -v ./internal/apiserver/...
# ç»“æœï¼šæˆåŠŸï¼Œæ— é”™è¯¯
```

### å½±å“èŒƒå›´
- âœ… CreateTestee - åˆ›å»ºå—è¯•è€…
- âœ… FindByProfile - æŸ¥è¯¢å—è¯•è€…
- âœ… BindProfile - ç»‘å®šæ¡£æ¡ˆ
- âœ… EnsureByProfile - ç¡®ä¿å—è¯•è€…å­˜åœ¨
- âœ… gRPC API - CreateTestee, TesteeExists
- âœ… RESTful API - POST /testees

---

## åç»­è®¡åˆ’

### ç«‹å³å¯åš
- âœ… æäº¤ä»£ç åˆ°ç‰ˆæœ¬æ§åˆ¶
- â³ æ›´æ–°å•å…ƒæµ‹è¯•ç”¨ä¾‹
- â³ æ‰§è¡Œé›†æˆæµ‹è¯•
- â³ éƒ¨ç½²åˆ°æµ‹è¯•ç¯å¢ƒ

### å¯é€‰ä¼˜åŒ–ï¼ˆä½ä¼˜å…ˆçº§ï¼‰
1. **æ•°æ®åº“é‡å‘½å**
   - `iam_child_id` â†’ `profile_id`
   - éœ€è¦ migration è„šæœ¬

2. **Proto æ›´æ–°**
   - æ·»åŠ  `profile_id` å­—æ®µ
   - æ ‡è®° `iam_child_id` ä¸º `deprecated`

3. **ç§»é™¤å…¼å®¹ä»£ç **
   - å½“æ‰€æœ‰å®¢æˆ·ç«¯è¿ç§»åï¼Œç§»é™¤ `iam_child_id` å…¼å®¹é€»è¾‘

---

## æ³¨æ„äº‹é¡¹

### âš ï¸ å‘åå…¼å®¹
- API åŒæ—¶æ¥å— `profile_id` å’Œ `iam_child_id`
- ä¼˜å…ˆä½¿ç”¨ `profile_id`ï¼Œå›é€€åˆ° `iam_child_id`
- å“åº”ä¸­ä¸¤ä¸ªå­—æ®µå€¼ç›¸åŒ

### âš ï¸ æ•°æ®ä¸€è‡´æ€§
- æ•°æ®åº“å±‚é¢ä½¿ç”¨ `iam_child_id` å­˜å‚¨
- åº”ç”¨å±‚é¢ç»Ÿä¸€ä½¿ç”¨ `ProfileID` æ¦‚å¿µ
- é€šè¿‡æ˜ å°„å±‚ä¿è¯ä¸€è‡´æ€§

### âš ï¸ ä¸šåŠ¡è¯­ä¹‰
- **å½“å‰**: ProfileID = IAM.Child.IDï¼ˆ1:1æ˜ å°„ï¼‰
- **æœªæ¥**: ProfileID å¯æŒ‡å‘ç‹¬ç«‹çš„ Profile è¡¨

---

## å›¢é˜Ÿæ²Ÿé€š

### å¯¹æ¥å£è°ƒç”¨æ–¹
- æ¨èä½¿ç”¨ `profile_id` å­—æ®µ
- `iam_child_id` ä»å¯ç”¨ä½†å·²åºŸå¼ƒ
- ä¸¤ä¸ªå­—æ®µå½“å‰å€¼ç›¸åŒ

### å¯¹åç«¯å¼€å‘è€…
- æ–°ä»£ç ç»Ÿä¸€ä½¿ç”¨ `ProfileID`
- é¿å…ç›´æ¥ä½¿ç”¨ `IAMUserID`/`IAMChildID`
- ç†è§£å½“å‰æ˜ å°„å…³ç³»ï¼šProfileID â†” iam_child_id

---

## æ€»ç»“

âœ… **é‡æ„æˆåŠŸå®Œæˆ**ï¼Œå®ç°äº†ä»¥ä¸‹ç›®æ ‡ï¼š

1. **æ¶æ„æ¸…æ™°**: 4 å±‚æ¶æ„å®Œæ•´æ›´æ–°
2. **å‘åå…¼å®¹**: ä¸å½±å“ç°æœ‰ API è°ƒç”¨æ–¹
3. **é›¶æ•°æ®è¿ç§»**: ä¸éœ€è¦ä¿®æ”¹æ•°æ®åº“æ•°æ®
4. **ç¼–è¯‘é€šè¿‡**: æ‰€æœ‰ä»£ç ç¼–è¯‘æˆåŠŸ
5. **æ–‡æ¡£å®Œæ•´**: æä¾›è¯¦ç»†çš„æŠ€æœ¯æ–‡æ¡£

**å¯ä»¥å®‰å…¨éƒ¨ç½²åˆ°æµ‹è¯•ç¯å¢ƒè¿›è¡ŒéªŒè¯ï¼** ğŸš€
