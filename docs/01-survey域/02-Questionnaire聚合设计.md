# Questionnaire èšåˆè®¾è®¡

> **ç‰ˆæœ¬**ï¼šV4.0 é‡‘å­—å¡”ç»“æ„ç‰ˆ  
> **æœ€åæ›´æ–°**ï¼š2025-11-26  
> **æ‰€å±ç³»åˆ—**ï¼š[Survey å­åŸŸè®¾è®¡ç³»åˆ—](./11-04-Surveyå­åŸŸè®¾è®¡ç³»åˆ—.md)

---

## ğŸ“‹ ç›®å½•

- [1. æ ¸å¿ƒä»·å€¼ï¼šè§£å†³ä»€ä¹ˆé—®é¢˜](#1-æ ¸å¿ƒä»·å€¼è§£å†³ä»€ä¹ˆé—®é¢˜)
- [2. æ•´ä½“æ¶æ„ï¼šä¸‰å±‚è®¾è®¡](#2-æ•´ä½“æ¶æ„ä¸‰å±‚è®¾è®¡)
- [3. æ ¸å¿ƒè®¾è®¡å†³ç­–](#3-æ ¸å¿ƒè®¾è®¡å†³ç­–)
- [4. é¢˜å‹æ‰©å±•ä½“ç³»](#4-é¢˜å‹æ‰©å±•ä½“ç³»)
- [5. èšåˆæ ¹è®¾è®¡](#5-èšåˆæ ¹è®¾è®¡)
- [6. é¢†åŸŸæœåŠ¡è®¾è®¡](#6-é¢†åŸŸæœåŠ¡è®¾è®¡)
- [7. è¿è¡Œæœºåˆ¶](#7-è¿è¡Œæœºåˆ¶)
- [8. è®¾è®¡æ¨¡å¼æ€»ç»“](#8-è®¾è®¡æ¨¡å¼æ€»ç»“)
- [9. ä»£ç å¯¼èˆª](#9-ä»£ç å¯¼èˆª)

---

## 1. æ ¸å¿ƒä»·å€¼ï¼šè§£å†³ä»€ä¹ˆé—®é¢˜

### 1.1 ä¸€å¥è¯æ€»ç»“

**Questionnaire èšåˆå®ç°äº†å¯æ— é™æ‰©å±•çš„é—®å·æ¨¡å‹ï¼Œæ”¯æŒå¤šé¢˜å‹ã€ç‰ˆæœ¬ç®¡ç†å’Œç”Ÿå‘½å‘¨æœŸæ§åˆ¶ï¼Œæ–°å¢é¢˜å‹æ— éœ€ä¿®æ”¹æ ¸å¿ƒä»£ç ã€‚**

### 1.2 ä¸šåŠ¡æŒ‘æˆ˜

```mermaid
graph TD
    A[ä¸šåŠ¡éœ€æ±‚] --> B1[é¢˜å‹å¤šæ ·åŒ–]
    A --> B2[é¢‘ç¹æ–°å¢é¢˜å‹]
    A --> B3[ç‰ˆæœ¬è¿½æº¯]
    A --> B4[å‘å¸ƒæµç¨‹ç®¡æ§]
    
    B1 --> C1[å•é€‰/å¤šé€‰/æ–‡æœ¬/æ•°å­—/æ—¥æœŸ...]
    B2 --> C2[æ¯æœˆå¯èƒ½æ–°å¢2-3ç§é¢˜å‹]
    B3 --> C3[éœ€è¦çŸ¥é“é—®å·çš„æ¼”è¿›å†å²]
    B4 --> C4[è‰ç¨¿â†’å‘å¸ƒâ†’ä¸‹çº¿â†’å½’æ¡£]
    
    C1 --> D[å¦‚ä½•é¿å…ä»£ç è†¨èƒ€?]
    C2 --> D
    C3 --> E[å¦‚ä½•æ¸…æ™°è¿½è¸ªç‰ˆæœ¬?]
    C4 --> F[å¦‚ä½•ä¿è¯çŠ¶æ€ä¸€è‡´æ€§?]
    
    style D fill:#ffe6e6
    style E fill:#ffe6e6
    style F fill:#ffe6e6
```

### 1.3 è§£å†³æ–¹æ¡ˆæ¦‚è§ˆ

| æŒ‘æˆ˜ | è§£å†³æ–¹æ¡ˆ | æ ¸å¿ƒæ”¶ç›Š |
|------|---------|---------|
| é¢˜å‹æ‰©å±• | æ³¨å†Œå™¨+å·¥å‚+æ¥å£ | âœ… æ–°å¢é¢˜å‹åªåŠ ä»£ç ï¼Œä¸æ”¹ç°æœ‰ä»£ç  |
| å‚æ•°é…ç½® | å‡½æ•°å¼é€‰é¡¹ | âœ… API å¯è¯»æ€§å¼ºï¼Œå‚æ•°çµæ´»ç»„åˆ |
| ç”Ÿå‘½å‘¨æœŸ | çŠ¶æ€æœº+é¢†åŸŸæœåŠ¡ | âœ… çŠ¶æ€è½¬æ¢è§„èŒƒï¼Œæµç¨‹å¯è¿½æº¯ |
| ç‰ˆæœ¬ç®¡ç† | è¯­ä¹‰åŒ–ç‰ˆæœ¬ | âœ… å¤§ç‰ˆæœ¬=å‘å¸ƒï¼Œå°ç‰ˆæœ¬=ä¿®æ”¹ |
| å¤æ‚é€»è¾‘ | é¢†åŸŸæœåŠ¡åˆ†ç¦» | âœ… å•ä¸€èŒè´£ï¼Œèšåˆæ ¹ä¿æŒè½»é‡ |

---

## 2. æ•´ä½“æ¶æ„ï¼šä¸‰å±‚è®¾è®¡

### 2.1 æ¶æ„å…¨æ™¯å›¾

```mermaid
graph TB
    subgraph "åº”ç”¨æœåŠ¡å±‚ Application"
        A1[QuestionnaireService]
    end
    
    subgraph "èšåˆå±‚ Aggregate"
        B1[Questionnaire èšåˆæ ¹]
        B2[Question æ¥å£ä½“ç³»]
        B3[å€¼å¯¹è±¡: Version/Option]
    end
    
    subgraph "é¢†åŸŸæœåŠ¡å±‚ Domain Services"
        C1[Lifecycle<br/>ç”Ÿå‘½å‘¨æœŸç®¡ç†]
        C2[QuestionManager<br/>é¢˜ç›®ç®¡ç†]
        C3[Versioning<br/>ç‰ˆæœ¬ç®¡ç†]
        C4[Validator<br/>ä¸šåŠ¡æ ¡éªŒ]
        C5[BaseInfo<br/>åŸºæœ¬ä¿¡æ¯ç®¡ç†]
    end
    
    subgraph "é¢˜å‹æ‰©å±•æœºåˆ¶ Extension"
        D1[Question æ³¨å†Œå™¨]
        D2[é¢˜å‹å·¥å‚]
        D3[å‚æ•°å®¹å™¨]
    end
    
    A1 --> C1
    A1 --> C2
    A1 --> C3
    
    C1 --> B1
    C2 --> B1
    C3 --> B1
    C4 --> B1
    C5 --> B1
    
    B1 --> B2
    B1 --> B3
    
    B2 --> D1
    D1 --> D2
    D2 --> D3
    
    style A1 fill:#e1f5ff
    style B1 fill:#fff4e6
    style C1 fill:#f3e5f5
    style C2 fill:#f3e5f5
    style C3 fill:#f3e5f5
    style C4 fill:#f3e5f5
    style C5 fill:#f3e5f5
    style D1 fill:#e8f5e9
```

### 2.2 ä¸‰å±‚èŒè´£åˆ’åˆ†

```mermaid
graph LR
    A[èšåˆæ ¹å±‚<br/>Aggregate Root] --> A1[ç»´æŠ¤ä¸šåŠ¡ä¸å˜å¼<br/>ä¿è¯æ•°æ®ä¸€è‡´æ€§]
    A --> A2[æš´éœ²åªè¯»æ¥å£<br/>ç§æœ‰åŒ–å†™æ“ä½œ]
    
    B[é¢†åŸŸæœåŠ¡å±‚<br/>Domain Services] --> B1[ç¼–æ’å¤æ‚ä¸šåŠ¡æµç¨‹<br/>å¦‚å‘å¸ƒ/ä¸‹çº¿/å½’æ¡£]
    B --> B2[åè°ƒå¤šä¸ªèšåˆæ“ä½œ<br/>è·¨å¯¹è±¡çš„ä¸šåŠ¡è§„åˆ™]
    
    C[é¢˜å‹æ‰©å±•å±‚<br/>Extension] --> C1[æ³¨å†Œå™¨ç®¡ç†é¢˜å‹<br/>å·¥å‚åˆ›å»ºå®ä¾‹]
    C --> C2[å‚æ•°å®¹å™¨æ”¶é›†é…ç½®<br/>å‡½æ•°é€‰é¡¹å¢å¼ºå¯è¯»æ€§]
    
    style A fill:#fff4e6
    style B fill:#f3e5f5
    style C fill:#e8f5e9
```

---

## 3. æ ¸å¿ƒè®¾è®¡å†³ç­–

### 3.1 å…³é”®å†³ç­–è¡¨

| # | å†³ç­–ç‚¹ | é€‰å‹ | åŸå›  | æƒè¡¡ |
|---|--------|------|------|------|
| 1 | é¢˜å‹æ‰©å±•æ–¹å¼ | æ³¨å†Œå™¨+å·¥å‚ | âœ… ç¬¦åˆå¼€é—­åŸåˆ™<br/>âœ… æ‰©å±•æ— éœ€æ”¹æ ¸å¿ƒ | âš ï¸ éœ€è¦ç†è§£æ³¨å†Œæœºåˆ¶ |
| 2 | å‚æ•°ä¼ é€’æ–¹å¼ | å‡½æ•°å¼é€‰é¡¹ | âœ… å¯è¯»æ€§å¼º<br/>âœ… å¯é€‰å‚æ•°çµæ´» | âš ï¸ ç¨å¾®å¢åŠ ä»£ç é‡ |
| 3 | æ¥å£è®¾è®¡ç²’åº¦ | ç»Ÿä¸€å¤§æ¥å£ | âœ… ä½¿ç”¨ç®€å•<br/>âœ… é¿å…æ¥å£çˆ†ç‚¸ | âš ï¸ éƒ¨åˆ†æ–¹æ³•è¿”å›ç©ºå€¼ |
| 4 | ä¸šåŠ¡é€»è¾‘ä½ç½® | é¢†åŸŸæœåŠ¡åˆ†ç¦» | âœ… å•ä¸€èŒè´£<br/>âœ… èšåˆæ ¹è½»é‡ | âš ï¸ éœ€è¦åè°ƒå¤šä¸ªæœåŠ¡ |
| 5 | ç‰ˆæœ¬å·ç­–ç•¥ | è¯­ä¹‰åŒ–ç‰ˆæœ¬ | âœ… å«ä¹‰æ¸…æ™°<br/>âœ… ä¸šç•Œé€šç”¨ | âš ï¸ éœ€ä¸¥æ ¼éµå®ˆè§„åˆ™ |

### 3.2 è®¾è®¡åŸåˆ™åº”ç”¨

```mermaid
mindmap
  root((è®¾è®¡åŸåˆ™))
    å¼€é—­åŸåˆ™ OCP
      æ–°å¢é¢˜å‹ä¸æ”¹æ ¸å¿ƒä»£ç 
      ä½¿ç”¨æ³¨å†Œå™¨æ‰©å±•
      å·¥å‚æ¨¡å¼å°è£…åˆ›å»º
    å•ä¸€èŒè´£ SRP
      èšåˆæ ¹åªç®¡æ•°æ®ä¸€è‡´æ€§
      é¢†åŸŸæœåŠ¡åˆ†å·¥æ˜ç¡®
      æ¯ä¸ªæœåŠ¡ä¸€ä¸ªå…³æ³¨ç‚¹
    ä¾èµ–å€’ç½® DIP
      ä¾èµ–æ¥å£è€Œéå®ç°
      Question æ¥å£ç»Ÿä¸€æŠ½è±¡
      é¢†åŸŸæœåŠ¡æ³¨å…¥èšåˆæ ¹
    é‡Œæ°æ›¿æ¢ LSP
      æ‰€æœ‰é¢˜å‹å¯äº’æ¢ä½¿ç”¨
      æ¥å£å¥‘çº¦ä¸€è‡´
      å¤šæ€è¡Œä¸ºç»Ÿä¸€
```

---

## 4. é¢˜å‹æ‰©å±•ä½“ç³»

### 4.1 æ‰©å±•æœºåˆ¶æ€»è§ˆ

**æ ¸å¿ƒæ€æƒ³**ï¼šå°†"é¢˜å‹"ä½œä¸ºå¯æ’æ‹”ç»„ä»¶ï¼Œé€šè¿‡æ³¨å†Œå™¨åŠ¨æ€ç®¡ç†ï¼Œå·¥å‚ç»Ÿä¸€åˆ›å»ºã€‚

```mermaid
sequenceDiagram
    autonumber
    participant C as è°ƒç”¨æ–¹
    participant N as NewQuestion
    participant P as QuestionParams
    participant R as æ³¨å†Œå™¨ Registry
    participant F as é¢˜å‹å·¥å‚ Factory
    participant Q as Question å®ä¾‹

    C->>N: NewQuestion(WithCode(), WithStem(), WithQuestionType(Radio), ...)
    N->>P: åˆ›å»º QuestionParams
    P->>P: Validate() å‚æ•°æ ¡éªŒ
    N->>R: GetFactory(Radio)
    R-->>N: RadioQuestionFactory
    N->>F: factory(params)
    F->>Q: new RadioQuestion
    Q-->>F: å®ä¾‹
    F-->>N: Question æ¥å£
    N-->>C: è¿”å› Question
```

### 4.2 Question æ¥å£ï¼šç»Ÿä¸€é¢˜å‹æŠ½è±¡

```go
// æ‰€æœ‰é¢˜å‹çš„ç»Ÿä¸€æ¥å£
type Question interface {
    // åŸºç¡€ä¿¡æ¯
    GetType() QuestionType
    GetCode() Code
    GetStem() string          // é¢˜å¹²
    GetTips() string          // æç¤ºæ–‡æœ¬
    
    // æ–‡æœ¬è¾“å…¥ç±»
    GetPlaceholder() string   // å ä½ç¬¦
    
    // é€‰æ‹©ç±»
    GetOptions() []Option     // é€‰é¡¹åˆ—è¡¨
    
    // æ ¡éªŒä¸è®¡ç®—
    GetValidationRules() []ValidationRule
    GetCalculationRule() *CalculationRule
}
```

**è®¾è®¡è¯´æ˜**ï¼š

- âœ… ç»Ÿä¸€æ¥å£ç®€åŒ–ä½¿ç”¨ï¼Œé—®å·å±‚é¢æ— éœ€å…³å¿ƒå…·ä½“é¢˜å‹
- âœ… éƒ¨åˆ†æ–¹æ³•æŸäº›é¢˜å‹è¿”å›ç©ºå€¼ï¼ˆå¦‚æ–‡æœ¬é¢˜æ— é€‰é¡¹ï¼‰
- âš ï¸ å¦‚æœæ¥å£è¿‡åº¦è†¨èƒ€å¯è€ƒè™‘æ‹†åˆ†ï¼Œä½†å½“å‰è§„æ¨¡åˆç†

ğŸ“„ **ä»£ç ä½ç½®**ï¼š[`questionnaire/question.go`](../../internal/apiserver/domain/questionnaire/question.go)

### 4.3 æ³¨å†Œå™¨æ¨¡å¼ï¼šç®¡ç†é¢˜å‹æ˜ å°„

```go
// å·¥å‚å‡½æ•°ç±»å‹
type QuestionFactory func(*QuestionParams) (Question, error)

// å…¨å±€æ³¨å†Œå™¨
var questionRegistry = map[QuestionType]QuestionFactory{}

// æ³¨å†Œå‡½æ•°
func RegisterQuestionFactory(t QuestionType, factory QuestionFactory) {
    questionRegistry[t] = factory
}

// è·å–å·¥å‚
func getQuestionFactory(t QuestionType) (QuestionFactory, bool) {
    factory, ok := questionRegistry[t]
    return factory, ok
}
```

**è¿ä½œæœºåˆ¶**ï¼š

```mermaid
graph LR
    A[åº”ç”¨å¯åŠ¨] --> B[å„é¢˜å‹ init]
    B --> C1[RadioQuestion.init]
    B --> C2[CheckboxQuestion.init]
    B --> C3[TextQuestion.init]
    
    C1 --> D[RegisterQuestionFactory<br/>TypeRadio â†’ RadioFactory]
    C2 --> D
    C3 --> D
    
    D --> E[questionRegistry<br/>Map å¡«å……å®Œæˆ]
    
    E --> F[NewQuestion<br/>æ ¹æ®ç±»å‹æŸ¥æ‰¾å·¥å‚]
    
    style E fill:#e8f5e9
```

ğŸ“„ **ä»£ç ä½ç½®**ï¼š[`questionnaire/question_registry.go`](../../internal/apiserver/domain/questionnaire/question_registry.go)

### 4.4 å·¥å‚æ¨¡å¼ï¼šåˆ›å»ºå…·ä½“é¢˜å‹

æ¯ä¸ªé¢˜å‹å®ç°è‡ªå·±çš„å·¥å‚å‡½æ•°ï¼š

```go
// å•é€‰é¢˜å·¥å‚
func newRadioQuestionFactory(p *QuestionParams) (Question, error) {
    // ç‰¹å®šæ ¡éªŒ
    if len(p.GetOptions()) < 2 {
        return nil, ErrInsufficientOptions
    }
    
    return &RadioQuestion{
        QuestionCore:    p.GetCore(),
        options:         p.GetOptions(),
        validationRules: p.GetValidationRules(),
        calculationRule: p.GetCalculationRule(),
    }, nil
}

// åœ¨ init ä¸­æ³¨å†Œ
func init() {
    RegisterQuestionFactory(TypeRadio, newRadioQuestionFactory)
}
```

**ç±»å›¾å…³ç³»**ï¼š

```mermaid
classDiagram
    class Question {
        <<interface>>
        +GetType() QuestionType
        +GetCode() Code
        +GetStem() string
        +GetOptions() []Option
    }
    
    class QuestionCore {
        -code Code
        -stem string
        -tips string
        -typ QuestionType
    }
    
    class RadioQuestion {
        -QuestionCore
        -options []Option
        -validationRules []ValidationRule
        +GetOptions() []Option
    }
    
    class CheckboxQuestion {
        -QuestionCore
        -options []Option
        -validationRules []ValidationRule
        +GetOptions() []Option
    }
    
    class TextQuestion {
        -QuestionCore
        -placeholder string
        -validationRules []ValidationRule
        +GetPlaceholder() string
    }
    
    Question <|.. RadioQuestion
    Question <|.. CheckboxQuestion
    Question <|.. TextQuestion
    
    QuestionCore <-- RadioQuestion
    QuestionCore <-- CheckboxQuestion
    QuestionCore <-- TextQuestion
```

ğŸ“„ **ä»£ç ä½ç½®**ï¼š

- [`questionnaire/question_radio.go`](../../internal/apiserver/domain/questionnaire/question_radio.go)
- [`questionnaire/question_checkbox.go`](../../internal/apiserver/domain/questionnaire/question_checkbox.go)
- [`questionnaire/question_text.go`](../../internal/apiserver/domain/questionnaire/question_text.go)

### 4.5 å‚æ•°å®¹å™¨ + å‡½æ•°å¼é€‰é¡¹

**é—®é¢˜**ï¼šä¼ ç»Ÿæ„é€ å‡½æ•°å‚æ•°è¿‡å¤šï¼Œéš¾ä»¥é˜…è¯»å’Œç»´æŠ¤ã€‚

```go
// âŒ ä¼ ç»Ÿæ–¹å¼ï¼šå‚æ•°åœ°ç‹±
NewRadioQuestion(code, stem, tips, required, options, rules, calcRule, displayOrder, ...)
```

**è§£å†³æ–¹æ¡ˆ**ï¼šå‚æ•°å®¹å™¨ + å‡½æ•°å¼é€‰é¡¹

```go
// âœ… å‚æ•°å®¹å™¨
type QuestionParams struct {
    core        QuestionCore
    placeholder string
    options     []Option
    rules       []ValidationRule
    calcRule    *CalculationRule
}

// âœ… é€‰é¡¹å‡½æ•°ç±»å‹
type QuestionParamsOption func(*QuestionParams)

// âœ… å…·ä½“é€‰é¡¹å‡½æ•°
func WithCode(code Code) QuestionParamsOption {
    return func(p *QuestionParams) {
        p.core.code = code
    }
}

func WithStem(stem string) QuestionParamsOption {
    return func(p *QuestionParams) {
        p.core.stem = stem
    }
}

func WithQuestionType(t QuestionType) QuestionParamsOption {
    return func(p *QuestionParams) {
        p.core.typ = t
    }
}

func WithOption(code, content string, score float64) QuestionParamsOption {
    return func(p *QuestionParams) {
        p.options = append(p.options, NewOption(code, content, score))
    }
}

func WithRequired() QuestionParamsOption {
    return func(p *QuestionParams) {
        p.core.required = true
    }
}
```

**æ„é€ æµç¨‹**ï¼š

```go
// NewQuestionParams æ”¶é›†æ‰€æœ‰é€‰é¡¹
func NewQuestionParams(opts ...QuestionParamsOption) *QuestionParams {
    p := &QuestionParams{
        options: make([]Option, 0),
        rules:   make([]ValidationRule, 0),
    }
    
    // åº”ç”¨æ‰€æœ‰é€‰é¡¹
    for _, opt := range opts {
        opt(p)
    }
    
    // ç»Ÿä¸€æ ¡éªŒ
    if err := p.Validate(); err != nil {
        panic(err) // æˆ–è¿”å›é”™è¯¯
    }
    
    return p
}
```

**ä½¿ç”¨ç¤ºä¾‹**ï¼š

```go
// âœ… æ¸…æ™°å¯è¯»çš„ API
question := NewQuestion(
    WithCode(NewCode("Q1")),
    WithStem("æ‚¨çš„æ€§åˆ«æ˜¯ï¼Ÿ"),
    WithQuestionType(TypeRadio),
    WithOption("A", "ç”·", 0),
    WithOption("B", "å¥³", 0),
    WithRequired(),
    WithCalculationRule(FormulaScore),
)
```

ğŸ“„ **ä»£ç ä½ç½®**ï¼š

- [`questionnaire/question_params.go`](../../internal/apiserver/domain/questionnaire/question_params.go)
- [`questionnaire/question_options.go`](../../internal/apiserver/domain/questionnaire/question_options.go)

### 4.6 æ–°å¢é¢˜å‹ï¼šå®Œæ•´æµç¨‹

**åœºæ™¯**ï¼šæ–°å¢ DateQuestionï¼ˆæ—¥æœŸé¢˜ï¼‰

```mermaid
graph TB
    A[1. å®šä¹‰é¢˜å‹æšä¸¾] --> B[2. å®ç° Question æ¥å£]
    B --> C[3. ç¼–å†™å·¥å‚å‡½æ•°]
    C --> D[4. æ³¨å†Œåˆ° Registry]
    D --> E[5. ä½¿ç”¨ NewQuestion åˆ›å»º]
    
    A1[const TypeDate = 'Date'] -.-> A
    B1[type DateQuestion struct] -.-> B
    C1[func newDateQuestionFactory] -.-> C
    D1[init: RegisterQuestionFactory] -.-> D
    E1[NewQuestion WithQuestionType TypeDate] -.-> E
    
    style A fill:#e1f5ff
    style B fill:#e1f5ff
    style C fill:#e1f5ff
    style D fill:#e1f5ff
    style E fill:#c8e6c9
```

**å®Œæ•´ä»£ç ç¤ºä¾‹**ï¼š

```go
// ========== 1. æšä¸¾å®šä¹‰ ==========
// åœ¨ question_types.go ä¸­æ·»åŠ 
const TypeDate QuestionType = "Date"

// ========== 2. å®ç°æ¥å£ ==========
// æ–°å»º question_date.go
type DateQuestion struct {
    QuestionCore
    placeholder string
    minDate     *time.Time
    maxDate     *time.Time
    rules       []ValidationRule
}

// å®ç° Question æ¥å£
func (q *DateQuestion) GetType() QuestionType { return TypeDate }
func (q *DateQuestion) GetCode() Code { return q.QuestionCore.code }
func (q *DateQuestion) GetStem() string { return q.QuestionCore.stem }
func (q *DateQuestion) GetPlaceholder() string { return q.placeholder }
func (q *DateQuestion) GetOptions() []Option { return nil } // æ—¥æœŸé¢˜æ— é€‰é¡¹
// ... å…¶ä»–æ¥å£æ–¹æ³•

// ========== 3. å·¥å‚å‡½æ•° ==========
func newDateQuestionFactory(p *QuestionParams) (Question, error) {
    // æ—¥æœŸé¢˜ç‰¹å®šæ ¡éªŒ
    if p.GetPlaceholder() == "" {
        return nil, errors.New("æ—¥æœŸé¢˜å¿…é¡»æä¾›å ä½ç¬¦")
    }
    
    return &DateQuestion{
        QuestionCore: p.GetCore(),
        placeholder:  p.GetPlaceholder(),
        rules:        p.GetValidationRules(),
    }, nil
}

// ========== 4. æ³¨å†Œ ==========
func init() {
    RegisterQuestionFactory(TypeDate, newDateQuestionFactory)
}

// ========== 5. ä½¿ç”¨ ==========
// åœ¨ä»»ä½•åœ°æ–¹ä½¿ç”¨
dateQ := NewQuestion(
    WithCode(NewCode("Q5")),
    WithStem("è¯·é€‰æ‹©æ‚¨çš„å‡ºç”Ÿæ—¥æœŸ"),
    WithQuestionType(TypeDate),
    WithPlaceholder("YYYY-MM-DD"),
    WithRequired(),
)
```

**å…³é”®ç‚¹**ï¼š

- âœ… æ— éœ€ä¿®æ”¹ `NewQuestion` å‡½æ•°
- âœ… æ— éœ€ä¿®æ”¹ `Question` æ¥å£
- âœ… æ— éœ€ä¿®æ”¹å…¶ä»–é¢˜å‹ä»£ç 
- âœ… å®Œå…¨ç¬¦åˆå¼€é—­åŸåˆ™

---

## 5. èšåˆæ ¹è®¾è®¡

### 5.1 Questionnaire èšåˆæ ¹ç»“æ„

```go
type Questionnaire struct {
    // èº«ä»½æ ‡è¯†
    id   ID
    code Code
    
    // åŸºæœ¬ä¿¡æ¯
    title   string
    desc    string
    imgURL  string
    
    // ç‰ˆæœ¬ä¸çŠ¶æ€
    version Version
    status  Status
    
    // é¢˜ç›®åˆ—è¡¨
    questions []Question
    
    // å®¡è®¡ä¿¡æ¯
    createdBy ID
    createdAt time.Time
    updatedAt time.Time
}
```

**èŒè´£è¾¹ç•Œ**ï¼š

```mermaid
graph LR
    A[èšåˆæ ¹è´Ÿè´£] --> A1[âœ… ç»´æŠ¤æ•°æ®ä¸€è‡´æ€§]
    A --> A2[âœ… ä¿è¯é¢˜ç›®ç¼–ç å”¯ä¸€]
    A --> A3[âœ… æš´éœ²åªè¯»æŸ¥è¯¢]
    A --> A4[âœ… ç§æœ‰åŒ–ä¿®æ”¹æ“ä½œ]
    
    B[èšåˆæ ¹ä¸è´Ÿè´£] --> B1[âŒ ä¸šåŠ¡æµç¨‹ç¼–æ’]
    B --> B2[âŒ å¤æ‚ä¸šåŠ¡è§„åˆ™]
    B --> B3[âŒ å¤–éƒ¨ä¾èµ–è®¿é—®]
    B --> B4[âŒ DTO è½¬æ¢]
    
    style A fill:#c8e6c9
    style B fill:#ffccbc
```

### 5.2 æ„é€ å‡½æ•°

```go
// NewQuestionnaire åˆ›å»ºæ–°é—®å·
func NewQuestionnaire(code Code, title string, createdBy ID) (*Questionnaire, error) {
    // å‚æ•°æ ¡éªŒ
    if code.IsEmpty() {
        return nil, ErrCodeEmpty
    }
    if title == "" {
        return nil, ErrTitleEmpty
    }
    if len(title) > 200 {
        return nil, ErrTitleTooLong
    }
    
    return &Questionnaire{
        id:        NewID(),
        code:      code,
        title:     title,
        version:   Version("0.0.1"), // åˆå§‹ç‰ˆæœ¬
        status:    StatusDraft,       // åˆå§‹çŠ¶æ€ï¼šè‰ç¨¿
        questions: make([]Question, 0),
        createdBy: createdBy,
        createdAt: time.Now(),
        updatedAt: time.Now(),
    }, nil
}
```

ğŸ“„ **ä»£ç ä½ç½®**ï¼š[`questionnaire/questionnaire.go`](../../internal/apiserver/domain/questionnaire/questionnaire.go)

### 5.3 å…¬å…±æ¥å£ï¼šåªè¯»ä¸ºä¸»

```go
// ========== åªè¯»æŸ¥è¯¢ ==========
func (q *Questionnaire) ID() ID                    { return q.id }
func (q *Questionnaire) Code() Code                { return q.code }
func (q *Questionnaire) GetTitle() string          { return q.title }
func (q *Questionnaire) GetVersion() Version       { return q.version }
func (q *Questionnaire) GetStatus() Status         { return q.status }
func (q *Questionnaire) GetQuestions() []Question  { return q.questions }
func (q *Questionnaire) QuestionCount() int        { return len(q.questions) }

// ========== çŠ¶æ€åˆ¤æ–­ ==========
func (q *Questionnaire) IsDraft() bool     { return q.status == StatusDraft }
func (q *Questionnaire) IsPublished() bool { return q.status == StatusPublished }
func (q *Questionnaire) IsArchived() bool  { return q.status == StatusArchived }
```

### 5.4 ç§æœ‰æ¥å£ï¼šä»…ä¾›é¢†åŸŸæœåŠ¡

```go
// ========== ä»…åŒåŒ…å¯è§çš„ä¿®æ”¹æ“ä½œ ==========

// changeStatus ä¿®æ”¹çŠ¶æ€ï¼ˆä»…é™ Lifecycle æœåŠ¡è°ƒç”¨ï¼‰
func (q *Questionnaire) changeStatus(status Status) error {
    q.status = status
    q.updatedAt = time.Now()
    return nil
}

// updateBasicInfo æ›´æ–°åŸºæœ¬ä¿¡æ¯ï¼ˆä»…é™ BaseInfo æœåŠ¡è°ƒç”¨ï¼‰
func (q *Questionnaire) updateBasicInfo(title, desc, imgURL string) error {
    if title != "" {
        q.title = title
    }
    q.desc = desc
    q.imgURL = imgURL
    q.updatedAt = time.Now()
    return nil
}

// addQuestion æ·»åŠ é¢˜ç›®ï¼ˆä»…é™ QuestionManager æœåŠ¡è°ƒç”¨ï¼‰
func (q *Questionnaire) addQuestion(question Question) error {
    q.questions = append(q.questions, question)
    q.updatedAt = time.Now()
    return nil
}

// updateVersion æ›´æ–°ç‰ˆæœ¬ï¼ˆä»…é™ Versioning æœåŠ¡è°ƒç”¨ï¼‰
func (q *Questionnaire) updateVersion(v Version) error {
    q.version = v
    q.updatedAt = time.Now()
    return nil
}
```

**è®¾è®¡æ„å›¾**ï¼š

```mermaid
graph TB
    A[å¤–éƒ¨è°ƒç”¨è€…<br/>åº”ç”¨æœåŠ¡] --> B{å°è¯•ä¿®æ”¹é—®å·}
    B -->|ç›´æ¥è°ƒç”¨| C[âŒ ç¼–è¯‘é”™è¯¯<br/>ç§æœ‰æ–¹æ³•ä¸å¯è§]
    B -->|é€šè¿‡é¢†åŸŸæœåŠ¡| D[âœ… é¢†åŸŸæœåŠ¡<br/>Lifecycle/QuestionManager]
    D --> E[é¢†åŸŸæœåŠ¡æ‰§è¡Œä¸šåŠ¡è§„åˆ™]
    E --> F[è°ƒç”¨èšåˆæ ¹ç§æœ‰æ–¹æ³•]
    F --> G[âœ… ä¿®æ”¹æˆåŠŸ<br/>ä¿è¯ä¸šåŠ¡ä¸€è‡´æ€§]
    
    style C fill:#ffccbc
    style G fill:#c8e6c9
```

---

## 6. é¢†åŸŸæœåŠ¡è®¾è®¡

### 6.1 äº”å¤§é¢†åŸŸæœåŠ¡æ€»è§ˆ

```mermaid
mindmap
  root((Questionnaire<br/>èšåˆæ ¹))
    Lifecycle
      å‘å¸ƒ Publish
      ä¸‹çº¿ Unpublish
      å½’æ¡£ Archive
    QuestionManager
      æ·»åŠ é¢˜ç›® AddQuestion
      åˆ é™¤é¢˜ç›® RemoveQuestion
      æ›¿æ¢æ‰€æœ‰é¢˜ç›® ReplaceQuestions
    Versioning
      åˆå§‹åŒ–ç‰ˆæœ¬ Initialize
      å°ç‰ˆæœ¬é€’å¢ IncrementMinor
      å¤§ç‰ˆæœ¬é€’å¢ IncrementMajor
    Validator
      å‘å¸ƒå‰æ ¡éªŒ ValidateForPublish
      é¢˜ç›®æ ¡éªŒ ValidateQuestions
    BaseInfo
      æ›´æ–°æ ‡é¢˜ UpdateTitle
      æ›´æ–°æè¿° UpdateDescription
      æ‰¹é‡æ›´æ–° UpdateAll
```

### 6.2 Lifecycleï¼šç”Ÿå‘½å‘¨æœŸç®¡ç†

**çŠ¶æ€æœºæ¨¡å‹**ï¼š

```mermaid
stateDiagram-v2
    [*] --> Draft: åˆ›å»ºé—®å·
    Draft --> Published: Publish()
    Published --> Published: Publish()<br/>(ä¿®æ”¹åå†å‘å¸ƒ)
    Published --> Draft: Unpublish()
    Published --> Archived: Archive()
    Archived --> [*]
    
    note right of Draft
        ç‰ˆæœ¬: 0.0.x
        å¯ç¼–è¾‘
    end note
    
    note right of Published
        ç‰ˆæœ¬: x.0.1+
        åªè¯»
    end note
    
    note right of Archived
        å†å²å­˜æ¡£
        ä¸å¯æ¢å¤
    end note
```

**Publish æ–¹æ³•å®ç°**ï¼š

```go
type Lifecycle struct {
    validator  *Validator
    versioning *Versioning
}

// Publish å‘å¸ƒé—®å·
func (lc *Lifecycle) Publish(ctx context.Context, q *Questionnaire) error {
    // 1. çŠ¶æ€æ£€æŸ¥
    if q.IsArchived() {
        return ErrCannotPublishArchivedQuestionnaire
    }
    
    // 2. ä¸šåŠ¡è§„åˆ™æ ¡éªŒ
    errs := lc.validator.ValidateForPublish(q)
    if len(errs) > 0 {
        return WrapValidationErrors(errs)
    }
    
    // 3. å¤§ç‰ˆæœ¬é€’å¢ï¼ˆå‘å¸ƒ=é‡å¤§å˜æ›´ï¼‰
    if err := lc.versioning.IncrementMajorVersion(q); err != nil {
        return err
    }
    
    // 4. çŠ¶æ€è½¬æ¢
    return q.changeStatus(StatusPublished)
}

// Unpublish ä¸‹çº¿é—®å·ï¼ˆå˜å›è‰ç¨¿ï¼‰
func (lc *Lifecycle) Unpublish(ctx context.Context, q *Questionnaire) error {
    if !q.IsPublished() {
        return ErrQuestionnaireNotPublished
    }
    return q.changeStatus(StatusDraft)
}

// Archive å½’æ¡£é—®å·ï¼ˆä¸å¯é€†ï¼‰
func (lc *Lifecycle) Archive(ctx context.Context, q *Questionnaire) error {
    if q.IsArchived() {
        return ErrAlreadyArchived
    }
    return q.changeStatus(StatusArchived)
}
```

**å‘å¸ƒæµç¨‹æ—¶åºå›¾**ï¼š

```mermaid
sequenceDiagram
    autonumber
    participant App as åº”ç”¨æœåŠ¡
    participant LC as Lifecycle
    participant VD as Validator
    participant VG as Versioning
    participant Q as Questionnaire

    App->>LC: Publish(ctx, q)
    LC->>Q: IsArchived()?
    Q-->>LC: false
    
    LC->>VD: ValidateForPublish(q)
    VD->>VD: æ£€æŸ¥æ ‡é¢˜/ç‰ˆæœ¬/é¢˜ç›®
    VD-->>LC: []ValidationError (ç©º=é€šè¿‡)
    
    alt æ ¡éªŒå¤±è´¥
        LC-->>App: è¿”å›é”™è¯¯åˆ—è¡¨
    else æ ¡éªŒé€šè¿‡
        LC->>VG: IncrementMajorVersion(q)
        VG->>Q: updateVersion(2.0.1)
        Q-->>VG: OK
        
        LC->>Q: changeStatus(Published)
        Q-->>LC: OK
        
        LC-->>App: å‘å¸ƒæˆåŠŸ
    end
```

ğŸ“„ **ä»£ç ä½ç½®**ï¼š[`questionnaire/lifecycle.go`](../../internal/apiserver/domain/questionnaire/lifecycle.go)

### 6.3 Versioningï¼šç‰ˆæœ¬ç®¡ç†

**è¯­ä¹‰åŒ–ç‰ˆæœ¬è§„åˆ™**ï¼š

```text
æ ¼å¼ï¼šMajor.Minor.Patch
ç¤ºä¾‹ï¼š2.1.3

è§„åˆ™ï¼š
- åˆå§‹ç‰ˆæœ¬ï¼š0.0.1
- è‰ç¨¿ä¿å­˜ï¼šMinor + 1    (0.0.1 â†’ 0.0.2)
- å‘å¸ƒï¼š    Major + 1    (0.0.5 â†’ 1.0.1)
- å†å‘å¸ƒï¼š  Major + 1    (1.0.3 â†’ 2.0.1)
```

**å®ç°**ï¼š

```go
type Versioning struct{}

// InitializeVersion åˆå§‹åŒ–ç‰ˆæœ¬ï¼ˆæ–°å»ºé—®å·æ—¶ï¼‰
func (Versioning) InitializeVersion(q *Questionnaire) error {
    return q.updateVersion(Version("0.0.1"))
}

// IncrementMinorVersion å°ç‰ˆæœ¬é€’å¢ï¼ˆä¿å­˜è‰ç¨¿ï¼‰
func (Versioning) IncrementMinorVersion(q *Questionnaire) error {
    currentVersion := q.GetVersion()
    newVersion := currentVersion.IncrementMinor()
    return q.updateVersion(newVersion)
}

// IncrementMajorVersion å¤§ç‰ˆæœ¬é€’å¢ï¼ˆå‘å¸ƒï¼‰
func (Versioning) IncrementMajorVersion(q *Questionnaire) error {
    currentVersion := q.GetVersion()
    newVersion := currentVersion.IncrementMajor()
    return q.updateVersion(newVersion)
}
```

**Version å€¼å¯¹è±¡**ï¼š

```go
type Version string

// IncrementMinor 0.0.1 â†’ 0.0.2
func (v Version) IncrementMinor() Version {
    parts := strings.Split(string(v), ".")
    if len(parts) != 3 {
        return v
    }
    
    patch, _ := strconv.Atoi(parts[2])
    return Version(fmt.Sprintf("%s.%s.%d", parts[0], parts[1], patch+1))
}

// IncrementMajor 0.0.5 â†’ 1.0.1
func (v Version) IncrementMajor() Version {
    parts := strings.Split(string(v), ".")
    if len(parts) != 3 {
        return v
    }
    
    major, _ := strconv.Atoi(parts[0])
    return Version(fmt.Sprintf("%d.0.1", major+1))
}
```

ğŸ“„ **ä»£ç ä½ç½®**ï¼š

- [`questionnaire/versioning.go`](../../internal/apiserver/domain/questionnaire/versioning.go)
- [`questionnaire/version.go`](../../internal/apiserver/domain/questionnaire/version.go)

### 6.4 QuestionManagerï¼šé¢˜ç›®ç®¡ç†

```go
type QuestionManager struct{}

// AddQuestion æ·»åŠ é¢˜ç›®
func (QuestionManager) AddQuestion(q *Questionnaire, question Question) error {
    if question == nil {
        return ErrNilQuestion
    }
    
    // æ£€æŸ¥ç¼–ç å”¯ä¸€æ€§
    for _, existing := range q.GetQuestions() {
        if existing.GetCode() == question.GetCode() {
            return ErrDuplicatedQuestionCode
        }
    }
    
    return q.addQuestion(question)
}

// RemoveQuestion åˆ é™¤é¢˜ç›®
func (QuestionManager) RemoveQuestion(q *Questionnaire, code Code) error {
    questions := q.GetQuestions()
    for i, question := range questions {
        if question.GetCode() == code {
            // åˆ é™¤è¯¥é¢˜
            q.questions = append(questions[:i], questions[i+1:]...)
            q.updatedAt = time.Now()
            return nil
        }
    }
    return ErrQuestionNotFound
}

// ReplaceQuestions ä¸€æ¬¡æ€§æ›¿æ¢æ‰€æœ‰é¢˜ç›®
func (QuestionManager) ReplaceQuestions(q *Questionnaire, questions []Question) error {
    if len(questions) == 0 {
        return ErrEmptyQuestions
    }
    
    // æ£€æŸ¥ç¼–ç å”¯ä¸€æ€§
    seen := make(map[string]bool)
    for _, question := range questions {
        if question == nil {
            return ErrNilQuestion
        }
        code := question.GetCode().Value()
        if seen[code] {
            return ErrDuplicatedQuestionCode
        }
        seen[code] = true
    }
    
    q.questions = questions
    q.updatedAt = time.Now()
    return nil
}
```

ğŸ“„ **ä»£ç ä½ç½®**ï¼š[`questionnaire/question_manager.go`](../../internal/apiserver/domain/questionnaire/question_manager.go)

### 6.5 Validatorï¼šä¸šåŠ¡è§„åˆ™æ ¡éªŒ

```go
type ValidationError struct {
    Field   string // å­—æ®µå
    Code    string // é”™è¯¯ä»£ç 
    Message string // é”™è¯¯æ¶ˆæ¯
}

type Validator struct{}

// ValidateForPublish å‘å¸ƒå‰æ ¡éªŒ
func (Validator) ValidateForPublish(q *Questionnaire) []ValidationError {
    var errs []ValidationError
    
    // 1. æ ‡é¢˜æ ¡éªŒ
    if q.GetTitle() == "" {
        errs = append(errs, ValidationError{
            Field:   "title",
            Code:    "TITLE_EMPTY",
            Message: "é—®å·æ ‡é¢˜ä¸èƒ½ä¸ºç©º",
        })
    }
    if len(q.GetTitle()) > 200 {
        errs = append(errs, ValidationError{
            Field:   "title",
            Code:    "TITLE_TOO_LONG",
            Message: "é—®å·æ ‡é¢˜ä¸èƒ½è¶…è¿‡200å­—ç¬¦",
        })
    }
    
    // 2. ç‰ˆæœ¬æ ¡éªŒ
    if q.GetVersion().IsEmpty() {
        errs = append(errs, ValidationError{
            Field:   "version",
            Code:    "VERSION_EMPTY",
            Message: "ç‰ˆæœ¬å·ä¸èƒ½ä¸ºç©º",
        })
    }
    
    // 3. é¢˜ç›®æ•°é‡æ ¡éªŒ
    if q.QuestionCount() == 0 {
        errs = append(errs, ValidationError{
            Field:   "questions",
            Code:    "QUESTIONS_EMPTY",
            Message: "é—®å·è‡³å°‘éœ€è¦ä¸€ä¸ªé¢˜ç›®",
        })
    }
    
    // 4. é€é¢˜æ ¡éªŒ
    for _, question := range q.GetQuestions() {
        // é¢˜ç›®ç¼–ç 
        if question.GetCode().IsEmpty() {
            errs = append(errs, ValidationError{
                Field:   "questions",
                Code:    "QUESTION_CODE_EMPTY",
                Message: "é¢˜ç›®ç¼–ç ä¸èƒ½ä¸ºç©º",
            })
        }
        
        // é¢˜å¹²
        if question.GetStem() == "" {
            errs = append(errs, ValidationError{
                Field:   "questions",
                Code:    "QUESTION_STEM_EMPTY",
                Message: fmt.Sprintf("é¢˜ç›® %s çš„é¢˜å¹²ä¸èƒ½ä¸ºç©º", question.GetCode()),
            })
        }
        
        // é€‰æ‹©é¢˜é€‰é¡¹æ•°é‡
        if question.GetType() == TypeRadio || question.GetType() == TypeCheckbox {
            if len(question.GetOptions()) < 2 {
                errs = append(errs, ValidationError{
                    Field:   "questions",
                    Code:    "OPTIONS_INSUFFICIENT",
                    Message: fmt.Sprintf("é¢˜ç›® %s è‡³å°‘éœ€è¦2ä¸ªé€‰é¡¹", question.GetCode()),
                })
            }
        }
    }
    
    return errs
}
```

ğŸ“„ **ä»£ç ä½ç½®**ï¼š[`questionnaire/validator.go`](../../internal/apiserver/domain/questionnaire/validator.go)

### 6.6 BaseInfoï¼šåŸºæœ¬ä¿¡æ¯ç®¡ç†

```go
type BaseInfo struct{}

// UpdateTitle æ›´æ–°æ ‡é¢˜
func (BaseInfo) UpdateTitle(q *Questionnaire, title string) error {
    if title == "" {
        return ErrTitleEmpty
    }
    if len(title) > 200 {
        return ErrTitleTooLong
    }
    return q.updateBasicInfo(title, q.desc, q.imgURL)
}

// UpdateDescription æ›´æ–°æè¿°
func (BaseInfo) UpdateDescription(q *Questionnaire, desc string) error {
    return q.updateBasicInfo(q.title, desc, q.imgURL)
}

// UpdateAll æ‰¹é‡æ›´æ–°
func (BaseInfo) UpdateAll(q *Questionnaire, title, desc, imgURL string) error {
    if title == "" {
        return ErrTitleEmpty
    }
    if len(title) > 200 {
        return ErrTitleTooLong
    }
    return q.updateBasicInfo(title, desc, imgURL)
}
```

ğŸ“„ **ä»£ç ä½ç½®**ï¼š[`questionnaire/baseinfo.go`](../../internal/apiserver/domain/questionnaire/baseinfo.go)

---

## 7. è¿è¡Œæœºåˆ¶

### 7.1 å®Œæ•´ç”¨ä¾‹ï¼šåˆ›å»ºå¹¶å‘å¸ƒ PHQ-9 é—®å·

**ä¸šåŠ¡æµç¨‹**ï¼š

```mermaid
graph TB
    A[åˆ›å»ºé—®å·èšåˆæ ¹] --> B[åˆå§‹åŒ–ç‰ˆæœ¬ 0.0.1]
    B --> C[æ·»åŠ  Q1-Q9 é¢˜ç›®]
    C --> D[ä¿å­˜è‰ç¨¿<br/>ç‰ˆæœ¬ 0.0.2]
    D --> E{æ˜¯å¦å‘å¸ƒ?}
    E -->|æ˜¯| F[Validator æ ¡éªŒ]
    F --> G{æ ¡éªŒé€šè¿‡?}
    G -->|æ˜¯| H[å¤§ç‰ˆæœ¬é€’å¢ 1.0.1]
    H --> I[çŠ¶æ€æ”¹ä¸º Published]
    I --> J[å®Œæˆ]
    G -->|å¦| K[è¿”å›é”™è¯¯åˆ—è¡¨]
    E -->|å¦| L[ä¿æŒè‰ç¨¿çŠ¶æ€]
```

**ä»£ç å®ç°**ï¼š

```go
// ========== 1. åˆå§‹åŒ–é¢†åŸŸæœåŠ¡ ==========
versioning := questionnaire.Versioning{}
lifecycle := questionnaire.NewLifecycle()
questionManager := questionnaire.QuestionManager{}

// ========== 2. åˆ›å»ºé—®å·èšåˆæ ¹ ==========
qnr, err := questionnaire.NewQuestionnaire(
    questionnaire.NewCode("PHQ-9"),
    "PHQ-9 æŠ‘éƒç—‡ç­›æŸ¥é‡è¡¨",
    creatorID,
)
if err != nil {
    return err
}

// ========== 3. åˆå§‹åŒ–ç‰ˆæœ¬ ==========
if err := versioning.InitializeVersion(qnr); err != nil {
    return err
}

// ========== 4. åˆ›å»ºå¹¶æ·»åŠ é¢˜ç›® ==========
// Q1
q1, err := questionnaire.NewQuestion(
    questionnaire.WithCode(questionnaire.NewCode("Q1")),
    questionnaire.WithStem("åšäº‹æ—¶æä¸èµ·åŠ²æˆ–æ²¡æœ‰å…´è¶£"),
    questionnaire.WithQuestionType(questionnaire.TypeRadio),
    questionnaire.WithOption("0", "å®Œå…¨ä¸ä¼š", 0),
    questionnaire.WithOption("1", "å‡ å¤©", 1),
    questionnaire.WithOption("2", "ä¸€åŠä»¥ä¸Šçš„å¤©æ•°", 2),
    questionnaire.WithOption("3", "å‡ ä¹æ¯å¤©", 3),
    questionnaire.WithRequired(),
    questionnaire.WithCalculationRule(questionnaire.FormulaScore),
)
if err != nil {
    return err
}
if err := questionManager.AddQuestion(qnr, q1); err != nil {
    return err
}

// Q2-Q9 ç±»ä¼¼...ï¼ˆæ­¤å¤„çœç•¥ï¼‰

// ========== 5. ä¿å­˜è‰ç¨¿ ==========
if err := versioning.IncrementMinorVersion(qnr); err != nil {
    return err
}
// æ­¤æ—¶ç‰ˆæœ¬ï¼š0.0.2

// ========== 6. å‘å¸ƒé—®å· ==========
if err := lifecycle.Publish(ctx, qnr); err != nil {
    return err
}
// æ­¤æ—¶ç‰ˆæœ¬ï¼š1.0.1ï¼ŒçŠ¶æ€ï¼šPublished
```

### 7.2 ç”¨ä¾‹ï¼šä¿®æ”¹å·²å‘å¸ƒé—®å·å¹¶å†æ¬¡å‘å¸ƒ

```go
baseInfo := questionnaire.BaseInfo{}

// ========== 1. ä¿®æ”¹æ ‡é¢˜ ==========
if err := baseInfo.UpdateTitle(qnr, "PHQ-9 æŠ‘éƒç—‡ç­›æŸ¥é‡è¡¨ï¼ˆä¿®è®¢ç‰ˆï¼‰"); err != nil {
    return err
}

// ========== 2. æ·»åŠ æ–°é¢˜ç›® ==========
q10, err := questionnaire.NewQuestion(
    questionnaire.WithCode(questionnaire.NewCode("Q10")),
    questionnaire.WithStem("è¡¥å……é¢˜ï¼šæ‚¨æ˜¯å¦æ¥å—è¿‡å¿ƒç†å’¨è¯¢ï¼Ÿ"),
    questionnaire.WithQuestionType(questionnaire.TypeRadio),
    questionnaire.WithOption("Y", "æ˜¯", 0),
    questionnaire.WithOption("N", "å¦", 0),
)
if err != nil {
    return err
}
if err := questionManager.AddQuestion(qnr, q10); err != nil {
    return err
}

// ========== 3. ä¿å­˜è‰ç¨¿ï¼ˆå°ç‰ˆæœ¬é€’å¢ï¼‰ ==========
if err := versioning.IncrementMinorVersion(qnr); err != nil {
    return err
}
// ç‰ˆæœ¬ï¼š1.0.2

// ========== 4. å†æ¬¡å‘å¸ƒï¼ˆå¤§ç‰ˆæœ¬é€’å¢ï¼‰ ==========
if err := lifecycle.Publish(ctx, qnr); err != nil {
    return err
}
// ç‰ˆæœ¬ï¼š2.0.1ï¼ŒçŠ¶æ€ï¼šPublished
```

### 7.3 æ•°æ®æµè½¬å›¾

```mermaid
sequenceDiagram
    autonumber
    participant App as åº”ç”¨æœåŠ¡
    participant LC as Lifecycle
    participant QM as QuestionManager
    participant VG as Versioning
    participant VD as Validator
    participant Q as Questionnaire

    App->>Q: NewQuestionnaire(code, title, creator)
    Q-->>App: èšåˆæ ¹å®ä¾‹
    
    App->>VG: InitializeVersion(q)
    VG->>Q: updateVersion("0.0.1")
    
    App->>QM: AddQuestion(q, q1)
    QM->>Q: addQuestion(q1)
    
    App->>QM: AddQuestion(q, q2)
    QM->>Q: addQuestion(q2)
    
    App->>VG: IncrementMinorVersion(q)
    VG->>Q: updateVersion("0.0.2")
    
    App->>LC: Publish(ctx, q)
    LC->>VD: ValidateForPublish(q)
    VD-->>LC: []ValidationError (ç©º)
    LC->>VG: IncrementMajorVersion(q)
    VG->>Q: updateVersion("1.0.1")
    LC->>Q: changeStatus(Published)
    LC-->>App: OK
```

---

## 8. è®¾è®¡æ¨¡å¼æ€»ç»“

### 8.1 æ¨¡å¼åº”ç”¨å…¨æ™¯

```mermaid
mindmap
  root((è®¾è®¡æ¨¡å¼))
    åˆ›å»ºå‹
      å·¥å‚æ¨¡å¼
        QuestionFactory
        å„é¢˜å‹å·¥å‚å‡½æ•°
      æ„å»ºå™¨æ¨¡å¼
        QuestionParams
        å‚æ•°å®¹å™¨æ”¶é›†é…ç½®
    ç»“æ„å‹
      ç»„åˆæ¨¡å¼
        Questionnaire åŒ…å« Questions
        æ ‘çŠ¶ç»“æ„
      é—¨é¢æ¨¡å¼
        é¢†åŸŸæœåŠ¡å°è£…å¤æ‚æ“ä½œ
        ç®€åŒ–å¤–éƒ¨è°ƒç”¨
    è¡Œä¸ºå‹
      ç­–ç•¥æ¨¡å¼
        ä¸åŒé¢˜å‹ä¸åŒè¡Œä¸º
        Question æ¥å£
      çŠ¶æ€æ¨¡å¼
        Draft/Published/Archived
        çŠ¶æ€è½¬æ¢è§„åˆ™
      æ¨¡æ¿æ–¹æ³•
        Validator æ ¡éªŒæµç¨‹
        å›ºå®šæ­¥éª¤å¯æ‰©å±•å†…å®¹
```

### 8.2 æ¨¡å¼è¯¦è§£è¡¨

| æ¨¡å¼ | åº”ç”¨ä½ç½® | é—®é¢˜ | è§£å†³æ–¹æ¡ˆ | æ”¶ç›Š |
|------|---------|------|---------|------|
| **æ³¨å†Œå™¨æ¨¡å¼** | `questionRegistry` | é¢˜å‹ä¸åˆ›å»ºé€»è¾‘ç¡¬ç¼–ç  | è¿è¡Œæ—¶åŠ¨æ€æ³¨å†Œæ˜ å°„ | âœ… æ‰©å±•æ—¶ä¸æ”¹æ ¸å¿ƒä»£ç  |
| **å·¥å‚æ¨¡å¼** | å„é¢˜å‹ Factory | åˆ›å»ºé€»è¾‘åˆ†æ•£ | é›†ä¸­åœ¨å·¥å‚å‡½æ•° | âœ… åˆ›å»ºé€»è¾‘å¯æµ‹è¯•ã€å¯å¤ç”¨ |
| **å‡½æ•°å¼é€‰é¡¹** | `WithXXX()` | æ„é€ å‚æ•°è¿‡å¤š | é€‰é¡¹å‡½æ•°é“¾å¼è°ƒç”¨ | âœ… å¯è¯»æ€§å¼ºã€å¯ç»„åˆ |
| **å‚æ•°å®¹å™¨** | `QuestionParams` | å‚æ•°ä¼ é€’æ··ä¹± | ç»Ÿä¸€æ”¶é›†ä¸æ ¡éªŒ | âœ… å‚æ•°ç®¡ç†è§„èŒƒåŒ– |
| **é¢†åŸŸæœåŠ¡** | Lifecycle ç­‰ | èšåˆæ ¹è‡ƒè‚¿ | æ‹†åˆ†åˆ°ä¸“é—¨æœåŠ¡ | âœ… å•ä¸€èŒè´£ã€æ˜“ç»´æŠ¤ |
| **å€¼å¯¹è±¡** | Version/Option | åŸå§‹ç±»å‹è¯­ä¹‰å¼± | å°è£…è¡Œä¸ºä¸æ ¡éªŒ | âœ… ç±»å‹å®‰å…¨ã€è¯­ä¹‰æ˜ç¡® |
| **çŠ¶æ€æœº** | Status | çŠ¶æ€è½¬æ¢æ··ä¹± | æ˜¾å¼çŠ¶æ€ä¸è½¬æ¢è§„åˆ™ | âœ… æµç¨‹æ¸…æ™°ã€å¯è¿½æº¯ |

### 8.3 SOLID åŸåˆ™ä½“ç°

```mermaid
graph LR
    A[SOLID åŸåˆ™] --> B[å•ä¸€èŒè´£ SRP]
    A --> C[å¼€é—­åŸåˆ™ OCP]
    A --> D[é‡Œæ°æ›¿æ¢ LSP]
    A --> E[æ¥å£éš”ç¦» ISP]
    A --> F[ä¾èµ–å€’ç½® DIP]
    
    B --> B1[èšåˆæ ¹åªç®¡ä¸€è‡´æ€§<br/>é¢†åŸŸæœåŠ¡å„å¸å…¶èŒ]
    C --> C1[æ–°å¢é¢˜å‹ä¸æ”¹æ ¸å¿ƒ<br/>æ³¨å†Œå™¨æ‰©å±•æœºåˆ¶]
    D --> D2[æ‰€æœ‰é¢˜å‹å¯äº’æ¢<br/>ç»Ÿä¸€ Question æ¥å£]
    E --> E1[Question æ¥å£é€‚åº¦åˆ†å±‚<br/>ä¸è¿‡åº¦ç»†åŒ–]
    F --> F1[ä¾èµ–æ¥å£éå®ç°<br/>å·¥å‚è¿”å›æ¥å£ç±»å‹]
    
    style B1 fill:#c8e6c9
    style C1 fill:#c8e6c9
    style D2 fill:#c8e6c9
    style E1 fill:#c8e6c9
    style F1 fill:#c8e6c9
```

### 8.4 è®¾è®¡æ€æƒ³æ€»ç»“

| è®¾è®¡æ€æƒ³ | ä½“ç°æ–¹å¼ | ä»·å€¼ |
|---------|---------|------|
| **å…³æ³¨ç‚¹åˆ†ç¦»** | èšåˆæ ¹ã€é¢†åŸŸæœåŠ¡ã€å€¼å¯¹è±¡å„å¸å…¶èŒ | é™ä½è€¦åˆï¼Œæé«˜å†…èš |
| **å……è¡€æ¨¡å‹** | èšåˆæ ¹åŒ…å«è¡Œä¸ºè€Œéçº¯æ•°æ® | ä¸šåŠ¡é€»è¾‘å†…èšåœ¨é¢†åŸŸå±‚ |
| **ä¸å˜å¼ä¿æŠ¤** | ç§æœ‰ä¿®æ”¹æ–¹æ³•+é¢†åŸŸæœåŠ¡ç¼–æ’ | ç¡®ä¿æ•°æ®ä¸€è‡´æ€§ |
| **å¼€é—­åŸåˆ™** | æ³¨å†Œå™¨+å·¥å‚æ‰©å±•é¢˜å‹ | æ–°å¢åŠŸèƒ½æ— éœ€æ”¹åŠ¨ç°æœ‰ä»£ç  |
| **è¯­ä¹‰åŒ–ç‰ˆæœ¬** | Version å€¼å¯¹è±¡+é€’å¢è§„åˆ™ | æ¼”è¿›æ¸…æ™°ï¼Œè¿½æº¯æ–¹ä¾¿ |

---

## 9. ä»£ç å¯¼èˆª

### 9.1 ç›®å½•ç»“æ„

```text
internal/apiserver/domain/questionnaire/
â”œâ”€â”€ questionnaire.go              # èšåˆæ ¹
â”œâ”€â”€ question.go                   # Question æ¥å£
â”œâ”€â”€ question_types.go             # é¢˜å‹æšä¸¾
â”œâ”€â”€ question_core.go              # é¢˜å‹å…¬å…±å­—æ®µ
â”œâ”€â”€ question_params.go            # å‚æ•°å®¹å™¨
â”œâ”€â”€ question_options.go           # å‡½æ•°å¼é€‰é¡¹
â”œâ”€â”€ question_registry.go          # æ³¨å†Œå™¨
â”‚
â”œâ”€â”€ question_radio.go             # å•é€‰é¢˜å®ç°
â”œâ”€â”€ question_checkbox.go          # å¤šé€‰é¢˜å®ç°
â”œâ”€â”€ question_text.go              # æ–‡æœ¬é¢˜å®ç°
â”œâ”€â”€ question_textarea.go          # å¤šè¡Œæ–‡æœ¬å®ç°
â”œâ”€â”€ question_number.go            # æ•°å­—é¢˜å®ç°
â”‚
â”œâ”€â”€ lifecycle.go                  # ç”Ÿå‘½å‘¨æœŸæœåŠ¡
â”œâ”€â”€ question_manager.go           # é¢˜ç›®ç®¡ç†æœåŠ¡
â”œâ”€â”€ versioning.go                 # ç‰ˆæœ¬ç®¡ç†æœåŠ¡
â”œâ”€â”€ validator.go                  # æ ¡éªŒæœåŠ¡
â”œâ”€â”€ baseinfo.go                   # åŸºæœ¬ä¿¡æ¯æœåŠ¡
â”‚
â”œâ”€â”€ version.go                    # ç‰ˆæœ¬å€¼å¯¹è±¡
â”œâ”€â”€ option.go                     # é€‰é¡¹å€¼å¯¹è±¡
â”œâ”€â”€ status.go                     # çŠ¶æ€æšä¸¾
â”œâ”€â”€ code.go                       # ç¼–ç å€¼å¯¹è±¡
â””â”€â”€ errors.go                     # é”™è¯¯å®šä¹‰
```

### 9.2 æ ¸å¿ƒä»£ç é“¾æ¥

#### èšåˆæ ¹ä¸æ¥å£

- [questionnaire.go](../../internal/apiserver/domain/questionnaire/questionnaire.go) - é—®å·èšåˆæ ¹
- [question.go](../../internal/apiserver/domain/questionnaire/question.go) - Question æ¥å£å®šä¹‰
- [question_types.go](../../internal/apiserver/domain/questionnaire/question_types.go) - é¢˜å‹æšä¸¾

#### é¢˜å‹æ‰©å±•æœºåˆ¶

- [question_registry.go](../../internal/apiserver/domain/questionnaire/question_registry.go) - æ³¨å†Œå™¨
- [question_params.go](../../internal/apiserver/domain/questionnaire/question_params.go) - å‚æ•°å®¹å™¨
- [question_options.go](../../internal/apiserver/domain/questionnaire/question_options.go) - å‡½æ•°å¼é€‰é¡¹

#### å…·ä½“é¢˜å‹å®ç°

- [question_radio.go](../../internal/apiserver/domain/questionnaire/question_radio.go) - å•é€‰é¢˜
- [question_checkbox.go](../../internal/apiserver/domain/questionnaire/question_checkbox.go) - å¤šé€‰é¢˜
- [question_text.go](../../internal/apiserver/domain/questionnaire/question_text.go) - æ–‡æœ¬é¢˜
- [question_textarea.go](../../internal/apiserver/domain/questionnaire/question_textarea.go) - å¤šè¡Œæ–‡æœ¬
- [question_number.go](../../internal/apiserver/domain/questionnaire/question_number.go) - æ•°å­—é¢˜

#### é¢†åŸŸæœåŠ¡

- [lifecycle.go](../../internal/apiserver/domain/questionnaire/lifecycle.go) - ç”Ÿå‘½å‘¨æœŸç®¡ç†
- [question_manager.go](../../internal/apiserver/domain/questionnaire/question_manager.go) - é¢˜ç›®ç®¡ç†
- [versioning.go](../../internal/apiserver/domain/questionnaire/versioning.go) - ç‰ˆæœ¬ç®¡ç†
- [validator.go](../../internal/apiserver/domain/questionnaire/validator.go) - ä¸šåŠ¡æ ¡éªŒ
- [baseinfo.go](../../internal/apiserver/domain/questionnaire/baseinfo.go) - åŸºæœ¬ä¿¡æ¯ç®¡ç†

#### å€¼å¯¹è±¡

- [version.go](../../internal/apiserver/domain/questionnaire/version.go) - ç‰ˆæœ¬å·
- [option.go](../../internal/apiserver/domain/questionnaire/option.go) - é€‰é¡¹
- [code.go](../../internal/apiserver/domain/questionnaire/code.go) - ç¼–ç 
- [status.go](../../internal/apiserver/domain/questionnaire/status.go) - çŠ¶æ€

### 9.3 ç›¸å…³æ–‡æ¡£

- [11-04-01 Survey å­åŸŸæ¶æ„æ€»è§ˆ](./11-04-01-Surveyå­åŸŸæ¶æ„æ€»è§ˆ.md) - ä¸Šå±‚æ¶æ„
- [11-04-03 AnswerSheet èšåˆè®¾è®¡](./11-04-03-AnswerSheetèšåˆè®¾è®¡.md) - ç­”å·æ¨¡å‹
- [11-04-04 Validation å­åŸŸè®¾è®¡](./11-04-04-Validationå­åŸŸè®¾è®¡.md) - æ ¡éªŒå­åŸŸ
- [11-04-05 åº”ç”¨æœåŠ¡å±‚è®¾è®¡](./11-04-05-åº”ç”¨æœåŠ¡å±‚è®¾è®¡.md) - åº”ç”¨å±‚
- [11-04-07 æ‰©å±•æŒ‡å—](./11-04-07-æ‰©å±•æŒ‡å—.md) - æ‰©å±•å¼€å‘

---

## é™„å½•ï¼šå¿«é€Ÿå‚è€ƒ

### A. åˆ›å»ºé—®å·æµç¨‹

```go
// 1. åˆå§‹åŒ–æœåŠ¡
versioning := questionnaire.Versioning{}
lifecycle := questionnaire.NewLifecycle()
questionManager := questionnaire.QuestionManager{}

// 2. åˆ›å»ºèšåˆæ ¹
qnr := questionnaire.NewQuestionnaire(code, title, creator)
versioning.InitializeVersion(qnr)

// 3. æ·»åŠ é¢˜ç›®
q := questionnaire.NewQuestion(WithCode(...), WithStem(...), ...)
questionManager.AddQuestion(qnr, q)

// 4. å‘å¸ƒ
lifecycle.Publish(ctx, qnr)
```

### B. æ–°å¢é¢˜å‹æ£€æŸ¥æ¸…å•

- [ ] åœ¨ `question_types.go` ä¸­æ·»åŠ æšä¸¾å€¼
- [ ] åˆ›å»º `question_xxx.go` æ–‡ä»¶
- [ ] å®ç° `Question` æ¥å£
- [ ] ç¼–å†™å·¥å‚å‡½æ•° `newXXXQuestionFactory`
- [ ] åœ¨ `init()` ä¸­æ³¨å†Œå·¥å‚
- [ ] ç¼–å†™å•å…ƒæµ‹è¯•
- [ ] æ›´æ–°æ–‡æ¡£

### C. å¸¸è§é—®é¢˜

**Q: ä¸ºä»€ä¹ˆä¸ç”¨å°æ¥å£ç»„åˆï¼Ÿ**
A: å½“å‰è§„æ¨¡ä¸‹ç»Ÿä¸€æ¥å£ä½¿ç”¨æ›´ç®€å•ï¼Œé¿å…æ¥å£çˆ†ç‚¸ã€‚å¦‚æœæ¥å£è†¨èƒ€å¯è€ƒè™‘æ‹†åˆ†ã€‚

**Q: ä¸ºä»€ä¹ˆèšåˆæ ¹æ–¹æ³•æ˜¯ç§æœ‰çš„ï¼Ÿ**
A: å¼ºåˆ¶é€šè¿‡é¢†åŸŸæœåŠ¡è°ƒç”¨ï¼Œç¡®ä¿ä¸šåŠ¡è§„åˆ™æ‰§è¡Œï¼Œä¿è¯ä¸€è‡´æ€§ã€‚

**Q: å¦‚ä½•å¤„ç†é¢˜å‹ç‰¹æœ‰å­—æ®µï¼Ÿ**
A: åœ¨å„é¢˜å‹ struct ä¸­æ·»åŠ ç§æœ‰å­—æ®µï¼Œé€šè¿‡ä¸“é—¨æ–¹æ³•æš´éœ²ã€‚

**Q: ç‰ˆæœ¬å·èƒ½å›é€€å—ï¼Ÿ**
A: ä¸èƒ½ï¼Œç‰ˆæœ¬å·åªèƒ½é€’å¢ï¼Œä½“ç°æ¼”è¿›çš„å•å‘æ€§ã€‚

---

**æ–‡æ¡£å˜æ›´å†å²**ï¼š

- V4.0 (2025-11-26) - é‡‘å­—å¡”ç»“æ„é‡æ„ï¼Œå¢å¼ºå¯è§†åŒ–å’Œä»£ç é“¾æ¥
- V3.0 (2025-11-26) - è®¾è®¡é˜è¿°ç‰ˆ
- V2.0 (2025-11-25) - å®ç°ç»†èŠ‚ç‰ˆ
- V1.0 (2025-11-20) - åˆå§‹ç‰ˆæœ¬
