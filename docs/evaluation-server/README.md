# Evaluation Server 项目文档

## 项目概述

Evaluation Server 是问卷量表系统的核心计算服务，负责处理答卷分数计算和解读报告生成。该服务采用微服务架构，通过消息驱动的方式处理计算任务。

## 架构设计

### 整体架构

```mermaid
┌─────────────────┐    ┌──────────────────┐    ┌─────────────────┐
│   API Server    │    │ Evaluation Server│    │  Domain Layer   │
│                 │    │                  │    │                 │
│ - 接收答卷数据   │───▶│ - 消息处理       │───▶│ - 计算引擎       │
│ - 触发计算任务   │    │ - 计算服务       │    │ - 策略模式       │
│ - 返回结果      │◀───│ - 结果处理       │◀───│ - 规则引擎       │
└─────────────────┘    └──────────────────┘    └─────────────────┘
```

### 核心模块

1. **计算模块 (Calculation)** - 纯计算逻辑，支持串行和并发执行
2. **消息处理模块 (Message)** - 处理答卷保存事件，协调计算流程
3. **应用服务层 (Application)** - 业务逻辑编排和数据处理

## 技术栈

- **语言**: Go 1.21+
- **架构模式**: 六边形架构 (Hexagonal Architecture)
- **设计模式**: 适配器模式、策略模式、工厂模式
- **并发处理**: Goroutine + Channel
- **消息通信**: 内部 PubSub 系统

## 目录结构

```mermaid
evaluation-server/
├── application/           # 应用服务层
│   ├── calculation/      # 计算应用服务
│   │   ├── ports.go      # 计算端口接口
│   │   ├── shared.go     # 共享数据结构
│   │   └── adapter_factory.go # 适配器工厂
│   └── message/          # 消息处理
│       ├── handler.go    # 消息处理器
│       └── answersheet-saved/ # 答卷保存事件处理
├── domain/               # 领域层
│   └── calculation/      # 计算领域逻辑
├── infrastructure/       # 基础设施层
│   └── grpc/            # gRPC 客户端
└── config/              # 配置管理
```

## 核心特性

### 1. 纯计算抽象

- 计算模块不依赖业务概念，只处理算法、操作数、结果
- 支持多种计算策略：选项计算、求和、平均值、加权等
- 可扩展的计算规则系统

### 2. 灵活的执行策略

- **串行执行**: 稳定可靠，适合小批量计算
- **并发执行**: 高性能，支持可配置的并发数
- **运行时切换**: 支持动态切换执行策略

### 3. 消息驱动架构

- 基于事件的异步处理
- 处理器链模式，支持多个处理器顺序执行
- 错误处理和重试机制

### 4. 适配器模式

- 统一的计算端口接口
- 不同的适配器实现不同的执行策略
- 工厂模式简化适配器创建

## 设计原则

### 1. 分离关注点 (Separation of Concerns)

- 计算逻辑与业务逻辑分离
- 消息处理与计算执行分离
- 数据转换与核心算法分离

### 2. 单一职责 (Single Responsibility)

- 每个模块只负责一个核心功能
- 适配器只关注执行策略
- 转换器只处理数据格式转换

### 3. 开闭原则 (Open/Closed Principle)

- 计算策略可扩展而不修改现有代码
- 新的执行策略通过适配器实现
- 消息处理器可插拔

### 4. 依赖倒置 (Dependency Inversion)

- 高层模块不依赖低层模块
- 依赖抽象而非具体实现
- 通过接口进行解耦

## 性能特性

### 并发处理

- 支持可配置的并发数 (默认 10)
- 工作池模式避免资源浪费
- 结果收集和错误处理

### 内存管理

- 流式处理大量数据
- 及时释放不需要的资源
- 避免内存泄漏

### 错误处理

- 优雅的错误恢复
- 详细的错误日志
- 部分失败不影响整体流程

## 扩展性

### 计算策略扩展

- 新增计算策略只需实现策略接口
- 无需修改现有计算引擎
- 支持运行时策略注册

### 执行策略扩展

- 新增执行策略只需实现适配器接口
- 工厂模式支持动态创建
- 配置驱动的策略选择

### 消息处理扩展

- 新增处理器只需实现 Handler 接口
- 处理器链支持动态添加
- 支持条件性处理器执行

## 监控和日志

### 日志记录

- 结构化日志输出
- 不同级别的日志分类
- 计算耗时统计

### 性能监控

- 计算任务执行时间
- 并发数监控
- 错误率统计

### 健康检查

- 服务状态检查
- 依赖服务连通性
- 资源使用情况

## 总结

Evaluation Server 通过清晰的分层架构和设计模式，实现了高性能、可扩展的计算服务。其核心优势在于：

1. **模块化设计**: 各模块职责清晰，易于维护和扩展
2. **高性能**: 支持并发处理，可处理大量计算任务
3. **可扩展性**: 支持新的计算策略和执行方式
4. **可靠性**: 完善的错误处理和监控机制
5. **可维护性**: 代码结构清晰，遵循设计原则

该服务为问卷量表系统提供了强大的计算能力，支持复杂的业务场景和未来的功能扩展。
