# 用户角色体系设计

## 概述

本系统采用**用户-角色分离**的设计模式，`User` 代表系统中的每个用户实体，而角色（Role）则代表用户在不同业务场景下的具体身份和权限。

## 角色类型

### 1. Testee (受试者/考生)

**定义**: 参与心理测评、能力测试的用户角色

**核心属性**:
- `UserID`: 关联的用户ID
- `Name`: 姓名
- `Sex`: 性别 (0-未知, 1-男, 2-女)
- `Birthday`: 真实生日

**核心方法**:
- `GetAge()`: 根据生日计算当前年龄
- `WithSex()`, `WithBirthday()`: 建造者模式设置属性

**使用场景**:
- 参与问卷测评
- 提交答卷
- 查看个人测评报告

**文件位置**: `internal/apiserver/domain/user/role/testee.go`

---

### 2. Writer (填写人)

**定义**: 代他人填写问卷的用户角色

**核心属性**:
- `UserID`: 关联的用户ID
- `Name`: 姓名

**核心方法**:
- `GetUserID()`: 获取用户ID
- `GetName()`: 获取姓名

**使用场景**:
- 代理填写问卷（如家长为孩子填写）
- 批量数据录入
- 协助他人完成测评

**文件位置**: `internal/apiserver/domain/user/role/writer.go`

---

### 3. Auditor (审核员/员工) ⭐ 新增

**定义**: 负责审核、管理问卷和答卷的员工角色

**核心属性**:
- `UserID`: 关联的用户ID
- `Name`: 姓名
- `EmployeeID`: 员工编号
- `Department`: 所属部门
- `Position`: 职位
- `Status`: 员工状态
- `HiredAt`: 入职时间

**员工状态枚举**:
```go
const (
    StatusOnDuty     Status = 1 // 在职
    StatusOnLeave    Status = 2 // 休假
    StatusSuspended  Status = 3 // 停职
    StatusResigned   Status = 4 // 离职
)
```

**核心方法**:
- `IsActive()`: 判断是否在职且可工作
- `CanAudit()`: 判断是否可以审核 (在职或休假状态)
- `WithDepartment()`, `WithPosition()`, `WithStatus()`, `WithHiredAt()`: 建造者模式

**使用场景**:
- 审核问卷内容
- 管理用户答卷
- 生成和审核解释报告
- 数据统计和分析

**文件位置**: `internal/apiserver/domain/user/role/auditor.go`

---

## 设计模式

### 值对象（Value Object）模式

所有角色都采用**值对象**设计，具有以下特点：

1. **不可变性**: 通过建造者模式创建和修改
2. **业务语义**: 每个角色都有明确的业务含义
3. **关联用户**: 通过 `UserID` 关联到 `User` 聚合根

### 建造者模式（Builder Pattern）

所有角色都支持链式调用：

```go
auditor := NewAuditor(userID, "张三", "EMP001").
    WithDepartment("人力资源部").
    WithPosition("高级审核员").
    WithStatus(StatusOnDuty).
    WithHiredAt(time.Date(2023, 1, 1, 0, 0, 0, 0, time.UTC))
```

---

## 角色对比

| 特性 | Testee | Writer | Auditor |
|------|--------|--------|---------|
| **主要职责** | 参与测评 | 代理填写 | 审核管理 |
| **核心属性** | 生日、性别 | 姓名 | 员工编号、部门、职位 |
| **状态管理** | ❌ 无 | ❌ 无 | ✅ 有（在职/休假/停职/离职） |
| **权限控制** | ❌ 无 | ❌ 无 | ✅ 有（CanAudit判断） |
| **年龄计算** | ✅ GetAge() | ❌ 无 | ❌ 无 |
| **入职管理** | ❌ 无 | ❌ 无 | ✅ HiredAt |

---

## 使用示例

### 创建 Auditor

```go
package example

import (
    "time"
    "github.com/fangcun-mount/qs-server/internal/apiserver/domain/user"
    "github.com/fangcun-mount/qs-server/internal/apiserver/domain/user/role"
)

func CreateAuditorExample() {
    // 1. 基础创建
    userID := user.NewUserID(1001)
    auditor := role.NewAuditor(userID, "张三", "EMP001")
    
    // 2. 完整创建
    auditor = role.NewAuditor(userID, "张三", "EMP001").
        WithDepartment("人力资源部").
        WithPosition("高级审核员").
        WithHiredAt(time.Date(2023, 1, 1, 0, 0, 0, 0, time.UTC))
    
    // 3. 检查权限
    if auditor.CanAudit() {
        // 执行审核操作
    }
    
    // 4. 修改状态
    auditor.WithStatus(role.StatusOnLeave) // 设置为休假
}
```

### 权限判断

```go
func AuditQuestionnaire(auditor *role.Auditor) error {
    // 检查是否可以审核
    if !auditor.CanAudit() {
        return errors.New("当前状态不允许审核")
    }
    
    // 执行审核逻辑
    // ...
    
    return nil
}
```

---

## 数据库设计建议

### 用户表 (users)
```sql
CREATE TABLE users (
    id BIGINT UNSIGNED PRIMARY KEY AUTO_INCREMENT,
    username VARCHAR(50) UNIQUE NOT NULL,
    password VARCHAR(255) NOT NULL,
    nickname VARCHAR(100),
    avatar VARCHAR(500),
    email VARCHAR(100),
    phone VARCHAR(20),
    introduction TEXT,
    status TINYINT UNSIGNED DEFAULT 0,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP
);
```

### 审核员表 (auditors)
```sql
CREATE TABLE auditors (
    id BIGINT UNSIGNED PRIMARY KEY AUTO_INCREMENT,
    user_id BIGINT UNSIGNED NOT NULL,
    name VARCHAR(100) NOT NULL,
    employee_id VARCHAR(50) UNIQUE NOT NULL,
    department VARCHAR(100),
    position VARCHAR(100),
    status TINYINT UNSIGNED DEFAULT 1 COMMENT '1-在职, 2-休假, 3-停职, 4-离职',
    hired_at TIMESTAMP NOT NULL,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    FOREIGN KEY (user_id) REFERENCES users(id)
);

CREATE INDEX idx_auditors_user_id ON auditors(user_id);
CREATE INDEX idx_auditors_employee_id ON auditors(employee_id);
CREATE INDEX idx_auditors_status ON auditors(status);
```

### 受试者表 (testees)
```sql
CREATE TABLE testees (
    id BIGINT UNSIGNED PRIMARY KEY AUTO_INCREMENT,
    user_id BIGINT UNSIGNED NOT NULL,
    name VARCHAR(100) NOT NULL,
    sex TINYINT UNSIGNED DEFAULT 0 COMMENT '0-未知, 1-男, 2-女',
    birthday DATE,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    FOREIGN KEY (user_id) REFERENCES users(id)
);

CREATE INDEX idx_testees_user_id ON testees(user_id);
```

### 填写人表 (writers)
```sql
CREATE TABLE writers (
    id BIGINT UNSIGNED PRIMARY KEY AUTO_INCREMENT,
    user_id BIGINT UNSIGNED NOT NULL,
    name VARCHAR(100) NOT NULL,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    FOREIGN KEY (user_id) REFERENCES users(id)
);

CREATE INDEX idx_writers_user_id ON writers(user_id);
```

---

## 扩展性

### 添加新角色

如需添加新角色（如 `Administrator`、`Analyst` 等），遵循以下步骤：

1. 在 `internal/apiserver/domain/user/role/` 创建新文件
2. 定义角色结构体，包含 `UserID` 和角色特定属性
3. 实现构造函数 `NewXXX()`
4. 实现 Getter 方法和 Builder 方法
5. 添加角色特定的业务方法
6. 编写对应的测试文件

### 示例：添加 Analyst (分析师)

```go
package role

type Analyst struct {
    UserID         user.UserID
    Name           string
    Specialization string // 专业方向
    Level          uint8  // 分析师级别
}

func NewAnalyst(userID user.UserID, name string) *Analyst {
    return &Analyst{
        UserID: userID,
        Name:   name,
        Level:  1,
    }
}

// ... 其他方法
```

---

## 总结

✅ **已实现的角色**:
- Testee (受试者)
- Writer (填写人)
- **Auditor (审核员/员工)** ⭐ 新增

✅ **设计特点**:
- 值对象模式
- 建造者模式
- 清晰的职责分离
- 完善的测试覆盖

✅ **测试覆盖**:
- 所有测试通过 (8个测试用例)
- 覆盖状态管理、权限判断、链式调用等场景
