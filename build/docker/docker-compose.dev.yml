version: '3.8'

services:
  # ===================================
  # QS API Server
  # ===================================
  qs-apiserver:
    build:
      context: ../../
      dockerfile: build/docker/Dockerfile.qs-apiserver
      args:
        VERSION: ${VERSION:-dev}
        BUILD_TIME: ${BUILD_TIME}
        GIT_COMMIT: ${GIT_COMMIT}
        GIT_BRANCH: ${GIT_BRANCH:-main}
    image: qs-apiserver:${VERSION:-latest}
    container_name: qs-apiserver
    restart: unless-stopped
    command: ["/app/qs-apiserver", "--config=/app/configs/apiserver.prod.yaml"]
    ports:
      - "8081:8080"   # 宿主机端口后移一位，避开已有 IAM 8080
      - "8444:8443"
    volumes:
      - ../../configs/apiserver.prod.yaml:/app/configs/apiserver.prod.yaml:ro
      - ../../configs/cert:/app/configs/cert:ro
      - apiserver-logs:/app/logs
    environment:
      - TZ=Asia/Shanghai
      - ENV=${ENV:-prod}
    networks:
      - qs-network
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:8080/health"]
      interval: 30s
      timeout: 5s
      retries: 3
      start_period: 10s
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

  # ===================================
  # Collection Server
  # ===================================
  collection-server:
    build:
      context: ../../
      dockerfile: build/docker/Dockerfile.collection-server
      args:
        VERSION: ${VERSION:-dev}
        BUILD_TIME: ${BUILD_TIME}
        GIT_COMMIT: ${GIT_COMMIT}
        GIT_BRANCH: ${GIT_BRANCH:-main}
    image: collection-server:${VERSION:-latest}
    container_name: collection-server
    restart: unless-stopped
    command: ["/app/collection-server", "--config=/app/configs/collection-server.prod.yaml"]
    ports:
      - "8082:8080"   # 宿主机端口后移一位，避开已有 IAM 8080/8081
      - "8445:8443"
    volumes:
      - ../../configs/collection-server.prod.yaml:/app/configs/collection-server.prod.yaml:ro
      - ../../configs/cert:/app/configs/cert:ro
      - collection-logs:/app/logs
    environment:
      - TZ=Asia/Shanghai
      - ENV=${ENV:-prod}
    networks:
      - qs-network
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:8080/health"]
      interval: 30s
      timeout: 5s
      retries: 3
      start_period: 10s
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

  # ===================================
  # QS Worker
  # ===================================
  qs-worker:
    build:
      context: ../../
      dockerfile: build/docker/Dockerfile.qs-worker
      args:
        VERSION: ${VERSION:-dev}
        BUILD_TIME: ${BUILD_TIME}
        GIT_COMMIT: ${GIT_COMMIT}
        GIT_BRANCH: ${GIT_BRANCH:-main}
    image: qs-worker:${VERSION:-latest}
    container_name: qs-worker
    restart: unless-stopped
    command: ["/app/qs-worker", "--config=/app/configs/worker.prod.yaml"]
    volumes:
      - ../../configs/worker.prod.yaml:/app/configs/worker.prod.yaml:ro
      - worker-logs:/app/logs
    environment:
      - TZ=Asia/Shanghai
      - ENV=${ENV:-prod}
      # 消息队列配置
      - MESSAGING_PROVIDER=${MESSAGING_PROVIDER:-nsq}
      - NSQ_ADDR=${NSQ_ADDR:-nsq:4150}
      - NSQ_LOOKUPD_ADDR=${NSQ_LOOKUPD_ADDR:-nsqlookupd:4161}
      - RABBITMQ_URL=${RABBITMQ_URL:-}
      # gRPC 客户端配置
      - GRPC_APISERVER_ADDR=${GRPC_APISERVER_ADDR:-qs-apiserver:9090}
      # 数据库配置
      - MYSQL_HOST=${MYSQL_HOST:-mysql}
      - MYSQL_USER=${MYSQL_USER:-app_user}
      - MYSQL_PASSWORD=${MYSQL_PASSWORD}
      - MYSQL_DATABASE=${MYSQL_DATABASE:-questionnaire_scale}
      - MONGODB_URL=${MONGODB_URL:-mongodb://mongo:27017/questionnaire_scale}
    networks:
      - qs-network
    depends_on:
      - qs-apiserver
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

# ===================================
# 网络配置
# ===================================
networks:
  qs-network:
    driver: bridge
    name: qs-network

# ===================================
# 数据卷配置
# ===================================
volumes:
  apiserver-logs:
    name: qs-apiserver-logs
  collection-logs:
    name: qs-collection-logs
  worker-logs:
    name: qs-worker-logs
