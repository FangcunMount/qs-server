services:
  qs-apiserver:
    image: ghcr.io/fangcunmount/qs-apiserver:latest
    container_name: qs-apiserver
    restart: unless-stopped
    networks:
      - qs-network
      - infra-network
    ports:
      - "8081:8080"
      - "9445:8443"
    env_file:
      - /opt/qs-server/qs-apiserver/configs/env/config.prod.env
    volumes:
      - /opt/qs-server/qs-apiserver/configs:/app/configs
      - /data/logs/qs-server/qs-apiserver:/data/logs/qs
      # Web 证书（HTTPS REST API）
      - /data/ssl/certs/yangshujie.com.crt:/etc/qs-server/ssl/yangshujie.com.crt:ro
      - /data/ssl/private/yangshujie.com.key:/etc/qs-server/ssl/yangshujie.com.key:ro
      # gRPC mTLS 证书挂载（宿主机 /data/infra/ssl/grpc → 容器 /etc/qs-server/ssl）
      - /data/infra/ssl/grpc:/etc/qs-server/ssl:ro
    command: ["--config=/app/configs/apiserver.prod.yaml"]
    deploy:
      resources:
        limits:
          cpus: "0.25"
          memory: 384M

  qs-collection-server:
    image: ghcr.io/fangcunmount/qs-collection-server:latest
    container_name: qs-collection-server
    restart: unless-stopped
    networks:
      - qs-network
      - infra-network
    ports:
      - "8082:8080"
      - "9446:8443"
    env_file:
      - /opt/qs-server/qs-collection-server/configs/env/config.prod.env
    volumes:
      - /opt/qs-server/qs-collection-server/configs:/app/configs
      - /data/logs/qs-server/qs-collection-server:/data/logs/qs
      # Web 证书（HTTPS REST API）
      - /data/ssl/certs/yangshujie.com.crt:/etc/qs-server/ssl/yangshujie.com.crt:ro
      - /data/ssl/private/yangshujie.com.key:/etc/qs-server/ssl/yangshujie.com.key:ro
      # gRPC mTLS 证书挂载（宿主机 /data/infra/ssl/grpc → 容器 /etc/qs-server/ssl）
      - /data/infra/ssl/grpc:/etc/qs-server/ssl:ro
    command: ["--config=/app/configs/collection-server.prod.yaml"]
    deploy:
      resources:
        limits:
          cpus: "0.20"
          memory: 256M

  qs-worker:
    image: ghcr.io/fangcunmount/qs-worker:latest
    container_name: qs-worker
    restart: unless-stopped
    networks:
      - qs-network
      - infra-network
    env_file:
      - /opt/qs-server/qs-worker/configs/env/config.prod.env
    volumes:
      - /opt/qs-server/qs-worker/configs:/app/configs
      - /data/logs/qs-server/qs-worker:/data/logs/qs
    command: ["--config=/app/configs/worker.prod.yaml"]
    deploy:
      resources:
        limits:
          cpus: "0.15"
          memory: 256M

networks:
  qs-network:
    external: true
  infra-network:
    external: true
