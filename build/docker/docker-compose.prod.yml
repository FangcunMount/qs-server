services:
  qs-apiserver:
    image: ghcr.io/fangcunmount/qs-apiserver:latest
    container_name: qs-apiserver
    restart: unless-stopped
    networks:
      - qs-network
      - infra-network
    ports:
      - "8081:8080"
      - "9445:8443"
    env_file:
      - /opt/qs-server/qs-apiserver/configs/env/config.prod.env
    volumes:
      - /opt/qs-server/qs-apiserver/configs:/app/configs
      - /data/logs/qs-server/qs-apiserver:/data/logs/qs
      # 证书与密钥目录统一挂载（避免单文件挂载在只读目录内创建 mountpoint 失败）
      - /data/ssl/certs:/etc/qs-server/ssl/certs:ro
      - /data/ssl/private:/etc/qs-server/ssl/private:ro
      # gRPC mTLS 证书目录
      - /data/infra/ssl/grpc:/etc/qs-server/ssl/grpc:ro
    command: ["--config=/app/configs/apiserver.prod.yaml"]
    deploy:
      resources:
        limits:
          cpus: "0.5"
          memory: 512M

  qs-collection-server:
    image: ghcr.io/fangcunmount/qs-collection-server:latest
    container_name: qs-collection-server
    restart: unless-stopped
    networks:
      - qs-network
      - infra-network
    ports:
      - "8082:8080"
      - "9446:8443"
    env_file:
      - /opt/qs-server/qs-collection-server/configs/env/config.prod.env
    volumes:
      - /opt/qs-server/qs-collection-server/configs:/app/configs
      - /data/logs/qs-server/qs-collection-server:/data/logs/qs
      # 证书与密钥目录统一挂载
      - /data/ssl/certs:/etc/qs-server/ssl/certs:ro
      - /data/ssl/private:/etc/qs-server/ssl/private:ro
      # gRPC mTLS 证书目录
      - /data/infra/ssl/grpc:/etc/qs-server/ssl/grpc:ro
    command: ["--config=/app/configs/collection-server.prod.yaml"]
    deploy:
      resources:
        limits:
          cpus: "0.5"
          memory: 512M

  qs-worker:
    image: ghcr.io/fangcunmount/qs-worker:latest
    container_name: qs-worker
    restart: unless-stopped
    networks:
      - qs-network
      - infra-network
    env_file:
      - /opt/qs-server/qs-worker/configs/env/config.prod.env
    volumes:
      - /opt/qs-server/qs-worker/configs:/app/configs
      - /data/logs/qs-server/qs-worker:/data/logs/qs
    command: ["--config=/app/configs/worker.prod.yaml"]
    deploy:
      resources:
        limits:
          cpus: "0.3"
          memory: 384M

networks:
  qs-network:
    external: true
  infra-network:
    external: true
