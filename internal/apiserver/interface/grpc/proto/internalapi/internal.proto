syntax = "proto3";

package internalapi;

option go_package = "github.com/FangcunMount/qs-server/internal/apiserver/interface/grpc/proto/internalapi";

// 内部服务 - 供 Worker 调用
// 用于事件处理后的业务逻辑调用
service InternalService {
  // ==================== AnswerSheet 操作 ====================
  
  // 计算答卷分数
  // 场景：worker 处理 answersheet.submitted 事件后调用
  // 流程：根据问卷评分规则计算每个答案的分数并保存
  rpc CalculateAnswerSheetScore(CalculateAnswerSheetScoreRequest) 
      returns (CalculateAnswerSheetScoreResponse);
  
  // ==================== Assessment 操作 ====================
  
  // 从答卷创建测评
  // 场景：worker 处理 answersheet.submitted 事件后调用（在计分之后）
  // 流程：根据答卷信息创建 Assessment，如果问卷关联了量表则自动提交
  rpc CreateAssessmentFromAnswerSheet(CreateAssessmentFromAnswerSheetRequest) 
      returns (CreateAssessmentFromAnswerSheetResponse);
  
  // 执行测评评估
  // 场景：worker 处理 assessment.submitted 事件后调用
  // 流程：加载测评和量表，执行计分和解读，保存结果
  rpc EvaluateAssessment(EvaluateAssessmentRequest) 
      returns (EvaluateAssessmentResponse);
  
  // ==================== Testee 操作 ====================
  
  // 给受试者打标签
  // 场景：worker 处理 report.generated 事件后调用
  // 流程：根据解读结果（风险等级、量表类型等）自动给受试者打标签
  rpc TagTestee(TagTesteeRequest) 
      returns (TagTesteeResponse);
}

// ==================== CalculateAnswerSheetScore ====================

// 计算答卷分数请求
message CalculateAnswerSheetScoreRequest {
  uint64 answersheet_id = 1;         // 答卷ID
}

// 计算答卷分数响应
message CalculateAnswerSheetScoreResponse {
  bool success = 1;                  // 是否成功
  double total_score = 2;            // 总分
  string message = 3;                // 描述信息
}

// ==================== CreateAssessmentFromAnswerSheet ====================

// 从答卷创建测评请求
message CreateAssessmentFromAnswerSheetRequest {
  uint64 answersheet_id = 1;         // 答卷ID
  string questionnaire_code = 2;     // 问卷编码
  string questionnaire_version = 3;  // 问卷版本
  uint64 testee_id = 4;              // 受试者ID
  uint64 org_id = 5;                 // 组织ID
  uint64 filler_id = 6;              // 填写人ID
  string filler_type = 7;            // 填写人类型：self/proxy
  string origin_type = 8;            // 来源类型：adhoc/plan/screening（可选）
  string origin_id = 9;              // 来源ID（可选）
}

// 从答卷创建测评响应
message CreateAssessmentFromAnswerSheetResponse {
  uint64 assessment_id = 1;          // 创建的测评ID（如果有）
  bool created = 2;                  // 是否创建了测评
  bool auto_submitted = 3;           // 是否自动提交（关联量表时）
  string message = 4;                // 描述信息
}

// ==================== EvaluateAssessment ====================

// 执行测评评估请求
message EvaluateAssessmentRequest {
  uint64 assessment_id = 1;          // 测评ID
}

// 执行测评评估响应
message EvaluateAssessmentResponse {
  bool success = 1;                  // 是否成功
  string status = 2;                 // 处理后的状态：interpreted/failed/skipped
  string message = 3;                // 描述信息
  double total_score = 4;            // 总分（成功时）
  string risk_level = 5;             // 风险等级（成功时）
}

// ==================== TagTestee ====================

// 给受试者打标签请求
message TagTesteeRequest {
  uint64 testee_id = 1;              // 受试者ID
  string risk_level = 2;             // 风险等级：none/low/medium/high/severe
  string scale_code = 3;             // 量表编码（可选）
  bool mark_key_focus = 4;           // 是否标记为重点关注（高风险时）
  repeated string high_risk_factors = 5; // 高风险因子编码列表（可选）
}

// 给受试者打标签响应
message TagTesteeResponse {
  bool success = 1;                  // 是否成功
  repeated string tags_added = 2;    // 已添加的标签列表
  bool key_focus_marked = 3;         // 是否标记为重点关注
  string message = 4;                // 描述信息
}
