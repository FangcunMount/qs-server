# OAuth æ¨¡å—å®ç°æ€»ç»“

## ğŸ“Š å®ç°æ¦‚è§ˆ

### ä»£ç ç»Ÿè®¡
- **æ–‡ä»¶æ•°é‡**: 6 ä¸ª Go æ–‡ä»¶
- **æ€»ä»£ç è¡Œæ•°**: 439 è¡Œï¼ˆåŒ…å«æµ‹è¯•å’Œæ³¨é‡Šï¼‰
- **æ ¸å¿ƒä»£ç **: ~350 è¡Œ
- **æµ‹è¯•ä»£ç **: ~87 è¡Œ
- **æ–‡æ¡£**: 3 ä¸ª Markdown æ–‡æ¡£

### æ–‡ä»¶æ¸…å•
```
internal/collection-server/application/oauth/
â”œâ”€â”€ oauth.go              (92 è¡Œ)  - OAuth æ¥å£å’ŒåŸºç±»
â”œâ”€â”€ wechat_oauth.go      (116 è¡Œ)  - å¾®ä¿¡ OAuth å®ç°
â”œâ”€â”€ user_loader.go        (55 è¡Œ)  - ç”¨æˆ·åŠ è½½å™¨
â”œâ”€â”€ token_generator.go    (28 è¡Œ)  - Token ç”Ÿæˆå™¨
â”œâ”€â”€ factory.go            (61 è¡Œ)  - OAuth å·¥å‚
â””â”€â”€ oauth_test.go         (87 è¡Œ)  - ä½¿ç”¨ç¤ºä¾‹å’Œæµ‹è¯•

docs/collection-server/
â”œâ”€â”€ 04-OAuthæ¨¡å—è®¾è®¡.md           - å®Œæ•´è®¾è®¡æ–‡æ¡£
â”œâ”€â”€ OAuthå¿«é€Ÿå‚è€ƒ.md              - å¿«é€Ÿä½¿ç”¨æŒ‡å—
â””â”€â”€ PHP-Golang-OAuthå¯¹ç…§è¡¨.md     - PHP åˆ° Golang è¿ç§»å¯¹ç…§
```

## âœ… å·²å®ŒæˆåŠŸèƒ½

### æ ¸å¿ƒæ¥å£
- [x] `OAuth` æ¥å£ - å®šä¹‰ç»Ÿä¸€çš„ OAuth è®¤è¯æ¥å£
- [x] `UserInfo` æ¥å£ - å®šä¹‰ç”¨æˆ·ä¿¡æ¯æ ‡å‡†
- [x] `TokenGenerator` æ¥å£ - å®šä¹‰ Token ç”Ÿæˆæ ‡å‡†
- [x] `UserLoader` æ¥å£ - å®šä¹‰ç”¨æˆ·åŠ è½½æ ‡å‡†

### æ ¸å¿ƒå®ç°
- [x] `BaseOAuth` - æ¨¡æ¿æ–¹æ³•æ¨¡å¼çš„åŸºç¡€å®ç°
- [x] `WechatOAuth` - å¾®ä¿¡å°ç¨‹åº OAuth å®ç°
- [x] `GRPCUserLoader` - åŸºäº gRPC çš„ç”¨æˆ·åŠ è½½å™¨
- [x] `JWTTokenGenerator` - JWT Token ç”Ÿæˆå™¨
- [x] `Factory` - OAuth å·¥å‚ï¼ˆå·¥å‚æ¨¡å¼ï¼‰

### åŠŸèƒ½ç‰¹æ€§
- [x] Code æ¢å– Token çš„å®Œæ•´æµç¨‹
- [x] å¾®ä¿¡ code2session é›†æˆ
- [x] ç”¨æˆ·åˆ›å»º/æ›´æ–°ï¼ˆé€šè¿‡ gRPCï¼‰
- [x] JWT Token ç”Ÿæˆ
- [x] ç”¨æˆ·ä¿¡æ¯æ ¡éªŒ
- [x] é”™è¯¯å¤„ç†å’Œæ—¥å¿—è®°å½•
- [x] Context æ”¯æŒï¼ˆè¶…æ—¶æ§åˆ¶ï¼‰

## ğŸ¯ è®¾è®¡æ¨¡å¼åº”ç”¨

### 1. æ¨¡æ¿æ–¹æ³•æ¨¡å¼
**ä½ç½®**: `BaseOAuth.Code2Token()`

```go
func (b *BaseOAuth) Code2Token(...) (string, error) {
    userInfo := queryUserInfo(...)      // å­ç±»å®ç°
    checkUserInfo(...)                  // å­ç±»å®ç°
    userID := b.userLoader.LoadOrCreateUser(...)  // åŸºç±»å®ç°
    token := b.tokenGenerator.GenerateToken(...)  // åŸºç±»å®ç°
    return token
}
```

**ä¼˜åŠ¿**:
- âœ… å®šä¹‰å›ºå®šçš„è®¤è¯æµç¨‹
- âœ… å­ç±»åªéœ€å®ç°ç‰¹å®šæ­¥éª¤
- âœ… æ˜“äºæ‰©å±•æ–°å¹³å°

### 2. å·¥å‚æ¨¡å¼
**ä½ç½®**: `Factory.CreateOAuth()`

```go
func (f *Factory) CreateOAuth(oauthType OAuthType) (OAuth, error) {
    switch oauthType {
    case OAuthTypeWechat:
        return NewWechatOAuth(...)
    case OAuthTypeQWechat:
        return NewQWechatOAuth(...)
    }
}
```

**ä¼˜åŠ¿**:
- âœ… é›†ä¸­ç®¡ç†å¯¹è±¡åˆ›å»º
- âœ… éšè—åˆ›å»ºç»†èŠ‚
- âœ… ä¾èµ–æ³¨å…¥

### 3. ç­–ç•¥æ¨¡å¼
**ä½ç½®**: ä¸åŒçš„ OAuth å®ç°

```go
var oauth OAuth
oauth, _ = factory.CreateOAuth(OAuthTypeWechat)
token, _ := oauth.Code2Token(...)
```

**ä¼˜åŠ¿**:
- âœ… è¿è¡Œæ—¶åˆ‡æ¢å®ç°
- âœ… å¼€é—­åŸåˆ™
- âœ… æ˜“äºæµ‹è¯•

### 4. ä¾èµ–æ³¨å…¥
**ä½ç½®**: æ‰€æœ‰æ„é€ å‡½æ•°

```go
func NewWechatOAuth(
    tokenGenerator TokenGenerator,  // æ¥å£ä¾èµ–
    userLoader UserLoader,           // æ¥å£ä¾èµ–
    miniProgramClient *wechat.MiniProgramClient,
    appID string,
) *WechatOAuth
```

**ä¼˜åŠ¿**:
- âœ… æ¾è€¦åˆ
- âœ… æ˜“äºæµ‹è¯•ï¼ˆMockï¼‰
- âœ… æ˜“äºæ›¿æ¢å®ç°

## ğŸ—ï¸ æ¶æ„è®¾è®¡

### å…­è¾¹å½¢æ¶æ„åˆ†å±‚

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚       Interface Layer (HTTP)            â”‚
â”‚  (routers.go, handler å±‚å¾…å®ç°)          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚       Application Layer                 â”‚
â”‚                                          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚         OAuth Module             â”‚   â”‚
â”‚  â”‚  - OAuth Interface               â”‚   â”‚
â”‚  â”‚  - BaseOAuth                     â”‚   â”‚
â”‚  â”‚  - WechatOAuth                   â”‚   â”‚
â”‚  â”‚  - Factory                       â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚         â–²              â–²                 â”‚
â”‚         â”‚              â”‚                 â”‚
â”‚    â”Œâ”€â”€â”€â”€â”´â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”´â”€â”€â”€â”€â”           â”‚
â”‚    â”‚ Token   â”‚    â”‚  User   â”‚           â”‚
â”‚    â”‚Generatorâ”‚    â”‚ Loader  â”‚           â”‚
â”‚    â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
          â”‚              â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚     Infrastructure Layer                 â”‚
â”‚  - JWTManager                            â”‚
â”‚  - gRPC UserServiceClient                â”‚
â”‚  - MiniProgramClient                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### ä¾èµ–æ–¹å‘
- âœ… å¤–å±‚ä¾èµ–å†…å±‚
- âœ… åº”ç”¨å±‚ä¸ä¾èµ–åŸºç¡€è®¾æ–½å±‚ï¼ˆé€šè¿‡æ¥å£ï¼‰

