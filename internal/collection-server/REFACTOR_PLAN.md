# Collection Server ç›®å½•ç»“æ„é‡æ„è®¡åˆ’

## æ¶æ„ç†è§£

### Collection Server çš„æ ¸å¿ƒèŒè´£
Collection Server æ˜¯ä¸€ä¸ª**è½»é‡çº§çš„æ”¶é›†æœåŠ¡**ï¼Œä¸»è¦è´Ÿè´£ï¼š
1. **æ¥æ”¶é—®å·æäº¤**ï¼šé€šè¿‡ REST API æ¥æ”¶å°ç¨‹åºç­‰å®¢æˆ·ç«¯çš„é—®å·æäº¤
2. **éªŒè¯ç­”å·æ•°æ®**ï¼šå¯¹æäº¤çš„ç­”å·è¿›è¡ŒéªŒè¯
3. **è½¬å‘åˆ° apiserver**ï¼šé€šè¿‡ gRPC å°†éªŒè¯é€šè¿‡çš„ç­”å·ä¿å­˜åˆ° apiserver
4. **å‘å¸ƒæ¶ˆæ¯**ï¼šå‘å¸ƒç­”å·ä¿å­˜äº‹ä»¶åˆ°æ¶ˆæ¯é˜Ÿåˆ—

### æ•°æ®æµå‘
```
å°ç¨‹åº/å®¢æˆ·ç«¯ â†’ Collection Server (REST API) â†’ éªŒè¯ â†’ gRPC â†’ apiserver
                                    â†“
                              æ¶ˆæ¯é˜Ÿåˆ— â†’ evaluation-server
```

## å½“å‰é—®é¢˜åˆ†æ

### 1. éªŒè¯æ¨¡å—è¿‡äºé›†ä¸­
- `application/validation/` ç›®å½•åŒ…å« 8 ä¸ªæ–‡ä»¶
- å¹¶å‘ç‰ˆæœ¬å’Œä¸²è¡Œç‰ˆæœ¬æ··åœ¨ä¸€èµ·
- èŒè´£è¾¹ç•Œä¸æ¸…æ™°

### 2. ç¼ºä¹æ¸…æ™°çš„ä¸šåŠ¡æ¨¡å—
- æ²¡æœ‰æ˜ç¡®çš„é—®å·å’Œç­”å·ä¸šåŠ¡æ¨¡å—
- éªŒè¯é€»è¾‘ä¸ä¸šåŠ¡é€»è¾‘æ··åˆ

### 3. æ¥å£å±‚ç»“æ„ç®€å•
- ç¼ºå°‘ä¸­é—´ä»¶ã€è¯·æ±‚/å“åº”æ¨¡å‹
- é”™è¯¯å¤„ç†ä¸å¤Ÿè§„èŒƒ

## é‡æ„ç›®æ ‡

### 1. æ˜ç¡®ä¸šåŠ¡è¾¹ç•Œ
- é—®å·ç®¡ç†ï¼šè·å–é—®å·ä¿¡æ¯ã€éªŒè¯é—®å·ä»£ç 
- ç­”å·å¤„ç†ï¼šæ¥æ”¶ã€éªŒè¯ã€ä¿å­˜ç­”å·
- éªŒè¯æœåŠ¡ï¼šç‹¬ç«‹çš„éªŒè¯æ¨¡å—

### 2. ä¼˜åŒ–éªŒè¯æ¶æ„
- åˆ†ç¦»å¹¶å‘å’Œä¸²è¡ŒéªŒè¯
- é…ç½®é©±åŠ¨çš„éªŒè¯ç­–ç•¥é€‰æ‹©
- æ¸…æ™°çš„éªŒè¯è§„åˆ™ç®¡ç†

### 3. æ”¹è¿›æ¥å£å±‚
- æ·»åŠ ä¸­é—´ä»¶
- è§„èŒƒåŒ–è¯·æ±‚/å“åº”æ¨¡å‹
- ç»Ÿä¸€çš„é”™è¯¯å¤„ç†

## æ–°çš„ç›®å½•ç»“æ„

```
internal/collection-server/
â”œâ”€â”€ app.go                    # åº”ç”¨å…¥å£
â”œâ”€â”€ run.go                    # è¿è¡Œé€»è¾‘
â”œâ”€â”€ server.go                 # æœåŠ¡å™¨é…ç½®
â”œâ”€â”€ routers.go                # è·¯ç”±é…ç½®
â”œâ”€â”€ config/                   # é…ç½®ç®¡ç†
â”‚   â””â”€â”€ config.go
â”œâ”€â”€ options/                  # å‘½ä»¤è¡Œé€‰é¡¹
â”‚   â””â”€â”€ options.go
â”œâ”€â”€ container/                # ä¾èµ–æ³¨å…¥å®¹å™¨
â”‚   â””â”€â”€ container.go
â”œâ”€â”€ domain/                   # é¢†åŸŸå±‚ï¼ˆè½»é‡çº§ï¼‰
â”‚   â”œâ”€â”€ questionnaire/        # é—®å·é¢†åŸŸæ¦‚å¿µ âœ… å·²å®Œæˆ
â”‚   â”‚   â”œâ”€â”€ entity.go         # é—®å·å®ä½“ âœ…
â”‚   â”‚   â”œâ”€â”€ validator.go      # é—®å·éªŒè¯å™¨ âœ…
â”‚   â”‚   â””â”€â”€ adapter.go        # é€‚é…å™¨ï¼ˆå®ç°æ¥å£ï¼‰ âœ…
â”‚   â”œâ”€â”€ answersheet/          # ç­”å·é¢†åŸŸæ¦‚å¿µ âœ… å·²å®Œæˆ
â”‚   â”‚   â”œâ”€â”€ entity.go         # ç­”å·å®ä½“ âœ…
â”‚   â”‚   â”œâ”€â”€ validator.go      # ç­”å·éªŒè¯å™¨ âœ…
â”‚   â”‚   â””â”€â”€ README.md         # ä½¿ç”¨æ–‡æ¡£ âœ…
â”‚   â””â”€â”€ validation/           # éªŒè¯é¢†åŸŸ âœ… å·²å®Œæˆé‡æ„
â”‚       â”œâ”€â”€ validator.go      # æ ¸å¿ƒéªŒè¯å™¨ âœ…
â”‚       â”œâ”€â”€ builders.go       # è§„åˆ™æ„å»ºå™¨ âœ…
â”‚       â”œâ”€â”€ validation_test.go # æµ‹è¯•æ–‡ä»¶ âœ…
â”‚       â”œâ”€â”€ README.md         # æ¶æ„æ–‡æ¡£ âœ…
â”‚       â”œâ”€â”€ rules/            # éªŒè¯è§„åˆ™ âœ…
â”‚       â”‚   â”œâ”€â”€ rule.go       # åŸºç¡€è§„åˆ™æ¥å£å’Œç±»å‹ âœ…
â”‚       â”‚   â”œâ”€â”€ required.go   # å¿…å¡«éªŒè¯è§„åˆ™ âœ…
â”‚       â”‚   â”œâ”€â”€ length.go     # é•¿åº¦éªŒè¯è§„åˆ™ âœ…
â”‚       â”‚   â””â”€â”€ value.go      # æ•°å€¼éªŒè¯è§„åˆ™ âœ…
â”‚       â””â”€â”€ strategies/       # éªŒè¯ç­–ç•¥ âœ…
â”‚           â”œâ”€â”€ strategy.go   # ç­–ç•¥æ¥å£å’Œå·¥å‚ âœ…
â”‚           â”œâ”€â”€ strategies.go # å…·ä½“ç­–ç•¥å®ç° âœ…
â”‚           â””â”€â”€ factory.go    # ç­–ç•¥å·¥å‚ âœ…
â”œâ”€â”€ application/              # åº”ç”¨å±‚
â”‚   â”œâ”€â”€ questionnaire/        # é—®å·åº”ç”¨æœåŠ¡
â”‚   â”‚   â”œâ”€â”€ service.go        # é—®å·æœåŠ¡ï¼ˆgRPCè°ƒç”¨ï¼‰
â”‚   â”‚   â””â”€â”€ dto.go           # æ•°æ®ä¼ è¾“å¯¹è±¡
â”‚   â”œâ”€â”€ answersheet/          # ç­”å·åº”ç”¨æœåŠ¡
â”‚   â”‚   â”œâ”€â”€ service.go        # ç­”å·æœåŠ¡ï¼ˆgRPCè°ƒç”¨ï¼‰
â”‚   â”‚   â””â”€â”€ dto.go           # æ•°æ®ä¼ è¾“å¯¹è±¡
â”‚   â””â”€â”€ validation/           # éªŒè¯åº”ç”¨æœåŠ¡
â”‚       â”œâ”€â”€ service.go        # éªŒè¯æœåŠ¡æ¥å£
â”‚       â”œâ”€â”€ concurrent/       # å¹¶å‘éªŒè¯å®ç°
â”‚       â”‚   â”œâ”€â”€ validator.go
â”‚       â”‚   â”œâ”€â”€ service.go
â”‚       â”‚   â””â”€â”€ adapter.go
â”‚       â”œâ”€â”€ sequential/       # ä¸²è¡ŒéªŒè¯å®ç°
â”‚       â”‚   â”œâ”€â”€ validator.go
â”‚       â”‚   â””â”€â”€ service.go
â”‚       â””â”€â”€ factory.go        # éªŒè¯æœåŠ¡å·¥å‚
â”œâ”€â”€ infrastructure/           # åŸºç¡€è®¾æ–½å±‚
â”‚   â”œâ”€â”€ grpc/                 # gRPC å®¢æˆ·ç«¯
â”‚   â”‚   â”œâ”€â”€ client_factory.go # å®¢æˆ·ç«¯å·¥å‚
â”‚   â”‚   â”œâ”€â”€ questionnaire_client.go
â”‚   â”‚   â””â”€â”€ answersheet_client.go
â”‚   â””â”€â”€ pubsub/               # æ¶ˆæ¯å‘å¸ƒ
â”‚       â””â”€â”€ publisher.go
â”œâ”€â”€ interface/                # æ¥å£å±‚
â”‚   â””â”€â”€ restful/              # REST API
â”‚       â”œâ”€â”€ router.go         # è·¯ç”±é…ç½®
â”‚       â”œâ”€â”€ middleware/       # ä¸­é—´ä»¶
â”‚       â”‚   â”œâ”€â”€ auth.go       # è®¤è¯ä¸­é—´ä»¶
â”‚       â”‚   â”œâ”€â”€ cors.go       # CORSä¸­é—´ä»¶
â”‚       â”‚   â”œâ”€â”€ logging.go    # æ—¥å¿—ä¸­é—´ä»¶
â”‚       â”‚   â””â”€â”€ validation.go # è¯·æ±‚éªŒè¯ä¸­é—´ä»¶
â”‚       â”œâ”€â”€ handler/          # å¤„ç†å™¨
â”‚       â”‚   â”œâ”€â”€ questionnaire_handler.go
â”‚       â”‚   â””â”€â”€ answersheet_handler.go
â”‚       â”œâ”€â”€ request/          # è¯·æ±‚æ¨¡å‹
â”‚       â”‚   â”œâ”€â”€ questionnaire.go
â”‚       â”‚   â””â”€â”€ answersheet.go
â”‚       â””â”€â”€ response/         # å“åº”æ¨¡å‹
â”‚           â”œâ”€â”€ questionnaire.go
â”‚           â””â”€â”€ answersheet.go
â””â”€â”€ docs/                     # æ–‡æ¡£
    â”œâ”€â”€ README.md
    â”œâ”€â”€ architecture.md
    â”œâ”€â”€ api.md
    â””â”€â”€ validation/
        â”œâ”€â”€ concurrent.md
        â””â”€â”€ rules.md
```

## ä¸šåŠ¡æ¨¡å—è®¾è®¡

### 1. é—®å·æ¨¡å— (Questionnaire) âœ… å·²å®Œæˆ
```go
// èŒè´£ï¼šé—®å·ä¿¡æ¯è·å–å’ŒéªŒè¯
type QuestionnaireService interface {
    GetQuestionnaire(ctx context.Context, code string) (*Questionnaire, error)
    ValidateQuestionnaireCode(ctx context.Context, code string) error
}
```

**å®ç°ç‰¹ç‚¹ï¼š**
- ä½¿ç”¨ protobuf è½¬æ¢å™¨ä» gRPC æ•°æ®è½¬æ¢ä¸ºé¢†åŸŸå®ä½“
- æä¾›é€‚é…å™¨å®ç°æ¥å£ï¼Œé¿å…å¾ªç¯å¯¼å…¥
- æ”¯æŒé—®å·ä»£ç å’Œå®ä½“éªŒè¯

### 2. ç­”å·æ¨¡å— (Answersheet) âœ… å·²å®Œæˆ
```go
// èŒè´£ï¼šç­”å·æ¥æ”¶ã€éªŒè¯ã€ä¿å­˜
type AnswersheetService interface {
    SubmitAnswersheet(ctx context.Context, req *SubmitRequest) (*SubmitResponse, error)
    ValidateAnswersheet(ctx context.Context, req *ValidationRequest) error
}
```

**å®ç°ç‰¹ç‚¹ï¼š**
- **åŸºäºé—®é¢˜éªŒè¯è§„åˆ™çš„åŠ¨æ€éªŒè¯**ï¼šæ¯ä¸ªç­”æ¡ˆæ ¹æ®å¯¹åº”é—®é¢˜çš„éªŒè¯è§„åˆ™è¿›è¡Œæ ¡éªŒ
- ä½¿ç”¨æ¥å£é¿å…å¾ªç¯å¯¼å…¥é—®é¢˜
- æ”¯æŒå¤šç§é—®é¢˜ç±»å‹çš„éªŒè¯ï¼ˆæ–‡æœ¬ã€æ•°å€¼ã€å•é€‰ã€å¤šé€‰ï¼‰
- æä¾›è¯¦ç»†çš„éªŒè¯é”™è¯¯ä¿¡æ¯

### 3. éªŒè¯æ¨¡å— (Validation) âœ… å·²å­˜åœ¨
```go
// èŒè´£ï¼šç‹¬ç«‹çš„éªŒè¯æœåŠ¡
type ValidationService interface {
    ValidateAnswers(ctx context.Context, answers []Answer, questionnaire *Questionnaire) error
    GetValidationStrategy() ValidationStrategy
}
```

## é‡æ„è¿›åº¦

### âœ… å·²å®Œæˆ - é¢†åŸŸå±‚é‡æ„

#### 1. é—®å·é¢†åŸŸæ¨¡å—
- [x] åˆ›å»ºé—®å·å®ä½“ (`domain/questionnaire/entity.go`)
- [x] å®ç° protobuf è½¬æ¢å™¨
- [x] åˆ›å»ºé—®å·éªŒè¯å™¨ (`domain/questionnaire/validator.go`)
- [x] åˆ›å»ºé€‚é…å™¨ (`domain/questionnaire/adapter.go`)

#### 2. ç­”å·é¢†åŸŸæ¨¡å—
- [x] åˆ›å»ºç­”å·å®ä½“ (`domain/answersheet/entity.go`)
- [x] åˆ›å»ºç­”å·éªŒè¯å™¨ (`domain/answersheet/validator.go`)
- [x] å®ç°åŸºäºé—®é¢˜éªŒè¯è§„åˆ™çš„åŠ¨æ€éªŒè¯
- [x] åˆ›å»ºä½¿ç”¨æ–‡æ¡£ (`domain/answersheet/README.md`)

#### 3. éªŒè¯æ¶æ„è®¾è®¡ âœ… å·²å®Œæˆé‡æ„
- [x] ä½¿ç”¨æ¥å£é¿å…å¾ªç¯å¯¼å…¥
- [x] å®ç°éªŒè¯è§„åˆ™è½¬æ¢æœºåˆ¶
- [x] æ”¯æŒå¤šç§é—®é¢˜ç±»å‹éªŒè¯
- [x] æä¾›è¯¦ç»†çš„é”™è¯¯å¤„ç†
- [x] é‡æ„ä¸ºåŸºäºç­–ç•¥æ¨¡å¼çš„éªŒè¯æ¶æ„
- [x] å®ç°éªŒè¯è§„åˆ™å’Œç­–ç•¥åˆ†ç¦»
- [x] åˆ›å»ºè§„åˆ™æ„å»ºå™¨æ¨¡å¼
- [x] æ·»åŠ å®Œæ•´çš„æµ‹è¯•è¦†ç›–
- [x] ç¼–å†™è¯¦ç»†çš„æ¶æ„æ–‡æ¡£

### ğŸ”„ è¿›è¡Œä¸­ - åº”ç”¨å±‚é‡æ„

#### 1. é—®å·åº”ç”¨æœåŠ¡
- [ ] åˆ›å»ºé—®å·æœåŠ¡æ¥å£
- [ ] å®ç° gRPC è°ƒç”¨é€»è¾‘
- [ ] åˆ›å»ºæ•°æ®ä¼ è¾“å¯¹è±¡

#### 2. ç­”å·åº”ç”¨æœåŠ¡
- [ ] åˆ›å»ºç­”å·æœåŠ¡æ¥å£
- [ ] å®ç° gRPC è°ƒç”¨é€»è¾‘
- [ ] é›†æˆé¢†åŸŸéªŒè¯å™¨

#### 3. éªŒè¯åº”ç”¨æœåŠ¡
- [ ] é‡æ„ç°æœ‰éªŒè¯æœåŠ¡
- [ ] åˆ†ç¦»å¹¶å‘å’Œä¸²è¡Œå®ç°
- [ ] åˆ›å»ºéªŒè¯æœåŠ¡å·¥å‚

### â³ å¾…å¼€å§‹ - åŸºç¡€è®¾æ–½å±‚é‡æ„

#### 1. gRPC å®¢æˆ·ç«¯
- [ ] åˆ›å»ºå®¢æˆ·ç«¯å·¥å‚
- [ ] å®ç°é—®å·å®¢æˆ·ç«¯
- [ ] å®ç°ç­”å·å®¢æˆ·ç«¯

#### 2. æ¶ˆæ¯å‘å¸ƒ
- [ ] åˆ›å»ºæ¶ˆæ¯å‘å¸ƒå™¨
- [ ] å®ç°äº‹ä»¶å‘å¸ƒé€»è¾‘

### â³ å¾…å¼€å§‹ - æ¥å£å±‚é‡æ„

#### 1. REST API
- [ ] åˆ›å»ºè·¯ç”±é…ç½®
- [ ] æ·»åŠ ä¸­é—´ä»¶
- [ ] è§„èŒƒåŒ–è¯·æ±‚/å“åº”æ¨¡å‹

#### 2. å¤„ç†å™¨
- [ ] é‡æ„é—®å·å¤„ç†å™¨
- [ ] é‡æ„ç­”å·å¤„ç†å™¨
- [ ] é›†æˆæ–°çš„åº”ç”¨æœåŠ¡

## æ ¸å¿ƒè®¾è®¡äº®ç‚¹

### 1. åŸºäºé—®é¢˜éªŒè¯è§„åˆ™çš„åŠ¨æ€éªŒè¯

è¿™æ˜¯æœ¬æ¬¡é‡æ„çš„æ ¸å¿ƒåˆ›æ–°ç‚¹ï¼š

```go
// éªŒè¯å•ä¸ªç­”æ¡ˆæ—¶ï¼Œæ ¹æ®é—®é¢˜çš„éªŒè¯è§„åˆ™è¿›è¡ŒéªŒè¯
func (v *Validator) ValidateAnswer(ctx context.Context, answer *Answer, question QuestionInfo) error {
    // 1. é—®é¢˜åŒ¹é…éªŒè¯
    // 2. åŸºç¡€éªŒè¯
    // 3. è§„åˆ™éªŒè¯ - æ ¹æ®é—®é¢˜çš„éªŒè¯è§„åˆ™è¿›è¡ŒéªŒè¯
    if len(question.GetValidationRules()) > 0 {
        rules := v.convertValidationRules(question.GetValidationRules())
        errors := v.validationValidator.ValidateMultiple(answer.Value, rules)
        // ...
    }
    // 4. ç±»å‹éªŒè¯
}
```

**ä¼˜åŠ¿ï¼š**
- æ¯ä¸ªç­”æ¡ˆéƒ½æ ¹æ®å…¶å¯¹åº”é—®é¢˜çš„å…·ä½“éªŒè¯è§„åˆ™è¿›è¡Œæ ¡éªŒ
- æ”¯æŒçµæ´»çš„éªŒè¯è§„åˆ™é…ç½®
- éªŒè¯é€»è¾‘ä¸é—®é¢˜å®šä¹‰ç´§å¯†è€¦åˆ

### 2. æ¥å£è®¾è®¡é¿å…å¾ªç¯å¯¼å…¥

é€šè¿‡å®šä¹‰æ¥å£å’Œé€‚é…å™¨æ¨¡å¼ï¼Œé¿å…äº†å¾ªç¯å¯¼å…¥é—®é¢˜ï¼š

```go
// åœ¨ answersheet åŒ…ä¸­å®šä¹‰æ¥å£
type QuestionInfo interface {
    GetCode() string
    GetType() string
    GetOptions() []QuestionOption
    GetValidationRules() []QuestionValidationRule
}

// åœ¨ questionnaire åŒ…ä¸­å®ç°é€‚é…å™¨
type QuestionAdapter struct {
    question *Question
}

func (a *QuestionAdapter) GetCode() string {
    return a.question.Code
}
```

### 3. éªŒè¯è§„åˆ™è½¬æ¢æœºåˆ¶

è‡ªåŠ¨å°†é—®å·ä¸­çš„éªŒè¯è§„åˆ™è½¬æ¢ä¸ºéªŒè¯å™¨çš„è§„åˆ™ï¼š

```go
func (v *Validator) convertValidationRule(protoRule QuestionValidationRule) *validation.ValidationRule {
    switch protoRule.GetRuleType() {
    case "required":
        return validation.NewValidationRule("required", nil, "æ­¤é¢˜ä¸ºå¿…ç­”é¢˜")
    case "min_length":
        return validation.NewValidationRule("min_length", protoRule.GetTargetValue(), "ç­”æ¡ˆé•¿åº¦ä¸èƒ½å°‘äºæŒ‡å®šå­—ç¬¦æ•°")
    // ...
    }
}
```

## ä¸‹ä¸€æ­¥è®¡åˆ’

### ç¬¬äºŒé˜¶æ®µï¼šåº”ç”¨å±‚é‡æ„
1. åˆ›å»ºé—®å·å’Œç­”å·åº”ç”¨æœåŠ¡
2. é‡æ„éªŒè¯åº”ç”¨æœåŠ¡
3. å®ç°éªŒè¯æœåŠ¡å·¥å‚

### ç¬¬ä¸‰é˜¶æ®µï¼šåŸºç¡€è®¾æ–½å±‚é‡æ„
1. é‡æ„ gRPC å®¢æˆ·ç«¯
2. å®ç°æ¶ˆæ¯å‘å¸ƒ

### ç¬¬å››é˜¶æ®µï¼šæ¥å£å±‚é‡æ„
1. æ·»åŠ ä¸­é—´ä»¶
2. è§„èŒƒåŒ–è¯·æ±‚/å“åº”æ¨¡å‹
3. é‡æ„å¤„ç†å™¨

## ä¼˜åŠ¿

### 1. æ¸…æ™°çš„ä¸šåŠ¡è¾¹ç•Œ
- é—®å·ç®¡ç†ï¼šç‹¬ç«‹çš„é—®å·æœåŠ¡
- ç­”å·å¤„ç†ï¼šç‹¬ç«‹çš„ç­”å·æœåŠ¡
- éªŒè¯æœåŠ¡ï¼šå¯é…ç½®çš„éªŒè¯ç­–ç•¥

### 2. æ›´å¥½çš„å¯ç»´æŠ¤æ€§
- æ¨¡å—åŒ–è®¾è®¡
- èŒè´£åˆ†ç¦»
- æ˜“äºæµ‹è¯•

### 3. æ”¯æŒç­–ç•¥åˆ‡æ¢
- å¹¶å‘/ä¸²è¡ŒéªŒè¯å¯é…ç½®
- éªŒè¯è§„åˆ™å¯æ‰©å±•
- ä¸­é—´ä»¶å¯æ’æ‹”

### 4. æé«˜å¼€å‘æ•ˆç‡
- ç›´è§‚çš„ç›®å½•ç»“æ„
- æ¸…æ™°çš„å‘½åçº¦å®š
- å®Œå–„çš„æ–‡æ¡£ 