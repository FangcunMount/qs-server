name: Deploy Crontab Configuration

# ============================================================================
# å¿…éœ€çš„ Secrets é…ç½®
# ============================================================================
# Organization Secrets (ç»„ç»‡çº§åˆ«ï¼Œå…±äº«é…ç½®):
#   SVRA_HOST, SVRA_USERNAME, SVRA_SSH_KEY, SVRA_SSH_PORT
#   SVRA_SUDO_PASSWORD (å¯é€‰ï¼Œå¦‚æžœ sudo éœ€è¦å¯†ç )
#
# Repository Secrets (ä»“åº“çº§åˆ«ï¼Œæ•æ„Ÿä¿¡æ¯):
#   IAM_USERNAME, IAM_PASSWORD (IAM ç™»å½•å‡­è¯)
#   IAM_LOGIN_URL (å¯é€‰ï¼Œé»˜è®¤: https://iam.example.com/api/v1/auth/login)
#   API_BASE_URL (å¯é€‰ï¼Œé»˜è®¤: http://localhost:8080)
# ============================================================================

on:
  push:
    branches: [ main ]
    paths:
      - 'configs/crontab/**'
      - '.github/workflows/deploy-crontab.yml'
  workflow_dispatch:
    inputs:
      force:
        description: 'å¼ºåˆ¶éƒ¨ç½²ï¼ˆå³ä½¿æ–‡ä»¶æœªå˜æ›´ï¼‰'
        required: false
        type: boolean
        default: false

env:
  DEPLOY_USER: root
  SCRIPTS_DIR: /usr/local/bin
  CONFIG_DIR: /etc/qs-server
  CRON_DIR: /etc/cron.d
  LOG_DIR: /var/log/qs-scheduler
  LOGROTATE_DIR: /etc/logrotate.d

jobs:
  deploy:
    name: Deploy Crontab Configuration
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Validate required secrets
        run: |
          echo "ðŸ” Validating GitHub Secrets..."
          echo ""
          
          # å¿…éœ€çš„ç»„ç»‡çº§åˆ« Secrets (Organization Secrets)
          echo "ðŸ“‹ Checking Organization Secrets..."
          MISSING_SECRETS=0
          
          if [ -z "${{ secrets.SVRA_HOST }}" ]; then
            echo "âŒ SVRA_HOST is not set (Organization Secret)"
            MISSING_SECRETS=$((MISSING_SECRETS + 1))
          else
            echo "âœ… SVRA_HOST is set"
          fi
          
          if [ -z "${{ secrets.SVRA_USERNAME }}" ]; then
            echo "âŒ SVRA_USERNAME is not set (Organization Secret)"
            MISSING_SECRETS=$((MISSING_SECRETS + 1))
          else
            echo "âœ… SVRA_USERNAME is set"
          fi
          
          if [ -z "${{ secrets.SVRA_SSH_KEY }}" ]; then
            echo "âŒ SVRA_SSH_KEY is not set (Organization Secret)"
            MISSING_SECRETS=$((MISSING_SECRETS + 1))
          else
            echo "âœ… SVRA_SSH_KEY is set"
          fi
          
          # å¯é€‰çš„ SSH ç«¯å£
          if [ -z "${{ secrets.SVRA_SSH_PORT }}" ]; then
            echo "âš ï¸  SVRA_SSH_PORT is not set, will use default: 22"
          else
            echo "âœ… SVRA_SSH_PORT is set: ${{ secrets.SVRA_SSH_PORT }}"
          fi
          
          # å¯é€‰çš„ sudo å¯†ç 
          if [ -z "${{ secrets.SVRA_SUDO_PASSWORD }}" ]; then
            echo "âš ï¸  SVRA_SUDO_PASSWORD is not set (optional, required if sudo needs password)"
          else
            echo "âœ… SVRA_SUDO_PASSWORD is set"
          fi
          
          echo ""
          echo "ðŸ“‹ Checking Repository Secrets..."
          
          # å¿…éœ€çš„ä»“åº“çº§åˆ« Secrets (Repository Secrets)
          if [ -z "${{ secrets.IAM_USERNAME }}" ]; then
            echo "âŒ IAM_USERNAME is not set (Repository Secret)"
            MISSING_SECRETS=$((MISSING_SECRETS + 1))
          else
            echo "âœ… IAM_USERNAME is set"
          fi
          
          if [ -z "${{ secrets.IAM_PASSWORD }}" ]; then
            echo "âŒ IAM_PASSWORD is not set (Repository Secret)"
            MISSING_SECRETS=$((MISSING_SECRETS + 1))
          else
            echo "âœ… IAM_PASSWORD is set"
          fi
          
          # å¯é€‰çš„ IAM é…ç½®
          if [ -z "${{ secrets.IAM_LOGIN_URL }}" ]; then
            echo "âš ï¸  IAM_LOGIN_URL is not set, will use default: https://iam.example.com/api/v1/auth/login"
          else
            echo "âœ… IAM_LOGIN_URL is set"
          fi
          
          if [ -z "${{ secrets.API_BASE_URL }}" ]; then
            echo "âš ï¸  API_BASE_URL is not set, will use default: http://localhost:8080"
          else
            echo "âœ… API_BASE_URL is set"
          fi
          
          echo ""
          if [ $MISSING_SECRETS -gt 0 ]; then
            echo "âŒ Validation failed: $MISSING_SECRETS required secret(s) are missing"
            echo ""
            echo "Please configure the following secrets:"
            echo "  Organization Secrets:"
            echo "    - SVRA_HOST"
            echo "    - SVRA_USERNAME"
            echo "    - SVRA_SSH_KEY"
            echo "  Repository Secrets:"
            echo "    - IAM_USERNAME"
            echo "    - IAM_PASSWORD"
            exit 1
          fi
          
          echo "âœ… All required secrets are configured"

      - name: Prepare deployment package
        run: |
          mkdir -p deploy-crontab
          
          # å¤åˆ¶è„šæœ¬æ–‡ä»¶
          cp configs/crontab/refresh-token.sh deploy-crontab/
          cp configs/crontab/api-call.sh deploy-crontab/
          
          # å¤åˆ¶é…ç½®æ–‡ä»¶
          cp configs/crontab/qs-scheduler deploy-crontab/
          cp configs/crontab/logrotate.conf deploy-crontab/
          
          # åˆ›å»ºéƒ¨ç½²è„šæœ¬
          cat > deploy-crontab/deploy.sh << 'DEPLOY_SCRIPT'
          #!/bin/bash
          set -euo pipefail
          
          SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
          SCRIPTS_DIR="${SCRIPTS_DIR:-/usr/local/bin}"
          CONFIG_DIR="${CONFIG_DIR:-/etc/qs-server}"
          CRON_DIR="${CRON_DIR:-/etc/cron.d}"
          LOG_DIR="${LOG_DIR:-/var/log/qs-scheduler}"
          LOGROTATE_DIR="${LOGROTATE_DIR:-/etc/logrotate.d}"
          
          echo "ðŸš€ Starting crontab deployment..."
          
          # 1. åˆ›å»ºå¿…è¦ç›®å½•
          echo "ðŸ“ Creating directories..."
          mkdir -p "${SCRIPTS_DIR}"
          mkdir -p "${CONFIG_DIR}"
          mkdir -p "${CRON_DIR}"
          mkdir -p "${LOG_DIR}"
          mkdir -p "${LOGROTATE_DIR}"
          
          chmod 755 "${SCRIPTS_DIR}"
          chmod 755 "${CONFIG_DIR}"
          chmod 755 "${CRON_DIR}"
          chmod 755 "${LOG_DIR}"
          
          # 2. éƒ¨ç½²è„šæœ¬æ–‡ä»¶
          echo "ðŸ“ Deploying scripts..."
          cp "${SCRIPT_DIR}/refresh-token.sh" "${SCRIPTS_DIR}/qs-refresh-token.sh"
          cp "${SCRIPT_DIR}/api-call.sh" "${SCRIPTS_DIR}/qs-api-call.sh"
          
          chmod +x "${SCRIPTS_DIR}/qs-refresh-token.sh"
          chmod +x "${SCRIPTS_DIR}/qs-api-call.sh"
          chown root:root "${SCRIPTS_DIR}/qs-refresh-token.sh"
          chown root:root "${SCRIPTS_DIR}/qs-api-call.sh"
          
          # 3. éƒ¨ç½² crontab é…ç½®æ–‡ä»¶ï¼ˆéœ€è¦æ›¿æ¢çŽ¯å¢ƒå˜é‡ï¼‰
          echo "âš™ï¸  Deploying crontab configuration..."
          # æ³¨æ„ï¼šçŽ¯å¢ƒå˜é‡æ›¿æ¢åœ¨ GitHub Actions ä¸­å®Œæˆ
          cp "${SCRIPT_DIR}/qs-scheduler" "${CRON_DIR}/qs-scheduler"
          chmod 644 "${CRON_DIR}/qs-scheduler"
          chown root:root "${CRON_DIR}/qs-scheduler"
          
          # 4. éƒ¨ç½²æ—¥å¿—è½®è½¬é…ç½®
          echo "ðŸ“‹ Deploying logrotate configuration..."
          cp "${SCRIPT_DIR}/logrotate.conf" "${LOGROTATE_DIR}/qs-scheduler"
          chmod 644 "${LOGROTATE_DIR}/qs-scheduler"
          chown root:root "${LOGROTATE_DIR}/qs-scheduler"
          
          # 5. éªŒè¯éƒ¨ç½²
          echo "âœ… Verifying deployment..."
          if [ ! -f "${SCRIPTS_DIR}/qs-refresh-token.sh" ]; then
            echo "âŒ qs-refresh-token.sh not found"
            exit 1
          fi
          if [ ! -f "${SCRIPTS_DIR}/qs-api-call.sh" ]; then
            echo "âŒ qs-api-call.sh not found"
            exit 1
          fi
          if [ ! -f "${CRON_DIR}/qs-scheduler" ]; then
            echo "âŒ qs-scheduler not found"
            exit 1
          fi
          
          # 6. éªŒè¯ crontab é…ç½®æ ¼å¼
          echo "ðŸ” Validating crontab format..."
          if ! crontab -l -u root 2>/dev/null | grep -q "qs-scheduler" || [ -f "${CRON_DIR}/qs-scheduler" ]; then
            # æ£€æŸ¥é…ç½®æ–‡ä»¶æ ¼å¼
            if ! grep -q "^[0-9*]" "${CRON_DIR}/qs-scheduler" 2>/dev/null; then
              echo "âš ï¸  Warning: No cron jobs found in qs-scheduler, but file exists"
            fi
          fi
          
          # 7. æµ‹è¯•è„šæœ¬å¯æ‰§è¡Œæ€§ï¼ˆä»…æ£€æŸ¥è¯­æ³•ï¼Œä¸å®žé™…æ‰§è¡Œï¼‰
          echo "ðŸ§ª Testing scripts..."
          # æ³¨æ„ï¼šè¿™é‡Œåªæ˜¯æ£€æŸ¥è¯­æ³•ï¼Œä¸å®žé™…æ‰§è¡Œè„šæœ¬ï¼ˆå› ä¸ºéœ€è¦çŽ¯å¢ƒå˜é‡ï¼‰
          # å®žé™…éƒ¨ç½²åŽä¼šåœ¨æœåŠ¡å™¨ä¸Šè¿›è¡Œè¯­æ³•æ£€æŸ¥
          
          echo "âœ… Deployment completed successfully!"
          echo ""
          echo "ðŸ“‹ Deployment summary:"
          echo "   - Scripts: ${SCRIPTS_DIR}/qs-*.sh"
          echo "   - Crontab: ${CRON_DIR}/qs-scheduler"
          echo "   - Logrotate: ${LOGROTATE_DIR}/qs-scheduler"
          echo "   - Log directory: ${LOG_DIR}"
          DEPLOY_SCRIPT
          
          chmod +x deploy-crontab/deploy.sh
          
          echo "âœ… Deployment package prepared"

      - name: Replace environment variables in crontab config
        run: |
          # ä»Ž secrets è¯»å–é…ç½®ï¼ˆå¦‚æžœè®¾ç½®äº†ï¼‰
          IAM_USERNAME="${{ secrets.IAM_USERNAME }}"
          IAM_PASSWORD="${{ secrets.IAM_PASSWORD }}"
          IAM_LOGIN_URL="${{ secrets.IAM_LOGIN_URL }}"
          API_BASE_URL="${{ secrets.API_BASE_URL }}"
          
          # ä½¿ç”¨é»˜è®¤å€¼ï¼ˆå¦‚æžœ secrets æœªè®¾ç½®ï¼‰
          IAM_USERNAME="${IAM_USERNAME:-qs-scheduler@example.com}"
          IAM_PASSWORD="${IAM_PASSWORD:-your-password-here}"
          IAM_LOGIN_URL="${IAM_LOGIN_URL:-https://iam.example.com/api/v1/auth/login}"
          API_BASE_URL="${API_BASE_URL:-http://localhost:8080}"
          
          # è½¬ä¹‰ç‰¹æ®Šå­—ç¬¦ï¼ˆç”¨äºŽ sedï¼‰
          IAM_USERNAME_ESC=$(echo "${IAM_USERNAME}" | sed 's/[[\.*^$()+?{|]/\\&/g')
          IAM_PASSWORD_ESC=$(echo "${IAM_PASSWORD}" | sed 's/[[\.*^$()+?{|]/\\&/g')
          IAM_LOGIN_URL_ESC=$(echo "${IAM_LOGIN_URL}" | sed 's/[[\.*^$()+?{|]/\\&/g')
          API_BASE_URL_ESC=$(echo "${API_BASE_URL}" | sed 's/[[\.*^$()+?{|]/\\&/g')
          
          # æ›¿æ¢é…ç½®æ–‡ä»¶ä¸­çš„å ä½ç¬¦
          # ä½¿ç”¨ | ä½œä¸ºåˆ†éš”ç¬¦ï¼Œé¿å…ä¸Ž URL ä¸­çš„ / å†²çª
          sed -i "s|IAM_USERNAME=\"qs-scheduler@example.com\"|IAM_USERNAME=\"${IAM_USERNAME_ESC}\"|g" deploy-crontab/qs-scheduler
          sed -i "s|IAM_PASSWORD=\"your-password-here\"|IAM_PASSWORD=\"${IAM_PASSWORD_ESC}\"|g" deploy-crontab/qs-scheduler
          sed -i "s|IAM_LOGIN_URL=\"https://iam.example.com/api/v1/auth/login\"|IAM_LOGIN_URL=\"${IAM_LOGIN_URL_ESC}\"|g" deploy-crontab/qs-scheduler
          sed -i "s|API_BASE_URL=\"http://localhost:8080\"|API_BASE_URL=\"${API_BASE_URL_ESC}\"|g" deploy-crontab/qs-scheduler
          
          # éªŒè¯æ›¿æ¢ç»“æžœï¼ˆä¸æ˜¾ç¤ºæ•æ„Ÿä¿¡æ¯ï¼‰
          echo "âœ… Environment variables replaced:"
          echo "   - IAM_USERNAME: ${IAM_USERNAME}"
          echo "   - IAM_LOGIN_URL: ${IAM_LOGIN_URL}"
          echo "   - API_BASE_URL: ${API_BASE_URL}"
          
          # é‡æ–°æ‰“åŒ…
          tar -czf deploy-crontab.tar.gz -C deploy-crontab .
          
          echo "âœ… Deployment package updated"

      - name: Upload deployment package
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.SVRA_HOST }}
          username: ${{ secrets.SVRA_USERNAME }}
          key: ${{ secrets.SVRA_SSH_KEY }}
          port: ${{ secrets.SVRA_SSH_PORT || 22 }}
          source: "deploy-crontab.tar.gz"
          target: "/tmp"

      - name: Deploy to Production Server
        uses: appleboy/ssh-action@v1.0.0
        env:
          SUDO_PASSWORD: ${{ secrets.SVRA_SUDO_PASSWORD }}
          SCRIPTS_DIR: ${{ env.SCRIPTS_DIR }}
          CONFIG_DIR: ${{ env.CONFIG_DIR }}
          CRON_DIR: ${{ env.CRON_DIR }}
          LOG_DIR: ${{ env.LOG_DIR }}
          LOGROTATE_DIR: ${{ env.LOGROTATE_DIR }}
        with:
          host: ${{ secrets.SVRA_HOST }}
          username: ${{ secrets.SVRA_USERNAME }}
          key: ${{ secrets.SVRA_SSH_KEY }}
          port: ${{ secrets.SVRA_SSH_PORT || 22 }}
          envs: SUDO_PASSWORD,SCRIPTS_DIR,CONFIG_DIR,CRON_DIR,LOG_DIR,LOGROTATE_DIR
          script: |
            set -Eeuo pipefail
            
            # å®šä¹‰çŽ¯å¢ƒå˜é‡ï¼ˆä½¿ç”¨çŽ¯å¢ƒå˜é‡æˆ–é»˜è®¤å€¼ï¼‰
            SCRIPTS_DIR="${SCRIPTS_DIR:-/usr/local/bin}"
            CONFIG_DIR="${CONFIG_DIR:-/etc/qs-server}"
            CRON_DIR="${CRON_DIR:-/etc/cron.d}"
            LOG_DIR="${LOG_DIR:-/var/log/qs-scheduler}"
            LOGROTATE_DIR="${LOGROTATE_DIR:-/etc/logrotate.d}"
            
            # SUDO åŠ©æ‰‹
            if sudo -n true 2>/dev/null; then
              SUDO_CMD() { sudo "$@"; }
              echo "â„¹ï¸ Using passwordless sudo."
            else
              if [ -z "${SUDO_PASSWORD:-}" ]; then
                echo "âŒ sudo needs password. Provide SVRA_SUDO_PASSWORD or configure NOPASSWD." >&2
                exit 1
              fi
              SUDO_CMD() { sudo -S "$@" <<<"$SUDO_PASSWORD"; }
              export -f SUDO_CMD
              SUDO_CMD -v || true
              echo "â„¹ï¸ Using sudo with password."
            fi
            
            echo "ðŸš€ Starting crontab deployment on $(hostname)..."
            
            # è§£åŽ‹éƒ¨ç½²åŒ…
            DEPLOY_DIR="/tmp/crontab-deploy-$$"
            mkdir -p "${DEPLOY_DIR}"
            cd "${DEPLOY_DIR}"
            tar -xzf /tmp/deploy-crontab.tar.gz
            
            # åˆ›å»ºå¿…è¦ç›®å½•
            echo "ðŸ“ Creating directories..."
            SUDO_CMD mkdir -p "${SCRIPTS_DIR}"
            SUDO_CMD mkdir -p "${CONFIG_DIR}"
            SUDO_CMD mkdir -p "${CRON_DIR}"
            SUDO_CMD mkdir -p "${LOG_DIR}"
            SUDO_CMD mkdir -p "${LOGROTATE_DIR}"
            
            SUDO_CMD chmod 755 "${SCRIPTS_DIR}"
            SUDO_CMD chmod 755 "${CONFIG_DIR}"
            SUDO_CMD chmod 755 "${CRON_DIR}"
            SUDO_CMD chmod 755 "${LOG_DIR}"
            
            # éƒ¨ç½²è„šæœ¬æ–‡ä»¶
            echo "ðŸ“ Deploying scripts..."
            SUDO_CMD cp "${DEPLOY_DIR}/refresh-token.sh" "${SCRIPTS_DIR}/qs-refresh-token.sh"
            SUDO_CMD cp "${DEPLOY_DIR}/api-call.sh" "${SCRIPTS_DIR}/qs-api-call.sh"
            
            SUDO_CMD chmod +x "${SCRIPTS_DIR}/qs-refresh-token.sh"
            SUDO_CMD chmod +x "${SCRIPTS_DIR}/qs-api-call.sh"
            SUDO_CMD chown root:root "${SCRIPTS_DIR}/qs-refresh-token.sh"
            SUDO_CMD chown root:root "${SCRIPTS_DIR}/qs-api-call.sh"
            
            # éƒ¨ç½² crontab é…ç½®æ–‡ä»¶
            echo "âš™ï¸  Deploying crontab configuration..."
            SUDO_CMD cp "${DEPLOY_DIR}/qs-scheduler" "${CRON_DIR}/qs-scheduler"
            SUDO_CMD chmod 644 "${CRON_DIR}/qs-scheduler"
            SUDO_CMD chown root:root "${CRON_DIR}/qs-scheduler"
            
            # éƒ¨ç½²æ—¥å¿—è½®è½¬é…ç½®
            echo "ðŸ“‹ Deploying logrotate configuration..."
            SUDO_CMD cp "${DEPLOY_DIR}/logrotate.conf" "${LOGROTATE_DIR}/qs-scheduler"
            SUDO_CMD chmod 644 "${LOGROTATE_DIR}/qs-scheduler"
            SUDO_CMD chown root:root "${LOGROTATE_DIR}/qs-scheduler"
            
            # éªŒè¯éƒ¨ç½²
            echo "âœ… Verifying deployment..."
            if [ ! -f "${SCRIPTS_DIR}/qs-refresh-token.sh" ]; then
              echo "âŒ qs-refresh-token.sh not found"
              exit 1
            fi
            if [ ! -f "${SCRIPTS_DIR}/qs-api-call.sh" ]; then
              echo "âŒ qs-api-call.sh not found"
              exit 1
            fi
            if [ ! -f "${CRON_DIR}/qs-scheduler" ]; then
              echo "âŒ qs-scheduler not found"
              exit 1
            fi
            
            # éªŒè¯ crontab é…ç½®æ ¼å¼
            echo "ðŸ” Validating crontab format..."
            if ! SUDO_CMD grep -qE "^[0-9*]+.*root.*qs-api-call.sh" "${CRON_DIR}/qs-scheduler" 2>/dev/null; then
              echo "âš ï¸  Warning: No cron jobs found in qs-scheduler"
            fi
            
            # æµ‹è¯•è„šæœ¬å¯æ‰§è¡Œæ€§ï¼ˆä»…æ£€æŸ¥è¯­æ³•ï¼Œä¸å®žé™…æ‰§è¡Œï¼‰
            echo "ðŸ§ª Testing scripts..."
            if ! SUDO_CMD bash -n "${SCRIPTS_DIR}/qs-refresh-token.sh" 2>/dev/null; then
              echo "âš ï¸  Warning: qs-refresh-token.sh has syntax errors"
            fi
            if ! SUDO_CMD bash -n "${SCRIPTS_DIR}/qs-api-call.sh" 2>/dev/null; then
              echo "âš ï¸  Warning: qs-api-call.sh has syntax errors"
            fi
            
            # æ¸…ç†ä¸´æ—¶æ–‡ä»¶
            rm -rf "${DEPLOY_DIR}"
            rm -f /tmp/deploy-crontab.tar.gz
            
            echo ""
            echo "âœ… Deployment completed successfully!"
            echo ""
            echo "ðŸ“‹ Deployment summary:"
            echo "   - Scripts: ${SCRIPTS_DIR}/qs-*.sh"
            echo "   - Crontab: ${CRON_DIR}/qs-scheduler"
            echo "   - Logrotate: ${LOGROTATE_DIR}/qs-scheduler"
            echo "   - Log directory: ${LOG_DIR}"
            echo ""
            echo "ðŸ“ Next steps:"
            echo "   1. Verify crontab config: cat ${CRON_DIR}/qs-scheduler"
            echo "   2. Check cron service: sudo systemctl status cron"
            echo "   3. Test token refresh: sudo ${SCRIPTS_DIR}/qs-refresh-token.sh"
            echo "   4. Test API call: sudo ${SCRIPTS_DIR}/qs-api-call.sh /api/v1/statistics/sync/daily"

      - name: Verify deployment
        uses: appleboy/ssh-action@v1.0.0
        env:
          SUDO_PASSWORD: ${{ secrets.SVRA_SUDO_PASSWORD }}
        with:
          host: ${{ secrets.SVRA_HOST }}
          username: ${{ secrets.SVRA_USERNAME }}
          key: ${{ secrets.SVRA_SSH_KEY }}
          port: ${{ secrets.SVRA_SSH_PORT || 22 }}
          envs: SUDO_PASSWORD
          script: |
            set -Eeuo pipefail
            
            # SUDO åŠ©æ‰‹
            if sudo -n true 2>/dev/null; then
              SUDO_CMD() { sudo "$@"; }
              echo "â„¹ï¸ Using passwordless sudo."
            else
              if [ -z "${SUDO_PASSWORD:-}" ]; then
                echo "âŒ sudo needs password. Provide SVRA_SUDO_PASSWORD or configure NOPASSWD." >&2
                exit 1
              fi
              SUDO_CMD() { sudo -S "$@" <<<"$SUDO_PASSWORD"; }
              export -f SUDO_CMD
              SUDO_CMD -v || true
              echo "â„¹ï¸ Using sudo with password."
            fi
            
            echo "ðŸ” Verifying deployment..."
            
            # æ£€æŸ¥æ–‡ä»¶æ˜¯å¦å­˜åœ¨
            echo "ðŸ“ Checking files..."
            SUDO_CMD test -f /usr/local/bin/qs-refresh-token.sh && echo "âœ… qs-refresh-token.sh exists" || echo "âŒ qs-refresh-token.sh missing"
            SUDO_CMD test -f /usr/local/bin/qs-api-call.sh && echo "âœ… qs-api-call.sh exists" || echo "âŒ qs-api-call.sh missing"
            SUDO_CMD test -f /etc/cron.d/qs-scheduler && echo "âœ… qs-scheduler exists" || echo "âŒ qs-scheduler missing"
            SUDO_CMD test -f /etc/logrotate.d/qs-scheduler && echo "âœ… logrotate config exists" || echo "âŒ logrotate config missing"
            
            # æ£€æŸ¥æ–‡ä»¶æƒé™
            echo ""
            echo "ðŸ” Checking permissions..."
            ls -l /usr/local/bin/qs-*.sh | head -2
            ls -l /etc/cron.d/qs-scheduler
            ls -l /etc/logrotate.d/qs-scheduler
            
            # æ£€æŸ¥ cron æœåŠ¡çŠ¶æ€
            echo ""
            echo "âš™ï¸  Checking cron service..."
            SUDO_CMD systemctl status cron --no-pager -l || SUDO_CMD systemctl status crond --no-pager -l || echo "âš ï¸  Cron service status check failed"
            
            # æ˜¾ç¤º crontab é…ç½®æ‘˜è¦ï¼ˆä¸æ˜¾ç¤ºæ•æ„Ÿä¿¡æ¯ï¼‰
            echo ""
            echo "ðŸ“‹ Crontab configuration summary:"
            SUDO_CMD grep -E "^[0-9*]+.*root.*qs-api-call.sh" /etc/cron.d/qs-scheduler | sed 's/.*qs-api-call.sh/  - Task: qs-api-call.sh/' || echo "  No tasks found"
            
            echo ""
            echo "âœ… Verification completed"

